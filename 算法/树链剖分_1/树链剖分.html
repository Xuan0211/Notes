<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../css/wolai.css"/><title>树链剖分 - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="树链剖分" class="main-title"></div></div></header><article><div id="5vNprex7ZtjFQUEVN4kxLZ" class="wolai-bookmark wolai-block"><a href="https://www.luogu.com.cn/blog/yjpiaomiao/shulianpoufen">通俗易懂的树链剖分详解 - 一剑缥缈的洛咕博客 - 洛谷博客</a><div class="info-box"><div class="text-pane"><div data-title="通俗易懂的树链剖分详解 - 一剑缥缈的洛咕博客 - 洛谷博客"></div><div class="icon-host"><div class="icon icon-image" style="background-image: url(&quot;https://www.luogu.com.cn/favicon.ico&quot;)"></div><div data-hostname="www.luogu.com.cn"></div></div></div><div class="preview-pane"></div></div></div><code-block id="p7Pr4yTsfqXXvcxdGEHWyj" class="wolai-block"><div class="wolai-pre"><div data-lang="C++" class="marker"></div><pre></pre></div></code-block><div id="38fr7jkNFQN2RvphVbDpVm" class="wolai-block wolai-text"><div></div></div><div id="jt33Pjdhga8mx5giRoE7LM" class="wolai-block wolai-text"><div><span class="inline-wrap">树链剖分，计算机术语，指一种对树进行划分的算法，</span><span class="inline-wrap"><b>它先通过轻重边剖分将树分为多条链，保证每个点属于且只属于一条链</b></span><span class="inline-wrap">，然后再通过数据结构（树状数组、BST、SPLAY、线段树等）来维护每一条链。</span></div></div><div id="sbQ9v4Eq8U71CENdT7k3pC" class="wolai-block wolai-text"><div><span class="inline-wrap">重链剖分</span></div></div><div id="xuPJmuEYYR8NC1aD1DTFk2" class="wolai-block wolai-text"><div><span class="inline-wrap">重儿子</span></div></div><aside id="3M3wBqeNrTwMTM5jsMJGgL" class="bg-cultured wolai-block"><div data-symbol="✒️" class="icon"></div><span class="inline-wrap">总体还是<span class="jill"></span>DFS<span class="jill"></span>算法，不过是在<span class="jill"></span>DFS<span class="jill"></span>算法的基础上加上了一计算子树所有顶点数的计算</span></aside><code-block id="tfLocKHXYfnKxRUhJNBqvF" class="wolai-block"><div class="wolai-pre"><div data-lang="C++" class="marker"></div><pre><span class="token keyword">void</span> <span class="token function">dfs1</span><span class="token punctuation">(</span><span class="token parameter">int now<span class="token punctuation">,</span>int father<span class="token punctuation">,</span>int depth</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    fa<span class="token punctuation">[</span>now<span class="token punctuation">]</span><span class="token operator">=</span>father<span class="token punctuation">;</span> <span class="token comment">//记录父亲</span>
    dep<span class="token punctuation">[</span>now<span class="token punctuation">]</span><span class="token operator">=</span>depth<span class="token punctuation">;</span> <span class="token comment">//记录辈分（深度）</span>
    size<span class="token punctuation">[</span>now<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//标记当前的初始小家族（子树）人数（节点数）为1</span>
    <span class="token keyword control-flow">for</span><span class="token punctuation">(</span>int i<span class="token operator">=</span>head<span class="token punctuation">[</span>now<span class="token punctuation">]</span><span class="token punctuation">;</span>i<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">=</span>e<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">nxt</span><span class="token punctuation">)</span>
        <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>e<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token operator">!=</span>father<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">dfs1</span><span class="token punctuation">(</span>e<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">,</span>now<span class="token punctuation">,</span>depth<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">//辈分变小（深度变深）</span>
            size<span class="token punctuation">[</span>now<span class="token punctuation">]</span><span class="token operator">+=</span>size<span class="token punctuation">[</span>e<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>size<span class="token punctuation">[</span>e<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">]</span><span class="token operator">></span>size<span class="token punctuation">[</span>son<span class="token punctuation">[</span>now<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                son<span class="token punctuation">[</span>now<span class="token punctuation">]</span><span class="token operator">=</span>e<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">;</span> <span class="token comment">//如果当前的后代数更多，就成为重儿子</span>
        <span class="token punctuation">}</span>
    <span class="token keyword control-flow">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre></div></code-block><code-block id="eiY8NXC6mwGdaFJMk256rr" class="wolai-block"><div class="wolai-pre"><div data-lang="C++" class="marker"></div><pre><span class="token keyword">void</span> <span class="token function">dfs2</span><span class="token punctuation">(</span><span class="token parameter">int now<span class="token punctuation">,</span>int nowt</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    top<span class="token punctuation">[</span>now<span class="token punctuation">]</span><span class="token operator">=</span>nowt<span class="token punctuation">;</span> <span class="token comment">//通过标记当前链的链首来连接重链</span>
    id<span class="token punctuation">[</span>now<span class="token punctuation">]</span><span class="token operator">=</span>cnt<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">//记录dfs序</span>
    rk<span class="token punctuation">[</span>cnt<span class="token punctuation">]</span><span class="token operator">=</span>now<span class="token punctuation">;</span> <span class="token comment">//记录dfs序指向的节点</span>
    <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>son<span class="token punctuation">[</span>now<span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword control-flow">return</span><span class="token punctuation">;</span>
    <span class="token function">dfs2</span><span class="token punctuation">(</span>son<span class="token punctuation">[</span>now<span class="token punctuation">]</span><span class="token punctuation">,</span>nowt<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//优先延伸重链，使同一条重链上的dfs序连续</span>
    <span class="token keyword control-flow">for</span><span class="token punctuation">(</span>int i<span class="token operator">=</span>head<span class="token punctuation">[</span>now<span class="token punctuation">]</span><span class="token punctuation">;</span>i<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">=</span>e<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">nxt</span><span class="token punctuation">)</span>
        <span class="token keyword control-flow">if</span><span class="token punctuation">(</span>e<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token operator">!=</span>son<span class="token punctuation">[</span>now<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> fa<span class="token punctuation">[</span>now<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token function">dfs2</span><span class="token punctuation">(</span>e<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">,</span>e<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//下一条重链的开始</span>
    <span class="token keyword control-flow">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre></div></code-block><code-block id="6F7nXZVaneu4eiBtebodrW" class="wolai-block"><div class="wolai-pre"><div data-lang="MATLAB" class="marker"></div><pre>void <span class="token function">dfs_1</span><span class="token punctuation">(</span>int x<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    size<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>int <span class="token number">i</span><span class="token operator">=</span>first<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token number">i</span><span class="token punctuation">;</span><span class="token number">i</span><span class="token operator">=</span>e<span class="token punctuation">[</span><span class="token number">i</span><span class="token punctuation">]</span><span class="token punctuation">.</span>next<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        int y<span class="token operator">=</span>e<span class="token punctuation">[</span><span class="token number">i</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>y<span class="token operator">==</span>fa<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span>
          <span class="token keyword">continue</span><span class="token punctuation">;</span>
          
        fa<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token operator">=</span>x<span class="token punctuation">;</span>
        deep<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token operator">=</span>deep<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token operator">/</span><span class="token operator">/</span>记录父亲和深度 
        
        <span class="token function">dfs_1</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        size<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token operator">+</span><span class="token operator">=</span>size<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span><span class="token punctuation">(</span>size<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token operator">></span>size<span class="token punctuation">[</span>son<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
          son<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token operator">=</span>y<span class="token punctuation">;</span><span class="token operator">/</span><span class="token operator">/</span>更新重儿子 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre></div></code-block><code-block id="p342n21g9X7eoiMH13WXm1" class="wolai-block"><div class="wolai-pre"><div data-lang="MATLAB" class="marker"></div><pre>void <span class="token function">dfs_2</span><span class="token punctuation">(</span>int x<span class="token punctuation">,</span>int tp<span class="token punctuation">)</span><span class="token operator">/</span><span class="token operator">/</span>打上top和时间戳
<span class="token punctuation">{</span>
    top<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token operator">=</span>tp<span class="token punctuation">;</span><span class="token operator">/</span><span class="token operator">/</span>更新每个点所在的重链的顶端 
    now<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">+</span><span class="token operator">+</span>tot<span class="token punctuation">;</span><span class="token operator">/</span><span class="token operator">/</span>得到每个点的dfs序（时间戳） 
    past<span class="token punctuation">[</span>tot<span class="token punctuation">]</span><span class="token operator">=</span>x<span class="token punctuation">;</span><span class="token operator">/</span><span class="token operator">/</span>记录每个新编号对应的原来的点 
    <span class="token keyword">if</span><span class="token punctuation">(</span>son<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token function">dfs_2</span><span class="token punctuation">(</span>son<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">,</span>tp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">/</span><span class="token operator">/</span>重儿子
    <span class="token keyword">for</span><span class="token punctuation">(</span>int <span class="token number">i</span><span class="token operator">=</span>first<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token number">i</span><span class="token punctuation">;</span><span class="token number">i</span><span class="token operator">=</span>e<span class="token punctuation">[</span><span class="token number">i</span><span class="token punctuation">]</span><span class="token punctuation">.</span>next<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        int y<span class="token operator">=</span>e<span class="token punctuation">[</span><span class="token number">i</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>y<span class="token punctuation">!</span><span class="token operator">=</span>son<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token operator">&amp;&amp;</span>y<span class="token punctuation">!</span><span class="token operator">=</span>fa<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span>
          <span class="token function">dfs_2</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">/</span><span class="token operator">/</span>轻儿子
    <span class="token punctuation">}</span>
    ctr<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token operator">=</span>tot<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre></div></code-block><div id="seurmpHfgi46fgLk3VGuck" class="wolai-bookmark wolai-block"><a href="https://blog.csdn.net/a_forever_dream/article/details/80651308">树链剖分详解_Hypoc_的博客-CSDN博客_树链剖分</a><div class="info-box"><div class="text-pane"><div data-title="树链剖分详解_Hypoc_的博客-CSDN博客_树链剖分"></div><div data-desc="树链剖分，正如其名，这个算法的主要思想就是 把“树”“剖分”成“链”那怎么实现以及它的作用是什么呢，以洛谷上的模板题为例子：已知一棵包含N个结点的树（连通且无环），每个节点上包含一个数值，需要支持以下操作：操作1： 格式： 1 x y z 表示将树从x到y结点最短路径上所有节点的值都加上z操作2： 格式： 2 x y 表示求树从x到y结点最短..."></div><div class="icon-host"><div class="icon icon-image" style="background-image: url(&quot;https://g.csdnimg.cn/static/logo/favicon32.ico&quot;)"></div><div data-hostname="blog.csdn.net"></div></div></div><div class="preview-pane"></div></div></div></article><footer></footer></body></html>