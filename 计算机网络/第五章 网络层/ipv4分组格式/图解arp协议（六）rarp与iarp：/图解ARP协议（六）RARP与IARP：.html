<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../../css/wolai.css"/><title>图解ARP协议（六）RARP与IARP：被遗忘的兄弟协议 - 知乎 - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="图解ARP协议（六）RARP与IARP：被遗忘的兄弟协议 - 知乎" class="main-title"></div></div></header><article><h2 id="oUX5YfNDXELWj1CY5m8671" class="wolai-block"><span class="inline-wrap"><b>一、概述</b></span></h2><div id="6bFLYqNnucEUsCvV5RAnMT" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-901388a916a81b98961884d89de5a594_b.jpg" style="width: 1120px"/></figure></div><div id="xk5Tvz2BPwLDJcR7md4uSi" class="wolai-block wolai-text"><div><span class="inline-wrap">在我第一次接触<span class="jill"></span>ARP<span class="jill"></span>协议的时候，发现这协议挺简单的，&quot;</span><span class="inline-wrap"><b>一去一回通过<span class="jill"></span>IP<span class="jill"></span>拿到<span class="jill"></span>MAC<span class="jill"></span>地址</b></span><span class="inline-wrap">&quot;，整个过程在<span class="jill"></span>1s<span class="jill"></span>内就搞定了。后面学到了</span><span class="inline-wrap"><b>代理<span class="jill"></span>ARP</b></span><span class="inline-wrap">，发现也不过是变了个法子，做了次**&quot;欺骗&quot;</span><span class="inline-wrap"><b>，本质还是一样。接下来又学到了</b></span><span class="inline-wrap">免费<span class="jill"></span>ARP**，顿时觉得网络协议设计者太牛了，一个协议居然能折腾出这么多玩法，连**&quot;地址检测&quot;</span><span class="inline-wrap"><b>都能实现。等学到了</b></span><span class="inline-wrap">ARP<span class="jill"></span>嗅探和欺骗**，又发现其实黑帽子更爱折腾，谁能想到这么简单的协议，居然能制造工具出来做</span><span class="inline-wrap"><b>内网探测</b></span><span class="inline-wrap">和</span><span class="inline-wrap"><b>欺骗攻击</b></span><span class="inline-wrap">，引发这么大的危害。</span></div></div><div id="fiG5H1qWfqG2K3TLCRoXfy" class="wolai-block wolai-text"><div><span class="inline-wrap">当我以为<span class="jill"></span>ARP<span class="jill"></span>这一知识点在我的技术旅途中应该就此翻篇了的时候，又冒出了</span><span class="inline-wrap"><b>RARP<span class="jill"></span>和<span class="jill"></span>IARP</b></span><span class="inline-wrap">这两，对比其他<span class="jill"></span>ARP<span class="jill"></span>协议的研究，当时学这两个协议是</span><span class="inline-wrap"><b>心不甘情不愿</b></span><span class="inline-wrap">的：</span></div></div><div id="hpjLFtMvcjEaaZYwTDTrZp" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>第一</b></span><span class="inline-wrap">，无论学习还是工作，极少碰到，真正**&quot;翻篇&quot;**了的协议；</span></div></div><div id="mzEtyVqY6HNbZQg74VwRG3" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>第二</b></span><span class="inline-wrap">，名字记不住，&quot;翻转&quot;&quot;反转&quot;&quot;逆向&quot;&quot;反向&quot;，不同技术文档的中文翻译有时候完全相反，没法记。毕竟汉语这么博大精深，就记住英文就好了，后面发现更加糟糕，因为</span><span class="inline-wrap"><b>reverse<span class="jill"></span>和<span class="jill"></span>inverse<span class="jill"></span>这两个单词仅仅<span class="jill"></span>2<span class="jill"></span>个字母之差</b></span><span class="inline-wrap">，老外太欺负人了，这根本没法记。</span></div></div><div id="rdD1iD3wfzg8oE6HPvCiHx" class="wolai-block wolai-text"><div><span class="inline-wrap">我在想，肯定也有很多朋友学到这个时候遇到了上面同样的问题和纠结，有些坚持研究通透有些中途离开。然后我又思考了一番：**ARP<span class="jill"></span>协议通过几个字段的细微调整，便能够适用于这么多不同场景，例如<span class="jill"></span>ARP、PARP、GARP、RARP、IARP，这是不是证明了它在<span class="jill"></span>TCP/IP<span class="jill"></span>协议栈里面独特的位置，有哪个协议能做到这一点，有这么多花样？**所以，我的建议是：既然到了这一步了，就继续搞清楚吧，否管它是否用的上。</span></div></div><div id="ec7Qh3bXmJhwtxNvscBr1H" class="wolai-block wolai-text"><div><span class="inline-wrap">那么，</span><span class="inline-wrap"><b>什么是<span class="jill"></span>RARP<span class="jill"></span>和<span class="jill"></span>IARP？中文叫法是什么？它们各自的应用场景在哪里？数据包又是怎样的</b></span><span class="inline-wrap">？</span></div></div><h2 id="cP9t63Re29mhAwuSUvT8pF" class="wolai-block"><span class="inline-wrap"><b>二、RARP<span class="jill"></span>原理与实践</b></span></h2><div id="uAYnjBUbnQfEa28XM77aTR" class="wolai-block wolai-text"><div><span class="inline-wrap">RARP（Reverse ARP）即反向<span class="jill"></span>ARP<span class="jill"></span>或者翻转<span class="jill"></span>ARP，顾名思义，它跟常规的<span class="jill"></span>ARP<span class="jill"></span>功能恰恰是相反的，</span><span class="inline-wrap"><b>ARP<span class="jill"></span>是实现<span class="jill"></span>IP<span class="jill"></span>到<span class="jill"></span>MAC<span class="jill"></span>地址的映射，而<span class="jill"></span>RARP<span class="jill"></span>是实现<span class="jill"></span>MAC<span class="jill"></span>到<span class="jill"></span>IP<span class="jill"></span>地址的映射</b></span><span class="inline-wrap">。</span></div></div><div id="32yoFZ1d2a56uyxohy3jsi" class="wolai-block wolai-text"><div><span class="inline-wrap">什么样的设备或者场景需要用到<span class="jill"></span>RARP<span class="jill"></span>呢？其实<span class="jill"></span>RARP<span class="jill"></span>原先在设计的时候，是适用于大部分终端设备的，不仅仅是无盘工作站，它的功能就是</span><span class="inline-wrap"><b>根据<span class="jill"></span>MAC<span class="jill"></span>获取<span class="jill"></span>IP<span class="jill"></span>地址，功能跟<span class="jill"></span>DHCP<span class="jill"></span>是一样的</b></span><span class="inline-wrap">。</span></div></div><div id="hfwMcMixXzknzwxCPHJYMx" class="wolai-block wolai-text"><div><span class="inline-wrap">例如，一个电脑刚接入网络，没有<span class="jill"></span>IP<span class="jill"></span>地址就无法上网，此时它便会通过本地<span class="jill"></span>MAC<span class="jill"></span>地址，对外发送<span class="jill"></span>RARP Request<span class="jill"></span>广播请求，看看局域网里面是否有<span class="jill"></span>RARP Server，若<span class="jill"></span>Server<span class="jill"></span>上面有关于此<span class="jill"></span>MAC<span class="jill"></span>地址的映射<span class="jill"></span>IP，则会向此电脑返回<span class="jill"></span>RARP Reply<span class="jill"></span>回应，电脑便获取了<span class="jill"></span>IP<span class="jill"></span>地址=&gt;</span></div></div><div id="mFKN4gkaqbCeYGi5M67R3s" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-e077ab99c0163a4ff13238dde1d59837_b.jpg" style="width: 576px"/></figure></div><div id="3j5oXN52z9BTkf4qsyseUc" class="wolai-block wolai-text"><div><span class="inline-wrap">RARP<span class="jill"></span>通过非常精简的交互实现了<span class="jill"></span>IP<span class="jill"></span>地址的获取，但同时也暴露了一些问题：</span></div></div><div id="gWmg3b4bVTs2fR3nFeVhHG" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>①RARP Server<span class="jill"></span>必须提前将<span class="jill"></span>MAC<span class="jill"></span>和<span class="jill"></span>IP<span class="jill"></span>的映射静态绑定在本地；若没有提前绑定，则电脑用自己<span class="jill"></span>MAC<span class="jill"></span>询问时，Server<span class="jill"></span>也不会回应；</b></span></div></div><div id="gYgba9XWScVtDMVfv1BS8K" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>②RARP Server<span class="jill"></span>只能给电脑分配<span class="jill"></span>IP<span class="jill"></span>地址，不包括其他信息，包括网关、DNS<span class="jill"></span>等信息；</b></span></div></div><div id="gxdz1svTfBkeBCeVS1M298" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>③RARP<span class="jill"></span>基于二层封装，只能运行在同一网段；每个网段分配地址，都需要一个<span class="jill"></span>RARP Server。</b></span><span class="inline-wrap"> </span></div></div><div id="v6PUkbxMeRySsjF1i3Tp3r" class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>RARP<span class="jill"></span>的基础上，后面又有了</span><span class="inline-wrap"><b>Bootp<span class="jill"></span>协议</b></span><span class="inline-wrap">，直译过来便是**&quot;启动协议&quot;**，功能同<span class="jill"></span>RARP，也是用于电脑接入网络时，用来获取<span class="jill"></span>IP<span class="jill"></span>地址的。但是毕竟做了增强，Bootp<span class="jill"></span>协议能让电脑启动时，</span><span class="inline-wrap"><b>不仅仅获取<span class="jill"></span>IP<span class="jill"></span>地址，而且能获取到网关地址</b></span><span class="inline-wrap">，从而让电脑实现跨网段通信。</span></div></div><div id="hibbYx65tfe1sw8CGsjcYT" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-f00934ef8ef7e7dda199e708af888ee8_b.jpg" style="width: 576px"/></figure></div><div id="4k5hKAeAjBsFiHDxDft9iX" class="wolai-block wolai-text"><div><span class="inline-wrap">Bootp<span class="jill"></span>协议虽然让电脑能够获取到更多的信息，但是仍然没有解决最大的问题：</span></div></div><div id="mAEaTc2dzDhVdQ6hR9sPQM" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>服务器仍然需要提前手工绑定<span class="jill"></span>MAC<span class="jill"></span>和<span class="jill"></span>IP<span class="jill"></span>地址，而对于现在的移动网络或者公共网络而言，这根本无法实现。</b></span><span class="inline-wrap"> </span></div></div><div id="8qZVAzNjaeCQXnt8cjFHjF" class="wolai-block wolai-text"><div><span class="inline-wrap">因为用户什么时候接入，接入的<span class="jill"></span>MAC<span class="jill"></span>是多少，管理员没法提前知道。这就有了后面的<span class="jill"></span>DHCP，DHCP<span class="jill"></span>通过动态分配的方式解决了这个诟病，并且通过<span class="jill"></span>DHCP<span class="jill"></span>中继技术实现了跨网段地址分配，实现了全网<span class="jill"></span>IP<span class="jill"></span>地址的统一管理。</span></div></div><div id="9FbvKZrEFqoxGMfrjVRWdr" class="wolai-block wolai-text"><div><span class="inline-wrap">小结：</span><span class="inline-wrap"><b>RARP<span class="jill"></span>是一种逝去的地址分配技术，是<span class="jill"></span>Bootp<span class="jill"></span>和<span class="jill"></span>DHCP<span class="jill"></span>的鼻祖，目前我们的电脑基本不会用到这个协议，只有部分无盘工作站等情况需要用到</b></span><span class="inline-wrap">。</span></div></div><div id="8NjRju9EFXC7oKCBDBFaqs" class="wolai-block wolai-text"><div><span class="inline-wrap">为了让大家更深入理解<span class="jill"></span>RARP，这里我们从数据包结构来解构它的功能。RARP<span class="jill"></span>的数据包比较难抓取，不像常规的<span class="jill"></span>ARP<span class="jill"></span>和<span class="jill"></span>DHCP<span class="jill"></span>协议，这里给大家提供一个思路：对于比较难找的协议数据包，除了搭建特殊的实验环境抓取之外，也可以借助一些**[数据包生成工具]</span><span class="inline-wrap"><b>来实现，例如<span class="jill"></span>nmap<span class="jill"></span>扫描器里面集成的</b></span><span class="inline-wrap">nping<span class="jill"></span>工具，可以生成非常多的协议包，包括<span class="jill"></span>arp、icmp、udp、tcp<span class="jill"></span>等等**。</span></div></div><div id="jZWKmfFuBxbNT1c6DZm9TZ" class="wolai-block wolai-text"><div><span class="inline-wrap">nmap<span class="jill"></span>的安装以及<span class="jill"></span>nping<span class="jill"></span>的使用，可以到</span><span class="inline-wrap"><a href="https://link.zhihu.com/?target=https%3A//nmap.org/nping"><span>https://nmap.org/nping</span></a></span><span class="inline-wrap">下查询。这里给大家演示如何用<span class="jill"></span>nping<span class="jill"></span>生成<span class="jill"></span>rarp<span class="jill"></span>数据包，下图是我们要**&quot;人为&quot;构造**出来的交互场景=&gt;</span></div></div><div id="4RvMQVdBDqUuow1JE3oaAr" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-432ed6086876e946bdd1dd004843794a_b.jpg" style="width: 576px"/></figure></div><div id="bqEBEiCC4zsfmC2ZVq1XXo" class="wolai-block wolai-text"><div><span class="inline-wrap">我的<span class="jill"></span>Macbook<span class="jill"></span>已经安装了<span class="jill"></span>nmap，自带了<span class="jill"></span>nping<span class="jill"></span>工具，跟<span class="jill"></span>ARP/RARP<span class="jill"></span>相关的帮助命令如下：</span></div></div><code-block id="e3agG9PKjcBA1UkfdEUUxW" class="wolai-block"><div class="wolai-pre"><div data-lang="Text" class="marker"></div><pre>jayking:~ jaykingchen$ nping
Nping 0.7.60 ( https://nmap.org/nping )
Usage: nping [Probe mode] [Options] {target specification}

TARGET SPECIFICATION:
 Targets may be specified as hostnames, IP addresses, networks, etc.
 Ex: scanme.nmap.org, microsoft.com/24, 192.168.0.1; 10.0.*.1-24

ARP/RARP PROBE MODE:
 --arp-type &lt;type>                : Type: ARP, ARP-reply, RARP, RARP-reply.
 --arp-sender-mac &lt;mac>           : Set sender MAC address.
 --arp-sender-ip  &lt;addr>          : Set sender IP address.
 --arp-target-mac &lt;mac>           : Set target MAC address.
 --arp-target-ip  &lt;addr>          : Set target IP address.</pre></div></code-block><div id="5dojckP2HPaYk91Vae2cUg" class="wolai-block wolai-text"><div><span class="inline-wrap">为了能够抓取到<span class="jill"></span>rarp<span class="jill"></span>的请求和回复包，首先打开<span class="jill"></span>wireshark<span class="jill"></span>抓取电脑网卡流量并设置<span class="jill"></span>arp<span class="jill"></span>过滤，然后采用两条命令：</span><span class="inline-wrap"><b>第一条命令模拟我的电脑发起的<span class="jill"></span>RARP<span class="jill"></span>请求包，第二条命令模拟局域网网关设备（极路由）返回的<span class="jill"></span>RARP<span class="jill"></span>回复包</b></span><span class="inline-wrap">。  </span></div></div><code-block id="9RLmuFNu9QWLgN5uB2VYqj" class="wolai-block"><div class="wolai-pre"><div data-lang="Text" class="marker"></div><pre>jayking:~ jaykingchen$ sudo nping --arp-type RARP  --arp-sender-mac ac:bc:32:8b:56:df --arp-sender-ip 0.0.0.0 --arp-target-mac ac:bc:32:8b:56:df --arp-target-ip 0.0.0.0 192.168.199.255
Starting Nping 0.7.60 ( https://nmap.org/nping ) at 2017-09-04 23:57 CST
SENT (0.0077s) RARP who is AC:BC:32:8B:56:DF? Tell AC:BC:32:8B:56:DF
SENT (1.0079s) RARP who is AC:BC:32:8B:56:DF? Tell AC:BC:32:8B:56:DF
SENT (2.0084s) RARP who is AC:BC:32:8B:56:DF? Tell AC:BC:32:8B:56:DF
SENT (3.0111s) RARP who is AC:BC:32:8B:56:DF? Tell AC:BC:32:8B:56:DF
SENT (4.0159s) RARP who is AC:BC:32:8B:56:DF? Tell AC:BC:32:8B:56:DF
Max rtt: N/A | Min rtt: N/A | Avg rtt: N/A
Raw packets sent: 5 (210B) | Rcvd: 0 (0B) | Lost: 5 (100.00%)
Nping done: 1 IP address pinged in 5.02 seconds</pre></div></code-block><code-block id="xbz9mc9o4iWEiTPLDFkxXx" class="wolai-block"><div class="wolai-pre"><div data-lang="Text" class="marker"></div><pre>jayking:~ jaykingchen$ sudo nping --arp-type RARP-reply  --arp-sender-mac d4:ee:07:54:c1:9e --arp-sender-ip 192.168.199.1 --arp-target-mac ac:bc:32:8b:56:df --arp-target-ip 192.168.199.153 192.168.199.153
Starting Nping 0.7.60 ( https://nmap.org/nping ) at 2017-09-05 00:03 CST
SENT (0.8094s) RARP reply: AC:BC:32:8B:56:DF is at 192.168.199.153
SENT (1.8107s) RARP reply: AC:BC:32:8B:56:DF is at 192.168.199.153
SENT (2.8114s) RARP reply: AC:BC:32:8B:56:DF is at 192.168.199.153
SENT (3.8138s) RARP reply: AC:BC:32:8B:56:DF is at 192.168.199.153
SENT (4.8159s) RARP reply: AC:BC:32:8B:56:DF is at 192.168.199.153
Max rtt: N/A | Min rtt: N/A | Avg rtt: N/A
Raw packets sent: 5 (210B) | Rcvd: 0 (0B) | Lost: 5 (100.00%)
Nping done: 1 IP address pinged in 5.82 seconds</pre></div></code-block><div id="gi7cz97iF2Nb9gpTDiDJB6" class="wolai-block wolai-text"><div><span class="inline-wrap">此时，从<span class="jill"></span>Wireshark<span class="jill"></span>抓取到的<span class="jill"></span>RARP<span class="jill"></span>请求和回复包如下=&gt;</span></div></div><div id="t9S9jt8iW3r91ybFLhfuuE" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-b518456ecf43425776056db944b07998_b.jpg" style="width: 576px"/></figure></div><div id="PotryS3Z856E6HGbZnnc7" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div id="9FVKkvuMp8cy5wMJDxJcRu" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-c888aa5f4b8cbee5020f70f633ed7c83_b.jpg" style="width: 576px"/></figure></div><div id="9TKtSrETKmmwdTBdDBzHqw" class="wolai-block wolai-text"><div><span class="inline-wrap">至此，关于<span class="jill"></span>RARP<span class="jill"></span>的原理和数据包分析便完成了。  </span></div></div><h2 id="5avVe8KeNjgXPNZNZAjNKG" class="wolai-block"><span class="inline-wrap"><b>三、IARP<span class="jill"></span>原理与实践</b></span></h2><div id="mydy3TTDrJ2muJ7ensNA8c" class="wolai-block wolai-text"><div><span class="inline-wrap">IARP（Inverse ARP）即逆向<span class="jill"></span>ARP，这个没法&quot;顾名思义&quot;，因为它既不是<span class="jill"></span>IP<span class="jill"></span>到<span class="jill"></span>MAC<span class="jill"></span>的映射，也不是<span class="jill"></span>MAC<span class="jill"></span>到<span class="jill"></span>IP<span class="jill"></span>的映射，而是</span><span class="inline-wrap"><b>DLCI<span class="jill"></span>到<span class="jill"></span>IP<span class="jill"></span>的映射</b></span><span class="inline-wrap">。相比前面所有其他<span class="jill"></span>ARP<span class="jill"></span>协议，IARP<span class="jill"></span>的应用场景不是在以太网（局域网）里面，而是**在帧中继网络（广域网）**里面。</span></div></div><div id="jBWQNPteAGyVWwWuy72skB" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-c7b3acc810bcfbda086a82da0939e490_b.jpg" style="width: 1121.6px"/></figure></div><div id="xkUoXRzDk8BsxfaKG4HxM1" class="wolai-block wolai-text"><div><span class="inline-wrap">要真正理解<span class="jill"></span>DLCI<span class="jill"></span>和<span class="jill"></span>IARP，需要有一些帧中继网络技术背景，这里简单说下：</span></div></div><div id="rQekX3Gve93dQ37GHvmuNV" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>DLCI（Data Link Connection Identifier）数据链接连接标识，是帧中继网络里面的二层地址，好比以太网里面的<span class="jill"></span>MAC<span class="jill"></span>地址，用于标记帧中继网络里面的虚拟专线</b></span><span class="inline-wrap">。示图如下：</span></div></div><div id="w9GXswTp68WtpFbHtnCa5x" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-08e437ebfe988061684773b8aa15ae92_b.jpg" style="width: 576px"/></figure></div><div id="vDQKczBYyDYP7FkpEk5W8p" class="wolai-block wolai-text"><div><span class="inline-wrap">图中<span class="jill"></span>R1<span class="jill"></span>和<span class="jill"></span>R2<span class="jill"></span>通过专线连接到帧中继交换机，对应的<span class="jill"></span>DLCI<span class="jill"></span>号分别是<span class="jill"></span>102<span class="jill"></span>和<span class="jill"></span>201。交换机通过转发表进行数据交换：</span><span class="inline-wrap"><b>根据接口收到数据包的<span class="jill"></span>DLCI，查看对应的接口，转发到匹配的线路</b></span><span class="inline-wrap">。</span></div></div><div id="wSYPSMdgnZW58kRNgeWLSy" class="wolai-block wolai-text"><div><span class="inline-wrap">所以说，帧中继网络里面，DLCI<span class="jill"></span>类似<span class="jill"></span>MAC，决定了数据包的去向。那么，DLCI<span class="jill"></span>和<span class="jill"></span>IP<span class="jill"></span>的映射关系又是如何的呢？我们来看下帧中继网络里面的数据封装，以<span class="jill"></span>R1 ping R2<span class="jill"></span>为例：</span></div></div><div id="esfNuGcBd1qffrLXfdbLAp" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-83e23299924d441f38defaf497cc9b3c_b.jpg" style="width: 576px"/></figure></div><div id="ucV271uDBWc4BMcNbXPpeG" class="wolai-block wolai-text"><div><span class="inline-wrap">从这里我们可以看到帧中继网络的数据封装和转发模式都不同于以太网：</span></div></div><div id="mXspS6hNnhvCkVxJS8UNKN" class="wolai-block wolai-text"><div><span class="inline-wrap">①二层封装的时候，不需要源目地址，只需要本地<span class="jill"></span>DLCI；例如<span class="jill"></span>10.1.1.1 ping 10.1.1.2，源目<span class="jill"></span>IP<span class="jill"></span>地址这个跟以太网的封装是一样的，但是链路层封装不需要目标<span class="jill"></span>DLCI 201。</span></div></div><div id="rBuHwfwEw2DWJuwXyMEV3F" class="wolai-block wolai-text"><div><span class="inline-wrap">②交换机会改变二层地址信息，例如这里的<span class="jill"></span>DLCI<span class="jill"></span>从左边的<span class="jill"></span>102，变成了右边的<span class="jill"></span>201。</span></div></div><div id="jWegm2hHSeBQUmwyKjJm6N" class="wolai-block wolai-text"><div><span class="inline-wrap">理解了这些差异，我们才能得到这里<span class="jill"></span>DLCI<span class="jill"></span>和<span class="jill"></span>IP<span class="jill"></span>的映射关系：</span><span class="inline-wrap"><b>即目标<span class="jill"></span>IP<span class="jill"></span>地址与本地<span class="jill"></span>DLCI<span class="jill"></span>的映射</b></span><span class="inline-wrap">。例如<span class="jill"></span>R1<span class="jill"></span>要访问<span class="jill"></span>10.1.1.2，此时需要映射到本地的<span class="jill"></span>102；而<span class="jill"></span>R2<span class="jill"></span>要访问<span class="jill"></span>10.1.1.1，则需要映射到本地的<span class="jill"></span>201。</span></div></div><div id="uBmxwbMLK6YtM3C9Ceq3c3" class="wolai-block wolai-text"><div><span class="inline-wrap">更完整的说明：</span><span class="inline-wrap"><b>逆向<span class="jill"></span>ARP<span class="jill"></span>解决帧中继网络里目标<span class="jill"></span>IP<span class="jill"></span>地址与本地<span class="jill"></span>DLCI<span class="jill"></span>的映射，并且让通信双方生成帧中继映射表（frame-relay map）。好比<span class="jill"></span>ARP<span class="jill"></span>解决了以太网里面目的<span class="jill"></span>IP<span class="jill"></span>与目标<span class="jill"></span>MAC<span class="jill"></span>的映射，并且让通信方生成<span class="jill"></span>ARP<span class="jill"></span>映射表</b></span><span class="inline-wrap">。</span></div></div><div id="4RzEn66up3UPvnXVPnqMyr" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-739bf93afd7444f6ac075b16708440bb_b.jpg" style="width: 576px"/></figure></div><div id="5UNMeZThEpjsHbJH8U8b5t" class="wolai-block wolai-text"><div><span class="inline-wrap">接下来，我们通过实验环境来验证，这里可以通过<span class="jill"></span>GNS3<span class="jill"></span>模拟器搭建以上环境，并且抓包验证=&gt;</span></div></div><div id="kbXJNCd9yUjc3K8wrdxcir" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-a85389259931b554288f8cf10238605f_b.jpg" style="width: 1120px"/></figure></div><div id="xA8mVJWQDKLNiun8upa6Mw" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>①为<span class="jill"></span>R1<span class="jill"></span>和<span class="jill"></span>R2<span class="jill"></span>打开接口，封装帧中继，并配置<span class="jill"></span>IP<span class="jill"></span>地址：</b></span><span class="inline-wrap"> </span></div></div><code-block id="7sjP3HJ1RJCKTK7f5cFdpf" class="wolai-block"><div class="wolai-pre"><div data-lang="Text" class="marker"></div><pre>R1(config)#int s0/0
R1(config-if)#no shutdown
R1(config-if)#encapsulation frame-relay
R1(config-if)#ip address 10.1.1.1 255.255.255.0

R2(config)#int s0/0
R2(config-if)#no shutdown
R2(config-if)#encapsulation frame-relay
R2(config-if)#ip address 10.1.1.2 255.255.255.0</pre></div></code-block><div id="ts5CVjUXmUiPu4fbC3ab5r" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>② 开启<span class="jill"></span>wireshark<span class="jill"></span>抓包，抓取<span class="jill"></span>IARP<span class="jill"></span>请求和回复包：</b></span><span class="inline-wrap"> </span></div></div><div id="tjXhjrrHb8Cv1qJRrymJJE" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-58752322584a92634433161e627852aa_b.jpg" style="width: 576px"/></figure></div><div id="7auPLRzLmbEUqPsCG5SsAJ" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div id="6oDm4PfmfJYtT8u12cqFbg" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-442de029cfdab7cd2cbc46dd37768236_b.jpg" style="width: 576px"/></figure></div><div id="m36s49Zaxs5ujiZMPx7evX" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>③查看<span class="jill"></span>R1<span class="jill"></span>和<span class="jill"></span>R2<span class="jill"></span>本地生成的<span class="jill"></span>IARP<span class="jill"></span>映射表：</b></span><span class="inline-wrap"> </span></div></div><code-block id="fkWS3atZ3PFow8Zeu1dG1p" class="wolai-block"><div class="wolai-pre"><div data-lang="Text" class="marker"></div><pre>R1#show frame-relay map
Serial0/0 (up): ip 10.1.1.2 dlci 102(0x66,0x1860), dynamic,
             broadcast,, status defined, active

R2#show frame-relay map
Serial0/0 (up): ip 10.1.1.1 dlci 201(0xC9,0x3090), dynamic,
             broadcast,, status defined, active</pre></div></code-block><div id="pXrG5WXgxkq3DfY5VvZSA6" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>④测试<span class="jill"></span>R1<span class="jill"></span>和<span class="jill"></span>R2<span class="jill"></span>之间的联通并抓取<span class="jill"></span>ICMP<span class="jill"></span>包：</b></span><span class="inline-wrap"> </span></div></div><code-block id="vCAxjjVJUwP3nzqJgmWCNm" class="wolai-block"><div class="wolai-pre"><div data-lang="Text" class="marker"></div><pre>R1#ping 10.1.1.2
Type escape sequence to abort.
Sending 5, 100-byte ICMP Echos to 10.1.1.2, timeout is 2 seconds:
!!!!!
Success rate is 100 percent (5/5), round-trip min/avg/max = 68/75/88 ms
</pre></div></code-block><div id="vD6FjzDdjk4f3nVSWvtpok" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-09d288d4413ef032f63ae3b2d137ea4f_b.jpg" style="width: 576px"/></figure></div><div id="qVNWtjbB2mHb3QXxj8U4y1" class="wolai-block wolai-text"><div><span class="inline-wrap">至此，IARP<span class="jill"></span>的原理与实践并完成了。那么，既然<span class="jill"></span>IARP<span class="jill"></span>能够实现帧中继的通信，为什么在文章开头，我们提到说<span class="jill"></span>IARP<span class="jill"></span>跟<span class="jill"></span>RARP<span class="jill"></span>一样，在工作中已经不常见了呢？</span></div></div><div id="pWKrnF1gwLrMDTy7tgmvR3" class="wolai-block wolai-text"><div><span class="inline-wrap">①帧中继作为一种广域网远程连接技术，正在慢慢</span><span class="inline-wrap"><b>被其他技术代替</b></span><span class="inline-wrap">；</span></div></div><div id="mSQFhhEYi2Tyx5Sm2BkpeA" class="wolai-block wolai-text"><div><span class="inline-wrap">②IARP<span class="jill"></span>不像<span class="jill"></span>ARP<span class="jill"></span>协议可以实时交互，它是</span><span class="inline-wrap"><b>周期性运行</b></span><span class="inline-wrap">的，通信双方若丢失<span class="jill"></span>IARP<span class="jill"></span>映射表，则需要等待到固定的时间交互才能重新生成并通信。另外不同厂商不同型号对<span class="jill"></span>IARP<span class="jill"></span>的</span><span class="inline-wrap"><b>兼容性也可能不同</b></span><span class="inline-wrap">。基于这些原因，</span><span class="inline-wrap"><b>一般建议直接关闭<span class="jill"></span>IARP<span class="jill"></span>协议，采用静态绑定的方式生成映射表</b></span><span class="inline-wrap">，这里不再深入。（有兴趣的小伙伴可以观看我之前的技术视频教程，有深入讲解了如何关闭<span class="jill"></span>IARP<span class="jill"></span>和静态绑定的做法。）</span></div></div><h2 id="pAgJdMws1e7EmNpKUQq694" class="wolai-block"><span class="inline-wrap"><b>四、RARP<span class="jill"></span>与<span class="jill"></span>IARP<span class="jill"></span>协议总结</b></span></h2><div id="sLDxZoXaBr7oSSRLM5MCvz" class="wolai-block wolai-text"><div><span class="inline-wrap">①RARP<span class="jill"></span>用于实现<span class="jill"></span>MAC<span class="jill"></span>到<span class="jill"></span>IP<span class="jill"></span>的映射，本质就是为了获取<span class="jill"></span>IP<span class="jill"></span>地址，是<span class="jill"></span>Bootp<span class="jill"></span>和<span class="jill"></span>DHCP<span class="jill"></span>协议的鼻祖；</span></div></div><div id="cS1DHevh34tckLe4VP5SRv" class="wolai-block wolai-text"><div><span class="inline-wrap">②IARP<span class="jill"></span>用于实现帧中继网络中<span class="jill"></span>DLCI<span class="jill"></span>到<span class="jill"></span>IP<span class="jill"></span>地址的映射，生成帧中继映射表（类似<span class="jill"></span>ARP<span class="jill"></span>表），实现数据封装与通信；</span></div></div><div id="ihZhdc7rfuLQ5fcRYx3JAn" class="wolai-block wolai-text"><div><span class="inline-wrap">③相比<span class="jill"></span>ARP、免费<span class="jill"></span>ARP、代理<span class="jill"></span>ARP、ARP<span class="jill"></span>攻防等技术，RARP<span class="jill"></span>和<span class="jill"></span>IARP<span class="jill"></span>随着技术的更新迭代正在退出历史舞台，成为**&quot;被遗忘的兄弟协议&quot;** 。（对于初学者来说，也算是个好事，因为终于不用&quot;翻转&quot;&quot;反向&quot;&quot;逆向&quot;各种分不清了）</span></div></div><div id="fFWju7khv6NTikTCRXr6js" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>ARP<span class="jill"></span>协议大总结及下一阶段预告</b></span></div></div><div id="uQR7raxNHr9edbv4aAgEvg" class="wolai-block wolai-text"><div><span class="inline-wrap">到这里，我们通过六篇文章终于搞定了<span class="jill"></span>ARP<span class="jill"></span>协议的方方面面，包括它们的应用场景、设计思想、数据包结构、实验验证等等。</span></div></div><div id="ffX888sqNXy5Wff1SvMFWP" class="wolai-block wolai-text"><div><span class="inline-wrap">另外，为什么这次图解系列的开头是从<span class="jill"></span>ARP<span class="jill"></span>协议开始写，而不是从<span class="jill"></span>Ethernet、IP、TCP、HTTP<span class="jill"></span>或其他呢？</span></div></div><div id="8FRWeaWqUdc23X7ue92WqX" class="wolai-block wolai-text"><div><span class="inline-wrap">主要是因为**&quot;ARP<span class="jill"></span>太简单了&quot;**，简单到大家在学网络和安全的时候，都容易去忽略协议背后的很多细节，例如很多人认为\[ARP<span class="jill"></span>的请求就一定是广播的，回复就一定是单播的\]，但&quot;常识&quot;背后也有另外一些特殊的情况。所以，通过这一个足够简单的协议，为大家解构背后相对复杂的机制，为后续深入研究开个好头。</span></div></div><div id="inHxPzPLJ7reUNR6Atbp8V" class="wolai-block wolai-text"><div><span class="inline-wrap">另外一个原因就是**&quot;ARP<span class="jill"></span>很有趣&quot;**，例如协议设计者通过不同的操作代码(opcode)，做了非常多的变种（arp<span class="jill"></span>是<span class="jill"></span>1<span class="jill"></span>和<span class="jill"></span>2，rarp<span class="jill"></span>是<span class="jill"></span>3<span class="jill"></span>和<span class="jill"></span>4，iarp<span class="jill"></span>是<span class="jill"></span>8<span class="jill"></span>和<span class="jill"></span>9），做一个模型便可以多处应用；而且通过精巧的构造，就可以在内网造成极大的杀伤力。</span></div></div><div id="mjCzuKEtR8XNsEQBg4akg4" class="wolai-block wolai-text"><div><span class="inline-wrap">anyway，图解<span class="jill"></span>ARP<span class="jill"></span>协议只是整个系列的开篇，下一阶段，我们将进入<span class="jill"></span>IP<span class="jill"></span>协议，探讨<span class="jill"></span>IP<span class="jill"></span>协议原理、数据包结构、优缺点、地址结构、IP<span class="jill"></span>攻击与防御（分片攻击、欺骗攻击）……</span></div></div><div id="5qMGWJinYzPUxqJ5AMeEpE" class="wolai-block wolai-text"><div><span class="inline-wrap">\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-</span></div></div><div id="iCfUp9AJZbmWPwkjQsVBZu" class="wolai-block wolai-text"><div><span class="inline-wrap">知乎专栏：</span><span class="inline-wrap"><a href="https://zhuanlan.zhihu.com/jaykingchen"><span>跟杰哥学网络与安全</span></a></span></div></div><div id="6V4dFkAri7yf35tHR6gXjT" class="wolai-block wolai-text"><div><span class="inline-wrap">新浪微博：</span><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.weibo.com/jaykingchen"><span>@<span class="jill"></span>拼客学院陈鑫杰</span></a></span></div></div><div id="6H6S8LgndHHt7YjGBw9fqr" class="wolai-block wolai-text"><div><span class="inline-wrap">微信公众号：拼客院长陈鑫杰（搜索&quot;</span><span class="inline-wrap"><b>pingsec</b></span><span class="inline-wrap">&quot;即可关注，大牛都在看）</span></div></div><div id="pE9JYTkLRKqQGkzHWEQh7H" class="wolai-block wolai-text"><div><span class="inline-wrap">拼客学院：</span><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.pinginglab.net"><span>http://www.pinginglab.net</span></a></span><span class="inline-wrap">（专注网络<span class="jill"></span>|<span class="jill"></span>安全<span class="jill"></span>|<span class="jill"></span>运维的<span class="jill"></span>IT<span class="jill"></span>学院）</span></div></div></article><footer></footer></body></html>