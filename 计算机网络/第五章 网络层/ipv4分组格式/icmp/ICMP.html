<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../../css/wolai.css"/><title>ICMP - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="ICMP" class="main-title"></div></div></header><article><h2 id="vps8Z8ZHYW1kJ7GT9GGC2t" class="wolai-block"><span class="inline-wrap">介绍</span></h2><div id="dHwjsTV8HtWQvnksP5Dxem" class="wolai-block wolai-text"><div><span class="inline-wrap">IP<span class="jill"></span>不能提供可靠的服务，为了更有效地转发 IP 数据报和提高交付成功的机会，在网络层使用了网际控制报文协议 ICMP (Internet Control MessageProtocol)来报告错误，并提供因特网中发生的最新情况给路由器。</span></div></div><div id="3HLULUEY8G77QYJTi1KrZT" class="wolai-block wolai-text"><div><span class="inline-wrap">ICMP<span class="jill"></span>是网络层比较重要的协议，主机或路由器报告差错情况和提供有关异常情况的报告。路由器主要利用该协议对数据报的传输过程进行监控。它也可以用来检测因特网，ICMP<span class="jill"></span>是在<span class="jill"></span>RFC792<span class="jill"></span>中定义的。</span></div></div><div id="iUYZqqbXMhtzNegkJHiSE8" class="wolai-block wolai-text"><div><span class="inline-wrap">ICMP<span class="jill"></span>通过将信息封装在<span class="jill"></span>IP<span class="jill"></span>分组中，并设置报头的协议字段为<span class="jill"></span>1<span class="jill"></span>来发送信息。但<span class="jill"></span>ICMP<span class="jill"></span>是<span class="jill"></span>IP<span class="jill"></span>层协议的一部分，不是高层协议。</span></div></div><h2 id="mSphNbZAdD58g4xATNG2yM" class="wolai-block"><span class="inline-wrap">参考文章</span></h2><div id="2CZcTePXHNE6TC5YRX4ZCw" class="wolai-sub-page wolai-block"><div class="page-icon"></div><a href="../ipv4%E5%8D%8F%E8%AE%AE/icmp/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3icmp%E5%8D%8F%E8%AE%AE%20-%20%E7%9F%A5%E4%B9%8E/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3icmp%E5%8D%8F%E8%AE%AE%20-%20%E7%9F%A5%E4%B9%8E.html"><span>深入理解ICMP协议 - 知乎</span></a></div><h1 id="ujAejXxeMtwXLPWQKFgx1j" class="wolai-block"><span class="inline-wrap">差错报文</span></h1><h2 id="7WvbQprVHNpvQZbLA23YYW" class="wolai-block"><span class="inline-wrap">差错报告</span></h2><div id="dStGYgtRth2hZ2AJBvKH7t" class="wolai-block wolai-text"><div><span class="inline-wrap">ICMP<span class="jill"></span>差错报文提供</span><span class="inline-wrap"><b>差错报告</b></span><span class="inline-wrap">，中间的路由器或目的端在处理<span class="jill"></span>IP<span class="jill"></span>报文时，如果发现错误，就向源端主机发送<span class="jill"></span>ICMP<span class="jill"></span>差错控制报文。主要包括：</span></div></div><div id="qrcjV9v7xpfGDCSok2hTsz" class="wolai-block wolai-text"><div><span class="inline-wrap">•目的无法到达(DestinationUnreachable),用于报告多种原因造成的<span class="jill"></span>IP<span class="jill"></span>报文无法到达的错误。</span></div></div><div id="7DrjQnym4xm1ckTSesEbfp" class="wolai-block wolai-text"><div><span class="inline-wrap">•超时(Time Exceeded)。 当<span class="jill"></span>IP<span class="jill"></span>分组中的生存期<span class="jill"></span>TTL<span class="jill"></span>字段减到<span class="jill"></span>0<span class="jill"></span>或重装定时器（在收到分组的第一个段时设置）到期时发送超时分组。类型值为<span class="jill"></span>11，码值为<span class="jill"></span>0<span class="jill"></span>或<span class="jill"></span>l。0<span class="jill"></span>表示<span class="jill"></span>TTL<span class="jill"></span>超时，而<span class="jill"></span>1<span class="jill"></span>表示重组超时 </span></div></div><div id="iMRSWB4ovzxiCSJmyhNtMV" class="wolai-block wolai-text"><div><span class="inline-wrap">•参数问题(ParameterProblem)报文用于报告<span class="jill"></span>IP<span class="jill"></span>报文头的错误。</span></div></div><h3 id="s4taWwtHE6KrCLVYoFeoJv" class="wolai-block"><span class="inline-wrap">详解</span></h3><div id="safMz8YMpVpGSsJeWj4g3A" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image.png" style="width: 100%"/></figure></div><h4 id="71KvwKz5JyKk9AQpjsb5SE" class="wolai-block"><span class="inline-wrap">3 目的端不可达</span></h4><aside id="qNKh2woX5GWXxfYG3n1bUf" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap">也就是前面的差错报文类型<span class="jill"></span>3<span class="jill"></span>中由分出了<span class="jill"></span>13<span class="jill"></span>种可能</span></aside><div id="dHfJJKScyuwxZcLWHEypC3" class="wolai-row"><div id="8fj6xK1Yq3tf6dxNan3bBt" class="wolai-col" style="flex-grow: 0.5"><div id="53sjjFpBrozFcHpcE1g8nH" class="wolai-block"><figure class="wolai-left" style="width: 100%"><img src="media/image_1.png" style="width: 601.6px"/></figure></div></div><div id="uf7kb3xP9RfDUmvkPUZMR5" class="wolai-col" style="flex-grow: 0.5"><div id="mwn6cQM1aSNMZL348CnSoN" class="wolai-block"><figure class="wolai-left" style="width: 100%"><img src="media/image_2.png" style="width: 549.6px"/></figure></div></div></div><div id="rxsgf7QkezdA9oDUpEBRnU" class="wolai-block wolai-text"><div></div></div><aside id="qDyg7p8DbFHz9FJxjqeP7L" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap">（1）当子网或路由器不能定位到一个分组的目标时，路由器可以使用“目标不可达”ICMP<span class="jill"></span>消息来报告情况；</span><div id="w6KpEaBLxRZvK6nAWVF9Qb" class="wolai-block wolai-text"><div><span class="inline-wrap">（2）当一个设置了<span class="jill"></span>DF<span class="jill"></span>位的长分组由于途中经过一个“小帧长”网络而不能被递交时，路由器可以使用“目标不可达”ICMP<span class="jill"></span>消息来报告情况；</span></div></div></aside><h4 id="w2D6RYaUcGpwX8sDpNjnwk" class="wolai-block"><span class="inline-wrap">12 参数问题</span></h4><div id="fZ1isoVSWfuixoW3t2pRRL" class="wolai-block wolai-text"><div><span class="inline-wrap">ICMP<span class="jill"></span>参数问题报文是由<span class="jill"></span>IP<span class="jill"></span>数据报首部字段值不明确或空缺而引起的差错报告。一旦路由器或信宿机发现错误的数据报首部和错误的数据报选项参数时，便丢弃该数据报，并向信源发送参数问题差错报文。</span></div></div><div id="atmXKvUnEug5tDJjk1a3QT" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_3.png" style="width: 100%"/></figure></div><div id="33dRcXUsV57uxy6fwCTcXt" class="wolai-block wolai-text"><div><span class="inline-wrap">码值=0</span><span class="inline-wrap">   </span><span class="inline-wrap">表示<span class="jill"></span>IP<span class="jill"></span>报文中现有的某参数错，指针指向报文中引起错误的字节。</span><span class="inline-wrap">首部某个字段出现差错或二义性。         </span></div></div><div id="rFeG4n2LgBwTfp8Aq1vMQP" class="wolai-block wolai-text"><div><span class="inline-wrap">码值=1   表示报文中缺少某一要求的选项(如安全选项等)，此时指针字段应该为<span class="jill"></span>0。缺少选项所要求的部分。</span></div></div><h3 id="evSVyVssJZ2BitvxHeTaiR" class="wolai-block"><span class="inline-wrap">数据字段</span></h3><div id="jHw6PL1cj2mP7QUr58EmYi" class="wolai-block wolai-text"><div><span class="inline-wrap">ICMP<span class="jill"></span>差错报告报文的数据字段的内容：</span><span class="inline-wrap"><b>把收到的需要进行差错报告的<span class="jill"></span>ICMP<span class="jill"></span>数据报的首部和引发错误的<span class="jill"></span>IP<span class="jill"></span>数据字段的前<span class="jill"></span>8<span class="jill"></span>个字节提取出来，作为<span class="jill"></span>ICMP<span class="jill"></span>报文的数据字段，再加上相应的<span class="jill"></span>ICMP<span class="jill"></span>差错报告的前<span class="jill"></span>8<span class="jill"></span>个字节，就构成了差错报告报文。</b></span></div></div><div id="vtCAhLgA4op6ZBFWc1bsLd" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>提取了数据部分的前八个字节则可以得到传输层的端口号和发送序号（TCP），对于通知高层协议是有用的
最后整个<span class="jill"></span>ICMP<span class="jill"></span>报文作为<span class="jill"></span>IP<span class="jill"></span>数据报的数据字段发送给源端</b></span></div></div><div id="41Qf46uWg9YhwKyGKk1Y4z" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_4.png" style="width: 100%"/></figure></div><h2 id="39Nt6kdLuh5WyuEyybpwZ6" class="wolai-block"><span class="inline-wrap">拥塞控制和路径控制</span></h2><div id="7KFTMPf4SnuXkeqqvqDYJw" class="wolai-block wolai-text"><div><span class="inline-wrap">ICMP<span class="jill"></span>差错报文还可用于网络层的</span><span class="inline-wrap"><b>拥塞控制和路径控制</b></span><span class="inline-wrap">。包括源抑制和重定向报文：</span></div></div><h3 id="mXXyoCb3zMnadmj1AqgkWg" class="wolai-block"><span class="inline-wrap">源抑制(SourceQuench)</span><span class="inline-wrap">：</span></h3><div id="qgajuAfdAtERd3KHMe7GGM" class="wolai-block wolai-text"><div><span class="inline-wrap">路由器收到太多的分组，发送要求降低分组的传输速度。 </span></div></div><div id="LBQkWc6Z5oiwbSm88XcPb" class="wolai-block wolai-text"><div><span class="inline-wrap">用于拥塞控制的源抑制报文的格式和差错报告的格式一样，源抑制报文类型为<span class="jill"></span>4，码值只能为<span class="jill"></span>0。</span></div></div><div id="cZyp2U12Tj55dRoru4yaS9" class="wolai-block wolai-text"><div><span class="inline-wrap">•IP<span class="jill"></span>协议采用的是无连接数据报方式进行传输</span></div></div><div id="4WugTfcpHwWJM4hK6qK7tV" class="wolai-block wolai-text"><div><span class="inline-wrap">•发送方事先并不了解中间的路由器和信宿的处理能力和缓冲区大小</span></div></div><div id="2ufc1kirA1qHncb4nW9XYD" class="wolai-block wolai-text"><div><span class="inline-wrap">•在数据报传输过程中没有采用任何流量控制机制</span></div></div><div id="3WRGnRxJ2PVcyurkqPAihs" class="wolai-block wolai-text"><div><span class="inline-wrap">• 因此，当大量的数据报进入路由器或信宿时，会造成缓冲区溢出，即出现拥塞(Congestion)。</span></div></div><div id="nPWJjFRRyRegACyo7CCS4b" class="wolai-block wolai-text"><div><span class="inline-wrap">•ICMP<span class="jill"></span>利用源端抑制的方法来进行拥塞控制，减缓信源发出数据报的速率。</span></div><div id="6EJ9UdgTh2k7kEMu6FraCJ" class="wolai-block"><figure class="wolai-left" style="width: 100%"><img src="media/image_5.png" style="width: 100%"/></figure></div></div><div id="3p5NJDUi6GhneAaSCFrpJw" class="wolai-block wolai-text"><div><span class="inline-wrap">用于拥塞控制的源抑制报文的格式和差错报告的格式一样，源抑制报文类型为<span class="jill"></span>4，码值只能为<span class="jill"></span>0。</span></div></div><aside id="b7iawVCRyCV9oNCXmUdUzQ" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap">“源端抑制”ICMP<span class="jill"></span>消息被用来通知发送端减慢发送速度，但现在很少使用了，而主要由传输层来承担拥塞控制任务；</span></aside><h3 id="jLte5k5AcpNgSxkXegpLyL" class="wolai-block"><span class="inline-wrap">重定向(Redirect)报文：</span></h3><div id="6XTyEFEemZSMMDATXf7z3n" class="wolai-block wolai-text"><div><span class="inline-wrap">重定向：也叫改变路由。</span></div></div><div id="9htsEjJFT2UFS46rt53dfC" class="wolai-block wolai-text"><div><span class="inline-wrap">因特网上的路由器和主机中都存有一个路由表，路由表决定了去往目的地的下一跳路由器的地址。</span></div></div><div id="8uHnHH6zaa2nTL7VmkHzES" class="wolai-block wolai-text"><div><span class="inline-wrap">•路由器上的路由表能够及时地反映网络结构的变化，这一特点由路由器之间定期交换路由信息加以保证。</span></div></div><div id="hKuNjFz4rPETLsDpsJnHch" class="wolai-block wolai-text"><div><span class="inline-wrap">•主机因为不能保证全天开机，所以主机中的路由表不能及时反映网络结构的变化情况。另外，由于因特网上的主机数量远大于路由器数量，主机如果参与路由信息交换，势必带来大量的通信开销。因此主机中的路由表不通过路由协议进行更新。</span></div></div><div id="sKxQGwMPgHE3hE3BohJ2Dv" class="wolai-block wolai-text"><div><span class="inline-wrap">•主机所在的网络可能和多个路由器相连，主机在发送信息时也要根据其路由表来选择下一跳路由器，为了解决主机路由表的刷新问题，ICMP<span class="jill"></span>提供了重定向机制。</span></div></div><div id="pTzSU5GYfhrRU54WCx83LM" class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>IP<span class="jill"></span>网络中，路由选择主要由网络中的路由器来承担。主机只是知道很少的寻径信息，它把非本网的信息往设置的缺省路由器上发送。在一个网络上有两台或多台路由器时，经过缺省路由器虽然可以保证把数据包发送出去，但不能保证对于所有的目的地总是最优的。ICMP<span class="jill"></span>中定义的重定向报文，是主机和路由器之间交换路由信息的途径。</span></div></div><div id="wwKS99A14dxZkT9KYzXEdW" class="wolai-block wolai-text"><div><span class="inline-wrap">主机路由表所给出的下一跳路由器可能并非去往信宿的最佳下一跳路由器，当主机的下一跳路由器收到数据报后，</span><span class="inline-wrap"><b>该路由器根据它的路由表判断本路由器是否是去往信宿的最佳选择，如果不是，该路由器仍然会向信宿网络转发该数据报，但在转发的同时会产生一个<span class="jill"></span>ICMP<span class="jill"></span>重定向报文，通知信源修改它的路由表，重定向报文中将给出信源最佳下一跳路由器的<span class="jill"></span>IP<span class="jill"></span>地址。</b></span><span class="inline-wrap"></span></div></div><aside id="njJhzjgFMP3g2KFVT85vW9" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap">当路由器发现一个分组看起来被错误转发了，它将发送“重定向”ICMP<span class="jill"></span>消息来告诉发送主机；</span></aside><div id="5GsL4m9nYdghtNdZ9Y9fmV" class="wolai-block wolai-text"><div><span class="inline-wrap">主机<span class="jill"></span>A<span class="jill"></span>向主机<span class="jill"></span>B<span class="jill"></span>发送数据报时，根据其路由表得知，去往主机<span class="jill"></span>B<span class="jill"></span>所在网络<span class="jill"></span>192.168.8.0<span class="jill"></span>的路由器接口是<span class="jill"></span>196.168.6.1，因此数据报被发送到路由器<span class="jill"></span>R1。R1<span class="jill"></span>收到数据报后判断出<span class="jill"></span>R2<span class="jill"></span>是主机<span class="jill"></span>A<span class="jill"></span>发送数据报到主机<span class="jill"></span>B<span class="jill"></span>的最佳下一跳，R1<span class="jill"></span>向<span class="jill"></span>R2<span class="jill"></span>转发数据报后，产生重定向报文，发送给<span class="jill"></span>A，主机<span class="jill"></span>A<span class="jill"></span>根据收到的重定向报文首部中的目标路由器<span class="jill"></span>IP<span class="jill"></span>地址（192.168.6.2）更新自己的路由表。</span></div></div><div id="28aYFkV4yDJGoV3KVbJpjD" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_6.png" style="width: 100%"/></figure></div><div id="bs8ttHZkNX1rHanBBHJpVn" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_7.png" style="width: 681.6px"/></figure></div><div id="hgEMENEEoQoeabAWzXKRy5" class="wolai-block wolai-text"><div><span class="inline-wrap">从<span class="jill"></span>ICMP<span class="jill"></span>报文数据部分的<span class="jill"></span>IP<span class="jill"></span>报文头部，可以得到目的地的地址。在<span class="jill"></span>ICMP<span class="jill"></span>包中路由器<span class="jill"></span>IP<span class="jill"></span>地址即为到该目的地的最优路径的第一个路由器。 </span></div></div><h2 id="sNsztyp7refsNjxYsUnhsK" class="wolai-block"><span class="inline-wrap">不应发送<span class="jill"></span>ICMP<span class="jill"></span>差错报告报文的几种情况</span></h2><div id="7UFaV5UAjajZQ6sWybkmdF" class="wolai-block wolai-text"><div><span class="inline-wrap">对 ICMP 差错报告报文不再发送 ICMP 差错报告报文。</span></div></div><div id="aBnbsKcukvV8yFcRfNhLXL" class="wolai-block wolai-text"><div><span class="inline-wrap">对第一个分片的数据报片的所有后续数据报片都不发送 ICMP 差错报告报文。</span></div></div><div id="9S5tqbrywzzFzaZwoziiUz" class="wolai-block wolai-text"><div><span class="inline-wrap">对具有多播地址的数据报都不发送 ICMP 差错报告报文。</span></div></div><div id="bDF6f3asf6tSeoaqdKyuFp" class="wolai-block wolai-text"><div><span class="inline-wrap">对具有特殊地址（如<span class="jill"></span>127.0.0.0 或 0.0.0.0）的数据报不发送 ICMP 差错报告报文。</span></div></div><h1 id="hxY3Zn2TQuofkvUpQQQaC6" class="wolai-block"><span class="inline-wrap">查询报文</span></h1><div id="daaxNCgJ6xdyU9pJxrJbiX" class="wolai-block wolai-text"><div><span class="inline-wrap">ICMP<span class="jill"></span>查询报文类型值如下图所示。其中的信息请求与应答报文和地址掩码请求与应答已经不再使用。 </span></div></div><div id="nCan5ybxZfoz7my45TDjoN" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_8.png" style="width: 100%"/></figure></div><h3 id="obBjsKqNugi14Pgk3idxVQ" class="wolai-block"><span class="inline-wrap">回送请求和应答报文(EchoRequest and Rely) 8<span class="jill"></span>或者<span class="jill"></span>0</span></h3><div id="q1y2YXStyA6D6VwwyuAyCn" class="wolai-block wolai-text"><div><span class="inline-wrap">ICMP<span class="jill"></span>使用这个分组来确定某具体目的地能否到达。</span></div></div><div id="KwXyy9MadWnZtoendNQkZ" class="wolai-block wolai-text"><div><span class="inline-wrap">•使得因特网上的任何主机或路由器可以向其他主机或路由器发送请求并获得应答。</span></div></div><div id="9ncg1w1Tmd2hme179cYdHA" class="wolai-block wolai-text"><div><span class="inline-wrap">•通过<span class="jill"></span>ICMP<span class="jill"></span>查询报文，网络管理人员、用户或应用程序可以对网络进行检测，了解：</span></div><div id="q9hL89T33fgUcfwiDcfkiw" class="wolai-block wolai-text"><div><span class="inline-wrap">•设备的可达性（如<span class="jill"></span>Ping<span class="jill"></span>命令）</span></div></div><div id="6VyDVAcS1qYYn3sGeKnrQV" class="wolai-block wolai-text"><div><span class="inline-wrap">•地址掩码的设置</span></div></div><div id="98SGdEm3D1XHvBhQt2xMBF" class="wolai-block wolai-text"><div><span class="inline-wrap">•时钟的同步等情况</span></div></div><div id="pSNfCyobM4Hw4pjNkUEiKN" class="wolai-block wolai-text"><div><span class="inline-wrap">•ICMP<span class="jill"></span>查询报文目的是利用这些有用的信息，对网络进行故障诊断和控制。</span></div></div></div><div id="eM3A2TSXxK2QJ2bKspYx5h" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_9.png" style="width: 100%"/></figure></div><h3 id="7XRwgk161n7BsBt3XdCekE" class="wolai-block"><span class="inline-wrap">时间戳请求和回答报文(Timestamp Request and Reply) 13<span class="jill"></span>或者<span class="jill"></span>14</span></h3><div id="riSCKfezdQiHqagqm9XJzq" class="wolai-block wolai-text"><div><span class="inline-wrap">时戳分组使主机能估计它到另一个主机间一次来回所需的时间。</span></div></div><div id="qSqP2KcTEYPMgVFPU8AA1n" class="wolai-block wolai-text"><div><span class="inline-wrap">•因特网中的各个主机和路由器都是独立运行的，因此在时钟上存在着较大的差异，而一些分布式应用系统要求各个设备的时钟是同步的，ICMP<span class="jill"></span>时间戳请求和回答报文就是用于设备间进行时钟同步的报文对。</span></div></div><div id="iES2eAynVcAWBvKMQ1X3TU" class="wolai-block wolai-text"><div><span class="inline-wrap">•时钟同步的基本思路是请求方主机通过获取另一主机的时间戳信息，将该信息和请求方主机的时间戳信息进行比较后，估算两者的时钟差异。</span></div></div><div id="ma1tgV1gQ8G6zrNM4Atj9" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_10.png" style="width: 100%"/></figure></div><div id="5ezQCsKn7Je7L52nGsJzKY" class="wolai-block wolai-text"><div><span class="inline-wrap">具体而言，上面的字段中：</span></div></div><div id="aBxjC5jAwXXQFKpXtC4ZBS" class="wolai-block wolai-text"><div><span class="inline-wrap">•原始时间戳字段用于指示请求方发出请求的时间</span></div></div><div id="tQsmDQJ5iAnoRdBKLB3rWP" class="wolai-block wolai-text"><div><span class="inline-wrap">•接收时间戳字段用于指示应答方主机收到请求的时间</span></div></div><div id="4ipV74ADYgaoQTkenZeU83" class="wolai-block wolai-text"><div><span class="inline-wrap">•发送时间戳字段用于指示应答方主机发送应答的时间</span></div></div><div id="7QawxHaTWqmpAVsrxSQZyX" class="wolai-block wolai-text"><div><span class="inline-wrap">•三个时间戳字段均为<span class="jill"></span>4<span class="jill"></span>字节，以毫秒为单位从世界时间午夜<span class="jill"></span>0<span class="jill"></span>点起计时。时间戳的计数值不能超过<span class="jill"></span>24<span class="jill"></span>小时。</span></div></div><aside id="oNUTYuYiJdFXaWEbp3kUoP" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap">ECHO<span class="jill"></span>和<span class="jill"></span>ECHO REPLY（可以用来判断一个指定目标是否可达，以及是否还存活），以及<span class="jill"></span>TIMESTAMP RESQUEST<span class="jill"></span>和<span class="jill"></span>TIMESTAMP REPLY（用途类似前述），可被用于测试网络性能。</span></aside><h4 id="iT5ZoD1KhHnCkhbqYhwzfA" class="wolai-block"><span class="inline-wrap">应用：同步收发端的时钟</span></h4><div id="gQVDhSt39kdfNoU7YCeoN2" class="wolai-block wolai-text"><div><span class="inline-wrap">1）计算出时间戳请求和应答的往返时间</span></div></div><div id="kTTEAw9SGh8CoWmUgxgQHx" class="wolai-block wolai-text"><div><span class="inline-wrap">2）计算出单程时延</span></div></div><div id="aw8cvqxQ8kHZxXCZ5ciawJ" class="wolai-block wolai-text"><div><span class="inline-wrap">3）由两设备的时间戳和单程传输延迟计算出两台设备之间的时间差，从而实现时钟的同步。</span></div></div><hr id="pxYhWXy4xnEPQsxVU5bCit" class="wolai-block"/><div id="3wDurp3snM94NaCxrnfGNU" class="wolai-block wolai-text"><div><span class="inline-wrap">往返延迟时间可以用下式计算：</span></div></div><div id="4vpd1sSPKgvN4w1bupKzph" class="wolai-block wolai-text"><div><span class="inline-wrap">往返时间＝t<span class="jill"></span>当前－t<span class="jill"></span>初始－(t<span class="jill"></span>发送－t<span class="jill"></span>接收)</span></div><div id="28Pz5Y9JLVAm6aUVQeai3D" class="wolai-block wolai-text"><div><span class="inline-wrap">＝t<span class="jill"></span>接收－t<span class="jill"></span>初始＋t<span class="jill"></span>当前－t<span class="jill"></span>发送</span></div></div></div><div id="bwnC881RXBghyhvZJejMXY" class="wolai-block wolai-text"><div><span class="inline-wrap">假设传输请求的时延和传输应答的时延相同，那么单程时延就等于往返时间的一半。</span></div></div><hr id="hyESheYRxTAGP8bmVg95ur" class="wolai-block"/><div id="qqQcmeKhupwVBX2YeRVWtR" class="wolai-block wolai-text"><div><span class="inline-wrap">一个时钟同步的例子：主机<span class="jill"></span>A<span class="jill"></span>发出时间戳请求时的初始时间戳为<span class="jill"></span>1000<span class="jill"></span>毫秒，主机<span class="jill"></span>B<span class="jill"></span>收到请求时的接收时间戳是<span class="jill"></span>1055<span class="jill"></span>毫秒，主机<span class="jill"></span>B<span class="jill"></span>给出应答时的发送时间戳是<span class="jill"></span>1057<span class="jill"></span>毫秒，主机<span class="jill"></span>A<span class="jill"></span>收到应答时的时间为<span class="jill"></span>1030<span class="jill"></span>毫秒。主机<span class="jill"></span>A<span class="jill"></span>可以根据这些时间戳计算出两台主机间的时间差。</span></div></div><div id="kbDTb2aECSkTeG8VxAgieo" class="wolai-block wolai-text"><div><span class="inline-wrap">往返时间＝t<span class="jill"></span>当前－t<span class="jill"></span>初始－(t<span class="jill"></span>发送－t<span class="jill"></span>接收)</span></div><div id="fvtoVUTsDKk7ExFa1iGqG4" class="wolai-block wolai-text"><div><span class="inline-wrap">＝1030－1000－(1057－1055)＝28(毫秒)</span></div></div></div><div id="uuM1mDpVe7zVyFtCYU8iuS" class="wolai-block wolai-text"><div><span class="inline-wrap">单程时延＝28÷2＝14(毫秒)</span></div></div><div id="6iFmuQPXprYi7aaKbj6t7M" class="wolai-block wolai-text"><div><span class="inline-wrap">时间差＝t<span class="jill"></span>接收－(t<span class="jill"></span>初始＋单程时延)＝1055－(1000＋14)＝41(毫秒)</span></div></div><div id="9ZiHcgRMG5Hv4Cjbq6z3eW" class="wolai-block wolai-text"><div><span class="inline-wrap">•由上面的计算可知：主机<span class="jill"></span>B<span class="jill"></span>的时钟比主机<span class="jill"></span>A<span class="jill"></span>的时钟快了<span class="jill"></span>41<span class="jill"></span>毫秒。</span></div></div><h3 id="2btBxw3ebh2UVwgxER1eBV" class="wolai-block"><span class="inline-wrap">地址掩码请求和应答(AddressMask Request and Reply)17<span class="jill"></span>或者<span class="jill"></span>18</span></h3><div id="m1aGXtSezpQV3eCMcQQ49z" class="wolai-block wolai-text"><div><span class="inline-wrap">主机可以向路由器发送一个地址掩码请求分组来获取它所在网络的网络掩码，路由器会作出应答。</span></div></div><h1 id="ccv3cxf9FUAPmYLLaXNf22" class="wolai-block"><span class="inline-wrap">相关命令</span></h1><h2 id="FXJjkAKgFduH3LeAHrwhH" class="wolai-block"><span class="inline-wrap">PING</span></h2><div id="qM2FShd2q6HAcPMD2HQzQ6" class="wolai-block wolai-text"><div><span class="inline-wrap">•PING (Packet InterNetGroper)</span></div></div><div id="iMyKzTZicY8qWSK7HBkE42" class="wolai-block wolai-text"><div><span class="inline-wrap">•PING 用来测试两个主机之间的连通性。</span></div></div><div id="6M35ukeQEQBWKBD5uYEap5" class="wolai-block wolai-text"><div><span class="inline-wrap">•PING 使用了 ICMP<span class="jill"></span>回送请求与回送回答报文。</span></div></div><div id="cKkMGuy5Cgi9KcoXLTnb5J" class="wolai-block wolai-text"><div><span class="inline-wrap">•PING 是应用层直接使用网络层 ICMP<span class="jill"></span>的例子，它没有通过运输层的<span class="jill"></span>TCP<span class="jill"></span>或<span class="jill"></span>UDP。</span></div></div><div id="r2mDEcdmzsVz1MsWNMNeUe" class="wolai-block wolai-text"><div><span class="inline-wrap">•源主机向目标主机发送<span class="jill"></span>ICMP<span class="jill"></span>回送请求数据包，然后等待目标主机的回答。目标主机收到<span class="jill"></span>ICMP<span class="jill"></span>回送请求数据包后，交换源、目的主机地址，然后将收到的<span class="jill"></span>ICMP<span class="jill"></span>回送请求数据包中的数据部分，原封不动地封装在自己的<span class="jill"></span>ICMP<span class="jill"></span>应答数据包中，发回给源主机。</span></div></div><div id="uBK2Kogvo7GvoEpppJTt1p" class="wolai-block wolai-text"><div><span class="inline-wrap">•发送方校验正确，认为目标主机回送服务正常，即物理连接畅通。</span></div></div><div id="vQgvpfWAcqJ2Uc9D994dvq" class="wolai-block wolai-text"><div><span class="inline-wrap">实际上<span class="jill"></span>Ping<span class="jill"></span>是向目标发送一个要求回显（Type = 8）的<span class="jill"></span>ICMP<span class="jill"></span>数据报，当主机得到请求后，再返回一个应答（Type = 0）数据报。</span></div></div><h3 id="oiWZki4Aq2BJSXpGTDZ9pE" class="wolai-block"><span class="inline-wrap">ping<span class="jill"></span>命令的语法</span></h3><code-block id="asst6taTfsogJqc47bL5fk" class="wolai-block"><div class="wolai-pre"><div data-lang="PowerShell" class="marker"></div><pre>ping <span class="token operator">/</span>? 显示帮助

ping target_name 测试和目标主机间的链接

ping <span class="token operator">-</span>a 解析地址到主机名

ping <span class="token operator">-</span>n count 发送的响应请求数，默认为4</pre></div></code-block><div id="pV45HaieAwACe6tMWBpFze" class="wolai-block wolai-text"><div><span class="inline-wrap">在例子中&quot;bytes=32&quot;表示<span class="jill"></span>ICMP<span class="jill"></span>报文中有<span class="jill"></span>32<span class="jill"></span>个字节的测试数据，&quot;time= ms&quot;是往返时间。 Sent 发送多个包、Received 收到多个回应包、Lost 丢弃了多少个<span class="jill"></span>Minmum 最小值 、MAXimun 最大值、Average 平均值。所在图上来看，来回只用了<span class="jill"></span>7MS 时间，lost =0 即是丢包数为<span class="jill"></span>0，网络状态相当良好。 (更详细可以使用-n<span class="jill"></span>参数 “ping –n 100 IP<span class="jill"></span>地址” ping 100<span class="jill"></span>次。查看 Sent Received Lost Minmum MAXimun Average 这些值的变化。)</span></div></div><h2 id="v6vQig6PsRjwHvxubx7zaT" class="wolai-block"><span class="inline-wrap">Tracert</span></h2><div id="iGhFK6obnnbeCoabQ99MDy" class="wolai-block wolai-text"><div><span class="inline-wrap">•Tracert（Windows<span class="jill"></span>下）和<span class="jill"></span>Traceroute（Unix<span class="jill"></span>下）是一个路由跟踪实用程序，用来跟踪一个分组从源点到终点的路径。确定<span class="jill"></span>IP 数据报访问目标所经过的路由。Tracert 命令用<span class="jill"></span>IP 生存时间字段<span class="jill"></span>TTL<span class="jill"></span>和 ICMP 错误消息来确定从一个主机到网络上其他主机的路由。</span></div></div><div id="hi93kxSMMSgmbfB5hf8YKD" class="wolai-block wolai-text"><div><span class="inline-wrap">•通过向目标发送不同<span class="jill"></span>TTL 值的<span class="jill"></span>ICMP<span class="jill"></span>回应数据包，Tracert 程序确定到目标所经过的路由。</span></div></div><div id="mqPzF5VJySELUoRDz4paPY" class="wolai-block wolai-text"><div><span class="inline-wrap">•数据包上的<span class="jill"></span>TTL 减为 0 时，路由器将<span class="jill"></span>ICMP<span class="jill"></span>超时报文发回源系统。</span></div></div><div id="hzYfnnuxmeAy3DojH12Acp" class="wolai-block wolai-text"><div><span class="inline-wrap">•收到<span class="jill"></span>ICMP<span class="jill"></span>报文的，计算往返时间。</span></div></div><div id="u1AbEsobksWoTowFKSxAtR" class="wolai-block wolai-text"><div><span class="inline-wrap">•Tracert<span class="jill"></span>的使用很简单，只需要在<span class="jill"></span>tracert<span class="jill"></span>后面跟一个<span class="jill"></span>IP<span class="jill"></span>地址或<span class="jill"></span>URL，Tracert<span class="jill"></span>会进行相应的域名转换。Tracert<span class="jill"></span>一般用来检测故障的位置，用<span class="jill"></span>tracert IP<span class="jill"></span>告诉你问题所在的地方。</span></div></div><h3 id="b1g7q6ypRk3ZkG5HTRYhsG" class="wolai-block"><span class="inline-wrap">Tracert<span class="jill"></span>命令</span></h3><code-block id="s9iZvw3iQ1K8JHJcgqFTsA" class="wolai-block"><div class="wolai-pre"><div data-lang="PowerShell" class="marker"></div><pre>tracert target_name 

tracert <span class="token operator">-</span>d target_name 不解析地址到主机名

tracert <span class="token operator">-</span>h maximum hops 指定最大跳数，默认为30
</pre></div></code-block><h3 id="tgSKBHAGjoWrkoZrTE1E5H" class="wolai-block"><span class="inline-wrap">工作原理</span></h3><div id="sGBNKF195v5nkA32tCyK3J" class="wolai-block wolai-text"><div><span class="inline-wrap">•Tracert<span class="jill"></span>是利用<span class="jill"></span>ICMP<span class="jill"></span>和<span class="jill"></span>TTL<span class="jill"></span>进行工作的。首先<span class="jill"></span>tracert<span class="jill"></span>会发出<span class="jill"></span>TTL<span class="jill"></span>值为<span class="jill"></span>1<span class="jill"></span>的<span class="jill"></span>ICMP<span class="jill"></span>数据报（包含<span class="jill"></span>40<span class="jill"></span>个字节，包括源地址、目标地址和发出的时间标签，一般会连续发<span class="jill"></span>3<span class="jill"></span>个包）。</span></div></div><div id="3PENTJmVWZcPa4JtZAnVYD" class="wolai-block wolai-text"><div><span class="inline-wrap">•当到达路径上的第一个路由器时,路由器会将<span class="jill"></span>TTL<span class="jill"></span>值减<span class="jill"></span>1，此时<span class="jill"></span>TTL<span class="jill"></span>值变成<span class="jill"></span>0，该路由器会将此数据报丢弃，并返回一个超时回应数据报（包括数据报的源地址、内容和路由器的<span class="jill"></span>IP<span class="jill"></span>地址）</span></div></div><div id="tsF1YDKdEZcdyivFm6LpUf" class="wolai-block wolai-text"><div><span class="inline-wrap">•当<span class="jill"></span>tracert<span class="jill"></span>收到该数据报时，它便获得了这个路径上的第一个路由器的地址。接着，tracert<span class="jill"></span>再发送另一个<span class="jill"></span>TTL<span class="jill"></span>为<span class="jill"></span>2<span class="jill"></span>的数据报，第一个路由器会将此数据报转发给第二个路由器，而第二个路由器收到数据报时，TTL<span class="jill"></span>为<span class="jill"></span>0。第二个路由器便会返回一个超时回应数据报，从而<span class="jill"></span>tracert<span class="jill"></span>便获得了第二个路由器的地址</span></div></div><div id="rkXTb5FHDztxxbuZezRRiv" class="wolai-block wolai-text"><div><span class="inline-wrap">•Tracert<span class="jill"></span>每次发出数据报时便会将<span class="jill"></span>TTL<span class="jill"></span>加<span class="jill"></span>1（一般每次都是发<span class="jill"></span>3<span class="jill"></span>个数据报），来发现下一个路由器。这个动作一直重复，直到到达目的地或者确定目标主机不可到达为止。</span></div></div><div id="491bLYcu1cRpnxvXv4BUqu" class="wolai-block wolai-text"><div><span class="inline-wrap">•当数据报到达目的地后，目标主机并不返回超时回应数据报。</span></div></div><h3 id="6Le9rfcUgu17Kuk9FgK2q1" class="wolai-block"><span class="inline-wrap">执行过程</span></h3><div id="qVF5R3R8ambeP9vfjj8q9E" class="wolai-block wolai-text"><div><span class="inline-wrap">•源端发送一系列的<span class="jill"></span>UDP<span class="jill"></span>数据报给目的端</span></div></div><div id="xiFG8rKGutXrYHKY4MKJZE" class="wolai-block wolai-text"><div><span class="inline-wrap">•第一个字段<span class="jill"></span>TTL =1</span></div></div><div id="utRbH7a9tdoHyRkCYDyY97" class="wolai-block wolai-text"><div><span class="inline-wrap">•第二个字段<span class="jill"></span>TTL=2,</span></div></div><div id="m1mjZu1kN5ZynaZi6QkuCe" class="wolai-block wolai-text"><div><span class="inline-wrap">•以此类推<span class="jill"></span>etc.</span></div></div><div id="jYa4ZXKwkgaEKwQXBQ1kFc" class="wolai-block wolai-text"><div><span class="inline-wrap">•当第<span class="jill"></span>n<span class="jill"></span>个数据报到达第<span class="jill"></span>n<span class="jill"></span>个路由器</span></div></div><div id="6zkMaD57iKqmh9ag3fYUfr" class="wolai-block wolai-text"><div><span class="inline-wrap">•路由器抛弃掉数据报。</span></div></div><div id="bRKHe1eLXgy3DgQsYgRxHJ" class="wolai-block wolai-text"><div><span class="inline-wrap">•发送给源端<span class="jill"></span>ICMP<span class="jill"></span>消息（类型为<span class="jill"></span>11，code<span class="jill"></span>为<span class="jill"></span>0）</span></div></div><div id="v5nb2djEL1DYpR1aL8NDrs" class="wolai-block wolai-text"><div><span class="inline-wrap">•而消息中包含了每台路由器的名字和<span class="jill"></span>IP<span class="jill"></span>地址</span></div></div><div id="gGLDnFa5QLPSNT337AQKiw" class="wolai-block wolai-text"><div><span class="inline-wrap">•当<span class="jill"></span>ICMP<span class="jill"></span>消息到达后，源端可以计算<span class="jill"></span>RTT（Roundtrip time,往返时间）</span></div></div><div id="2y8bYUW6FddjKdbdCYg9Ff" class="wolai-block wolai-text"><div><span class="inline-wrap">•Traceroute 做三次这样的命令</span></div></div><div id="v1Z5nGBJ9iCz8jmdxCQsz6" class="wolai-block wolai-text"><div><span class="inline-wrap">•停止规则</span></div></div><div id="qNiJNVKu7FYoeQUubYrZBz" class="wolai-block wolai-text"><div><span class="inline-wrap">•UDP 数据段 最终到达目的主机</span></div></div><div id="onrqzUeVpQRQwLinZ2NuoV" class="wolai-block wolai-text"><div><span class="inline-wrap">•目的主机返回<span class="jill"></span>ICMP “host unreachable” 数据包。</span></div><div id="treyB8RBusyZ7GEhwAVuaA" class="wolai-block wolai-text"><div><span class="inline-wrap">因为发送的<span class="jill"></span>UDP<span class="jill"></span>数据段故意使用的是一个非法<span class="jill"></span>UDP<span class="jill"></span>端口，结果<span class="jill"></span>ICMP<span class="jill"></span>就返回“端口不可达”的差错报文，达到测试的目的。（在<span class="jill"></span>Traceroute<span class="jill"></span>命令中应用层并没有真正的数据要传送，就是为了测试）</span></div></div></div><div id="2UUA5LHSWoPTzBHgudfV22" class="wolai-block wolai-text"><div><span class="inline-wrap">•最终当源端收到该<span class="jill"></span>ICMP<span class="jill"></span>消息，停止</span></div></div></article><footer></footer></body></html>