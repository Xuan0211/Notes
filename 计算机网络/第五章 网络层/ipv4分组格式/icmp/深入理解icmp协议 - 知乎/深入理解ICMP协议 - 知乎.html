<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/wolai.css"/><title>深入理解ICMP协议 - 知乎 - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="深入理解ICMP协议 - 知乎" class="main-title"></div></div></header><article><div id="9BqZcdoedN3x5oSb5wjNy5" class="wolai-block wolai-text"><div><span class="inline-wrap">在日常工作中，我们经常需要判断网络是否连通，相信大家使用最多的命令就是 ping，traceroute 啦。大家都知道 ping/traceroute 命令是基于 ICMP 协议来实现的，那么什么是 ICMP 协议呢？ping/traceroute 命令又是如何基于 ICMP 实现的呢？  </span></div></div><div id="ibcLAuPKSz7UtnoxTrdunT" class="wolai-block wolai-text"><div><span class="inline-wrap">今天这篇文章，我们就来一起搞清楚其中的原理。下面首先我们先来了解一下<span class="jill"></span>ICMP 协议。</span></div></div><h2 id="fkUt4bfebpu3mkfdo9S8L7" class="wolai-block"><span class="inline-wrap"><b>ICMP<span class="jill"></span>协议</b></span></h2><div id="iEbLC3BjbfadacPW39a9je" class="wolai-block wolai-text"><div><span class="inline-wrap">ICMP<span class="jill"></span>是 Internet Control Message Protocol 的缩写，即互联网控制消息协议。它是互联网协议族的核心协议之一。它用于 TCP/IP 网络中发送控制消息，提供可能发生在通信环境中的各种问题反馈，通过这些信息，使网络管理者可以对所发生的问题作出诊断，然后采取适当的措施解决问题。</span></div></div><div id="4nkTyKKgGhUJabwkiDuMca" class="wolai-block wolai-text"><div><span class="inline-wrap">虽然 ICMP 是网络层协议，但是它不像 IP 协议和 ARP 协议一样直接传递给数据链路层，而是先封装成 IP 数据包然后再传递给数据链路层。</span><span class="inline-wrap"><b>所以在 IP 数据包中如果协议类型字段的值是 1 的话，就表示 IP 数据是 ICMP 报文。IP 数据包就是靠这个协议类型字段来区分不同的数据包的。</b></span><span class="inline-wrap">如下图 WireShark 抓包所示：</span></div></div><div id="pt9Q87uyBQt4qN8Z565aYb" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-7614b8422b03023ecfa1bd9150f504bb_b.jpg" style="width: 724px"/></figure></div><div id="dEHAKA6FTDBFho2ZNNB6Re" class="wolai-block wolai-text"><div><span class="inline-wrap">在 IP 通信中如果某个包因为未知原因没有到达目的地址，那么这个具体的原因就是由 ICMP 负责告知。而 ICMP 协议的类型定义中就清楚的描述了各种报文的含义。</span></div></div><h2 id="wqkjD7grW3kCRL73AHmjda" class="wolai-block"><span class="inline-wrap"><b>ICMP<span class="jill"></span>协议类型</b></span></h2><div id="qLPMBGUCtYpHzfDsiigV3K" class="wolai-block wolai-text"><div><span class="inline-wrap">ICMP<span class="jill"></span>协议的类型分为两大类，</span><span class="inline-wrap"><b>查询报文</b></span><span class="inline-wrap">和</span><span class="inline-wrap"><b>差错报文</b></span><span class="inline-wrap">。如下表：</span></div></div><div id="peKmD3sxRCBNCQD5tPATxF" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-4f259c166221946c2ef40960d360053c_b.jpg" style="width: 576px"/></figure></div><div id="oBk6kyhUmCkL7TpQEGE7ZM" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-621f5a7f9898466bb1ec4d097b3c141f_b.jpg" style="width: 576px"/></figure></div><div id="tPCqBAdvCYVi3Rdzsjc64Y" class="wolai-block wolai-text"><div><span class="inline-wrap"><i>是不是看起来有点多啊？计算机网络真的是博大精深啊。而平时我们经常使用的少之又少。</i></span></div></div><aside id="2SDfZgWM3uanoedcy1bFou" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap">PPT<span class="jill"></span>表格</span><div id="4uELKDVhiNM5hKj8XycTK3" class="wolai-block"><figure class="wolai-left" style="width: 100%"><img src="media/image.png" style="width: 100%"/></figure></div></aside><h2 id="cTVuHXDKkjgPW4UuEYU8fY" class="wolai-block"><span class="inline-wrap"><b>ICMP<span class="jill"></span>报文格式</b></span></h2><div id="b3pp2XNpx5jQbMsM6GqfS5" class="wolai-block wolai-text"><div><span class="inline-wrap">从 ICMP 的报文格式来说，ICMP 是 IP 的上层协议。但是 ICMP 是分担了 IP 的一部分功能。所以，他也被认为是与 IP 同层的协议。下面一起来看一下 ICMP 数据包格式和报文内容吧。具体参考下图：</span></div></div><div id="e7xvAeegwMzbgFwkvop1oh" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-ef5b42aff92acc5a8873d946d48177e4_b.jpg" style="width: 556.8px"/></figure></div><div id="fZvTZBwP6jPNhQk4Pr4UJh" class="wolai-block wolai-text"><div><span class="inline-wrap">可以看到，我们一层层剥开 ICMP 的外壳，查看其本质。方便我们更好的理解 ICMP 协议。  </span></div></div><h2 id="r3aaYMrt9F6Kh1svWtQSX9" class="wolai-block"><span class="inline-wrap"><b>ICMP<span class="jill"></span>协议实现--Ping<span class="jill"></span>命令</b></span></h2><div id="d5ZrSBEUhY3GKmbwn51pcP" class="wolai-block wolai-text"><div><span class="inline-wrap">通过上面的叙述，我们初步了解了 ICMP 协议的内容，那么下面我们来看一下<span class="jill"></span>ICMP 的具体实现与应用吧，首先我们来了解</span><span class="inline-wrap"><b>查询报文</b></span><span class="inline-wrap">的应用--ping，下面我们通过 ping 同一个子网的主机，来看一下整个过程是怎么样的。</span></div></div><div id="hssDob18gjKgJ421wRBJrB" class="wolai-block wolai-text"><div><span class="inline-wrap">那么比较完整的流程是：  </span></div></div><div id="5v6miYzwKeMXgYCzhDLDF" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>1. 向目的服务器发送回显请求</b></span><span class="inline-wrap">首先，向目的服务器上执行<span class="jill"></span>ping<span class="jill"></span>命令，主机会构建一个 ICMP 回显请求消息数据包（类型是<span class="jill"></span>8，代码是<span class="jill"></span>0），在这个回显请求数据包中，除了类型和代码字段，还被追加了标识符和序号字段。标识符和序号字段分别是 16 位的字段。ping 命令在发送回显请求数据包时，会将进程号填写在标识符里。对于序号，每送出一个数据包数值就增加<span class="jill"></span>1。而且，回显请求的选项数据部分用来装任意数据。这个任意数据用来调整 ping 的交互数据包的大小。如下图在 192.168.1.10<span class="jill"></span>上执行 ping 192.168.1.1<span class="jill"></span>的命令：</span></div></div><div id="4e2RAjjNf7NheqhWfCmtaE" class="wolai-block wolai-text"><div><span class="inline-wrap">ping 命令执行的时候，他的进程号是 43991：</span></div></div><div id="5yDLChYVwettJYAhyCC5xK" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-d8a328032435c1713659ae37411afdcc_b.jpg" style="width: 864px"/></figure></div><div id="w9N9eiig2GK4UrYFuTuefU" class="wolai-block wolai-text"><div><span class="inline-wrap">通过 WireShark 抓包可以看出，上图中的 192.168.1.10 主机会构建一个 ICMP 回显请求消息数据包。</span></div></div><div id="BKSiKYdtEk1oS5RdWz28H" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-d2161822052e99cd7e545a14dc965386_b.jpg" style="width: 100%"/></figure></div><div id="biJH2i1NwZjn28pjZFF5rx" class="wolai-block wolai-text"><div><span class="inline-wrap">上图中我们可以看到 ICMP 的 Type（协议类型）是 8，Code（代码）是 0，Identifier(ping<span class="jill"></span>进程号) 是 43991，同时还有 Sequence Number 发送序号<span class="jill"></span>11，以及发送时间 。</span></div></div><div id="3jMVJ32ZrQwh5xHMaPRmS7" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>2. 目的服务器发送回显应答</b></span></div></div><div id="rRKgihuYKXb2DGKXjWnVs3" class="wolai-block wolai-text"><div><span class="inline-wrap">当<span class="jill"></span>192.168.1.10<span class="jill"></span>送到 回显请求数据包后，192.168.1.1<span class="jill"></span>就会向发送方<span class="jill"></span>192.168.1.10<span class="jill"></span>发送回显应答（类型是<span class="jill"></span>0，代码是<span class="jill"></span>0），这个 ICMP 回显应答数据包在 IP 层来看，与被送来的回显请求数据包基本上一样。不同的只有源、目标 IP 地址字段被交换了，Type<span class="jill"></span>类型字段里填入了表示回显应答的<span class="jill"></span>0。通过 WireShark 抓包可以看出，如下图：</span></div></div><div id="cPFECcYpzVPDA3nkHvYQWB" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-6ac347e9fecb1feba27f11929f463fd7_b.jpg" style="width: 100%"/></figure></div><div id="5uTfpLxg7MNvxNncvN2QKG" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>3. 源服务器显示相关数据</b></span></div></div><div id="9EvNTecxP9YFqwtY16DMhv" class="wolai-block wolai-text"><div><span class="inline-wrap">如果源服务器可以接收到回显应答数据包，那我们就认为<span class="jill"></span>192.168.1.1<span class="jill"></span>是正常工作着的。进一步，记住发送回显请求数据包的时间，与接收到回显应答数据包的时间差，就能计算出数据包一去一回所需要的时间。这个时候<span class="jill"></span>ping<span class="jill"></span>命令就会将目的服务器的 IP 地址，数据大小，往返花费的时间打印到屏幕上。如下图：</span></div></div><div id="8WdnP56wiF7y1gZgjK4Xwm" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-b4d74f52d89436bc6e7fbcf9165e9ef8_b.jpg" style="width: 100%"/></figure></div><h2 id="rTEfghdkkcs5x8LdvJ4Rxt" class="wolai-block"><span class="inline-wrap"><b>ICMP<span class="jill"></span>协议实现--traceroute<span class="jill"></span>命令</b></span></h2><div id="dMZaL8B3RLpMXbwrMUPrmg" class="wolai-block wolai-text"><div><span class="inline-wrap">traceroute<span class="jill"></span>命令是一款充分利用 ICMP </span><span class="inline-wrap"><b>差错报文</b></span><span class="inline-wrap">类型的应用，其主要用作追踪路由信息，下面我们来逐个查看一下其工作原理。</span></div></div><div id="gtWfmBRYFwFyAs77dCkKk7" class="wolai-block wolai-text"><div><span class="inline-wrap">我们通过执行 traceroute 192.168.1.1，来分析一下他的原理，它的原理就是利用 IP 包的 TTL 从 1 开始按照顺序递增的同时发送 UDP 包，强制接收 ICMP 超时消息的方法。</span></div></div><div id="weG4E5oCfDFSyZ5DYGPh3Y" class="wolai-block wolai-text"><div><span class="inline-wrap">首先 traceroute 会将 IP 包的 TTL 设置 为 1，然后发送 UDP 包，他会填入一个端口号作为 UDP 目标端口号（默认是：33434-33534）。如下图：</span></div></div><div id="nupDVUqtrjd34dbooGmGCa" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-b94339a7a5f98df9a54e2c57a8e0335e_b.jpg" style="width: 576px"/></figure></div><div id="v6VUBkLNKmxMg8jptqBY1n" class="wolai-block wolai-text"><div><span class="inline-wrap">当目的主机收到 UDP 包后，会返回 ICMP 差错报文消息（类型 3，代码 3）。参照上面的表，该错报文类型是端口不可达，说明发送方发出的 UDP 包到达了目的主机。如下图：</span></div></div><div id="fwP484GhjdR7NXsoqxvMAW" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-fe105808fa75759d2bcbf902b95583b2_b.jpg" style="width: 576px"/></figure></div><div id="jwY4sGNFjcdKpJbAkCpywc" class="wolai-block wolai-text"><div><span class="inline-wrap">这样的过程，traceroute 就可以拿到了所有的路由器 IP，这样子就可以看到从源主机到目的主机过程中的所有路由信息。  </span></div></div><div id="cNZgc1ANXaxrbryUk9jCJa" class="wolai-block wolai-text"><div><span class="inline-wrap">当然实际情况有的路由器禁用 ICMP ，那么他就根本不会返回这个 ICMP 差错报文，所以是看不到中间经过的路由<span class="jill"></span>IP<span class="jill"></span>的。</span></div></div><blockquote id="kfawgUyrENAEaQrD9gNxre" class="wolai-block"><span class="inline-wrap">Tips：traceroute 在类 Unix/Linux 系统中默认使用的是 UDP 协议，也可以通过参数修改为使用 ICMP 协议；Windows 操作系统中只使用 ICMP 协议。</span></blockquote><div id="9LU6tyKL2p4YvB5AVVEYTG" class="wolai-block wolai-text"><div><span class="inline-wrap">说了这么多，我们还是直接来看一张图吧，基本可以描述清楚 traceroute 的整个过程。如下图：</span></div></div><div id="mV2jrJzCdVWb7FmjA9ybW4" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-1835f72b05f39288dd909bd059a55944_b.jpg" style="width: 576px"/></figure></div><h2 id="ntgkVMuFpnYRadTA385wYM" class="wolai-block"><span class="inline-wrap"><b>总结</b></span></h2><div id="wFvNGWsWEMEoChcc8Jffka" class="wolai-block wolai-text"><div><span class="inline-wrap">以上内容就是关于<span class="jill"></span>ICMP<span class="jill"></span>协议的全部内容啦，相信你看完本篇文章就可以深入理解每一次<span class="jill"></span>ping，traceroute<span class="jill"></span>背后的工作原理啦。好了，当我们深入学习完以上内容，当我们面对面试官的各种刁钻问题时，是不是游刃有余了呢？那么面试官一般都问些什么问题呢？这就给推荐牛客网，各种面试经历，还有在线面试模拟。</span></div></div><div id="cJyeHvEBDKFsX5QRSZFuoB" class="wolai-block wolai-text"><div><span class="inline-wrap">另外，欢迎添加我的微信公众号：矢量<span class="jill"></span>SRE</span></div></div><div id="5yzYxQuAqbvkE28fuNe5gM" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-7393ad246801c6a39f9e67b531fac477_b.jpg" style="width: 206.4px"/></figure></div></article><footer></footer></body></html>