<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../../css/wolai.css"/><title>图解ARP协议（五）免费ARP：地址冲突了肿么办？ - 知乎 - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="图解ARP协议（五）免费ARP：地址冲突了肿么办？ - 知乎" class="main-title"></div></div></header><article><h2 id="8ThCgDqei1twZ6b6Rf8fVM" class="wolai-block"><span class="inline-wrap"><b>一、免费<span class="jill"></span>ARP<span class="jill"></span>概述</b></span></h2><div id="7rW5M3gKddGYhGoou8354g" class="wolai-block wolai-text"><div><span class="inline-wrap">网络世界纷繁复杂，除了各种黑客攻击行为对网络能造成实际破坏之外，还有一类安全问题或泛安全问题，看上去问题不大，但其实仍然可以造成极大的杀伤力。今天跟大家探讨的，也是技术原理比较简单，但实际防范比较头疼的一个问题：</span><span class="inline-wrap"><b>地址冲突</b></span><span class="inline-wrap">。</span></div></div><div id="wv9GkAje2eHJd5hkKVCfud" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-c596ff81f272c76e75c042efe4268ba9_b.jpg" style="width: 576px"/></figure></div><div id="wUJCTPUYqHsJpSZTG7xpnf" class="wolai-block wolai-text"><div><span class="inline-wrap">这个局域网中，大家所在<span class="jill"></span>IP<span class="jill"></span>网段是<span class="jill"></span>192.168.1.0/24，PC1<span class="jill"></span>的地址是<span class="jill"></span>192.168.1.1，而<span class="jill"></span>PC2<span class="jill"></span>和<span class="jill"></span>PC3<span class="jill"></span>的地址发生冲突，都是<span class="jill"></span>192.168.1.2。那么，如果<span class="jill"></span>PC1<span class="jill"></span>需要将数据包发送给<span class="jill"></span>192.168.1.2，数据包最终到了<span class="jill"></span>PC2<span class="jill"></span>还是<span class="jill"></span>PC3<span class="jill"></span>手里？还是负载均衡？不管结果如何，这里的地址冲突肯定会对正常通信造成麻烦。</span></div></div><div id="isHF6Qo7eYVTBUm62nAkFV" class="wolai-block wolai-text"><div><span class="inline-wrap">上面这个电脑/手机之间的地址冲突，大家可能觉得没什么太大的问题，那么接下来再看下面这个图片=&gt;</span></div></div><div id="6kfvzWdkzEcK9EVXuzHrXu" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-cbf4f15aa6be1a12a86360bdd4e1e469_b.jpg" style="width: 576px"/></figure></div><div id="vCXEmegXikZNqo38NAZjBY" class="wolai-block wolai-text"><div><span class="inline-wrap">这里的<span class="jill"></span>Server1<span class="jill"></span>和<span class="jill"></span>Server2<span class="jill"></span>处在 [服务集群]中，提供着企业的某种服务，例如<span class="jill"></span>Web<span class="jill"></span>网站、邮箱系统、FTP<span class="jill"></span>文件服务器等，此时服务器的地址发生了冲突，都是<span class="jill"></span>10.1.1.1。这种地址冲突则会影响大规模的用户无法访问这个服务器，</span><span class="inline-wrap"><b>若服务器承载的是核心业务，对于企业则会造成极大的影响</b></span><span class="inline-wrap">。</span></div></div><div id="kG7eaeVAJkcomW3oipShK3" class="wolai-block wolai-text"><div><span class="inline-wrap">所以，</span><span class="inline-wrap"><b>地址冲突问题可大可小，可能网络运维人员部署上的疏忽，也可能是普通电脑小白无意导致的，更有可能是主动的黑客行为</b></span><span class="inline-wrap">，例如攻击者制造地址冲突场景，扰乱正常业务，导致业务服务中断。</span></div></div><div id="8nDpJwSj4f6Rxmc1boGpii" class="wolai-block wolai-text"><div><span class="inline-wrap">因此，</span><span class="inline-wrap"><b>如何在<span class="jill"></span>IP<span class="jill"></span>地址冲突的时候及时检测，并且做出解决方案呢？</b></span></div></div><h2 id="hMQgmey6tcrTBtKLdXo1Fr" class="wolai-block"><span class="inline-wrap"><b>二、免费<span class="jill"></span>ARP<span class="jill"></span>原理</b></span></h2><div id="tjTaUyQtD4ybwxk8PzSp2v" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Gratuitous ARP，被翻译为『免费<span class="jill"></span>ARP』也被称为『无故<span class="jill"></span>ARP』，用于检测局域网内的<span class="jill"></span>IP<span class="jill"></span>地址冲突</b></span><span class="inline-wrap">，在一定程度上能够给用户和网络运维人员提供帮助。相比『免费』这个翻译，『无故』这个词其实会更加好理解：&quot;</span><span class="inline-wrap"><b>在没有人问自己的情况下，无缘无故自问自答</b></span><span class="inline-wrap">&quot;。</span></div></div><div id="aM1suhy5ojgbtnFx1e6zpi" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-f2ab93fe622b32c57e50524e1f11fb74_b.jpg" style="width: 576px"/></figure></div><div id="gHB8mN5UzdQzSH7WuD4zev" class="wolai-block wolai-text"><div><span class="inline-wrap">这项技术不需要电脑和服务器安装什么安全软件或产品例如防火墙之类的，也不需要交换机和路由器购买什么<span class="jill"></span>license，只要设备具备联网功能（有网卡）就内置了这项功能，由于免费<span class="jill"></span>ARP<span class="jill"></span>本质是<span class="jill"></span>ARP<span class="jill"></span>协议的实现，所以只要有<span class="jill"></span>TCP/IP<span class="jill"></span>协议栈的网卡，就能支持。相比其他安全防御技术，</span><span class="inline-wrap"><b>免费<span class="jill"></span>ARP<span class="jill"></span>是一项轻量级的&quot;用户无感知&quot;的技术。</b></span><span class="inline-wrap"> </span></div></div><div id="hsX2rY1pZQ8L87cUWdYbAV" class="wolai-block wolai-text"><div><span class="inline-wrap">接下来，我们来回顾下之前的图片=&gt;</span></div></div><div id="77nivVCJS92sfYjiq13uDf" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-f72af8ecc7c0572b5b608cdf399649c1_b.jpg" style="width: 658px"/></figure></div><div id="92tp1RdgL7q7i8sVXjwnE7" class="wolai-block wolai-text"><div><span class="inline-wrap">当用户发送数据包给<span class="jill"></span>192.168.1.2<span class="jill"></span>的时候，交换机会将数据包转发给谁呢？</span></div></div><div id="adL337o1vU99BttvCgNtd7" class="wolai-block wolai-text"><div><span class="inline-wrap">①根据我们之前学过的<span class="jill"></span>ARP<span class="jill"></span>原理，交换机会拆开这个数据包，并且</span><span class="inline-wrap"><b>根据目的<span class="jill"></span>MAC<span class="jill"></span>进行转发</b></span><span class="inline-wrap">；</span></div></div><div id="n9hLuBVfTShEsFBHRajh9d" class="wolai-block wolai-text"><div><span class="inline-wrap">②那么<span class="jill"></span>PC1<span class="jill"></span>在数据封装的时候，</span><span class="inline-wrap"><b>目的<span class="jill"></span>MAC<span class="jill"></span>是封装<span class="jill"></span>PC2<span class="jill"></span>还是<span class="jill"></span>PC3<span class="jill"></span>的<span class="jill"></span>MAC</b></span><span class="inline-wrap">？</span></div></div><div id="nmoFV3jHcwndLtGyeNAJUy" class="wolai-block wolai-text"><div><span class="inline-wrap">③</span><span class="inline-wrap"><b>目标<span class="jill"></span>MAC<span class="jill"></span>则取决于电脑本地的<span class="jill"></span>ARP<span class="jill"></span>缓存表</b></span><span class="inline-wrap">，所以<span class="jill"></span>PC1<span class="jill"></span>最终把数据包给<span class="jill"></span>PC2<span class="jill"></span>还是<span class="jill"></span>PC3，则取决于收到的<span class="jill"></span>ARP<span class="jill"></span>回应，并且根据&quot;</span><span class="inline-wrap"><b>后到优先</b></span><span class="inline-wrap">&quot;原则作出选择。</span></div></div><div id="omXWNEu2ys4NBWjdThGKKb" class="wolai-block wolai-text"><div><span class="inline-wrap">所以，若<span class="jill"></span>PC2<span class="jill"></span>提前回应<span class="jill"></span>ARP，则<span class="jill"></span>PC1<span class="jill"></span>一直发给<span class="jill"></span>PC3；若<span class="jill"></span>PC3<span class="jill"></span>提前回应<span class="jill"></span>ARP，则<span class="jill"></span>PC1<span class="jill"></span>一直发送给<span class="jill"></span>PC2。还有一种情况，PC2<span class="jill"></span>和<span class="jill"></span>PC3<span class="jill"></span>交替回应<span class="jill"></span>ARP，PC1<span class="jill"></span>有可能将部分数据给<span class="jill"></span>PC2，部分数据给<span class="jill"></span>PC3（而<span class="jill"></span>PC1<span class="jill"></span>则处于懵逼状态，因为关于<span class="jill"></span>192.168.1.2<span class="jill"></span>的<span class="jill"></span>MAC<span class="jill"></span>映射一直在变动）。这个更多是理论推导，</span><span class="inline-wrap"><b>实际情况不同设备测试出来的效果有些差异，后面章节我会带大家做真实和虚拟网络的实验</b></span><span class="inline-wrap">。</span></div></div><div id="pMgXjte1abVhNXSkG2jhxs" class="wolai-block wolai-text"><div><span class="inline-wrap">我们来看看免费<span class="jill"></span>ARP<span class="jill"></span>是如何工作的并介入这场冲突的？</span></div></div><div id="xi613Na6uXBx8v9CprcjQo" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-41c5818c2ad4c2c1645cba4e5c6d58c3_b.jpg" style="width: 684px"/></figure></div><div id="f9oaxTwsPY1MijL53PMoaT" class="wolai-block wolai-text"><div><span class="inline-wrap">当电脑检测到自己的<span class="jill"></span>IP<span class="jill"></span>地址跟其他电脑冲突时，它们会相互发送</span><span class="inline-wrap"><b>免费<span class="jill"></span>ARP（&quot;互怼&quot;）</b></span><span class="inline-wrap">，用来提醒对方：</span><span class="inline-wrap"><b>你的<span class="jill"></span>IP<span class="jill"></span>地址跟我的冲突啦！</b></span><span class="inline-wrap"> 这里要注意一点：免费<span class="jill"></span>ARP<span class="jill"></span>是</span><span class="inline-wrap"><b>以<span class="jill"></span>ARP Request<span class="jill"></span>或<span class="jill"></span>Reply<span class="jill"></span>广播形式</b></span><span class="inline-wrap">发送，将<span class="jill"></span>IP<span class="jill"></span>和<span class="jill"></span>MAC<span class="jill"></span>地址信息绑定，并宣告到整个局域网。如果在宣告的过程中，其他电脑监听到，并且地址跟自己一样，也会直接参与这个&quot;互怼&quot;过程。</span></div></div><div id="wD9hEuEYggAg1fCmgMJUyd" class="wolai-block wolai-text"><div><span class="inline-wrap">上面<span class="jill"></span>PC2<span class="jill"></span>和<span class="jill"></span>PC3<span class="jill"></span>一直不停地对外发送免费<span class="jill"></span>ARP：我的地址是<span class="jill"></span>192.168.1.2，MAC<span class="jill"></span>是<span class="jill"></span>xxx。与此同时，同一局域网的其他主机，则根据这两个免费<span class="jill"></span>ARP<span class="jill"></span>信息不断的修改本地<span class="jill"></span>ARP<span class="jill"></span>表，192.168.1.2<span class="jill"></span>一会映射到<span class="jill"></span>MAC2，一会映射到<span class="jill"></span>MAC3。</span></div></div><div id="pWuwMBw5jHYHhSb6cccw2Q" class="wolai-block wolai-text"><div><span class="inline-wrap">那么，</span><span class="inline-wrap"><b>这个混乱的争抢过程，会不会停下来呢？</b></span></div></div><div id="afoDbJaPxfnGecejf1JAJH" class="wolai-block wolai-text"><div><span class="inline-wrap">可能会持续一段时间，也可能一直持续下去（后面有实验验证）。冲突方之间可能会一直发送，直到有一边做出让步并修改<span class="jill"></span>IP<span class="jill"></span>地址。（不同系统解决方法不同）</span></div></div><div id="tpHB1jac1TFbZEw2chnqwh" class="wolai-block wolai-text"><div><span class="inline-wrap">很多人在这里开始有疑惑，即便免费<span class="jill"></span>ARP<span class="jill"></span>帮我们检测到了地址冲突，但是也是在协议底层在&quot;互怼&quot;，**我们作为&quot;主人&quot;，如何收到地址冲突提示，并且做出修改和让步呢？**因为无论是普通用户还是专业工程师，也不可能天天挂在<span class="jill"></span>wireshark<span class="jill"></span>这种抓包软件，时时刻刻盯着免费<span class="jill"></span>ARP<span class="jill"></span>包，判断是否有人跟我们地址冲突了。所以，这又涉及到电脑（操作系统）如何根据免费<span class="jill"></span>ARP<span class="jill"></span>的地址冲突检测，更好的提示或帮助用户了。</span></div></div><div id="gmRS5jCVYNGPF6eeCKmtPU" class="wolai-block wolai-text"><div><span class="inline-wrap">目前行业的解决方案是这样的：如果是</span><span class="inline-wrap"><b>图形化</b></span><span class="inline-wrap">操作系统，例如<span class="jill"></span>Windows<span class="jill"></span>或者<span class="jill"></span>MacOS，是通过系统</span><span class="inline-wrap"><b>弹框</b></span><span class="inline-wrap">的方式提示用户；而如果是</span><span class="inline-wrap"><b>命令行</b></span><span class="inline-wrap">操作系统（交换机/路由器/防火墙），则通过</span><span class="inline-wrap"><b>日志</b></span><span class="inline-wrap">报错信息提示用户。</span></div></div><div id="dThPcuttD1GC1gRre19jrx" class="wolai-block wolai-text"><div><span class="inline-wrap">也就是说，无论普通电脑还是专业的防火墙设备，通过免费<span class="jill"></span>ARP<span class="jill"></span>检测到地址冲突之后，设备都会弹出来跟他说：</span><span class="inline-wrap"><b>喂，主人，你地址跟人家冲突了，该改改了！</b></span></div></div><div id="GYoAXgSu8NkpK7GHATfhq" class="wolai-block wolai-text"><div><span class="inline-wrap">这是<span class="jill"></span>Windows<span class="jill"></span>和<span class="jill"></span>MacOS<span class="jill"></span>的地址冲突弹框告警，引导用户修改本机<span class="jill"></span>IP<span class="jill"></span>地址=&gt;  </span></div></div><div id="n3eLG91bFGjKgaqaQ7mVQ9" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-83bc2661bb6d2ba7007513357d5584f7_b.jpg" style="width: 576px"/></figure></div><div id="bbpeYn3AbiW7GBj2LniVa" class="wolai-block wolai-text"><div><span class="inline-wrap">这是思科路由器<span class="jill"></span>IOS（网际操作系统）的地址冲突日志信息，引导网络运维人员修改<span class="jill"></span>IP<span class="jill"></span>地址=&gt;</span></div></div><div id="foAVj4gEe8jMpH3EfUztcf" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>%IP-4-DUPADDR: Duplicate address</b></span><span class="inline-wrap"> 192.168.1.2 on FastEthernet0/0, sourced by cc02.394f.0000</span></div></div><div id="jqSQ22nP7yuwXBBHTyqa2q" class="wolai-block wolai-text"><div><span class="inline-wrap">所以，当地址发生冲突时，根据免费<span class="jill"></span>ARP<span class="jill"></span>引起的弹框和日志告警，用户或者管理员便可以对<span class="jill"></span>IP<span class="jill"></span>地址进行修改，从而解决通信问题。例如，下面的<span class="jill"></span>PC2<span class="jill"></span>和<span class="jill"></span>PC3，只要一方修改了地址即可 =&gt;</span></div></div><div id="dB2AcCFyk3Pr79Li4yBu8t" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-c0ccd54288808752b50ae90a40e6f986_b.jpg" style="width: 576px"/></figure></div><h2 id="poX8MS2JQRrS9Fk36yDxZA" class="wolai-block"><span class="inline-wrap"><b>三、免费<span class="jill"></span>ARP<span class="jill"></span>实战指南</b></span></h2><div id="nAGLBtbKfeukXKuMcpDxeD" class="wolai-block wolai-text"><div><span class="inline-wrap">免费<span class="jill"></span>ARP<span class="jill"></span>出现的场景非常多，例如</span><span class="inline-wrap"><b>地址冲突时、地址修改或变更时、DHCP<span class="jill"></span>分发地址时、网关冗余协议交互时（例如<span class="jill"></span>HSRP）、TFTP<span class="jill"></span>传输数据时</b></span><span class="inline-wrap">……</span></div></div><div id="ujNa4nNbSGPAaVDLCEE1wH" class="wolai-block wolai-text"><div><span class="inline-wrap">不同的场景，抓到的免费<span class="jill"></span>ARP<span class="jill"></span>数据包，底层结构都会有所差异，可能是基于<span class="jill"></span>ARP<span class="jill"></span>请求广播发送的，也可能是基于<span class="jill"></span>ARP<span class="jill"></span>回应广播发送的（没看错！ARP<span class="jill"></span>回应这里是广播方式）</span></div></div><div id="iKTU8qxcYaWLEWnRFeHfCT" class="wolai-block wolai-text"><div><span class="inline-wrap">为了让大家&quot;亲眼所见&quot;，同时可跟着我一起实践，更好吸收这块的知识，这里我设计了真实和虚拟网络来进行实战，并抓取免费<span class="jill"></span>ARP<span class="jill"></span>数据包，通过数据包解构原理。</span></div></div><div id="8nPj8pXh86Gu1QnZzsnM25" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>（一）真实网络下 免费<span class="jill"></span>ARP<span class="jill"></span>实战</b></span></div></div><div id="oisn9vLP9u9n9uA6bRC4rt" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>① 跟上一篇文章中代理<span class="jill"></span>ARP<span class="jill"></span>的真实网络一样，我的网络拓扑是这样的：</b></span><span class="inline-wrap"> </span></div></div><div id="pb4GfffQMQNZdLp7vvyA5o" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-23b2f1e5e51ce53642b217e6d696cc13_b.jpg" style="width: 576px"/></figure></div><div id="wYtY8iY6jotpvhR61Keesp" class="wolai-block wolai-text"><div><span class="inline-wrap">为了让这个实验更有通用性，我加入了一台<span class="jill"></span>Windows<span class="jill"></span>电脑。此时登录无线路由器（极路由）查看局域网主机列表：</span></div></div><div id="psiLdFVDrabTCQTDMWMQ8F" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-a3ca2596fc8de941f7bda5e1a760d49b_b.jpg" style="width: 576px"/></figure></div><div id="sqyVXYDewRx1WYscKNDGNV" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>还是原来的配方.... 苹果全家桶和一台<span class="jill"></span>Windows<span class="jill"></span>电脑。</b></span><span class="inline-wrap"> 实物图大概是这样的：</span></div></div><div id="nBgjHfmB5ja4eRNce6V7aL" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-ab50aabaa042494abf31a9da3cfb43ab_b.jpg" style="width: 576px"/></figure></div><div id="pwVLLLSqivQrGLmeQhYebv" class="wolai-block wolai-text"><div><span class="inline-wrap">② 接下来，为了看到地址冲突时，免费<span class="jill"></span>ARP<span class="jill"></span>的数据包交互，我们在<span class="jill"></span>Windows<span class="jill"></span>和<span class="jill"></span>MacOS<span class="jill"></span>同时开启<span class="jill"></span>Wireshark<span class="jill"></span>并抓包本机电脑的数据包，设置<span class="jill"></span>arp<span class="jill"></span>过滤。</span></div></div><div id="9CE511EbbPVKodzD3kRSnf" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>macbook<span class="jill"></span>端截图如下：</b></span><span class="inline-wrap"> </span></div></div><div id="mao9pHCUpZySFE7r669jRw" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-bc5a4ccea5eccf78b0a0b6343d9269d4_b.jpg" style="width: 961.6px"/></figure></div><div id="eyd3TJyin3WEEyV2BjiX5H" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Windows<span class="jill"></span>端截图如下：</b></span><span class="inline-wrap"> （Windows 10<span class="jill"></span>跟无线路由器一直在交互）</span></div></div><div id="o2BhiArMAjRPAYaVVpYZpf" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-d8287e3876e8763e6465bc8831417bf1_b.jpg" style="width: 576px"/></figure></div><div id="v91859MBpMN6WUyNDTsJvj" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>③在<span class="jill"></span>Mac<span class="jill"></span>端，将<span class="jill"></span>IP<span class="jill"></span>地址设置为跟<span class="jill"></span>Windows<span class="jill"></span>地址一样</b></span><span class="inline-wrap">，</span><span class="inline-wrap"><b>从<span class="jill"></span>192.168.199.177<span class="jill"></span>改为<span class="jill"></span>192.168.199.152</b></span></div></div><div id="8PVMgW7JaRzuEoAvEw2chW" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-b23a3f127bb2a3afdfa23946877a9d99_b.jpg" style="width: 832px"/></figure></div><div id="6xCrJUmj2Dn1aWLQ96UNJV" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div id="4Pj8xz28sEL7RgD9feg6DB" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-b287c94c0611b32e2e55fa91105b20db_b.jpg" style="width: 827.2px"/></figure></div><div id="46TNDbx5r4vACoMGxKr5wL" class="wolai-block wolai-text"><div><span class="inline-wrap">点击应用之后，开始观察两边电脑弹框和<span class="jill"></span>wireshark<span class="jill"></span>的<span class="jill"></span>ARP<span class="jill"></span>包交互过程=&gt;</span></div></div><div id="9iuHiwxxAsm3W7QeAC9xfY" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-66ff0ff69022026f9de918769e8cd2c1_b.jpg" style="width: 576px"/></figure></div><div id="mnWvr54ThgZcRvgFRHJs17" class="wolai-block wolai-text"><div><span class="inline-wrap">上图可以看到<span class="jill"></span>macbook<span class="jill"></span>的弹框告警了，接下来我们来分析下此时<span class="jill"></span>Mac<span class="jill"></span>和<span class="jill"></span>windows<span class="jill"></span>抓到的数据交互过程=&gt;</span></div></div><div id="rYRNrb6N2dT1bKmc2mjYmK" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-a0de09b36c871cdb62cd66c134eff25b_b.jpg" style="width: 576px"/></figure></div><div id="u4eCiwqoYQvs1z4qGLu5JS" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div id="c2WBmCan9aFdpozJ5mS7dq" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-fdb130c3bed93cba852e20325cfce669_b.jpg" style="width: 576px"/></figure></div><div id="qQd4s85Eba8GAzo1rxrETn" class="wolai-block wolai-text"><div><span class="inline-wrap">我的<span class="jill"></span>windows<span class="jill"></span>电脑很明确的回应<span class="jill"></span>Mac<span class="jill"></span>电脑：</span><span class="inline-wrap"><b>这个地址<span class="jill"></span>199.152，已经被我用了</b></span><span class="inline-wrap">。这个过程重复了<span class="jill"></span>3<span class="jill"></span>次。根据抓包，</span><span class="inline-wrap"><b>这个过程后面还在不断的持续中，不管在<span class="jill"></span>win<span class="jill"></span>还是<span class="jill"></span>mac，都能抓到类似的问答过程</b></span><span class="inline-wrap">。</span></div></div><div id="gmAJLyzhpNHJzAJd7eQkGu" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-01e9ff6f9614614faf95e160f217f947_b.jpg" style="width: 576px"/></figure></div><div id="fSckk7AEx9j9EgR33vFNg" class="wolai-block wolai-text"><div><span class="inline-wrap">由于<span class="jill"></span>macbook<span class="jill"></span>电脑</span><span class="inline-wrap"><b>此刻不能上网</b></span><span class="inline-wrap">，所以还&quot;</span><span class="inline-wrap"><b>不屈不挠</b></span><span class="inline-wrap">&quot;的询问着，它在想：没准<span class="jill"></span>windows<span class="jill"></span>下线了，没有回应了呢？（如果<span class="jill"></span>win<span class="jill"></span>没有回应，则说明它下线了或改为其他地址了，那么<span class="jill"></span>mac<span class="jill"></span>就可以使用）</span></div></div><div id="q8CnYiQDEuHSt8uTKNNfS5" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-1dd7a2975a0c2fce99cc8e9cd6a5fd49_b.jpg" style="width: 582.4px"/></figure></div><div id="nsRjjdmrwhkketbMmUPTGH" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>④ 接下来，我们将<span class="jill"></span>windows<span class="jill"></span>的网络断开，然后在<span class="jill"></span>macbook<span class="jill"></span>这端观察<span class="jill"></span>arp<span class="jill"></span>交互和网络连接状态：</b></span><span class="inline-wrap"> </span></div></div><div id="oE2ckmZchGY3tx6LAn8Qed" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-8006ecef56d9e6b44b668ef1c554356a_b.jpg" style="width: 576px"/></figure></div><div id="t78PaqK71TrCDbqcx1RrgM" class="wolai-block wolai-text"><div><span class="inline-wrap">此时，macbook<span class="jill"></span>跟往常一样发生三个<span class="jill"></span>arp<span class="jill"></span>请求，询问<span class="jill"></span>152<span class="jill"></span>这个地址是否有人使用，</span><span class="inline-wrap"><b>由于<span class="jill"></span>windows<span class="jill"></span>已经下线，所以三次都没有应答</b></span><span class="inline-wrap">。紧接着有三个<span class="jill"></span>gratuitous arp<span class="jill"></span>数据包，跟上面三个请求包几乎是一样的，只有一个区别，就是发送者的<span class="jill"></span>IP<span class="jill"></span>地址此时从<span class="jill"></span>0.0.0.0<span class="jill"></span>修改为<span class="jill"></span>192.168.199.152。这意味着</span><span class="inline-wrap"><b>mac<span class="jill"></span>确认了<span class="jill"></span>152<span class="jill"></span>没有其他人使用，并且认为此刻自己有资格用上<span class="jill"></span>152<span class="jill"></span>这个地址了</b></span><span class="inline-wrap">。</span></div></div><div id="pDz6iZmBWwbNJvLtXGLt45" class="wolai-block wolai-text"><div><span class="inline-wrap">从<span class="jill"></span>wireshark<span class="jill"></span>抓包来看，之前的<span class="jill"></span>arp<span class="jill"></span>请求好像没有标记**&quot;gratuitous&quot;</span><span class="inline-wrap"><b>这个关键词，那么算不是是免费<span class="jill"></span>arp<span class="jill"></span>或者无故<span class="jill"></span>arp<span class="jill"></span>呢？这个其实也是比较多讨论和争议。如果从</b></span><span class="inline-wrap">&quot;自己问自己的角度**&quot;出发，这两种<span class="jill"></span>arp<span class="jill"></span>都算是免费<span class="jill"></span>arp，因为都是在问自己配置的这个新地址<span class="jill"></span>192.168.199.152，而且</span><span class="inline-wrap"><b>目的都是一致的，都是为了检测是否地址可用是否存在冲突</b></span><span class="inline-wrap">。</span></div></div><div id="4d6S4PL2BzYgFS1o5qoxAE" class="wolai-block wolai-text"><div><span class="inline-wrap">当然，更严谨的的免费<span class="jill"></span>arp<span class="jill"></span>包，则是</span><span class="inline-wrap"><b>需要&quot;发送方<span class="jill"></span>ip&quot;和&quot;接收者<span class="jill"></span>ip&quot;是一致的</b></span><span class="inline-wrap">，就是下面这种<span class="jill"></span>arp<span class="jill"></span>请求包，都有<span class="jill"></span>192.168.199.152<span class="jill"></span>这个地址。所以，这一小知识点的话，我个人觉得不用太纠结，通过数据包结构还原整个免费<span class="jill"></span>arp<span class="jill"></span>工作原理才是最重要的。</span></div></div><div id="pYeoVvaLDMBHLhY7b3fGqF" class="wolai-block wolai-text"><div><span class="inline-wrap">从<span class="jill"></span>wireshark<span class="jill"></span>截图可以看到，经过了上面这些免费<span class="jill"></span>ARP<span class="jill"></span>的请求之后，由于一直没有其他设备回应<span class="jill"></span>152<span class="jill"></span>这个地址，所以<span class="jill"></span>macbook<span class="jill"></span>电脑再次询问网关<span class="jill"></span>192.168.199.1<span class="jill"></span>的物理地址，拿到网关的<span class="jill"></span>ARP<span class="jill"></span>回应之后，我的<span class="jill"></span>macbook<span class="jill"></span>便可以正常通信了。</span></div></div><div id="bw1Ez31pFWcKdwn4beiyRN" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-2952396d466a1e9236149a2d13b5980b_b.jpg" style="width: 726.4px"/></figure></div><div id="kQjWk8tGDx1iqVBFqMGeWU" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>⑤【接下来是拓展内容，涉及<span class="jill"></span>dhcp<span class="jill"></span>协议，新手的话可暂时忽略这一小段...】</b></span><span class="inline-wrap"> </span></div></div><div id="7KLocqx5GCztUH7gHHn3Sw" class="wolai-block wolai-text"><div><span class="inline-wrap">这个实验还可以继续深挖下来，此时</span><span class="inline-wrap"><b>让<span class="jill"></span>windows<span class="jill"></span>电脑重新接入这个<span class="jill"></span>wifi<span class="jill"></span>网络</b></span><span class="inline-wrap">，之后同样会出现免费<span class="jill"></span>arp<span class="jill"></span>的交互过程，只不过多了一个<span class="jill"></span>dhcp<span class="jill"></span>协议交互，并且最终<span class="jill"></span>windows<span class="jill"></span>使用了<span class="jill"></span>192.168.199.153<span class="jill"></span>这个地址接入<span class="jill"></span>wifi<span class="jill"></span>网络。先整理下流程再截核心数据包=&gt;</span></div></div><ol class="wolai-block"><li id="dFccsxhgowuFVCAQLa3qxE"><div class="marker"></div><span class="inline-wrap">当<span class="jill"></span>windows<span class="jill"></span>重新接入网络之后，会通过<span class="jill"></span>dhcp<span class="jill"></span>重新获取<span class="jill"></span>192.168.199.152<span class="jill"></span>这个地址（由于<span class="jill"></span>macbook<span class="jill"></span>的<span class="jill"></span>152<span class="jill"></span>这个地址是由我手工静态指定的而不是路由器分配，所有路由器仍然通过<span class="jill"></span>dhcp<span class="jill"></span>地址池分配）；</span></li><li id="h1vubZpoWauNLdMw1VKiEG"><div class="marker"></div><span class="inline-wrap">windows<span class="jill"></span>收到这个地址之后，第一时间便发送免费<span class="jill"></span>arp<span class="jill"></span>包进行地址检测，但是发现这个地址已经被<span class="jill"></span>macbook<span class="jill"></span>占用了！因此，通过<span class="jill"></span>dhcp decline<span class="jill"></span>数据包向无线路由器取消这个地址；</span></li><li id="uRh5cFw2vAjb6jxeBJQcFx"><div class="marker"></div><span class="inline-wrap">windows<span class="jill"></span>重新获取<span class="jill"></span>192.168.199.153<span class="jill"></span>这个地址，通过免费<span class="jill"></span>arp<span class="jill"></span>重新检测，发现没有人回应了，说明这个地址可用，后续用这个地址接入<span class="jill"></span>wifi<span class="jill"></span>网络。</span></li></ol><div id="qwKVFewiu7ZMxzt2KAko4S" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>windows<span class="jill"></span>重新接入网络的<span class="jill"></span>dhcp<span class="jill"></span>交互包=&gt;</b></span></div></div><div id="5wr56KMAdER9WB97XBxQHU" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-41c51ac01a48f0c1dec7e212618d6ff8_b.jpg" style="width: 576px"/></figure></div><div id="csQEuu6A9ZSVcoAiz5xwGF" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>windows<span class="jill"></span>获取地址后通过免费<span class="jill"></span>arp<span class="jill"></span>检测到<span class="jill"></span>macbook=&gt;</b></span></div></div><div id="gSukR4DGkAtynfnsKw6Ssf" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-856a2e5567a0bf0da1e5ae5ffe11fdbf_b.jpg" style="width: 576px"/></figure></div><div id="hPpCGovWbKGr61KUSe4af6" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>windows<span class="jill"></span>通过<span class="jill"></span>dhcp decline<span class="jill"></span>放弃<span class="jill"></span>152，并重新获取<span class="jill"></span>153<span class="jill"></span>这个地址=&gt;</b></span></div></div><div id="gYKefgTmZ9eaT3WXpHibUr" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-7023a63ddc3c622ac3a9ddd93793273f_b.jpg" style="width: 576px"/></figure></div><div id="qGRr9RNccouH49NVycgUpv" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>windows<span class="jill"></span>通过免费<span class="jill"></span>arp<span class="jill"></span>检测，发现<span class="jill"></span>153<span class="jill"></span>地址没其他人用，所以接入了网络=&gt;</b></span></div></div><div id="aPB8GxhZvD985dVVu6xNxA" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-177b0efe8d4f17d1cdfc96891bfb42b7_b.jpg" style="width: 576px"/></figure></div><div id="hCTZZaduaAwn3b35viHBiB" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>总结：</b></span><span class="inline-wrap"> 通过这个真实网络，我们构造了<span class="jill"></span>windows<span class="jill"></span>和<span class="jill"></span>macbook<span class="jill"></span>地址冲突的环境，通过<span class="jill"></span>wireshark<span class="jill"></span>抓取免费<span class="jill"></span>arp<span class="jill"></span>数据包，学习了免费<span class="jill"></span>arp<span class="jill"></span>的地址检测功能以及数据包结构。</span></div></div><div id="icc69ah8UREunZdMz26Zqp" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>①当电脑（手工）修改的地址跟局域网其他主机地址一样的时候，通过免费<span class="jill"></span>arp<span class="jill"></span>协议，电脑会弹框提醒并无法上网；</b></span></div></div><div id="suvmQbhWjVsr3EUb1abLMk" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>②当相同地址的电脑其中一台下线时，通过免费<span class="jill"></span>arp<span class="jill"></span>可以证明此地址可使用（没人争抢/回应），此时便可接入网络；</b></span></div></div><div id="euiuYdKgNY3JN2sHVd7Ti3" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>③当电脑通过<span class="jill"></span>DHCP<span class="jill"></span>获取地址时，会通过免费<span class="jill"></span>arp<span class="jill"></span>检测这个地址是否可用，若已经被使用，则重新通过<span class="jill"></span>dhcp<span class="jill"></span>获取新的地址，再接入互联网。</b></span><span class="inline-wrap"> </span></div></div><div id="wyyVHYpLFNZNpyZ12RYwBx" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>④这里抓取的免费<span class="jill"></span>ARP<span class="jill"></span>包是请求广播包，并且特征是&quot;自己问自己&quot;。</b></span><span class="inline-wrap"> （&quot;自己答自己&quot;的回应广播包，在下面的实验有）</span></div></div><div id="3xCB8CkaxU8MK3mqxBnN63" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>（二）虚拟网络下 免费<span class="jill"></span>ARP<span class="jill"></span>实战</b></span></div></div><div id="4MnKbvhXbB2yaNu3jrTg7P" class="wolai-block wolai-text"><div><span class="inline-wrap">网络拓扑采用<span class="jill"></span>GNS3<span class="jill"></span>搭建，采用<span class="jill"></span>C3640<span class="jill"></span>操作系统镜像=&gt;</span></div></div><div id="2stjroDeyMAMrpM4mE5f9U" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-6d6ed12ed7978ef7345579e16abaeb04_b.jpg" style="width: 896px"/></figure></div><div id="sMrV7xdWnQaRvfmMHjb5fv" class="wolai-block wolai-text"><div><span class="inline-wrap">①为每个路由器配置<span class="jill"></span>IP<span class="jill"></span>地址，所在网段为<span class="jill"></span>192.168.1.0/24=&gt;</span></div></div><div id="kGC9usCFa2b5Ey9pdGHMS4" class="wolai-block wolai-text"><div><span class="inline-wrap">R1(config)#int f0/0</span></div></div><div id="iT9uHqzLwxTHaKnqb2vQCZ" class="wolai-block wolai-text"><div><span class="inline-wrap">R1(config-if)#no sh</span></div></div><div id="61Pnpd1kEbRBpcUMiZ3uuQ" class="wolai-block wolai-text"><div><span class="inline-wrap">R1(config-if)#</span><span class="inline-wrap"><b>ip add 192.168.1.1 255.255.255.0</b></span></div></div><div id="9Hjfguj5GkeZpR33ZBeEbM" class="wolai-block wolai-text"><div><span class="inline-wrap">R2(config)#int f0/0</span></div></div><div id="b3mzD37uwR3pjFXwaFdYFm" class="wolai-block wolai-text"><div><span class="inline-wrap">R2(config-if)#no sh</span></div></div><div id="9W9UYdci6DuoBJdyouWrdp" class="wolai-block wolai-text"><div><span class="inline-wrap">R2(config-if)#</span><span class="inline-wrap"><b>ip add 192.168.1.2 255.255.255.0</b></span></div></div><div id="qz2rS3q667hVAG31PqwEh2" class="wolai-block wolai-text"><div><span class="inline-wrap">R3(config)#int f0/0</span></div></div><div id="c7196ukdPXsP7nnVNRbiFG" class="wolai-block wolai-text"><div><span class="inline-wrap">R3(config-if)#no sh</span></div></div><div id="kvCmMMVFguPzyVdHRfvW3G" class="wolai-block wolai-text"><div><span class="inline-wrap">R3(config-if)#</span><span class="inline-wrap"><b>ip add 192.168.1.3 255.255.255.0</b></span></div></div><div id="3AN6S8sN1oqU5cCtYezaVg" class="wolai-block wolai-text"><div><span class="inline-wrap">②在路由器相连链路上抓包，路由器相互<span class="jill"></span>PING<span class="jill"></span>通，并查看<span class="jill"></span>ARP<span class="jill"></span>表=&gt;</span></div></div><div id="kjHcXaFq6EUNWBT9yE5UzY" class="wolai-block wolai-text"><div><span class="inline-wrap">（这里用<span class="jill"></span>R1<span class="jill"></span>举例，其他类似）</span></div></div><div id="8rqzWgeqK4TLPNkz4tTqea" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>R1#ping 192.168.1.2</b></span></div></div><div id="i4Yh61DBJr1CXmtkY5ZEPi" class="wolai-block wolai-text"><div><span class="inline-wrap">Type escape sequence to abort.</span></div></div><div id="doLaY389VaaHbkCJDx7ns2" class="wolai-block wolai-text"><div><span class="inline-wrap">Sending 5, 100-byte ICMP Echos to 192.168.1.2, timeout is 2 seconds:</span></div></div><div id="2qK9RH4UT1LxPhLj9Frwap" class="wolai-block wolai-text"><div><span class="inline-wrap">!!!!!</span></div></div><div id="4jxsrLCNepTQExgXR6WMQA" class="wolai-block wolai-text"><div><span class="inline-wrap">Success rate is 100 percent (5/5), round-trip min/avg/max = 64/64/64 ms</span></div></div><div id="fjTxmbMH2EGhusBKfZ8h4G" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>R1#ping 192.168.1.3</b></span></div></div><div id="h5cFeCFvcEPc7heQCyDnVY" class="wolai-block wolai-text"><div><span class="inline-wrap">Type escape sequence to abort.</span></div></div><div id="si85cABQFyK1cPYHMUJLdb" class="wolai-block wolai-text"><div><span class="inline-wrap">Sending 5, 100-byte ICMP Echos to 192.168.1.3, timeout is 2 seconds:</span></div></div><div id="t4TU5ZBvmScyUQUHygaPjR" class="wolai-block wolai-text"><div><span class="inline-wrap">!!!!!</span></div></div><div id="p4gqRAjG658wXWYErphsyY" class="wolai-block wolai-text"><div><span class="inline-wrap">Success rate is 100 percent (5/5), round-trip min/avg/max = 64/64/68 ms</span></div></div><div id="s34KGvX96FEnATWXj1rDNx" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>R1#show arp</b></span></div></div><div id="qkYyAboQYRLEe4ifhLb3fS" class="wolai-block wolai-text"><div><span class="inline-wrap">Protocol Address Age (min) Hardware Addr Type Interface</span></div></div><div id="k8WRjwpRR79wbzJYTWUa5y" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet 192.168.1.1 - cc00.394f.0000 ARPA FastEthernet0/0</span></div></div><div id="aoNLBVK2WrBNz4tVX1iJhx" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet 192.168.1.3 0 cc02.394f.0000 ARPA FastEthernet0/0</span></div></div><div id="45H62LeUscHPJGFyYjwCHS" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet 192.168.1.2 0 cc01.394f.0000 ARPA FastEthernet0/0</span></div></div><div id="7voC8Qxjkh2zXJLHuK7fVY" class="wolai-block wolai-text"><div><span class="inline-wrap">③让<span class="jill"></span>R3<span class="jill"></span>和<span class="jill"></span>R2<span class="jill"></span>的地址冲突，例如将<span class="jill"></span>R3<span class="jill"></span>的地址从<span class="jill"></span>192.168.1.3<span class="jill"></span>配置为<span class="jill"></span>192.168.1.2，在<span class="jill"></span>R2<span class="jill"></span>和<span class="jill"></span>R3<span class="jill"></span>上面开启<span class="jill"></span>arp<span class="jill"></span>调试&quot;</span><span class="inline-wrap"><b>debug arp</b></span><span class="inline-wrap">&quot;，在<span class="jill"></span>R1<span class="jill"></span>上面查看<span class="jill"></span>ARP<span class="jill"></span>表，通过<span class="jill"></span>wireshark<span class="jill"></span>观察底层免费<span class="jill"></span>ARP<span class="jill"></span>包交互过程=&gt;</span></div></div><div id="5hSgYvoLbyEYiUkE5mmsyx" class="wolai-block wolai-text"><div><span class="inline-wrap">R3(config)#int f0/0</span></div></div><div id="tXEuT7pxy35cj5Ff8jJWzj" class="wolai-block wolai-text"><div><span class="inline-wrap">R3(config-if)#</span><span class="inline-wrap"><b>ip add 192.168.1.2 255.255.255.0</b></span></div></div><div id="k1MJYn23Z7nYF5qiCaMAtn" class="wolai-block wolai-text"><div><span class="inline-wrap">一旦<span class="jill"></span>R3<span class="jill"></span>设置了上面的地址，跟<span class="jill"></span>R2<span class="jill"></span>冲突之后，此时<span class="jill"></span>R2<span class="jill"></span>和<span class="jill"></span>R3<span class="jill"></span>的命令行界面开始</span><span class="inline-wrap"><b>不停断&quot;刷屏&quot;</b></span><span class="inline-wrap">=&gt;</span></div></div><div id="xxUTkHneyxmWPNNTDJc753" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-92f846cbeda69b3925b8bf9db0407f73_b.jpg" style="width: 576px"/></figure></div><div id="kEZSrJDz5oPRhHaPxuMZM8" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>核心日志信息：</b></span><span class="inline-wrap"> </span></div></div><div id="pbjebgDQatTwEexwUM4Arw" class="wolai-block wolai-text"><div><span class="inline-wrap">R2#</span></div></div><div id="agANHfBuovuHrwCyHBCT5S" class="wolai-block wolai-text"><div><span class="inline-wrap">*Mar 1 00:13:25.519: %IP-4-DUPADDR: Duplicate address 192.168.1.2 on FastEthernet0/0, sourced by cc02.394f.0000</span></div></div><div id="qLLrh9ZGeTZG4mCP2cSWr6" class="wolai-block wolai-text"><div><span class="inline-wrap">R2#</span></div></div><div id="cv2WvHJXW6VGdsTonkBgz7" class="wolai-block wolai-text"><div><span class="inline-wrap">*Mar 1 00:13:56.259: %IP-4-DUPADDR: Duplicate address 192.168.1.2 on FastEthernet0/0, sourced by cc02.394f.0000</span></div></div><div id="hDneSD4c2h9yuStDrQwPfV" class="wolai-block wolai-text"><div><span class="inline-wrap">R2#</span></div></div><div id="mwmkYaxCtPBgmnX7e12N7c" class="wolai-block wolai-text"><div><span class="inline-wrap">*Mar 1 00:14:27.167: %IP-4-DUPADDR: Duplicate address 192.168.1.2 on FastEthernet0/0, sourced by cc02.394f.0000</span></div></div><div id="vdxuVy4ghNnmuFqh6kvVBh" class="wolai-block wolai-text"><div><span class="inline-wrap">虽然网络设备没法像<span class="jill"></span>Windows<span class="jill"></span>或者<span class="jill"></span>Macos<span class="jill"></span>弹框告警，但是通过日志提示同样可以达到同样的目的，让网络运维人员作出修改。</span></div></div><div id="snURS4wCdgqWFR7ACVkGu3" class="wolai-block wolai-text"><div><span class="inline-wrap">Cisco IOS<span class="jill"></span>通过免费<span class="jill"></span>ARP<span class="jill"></span>检测到地址冲突之后，解决的方法</span><span class="inline-wrap"><b>相对&quot;暴力&quot;</b></span><span class="inline-wrap">，例如，R2<span class="jill"></span>和<span class="jill"></span>R3<span class="jill"></span>直接会持续发送</span><span class="inline-wrap"><b>免费<span class="jill"></span>ARP（reply<span class="jill"></span>广播包）</b></span><span class="inline-wrap">，直到地址冲突问题被解决掉。可以通过<span class="jill"></span>wireshark<span class="jill"></span>数据包观察=&gt;</span></div></div><div id="v85DHKJWcj4CZjyrzEf9hm" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-0b30c30a8efcb09fcf26351f822dff12_b.jpg" style="width: 576px"/></figure></div><div id="vJLv3c5us2DcA8VZP8t7L7" class="wolai-block wolai-text"><div><span class="inline-wrap">此时再观察<span class="jill"></span>R1<span class="jill"></span>上面的<span class="jill"></span>ARP<span class="jill"></span>表，关于<span class="jill"></span>192.168.1.2<span class="jill"></span>这个地址的映射信息：</span></div></div><div id="rKrs2NyMEUUp9PbXcP9VRR" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>R1#show arp</b></span></div></div><div id="8T8HWEaVqNBBzgpDP6mfpg" class="wolai-block wolai-text"><div><span class="inline-wrap">Protocol Address Age (min) Hardware Addr Type Interface</span></div></div><div id="q9eXrtvXLtyadJstLR5e4V" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet 192.168.1.1 - cc00.394f.0000 ARPA FastEthernet0/0</span></div></div><div id="jfjpJeFYmNFNDu2XkXKpPz" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet 192.168.1.3 6 cc02.394f.0000 ARPA FastEthernet0/0</span></div></div><div id="nqotVeJnjwyoUadLaYNTnZ" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Internet 192.168.1.2 0 cc02.394f.0000 ARPA FastEthernet0/0</b></span></div></div><div id="rvimmCPMhrMraiVaS5wQxN" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>R1#show arp</b></span></div></div><div id="npaWVNkfUXWpJFAUbkUbRH" class="wolai-block wolai-text"><div><span class="inline-wrap">Protocol Address Age (min) Hardware Addr Type Interface</span></div></div><div id="ghtioYiq6XoSG81ZvmdSU1" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet 192.168.1.1 - cc00.394f.0000 ARPA FastEthernet0/0</span></div></div><div id="oP8XhGzqBQxoTAUy1RCpuo" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet 192.168.1.3 6 cc02.394f.0000 ARPA FastEthernet0/0</span></div></div><div id="2NZmmjod8i2zLDmKAWgb96" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Internet 192.168.1.2 0 cc01.394f.0000 ARPA FastEthernet0/0</b></span></div></div><div id="pEepfgcAC2q6VW4GaVp8uC" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>R1#show arp</b></span></div></div><div id="mwG4d6pwVF2saXG1eDKKXR" class="wolai-block wolai-text"><div><span class="inline-wrap">Protocol Address Age (min) Hardware Addr Type Interface</span></div></div><div id="fodVgFeU89khFf6TzcYEcJ" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet 192.168.1.1 - cc00.394f.0000 ARPA FastEthernet0/0</span></div></div><div id="rn8W2DB7VoLoNbcwMsntr5" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet 192.168.1.3 6 cc02.394f.0000 ARPA FastEthernet0/0</span></div></div><div id="fkjtHmTTPoZRKPaA67bbX2" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Internet 192.168.1.2 0 cc02.394f.0000 ARPA FastEthernet0/0</b></span></div></div><div id="wkLMr6Y6xiyXAUooRM3ckt" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>R1#show arp</b></span></div></div><div id="7kJA4nXexq2PK6BqhwdDZC" class="wolai-block wolai-text"><div><span class="inline-wrap">Protocol Address Age (min) Hardware Addr Type Interface</span></div></div><div id="j15h4xj9n46FzTXAmLHRTw" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet 192.168.1.1 - cc00.394f.0000 ARPA FastEthernet0/0</span></div></div><div id="mLVhoFwQF59YhgYw1sBdxD" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet 192.168.1.3 6 cc02.394f.0000 ARPA FastEthernet0/0</span></div></div><div id="av7cnyJLKwhDZEpmbRrSg3" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Internet 192.168.1.2 0 cc01.394f.0000 ARPA FastEthernet0/0</b></span></div></div><div id="dfurhSdhB2zKTyyhzBuCLz" class="wolai-block wolai-text"><div><span class="inline-wrap">……</span></div></div><div id="fnB1bFESjJQqh92xevC524" class="wolai-block wolai-text"><div><span class="inline-wrap">可以看到，由于</span><span class="inline-wrap"><b>免费<span class="jill"></span>ARP<span class="jill"></span>是一种广播的形式，所以<span class="jill"></span>R1<span class="jill"></span>同处一个局域网可以收到，并且<span class="jill"></span>ARP<span class="jill"></span>信息被不断修改，一会将<span class="jill"></span>192.168.1.2<span class="jill"></span>指向<span class="jill"></span>R2<span class="jill"></span>的<span class="jill"></span>MAC<span class="jill"></span>地址，一会指向<span class="jill"></span>R3<span class="jill"></span>的<span class="jill"></span>MAC<span class="jill"></span>地址</b></span><span class="inline-wrap">。</span></div></div><div id="siC78U7EVAmAoMvBPJ92iB" class="wolai-block wolai-text"><div><span class="inline-wrap">这个过程会一种持续下去，直到地址做了修改，这里我们将<span class="jill"></span>R3<span class="jill"></span>的<span class="jill"></span>IP<span class="jill"></span>地址重新修改为<span class="jill"></span>192.168.1.3，之后网络便恢复了平静。</span></div></div><div id="ghAxobnzWomeY3xtKekV1r" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>总结：</b></span><span class="inline-wrap"> 通过这个虚拟网络，我们构造了路由器地址冲突的环境，同样验证了免费<span class="jill"></span>ARP<span class="jill"></span>能够检测<span class="jill"></span>IP<span class="jill"></span>地址冲突的功能，当然，这里跟<span class="jill"></span>Windows<span class="jill"></span>和<span class="jill"></span>Macos<span class="jill"></span>的处理方式有一些差别，例如<span class="jill"></span>Cisco<span class="jill"></span>路由器检测到免费<span class="jill"></span>ARP<span class="jill"></span>之后，会保持非常</span><span class="inline-wrap"><b>高频率的&quot;互怼&quot;过程</b></span><span class="inline-wrap">，然后不断报出错日志，督促管理员感觉修改地址。除此之外，数据包结构也有差异，</span><span class="inline-wrap"><b>Windows<span class="jill"></span>和<span class="jill"></span>Macos<span class="jill"></span>是&quot;自己问自己&quot;的<span class="jill"></span>arp request<span class="jill"></span>包，而<span class="jill"></span>cisco ios<span class="jill"></span>是&quot;自己答自己&quot;的<span class="jill"></span>arp reply<span class="jill"></span>包</b></span><span class="inline-wrap">。</span></div></div><h2 id="4vMpoQFQgnwrCRU2YCZ5PX" class="wolai-block"><span class="inline-wrap"><b>四、总结：地址冲突了怎么办？</b></span></h2><div id="hWVxFDuGutin9zgabRLLTV" class="wolai-block wolai-text"><div><span class="inline-wrap">①对于普通用户而言，当看到电脑弹框告警说明地址有冲突时，在不懂技术的情况下，可以</span><span class="inline-wrap"><b>尝试重启家里的路由器</b></span><span class="inline-wrap">，这样可以重新为局域网的电脑分配地址；</span></div></div><div id="df3SmrjhabsRuFQTLMUpJH" class="wolai-block wolai-text"><div><span class="inline-wrap">②路由器不是自己的，接入的是租房网络、校园网络等第三方网络，当看到电脑弹框告警说明地址有冲突时并且无法管理路由器的时候，</span><span class="inline-wrap"><b>可以尝试手工修改本机电脑的<span class="jill"></span>IP<span class="jill"></span>地址</b></span><span class="inline-wrap">，无论是<span class="jill"></span>Windows<span class="jill"></span>还是<span class="jill"></span>Macos，直接进入网卡设置修改即可，怎么做手工修改呢？例如电脑地址是<span class="jill"></span>192.168.1.1，提示冲突的话，那么</span><span class="inline-wrap"><b>可以在原有数字的基础上递增<span class="jill"></span>1<span class="jill"></span>或者<span class="jill"></span>10，直到显示不冲突</b></span><span class="inline-wrap">，例如修改为<span class="jill"></span>192.168.1.2、192.168.1.3<span class="jill"></span>或者<span class="jill"></span>192.168.1.11、192.168.1.21，以此类推..... （这种方法未必能保证解决，但是在管理员介入之前，至少算是一种解决方案）；</span></div></div><div id="VrFZi16eCa3bmkd1SnpLP" class="wolai-block wolai-text"><div><span class="inline-wrap">③对于专业的网络和安全运维人员而言，当看到网络地址冲突，则需要</span><span class="inline-wrap"><b>考虑自己的<span class="jill"></span>DHCP<span class="jill"></span>部署、IP<span class="jill"></span>地址规划有没有问题</b></span><span class="inline-wrap">，或者找出网络中是否有&quot;捣蛋鬼&quot;自己私设<span class="jill"></span>IP<span class="jill"></span>之类的；</span></div></div><div id="dyFW9u34F4vRH7wWDghoRa" class="wolai-block wolai-text"><div><span class="inline-wrap">④通过本章节的学习，我们掌握了免费<span class="jill"></span>ARP<span class="jill"></span>不同网络环境下的实现，例如&quot;自己问自己&quot;和&quot;自己答自己&quot;两种广播包方式，也了解了电脑和网络设备的不同机制。</span></div></div><div id="ghHTay95Nk3ZBEmLaqZ7LU" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>【相关推荐】</b></span><span class="inline-wrap"> </span></div></div><div id="7AuivgyG8CFQjLRGuMTuig" class="wolai-block wolai-text"><div><span class="inline-wrap">微信公众号：拼客院长陈鑫杰（搜索&quot;</span><span class="inline-wrap"><b>pingsec</b></span><span class="inline-wrap">&quot;，即刻关注）</span></div></div><div id="GAoqjpX7JnNHU1yiAem35" class="wolai-block wolai-text"><div><span class="inline-wrap">新浪微博：</span><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.weibo.com/jaykingchen"><span>@<span class="jill"></span>拼客学院陈鑫杰</span></a></span></div></div><div id="iNvpYrevrcVZyU5Exe8Vqf" class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://zhuanlan.zhihu.com/p/28865553"><span>图解<span class="jill"></span>ARP<span class="jill"></span>协议（三）ARP<span class="jill"></span>防御篇-如何揪出&quot;内鬼&quot;并&quot;优雅的还手&quot;？</span></a></span></div></div><div id="2zCSYyztbLoD6E4J2XiYrH" class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.pinginglab.net/course/4"><span>《GNS3<span class="jill"></span>从入门到精通》(精品免费视频教程）</span></a></span></div></div><div id="uBnHir6HSM4YNxASUAidND" class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.pinginglab.net/course/164"><span>《TCP/IP<span class="jill"></span>协议栈视频教程》</span></a></span><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.pinginglab.net/course/4"><span>(精品免费视频教程）</span></a></span></div></div><div id="iRZP42DCsT7UpQSW1pHAd4" class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.pinginglab.net/course/3"><span>《Wireshark<span class="jill"></span>协议分析从入门到精通》</span></a></span><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.pinginglab.net/course/4"><span>(精品免费视频教程）</span></a></span></div></div></article><footer></footer></body></html>