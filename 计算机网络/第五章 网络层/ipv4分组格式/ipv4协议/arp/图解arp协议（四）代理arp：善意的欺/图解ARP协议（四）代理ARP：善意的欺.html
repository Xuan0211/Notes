<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../../../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../../../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../../../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../../../../css/wolai.css"/><title>图解ARP协议（四）代理ARP：善意的欺骗 - 知乎 - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="图解ARP协议（四）代理ARP：善意的欺骗 - 知乎" class="main-title"></div></div></header><article><h2 id="3pnkWw6mVGKgg78qC3xeSW" class="wolai-block"><span class="inline-wrap"><b>一、代理<span class="jill"></span>ARP<span class="jill"></span>概述</b></span></h2><div id="8k51K5sUEbAWBo2QgR5nrE" class="wolai-block wolai-text"><div><span class="inline-wrap">我：</span><span class="inline-wrap"><b>当电脑要访问互联网上的服务器，目标<span class="jill"></span>MAC<span class="jill"></span>是什么？</b></span></div></div><div id="vMafcVQVTSywcU9WJ7VGpc" class="wolai-block wolai-text"><div><span class="inline-wrap">很多小伙伴在刚学习网络协议的时候，经常这样直接回应：</span><span class="inline-wrap"><b>不就是服务器的<span class="jill"></span>MAC<span class="jill"></span>嘛!</b></span></div></div><div id="bdFFLVAXSJqCAcP6NfMVFW" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-1949cb89d4fcefeac613a12ffaea7ebc_b.jpg" style="width: 1116.8px"/></figure></div><div id="kda3217fBpASSEn4j53zDA" class="wolai-block wolai-text"><div><span class="inline-wrap">这时我会反问：</span><span class="inline-wrap"><b>那电脑怎么拿到这个服务器的<span class="jill"></span>MAC<span class="jill"></span>地址呢？</b></span></div></div><div id="wbfZd8u6atKiqjhi9wK9Mn" class="wolai-block wolai-text"><div><span class="inline-wrap">小伙伴一般都自信的抛出下面两个点：</span></div></div><div id="oR7XitWUZRoHcHLaysiVtA" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>①根据网络通信中数据封装的原则，通信双方需要封装源目<span class="jill"></span>IP<span class="jill"></span>和<span class="jill"></span>MAC<span class="jill"></span>地址；</b></span></div></div><div id="mNaLQgZicyagHft1kG4wGa" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>②如果要拿到目标<span class="jill"></span>MAC<span class="jill"></span>地址，就需要通过<span class="jill"></span>ARP<span class="jill"></span>协议进行交互。</b></span><span class="inline-wrap"> </span></div></div><div id="2Vb5kVRDER9PdsZrDADc8U" class="wolai-block wolai-text"><div><span class="inline-wrap">我：好，确实没毛病，你是指的下面这个意思吧 ==&gt;</span></div></div><div id="gNzUVaHxjiqTDjBHD4qyKx" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-9e9c13063eb151a49015afb76a262cff_b.jpg" style="width: 576px"/></figure></div><div id="mchtb8VKK7z1R38xntb7j8" class="wolai-block wolai-text"><div><span class="inline-wrap">小伙伴：对对对，是这个意思的。</span></div></div><div id="jgdhJqkv2mk21kinceiCqc" class="wolai-block wolai-text"><div><span class="inline-wrap">我：好，你再看看下面这个图，再确认下。</span></div></div><div id="89XsSejDk14Tqy7Y4MUJCF" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-272f753039f57ce31f7a5fea5dff43de_b.jpg" style="width: 576px"/></figure></div><div id="aJWbA3PoecGjivj3gvK3GF" class="wolai-block wolai-text"><div><span class="inline-wrap">小伙伴：好像不太对唉，刚才没注意看...... 互联网这么多路由器，根据之前学过的：</span></div></div><div id="nWFiw2obsLLq3jy3DuUusC" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>①路由器隔离广播域，每个接口/网段都是独立的广播域；</b></span></div></div><div id="5vuAhsQpWQRn3LbGu43GLC" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>②ARP<span class="jill"></span>请求是二层广播包，广播包没法过路由器，</b></span></div></div><div id="dJKQrp1tuGLg3jtP1RWDS4" class="wolai-block wolai-text"><div><span class="inline-wrap">这样的话，ARP<span class="jill"></span>请求广播包根本没法穿越互联网到达目标服务器。</span></div></div><div id="iVfsfq2hRDpxsfrorDiyP2" class="wolai-block wolai-text"><div><span class="inline-wrap">我：那我们平常上微博逛知乎去京东剁手基本都依据上面这张图，</span><span class="inline-wrap"><b>通过<span class="jill"></span>DNS<span class="jill"></span>协议将域名解析为<span class="jill"></span>IP<span class="jill"></span>地址，通过<span class="jill"></span>ARP<span class="jill"></span>协议将<span class="jill"></span>IP<span class="jill"></span>解析为<span class="jill"></span>MAC<span class="jill"></span>地址</b></span><span class="inline-wrap">。现在<span class="jill"></span>ARP<span class="jill"></span>请求无法穿越过去，电脑便无法获取目标服务器的<span class="jill"></span>MAC<span class="jill"></span>地址，怎么跟它通信呢？</span></div></div><div id="hAgWhZHmR1WGxpJxnS4LDU" class="wolai-block wolai-text"><div><span class="inline-wrap">小伙伴：</span><span class="inline-wrap"><b>。。。。。。</b></span><span class="inline-wrap"> </span></div></div><div id="sZBsVgxobuT1C4RDJpLHyS" class="wolai-block wolai-text"><div><span class="inline-wrap">上面这个疑惑，我相信每个学习网络协议的初学者经常会问到，更普遍的情况是，很多工作多年的工程师，也未必能够将下面这几个问题完全搞清楚：</span></div></div><div id="g2x1jhbg2WjVzgd48qgWw3" class="wolai-block wolai-text"><div><span class="inline-wrap">①电脑访问互联网服务器的时候，ARP<span class="jill"></span>询问的内容，真的是问服务器的吗？</span></div></div><div id="pUmNiLQiGzMJQDmUbMXdha" class="wolai-block wolai-text"><div><span class="inline-wrap">②什么是代理<span class="jill"></span>ARP？跟<span class="jill"></span>ARP<span class="jill"></span>有什么区别？什么场景下会用到代理<span class="jill"></span>ARP？</span></div></div><div id="zhTVnYc7FK1LcJRZFFpcY" class="wolai-block wolai-text"><div><span class="inline-wrap">③代理<span class="jill"></span>ARP<span class="jill"></span>跟网关（默认路由）设置有什么关系？</span></div></div><div id="5pBqrxqLLehZenMxawPgGC" class="wolai-block wolai-text"><div><span class="inline-wrap">所以，这一篇文章虽然是讲代理<span class="jill"></span>ARP，但其实核心内容是</span><span class="inline-wrap"><b>围绕代理<span class="jill"></span>ARP，解读跨网段通信过程中，ARP/代理<span class="jill"></span>ARP/网关（默认路由）/数据封装等相关问题</b></span><span class="inline-wrap">。</span></div></div><h2 id="g575SZRBysSdzzMxF7fycQ" class="wolai-block"><span class="inline-wrap"><b>二、代理<span class="jill"></span>ARP<span class="jill"></span>原理</b></span></h2><div id="pWRiFPTcLvj9TX7d4NmBSV" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>当<span class="jill"></span>ARP<span class="jill"></span>请求目标跨网段时，网关设备收到此<span class="jill"></span>ARP<span class="jill"></span>请求，会用自己的<span class="jill"></span>MAC<span class="jill"></span>地址返回给请求者，这便是代理<span class="jill"></span>ARP（Proxy ARP）。</b></span></div></div><div id="pvNP8zT2mQH79PSBktPA9j" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-cf490c2868b7bcae3fed22a65d07dcfa_b.jpg" style="width: 576px"/></figure></div><div id="gWLhzwikbAsu2FQb8L7FxK" class="wolai-block wolai-text"><div><span class="inline-wrap">上面这张图中，电脑发送<span class="jill"></span>ARP<span class="jill"></span>请求服务器<span class="jill"></span>8.8.8.8<span class="jill"></span>的<span class="jill"></span>MAC<span class="jill"></span>地址，路由器（网关）收到这个请求时会进行判断，由于目标<span class="jill"></span>8.8.8.8<span class="jill"></span>不属于本网段（即跨网段），此时便返回自己的接口<span class="jill"></span>MAC<span class="jill"></span>地址给<span class="jill"></span>PC，后续电脑访问服务器时，目标<span class="jill"></span>MAC<span class="jill"></span>直接封装为<span class="jill"></span>MAC254。</span></div></div><div id="qdnTpD7mikveUDrte9p8JR" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>代理<span class="jill"></span>ARP<span class="jill"></span>本质是一个&quot;善意的欺骗&quot;，是一个&quot;错位&quot;的映射</b></span><span class="inline-wrap">。从图中我们看到服务器地址的正常映射是&lt;8.8.8.8-MAC2&gt;，而路由器返回给电脑的，却是 &lt;8.8.8.8-MAC254&gt;。</span><span class="inline-wrap"><b>不管是不是&quot;欺骗&quot;，至少最终电脑可以与外网的服务器实现通信</b></span><span class="inline-wrap">，以<span class="jill"></span>PC Ping Server<span class="jill"></span>为例=&gt;</span></div></div><div id="iou7jzypr17VjNUoFRR6ew" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-7890a7e816dee27fb135c1855cdc57ae_b.jpg" style="width: 576px"/></figure></div><div id="kEB3hMeP6eU5Pza2HFutx7" class="wolai-block wolai-text"><div><span class="inline-wrap">实际网络中，代理<span class="jill"></span>ARP<span class="jill"></span>由网络中的网关设备来执行，包括路由器、多层交换机、无线路由器、防火墙等设备。并且，网关即便有代理<span class="jill"></span>ARP<span class="jill"></span>功能，也未必一定执行，还必须满足两个条件：</span><span class="inline-wrap"><b>①网关已经开启代理<span class="jill"></span>ARP<span class="jill"></span>功能；②网关有目标的路由信息。</b></span><span class="inline-wrap"> 我们来看下面这张图=&gt;</span></div></div><div id="b3EXcoPrHPiMm1PYw8bEkm" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-3ad1bab63d9deff26258d9af8f08acc0_b.jpg" style="width: 576px"/></figure></div><div id="6T8nY83CD8uYp3JJEb4wZQ" class="wolai-block wolai-text"><div><span class="inline-wrap">上面这张图中，我们假设路由器已具备全网的路由，但</span><span class="inline-wrap"><b>连接电脑的接口没有开启（或不支持）代理<span class="jill"></span>ARP<span class="jill"></span>功能</b></span><span class="inline-wrap">，此时便造成一个尴尬的情况：电脑反复询问到<span class="jill"></span>8.8.8.8<span class="jill"></span>的<span class="jill"></span>MAC<span class="jill"></span>地址，路由器收到之后，处理流程跟正常<span class="jill"></span>ARP<span class="jill"></span>是一致的，&quot;问自己的回复，不是问自己的丢弃&quot;。因此，</span><span class="inline-wrap"><b>当网络通信采用代理<span class="jill"></span>ARP<span class="jill"></span>时，可能会&quot;受制于沿途网关设备&quot;，造成网络通信故障</b></span><span class="inline-wrap">。</span></div></div><div id="wfqrrnBK5AEE2JewNdNTg1" class="wolai-block wolai-text"><div><span class="inline-wrap">进一步思考：</span><span class="inline-wrap"><b>既然代理<span class="jill"></span>ARP<span class="jill"></span>不是一种特别流畅的实现，会&quot;受限于别人&quot;，那我们没必要一定要使用它。甚至，这里我们需要搞清一个事实：实际网络中，无论是同网段还是跨网段通信（例如访问互联网），绝大情况下都是使用正常的<span class="jill"></span>ARP，而不是代理<span class="jill"></span>ARP。</b></span><span class="inline-wrap"> 生活中的上网的经验也已经告诉我们，好像从来没有遇到或听到过&quot;XXX<span class="jill"></span>设备不支持代理<span class="jill"></span>ARP<span class="jill"></span>功能，导致通信故障&quot;这样的问题。</span></div></div><div id="dWzXQkZXyKB18e2ySgp49F" class="wolai-block wolai-text"><div><span class="inline-wrap">很多小伙伴看到这里，会有大大的疑惑：</span></div></div><div id="rMAVSEsqLSTZtnRwjRU73d" class="wolai-block wolai-text"><div><span class="inline-wrap">① &quot;什么! 我们才刚学习了代理<span class="jill"></span>ARP<span class="jill"></span>的实现原理，现在居然告诉说它没怎么用？&quot;</span></div></div><div id="4FZywStxSC8jMncBjyA3Bj" class="wolai-block wolai-text"><div><span class="inline-wrap">② 那</span><span class="inline-wrap"><b>为什么要创造代理<span class="jill"></span>ARP，它的真正使用场景在哪里？？</b></span></div></div><div id="5gXw7jRhTiLyGKjz6k9Cwh" class="wolai-block wolai-text"><div><span class="inline-wrap">③ 上述图解中，</span><span class="inline-wrap"><b>电脑跨网段通信时<span class="jill"></span>ARP<span class="jill"></span>到底是如何工作的？？？</b></span></div></div><div id="7Xx1TVFbiSjfUgxTNVtB24" class="wolai-block wolai-text"><div><span class="inline-wrap">接下来给大家划重点：</span></div></div><div id="2ACus33FSaJEgjqbPnQR63" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>第一，代理<span class="jill"></span>ARP<span class="jill"></span>仅仅是正常<span class="jill"></span>ARP<span class="jill"></span>的一个拓展使用，是可选项而不是必要项；</b></span></div></div><div id="2MQQrekS32eU7n3Us2YwTb" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>第二：代理<span class="jill"></span>ARP<span class="jill"></span>有特定的应用场景，与网关/路由的设置有直接关系：当电脑没有网关/路由功能时，并且需要跨网站通信时，则会触发代理<span class="jill"></span>ARP。换句话说，如果有网关/路由功能，则不需要代理<span class="jill"></span>ARP；</b></span></div></div><div id="upUr7GAuZ2Wm4HWx17y2B5" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>第三：正常环境下，当用户接入网络时，都会通过<span class="jill"></span>DHCP<span class="jill"></span>协议或手工配置的方式得到<span class="jill"></span>IP<span class="jill"></span>和网关信息（所以不需要代理<span class="jill"></span>ARP）。</b></span><span class="inline-wrap"> </span></div></div><h2 id="fda87R5s7N5nut9ETietbV" class="wolai-block"><span class="inline-wrap"><b>三、ARP<span class="jill"></span>与代理<span class="jill"></span>ARP：不是互斥而是互补</b></span></h2><div id="dzjwzGst9L4BQRAEjhKGdD" class="wolai-block wolai-text"><div><span class="inline-wrap">在大家理解了代理<span class="jill"></span>ARP<span class="jill"></span>的工作原理和应用场景之后，接下来我们终于可以更加全面的分析开篇的这个经典问题：</span><span class="inline-wrap"><b>当用户访问互联网的时候，到底用<span class="jill"></span>ARP<span class="jill"></span>还是代理<span class="jill"></span>ARP？跟网关/路由设置有什么关系？数据封装又有什么区别？</b></span></div></div><div id="jCH5d6nCRqwhCf5zAJ7qT1" class="wolai-block wolai-text"><div><span class="inline-wrap">我们通过下面两张图做个对比=&gt;</span></div></div><div id="r5wLqMueTEMjHmDUkPbVUi" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>当电脑没有网关时，PC Ping 8.8.8.8，采用代理<span class="jill"></span>ARP =&gt;</b></span></div></div><div id="p5f8LKMeUU8TTBhL2gehHa" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-7199b1ecd19e2e0f8c96674fb5cc08c0_b.jpg" style="width: 576px"/></figure></div><div id="2WkTYpEDLYDaMBbRDmcCd8" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>当电脑有网关时，PC Ping 8.8.8.8，采用正常<span class="jill"></span>ARP =&gt;</b></span></div></div><div id="xiSEHHXem3mNVgXQfV5Tmb" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-372458f6469f7a4e845e84f0f9bdf199_b.jpg" style="width: 576px"/></figure></div><div id="mAy18An3BrTY1NEGe12oma" class="wolai-block wolai-text"><div><span class="inline-wrap">通过上面的对比，我们得到以下信息：</span></div></div><div id="eqmJAmEH3kXsk8SqooKFVa" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>①电脑没有网关时，ARP<span class="jill"></span>直接询问目标<span class="jill"></span>IP<span class="jill"></span>对应的<span class="jill"></span>MAC<span class="jill"></span>地址（跨网段），采用代理<span class="jill"></span>ARP；</b></span></div></div><div id="eVMQ3yDYpLutdUAEiDmjHs" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>②电脑有网关时，ARP<span class="jill"></span>只需询问网关<span class="jill"></span>IP<span class="jill"></span>对应的<span class="jill"></span>MAC<span class="jill"></span>地址（同网段），采用正常<span class="jill"></span>ARP；</b></span></div></div><div id="9zidUaiWWSDY7g3qihnozo" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>③无论是正常<span class="jill"></span>ARP<span class="jill"></span>还是代理<span class="jill"></span>ARP，电脑最终都拿到同一个目标<span class="jill"></span>MAC<span class="jill"></span>地址：网关<span class="jill"></span>MAC。</b></span><span class="inline-wrap"> </span></div></div><div id="mNPx67Qqst5N3J2xdDb9Fb" class="wolai-block wolai-text"><div><span class="inline-wrap">为了让上面这个总结更加的通用性，我们将原有的网络拓扑稍微复杂化 =&gt;  </span></div></div><div id="qdhus9cmwKMtfpTBTZR5Hp" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>当电脑没有网关时（采用代理<span class="jill"></span>ARP ），PC 依次<span class="jill"></span>Ping 8.8.8.8、8.8.4.4、114.114.114.114=&gt;</b></span></div></div><div id="otFkP1Kk453U9hbfosn3di" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-b11fb72b4a000e399d9a45f2c8f5d013_b.jpg" style="width: 576px"/></figure></div><div id="wS9E7rGT3TdfEbVPhmCmFG" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>当电脑有网关时（采用正常<span class="jill"></span>ARP ），PC 依次<span class="jill"></span>Ping 8.8.8.8、8.8.4.4、114.114.114.114=&gt;</b></span></div></div><div id="55TVg5mPmdTxTnFpHPQMp9" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-749ffbf5dd00e47b19b4c8351880de33_b.jpg" style="width: 576px"/></figure></div><div id="2p52tZ2v3jLm8LYy4hPgkA" class="wolai-block wolai-text"><div><span class="inline-wrap">通过上面的拓扑，我们可以得到更加通用性的总结，归纳如下：</span></div></div><div id="cyEgdaMUsH7chLg49nQVwg" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>①当电脑没有网关（采用代理<span class="jill"></span>ARP）时：&quot;跨网段访问谁，就问谁的<span class="jill"></span>MAC&quot;</b></span></div></div><div id="6qrWBqRPNh5ZypdEN8PWGi" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>②当电脑有网关（采用正常<span class="jill"></span>ARP）时：&quot;跨网段访问谁，都问网关的<span class="jill"></span>MAC&quot;</b></span></div></div><div id="3Wd1GR7Gy4wceLhBeSBKxB" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>③无论哪种<span class="jill"></span>ARP，跨网段通信时，发送方请求得到的目标<span class="jill"></span>MAC<span class="jill"></span>地址都是网关<span class="jill"></span>MAC。</b></span><span class="inline-wrap"> </span></div></div><div id="osxPk91rEkn6Azv5rw3hJU" class="wolai-block wolai-text"><div><span class="inline-wrap">注明：</span><span class="inline-wrap"><b>网关（Gateway）、下一跳（Next-hop）、路由器（Router）都指的是离发送方最近的三层（或多层）设备，具备三层和路由转发功能。</b></span><span class="inline-wrap"> 举例：我们通过<span class="jill"></span>WiFi<span class="jill"></span>上网时，网关就是无线路由器，它帮忙将电脑和手机的数据转发到互联网；</span><span class="inline-wrap"><b>所以，我们访问互联网时（无论访问谁），电脑和手机采用的目的<span class="jill"></span>MAC，都是无线路由器的<span class="jill"></span>MAC</b></span><span class="inline-wrap">。有兴趣的小伙伴都可以跟着我验证下（请见下面章节）。</span></div></div><h2 id="9we2tL1Hdcpk34owCVuq5f" class="wolai-block"><span class="inline-wrap"><b>四、ARP<span class="jill"></span>与代理<span class="jill"></span>ARP<span class="jill"></span>实战指南</b></span></h2><div id="ov9FFB1xpkd5YNDUTaihb7" class="wolai-block wolai-text"><div><span class="inline-wrap">为了让大家更直观理解，真正**&quot;亲眼所见&quot;</span><span class="inline-wrap"><b>上面学到的技术原理，这里我带大家</b></span><span class="inline-wrap">在真实网络和虚拟环境分别验证**。第一个实验，主要是针对没任何命令基础的小伙伴，大家可以在家就可以实验；第二个实验，主要针对有一定网络和安全基础的小伙伴，通过构造网络虚拟实验环境来验证。</span></div></div><div id="kvv8apNwv6bZ7c5BaoiWq1" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>（一）真实网络下<span class="jill"></span>ARP<span class="jill"></span>与代理<span class="jill"></span>ARP<span class="jill"></span>实验</b></span></div></div><div id="wCAhxxYhxaX7bpj6nYn84x" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-c950317c70003e20fd2f05616af3e24d_b.png" style="width: 576px"/></figure></div><div id="meRSUfKiUCes3ZpxV3oRk7" class="wolai-block wolai-text"><div><span class="inline-wrap">这个网络中，我的电脑地址是<span class="jill"></span>192.168.199.177，连接到极路由（无线路由器），通过极路由器访问互联网。这个<span class="jill"></span>WiFi<span class="jill"></span>网络的主机列表情况如下，这里的<span class="jill"></span>PC<span class="jill"></span>就是我的<span class="jill"></span>Macbook。</span></div></div><div id="gnPDE7QsUbCjRgHDp2eV2s" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-712c8b1f06f48272407c7db44cfa8f31_b.jpg" style="width: 576px"/></figure></div><div id="mAQtyjJ4eW8vVeEdTouPQF" class="wolai-block wolai-text"><div><span class="inline-wrap">接下来再看看极路由<span class="jill"></span>MAC<span class="jill"></span>地址=&gt;</span></div></div><div id="4sSSiWwgMmp6GSRXkPRgwF" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-9cc3faa98096af00a1728c5238fdb26d_b.jpg" style="width: 888px"/></figure></div><div id="wrJzz4LVN2uZQs8SUEZ6H1" class="wolai-block wolai-text"><div><span class="inline-wrap">查看我的电脑(Macox<span class="jill"></span>系统）IP<span class="jill"></span>地址和网关信息，通过命令**&quot;ifconfig&quot;</span><span class="inline-wrap"><b>查看<span class="jill"></span>ip<span class="jill"></span>地址=&gt;（Windows<span class="jill"></span>系统则通过</b></span><span class="inline-wrap">&quot;ipconfig /all&quot;**查看<span class="jill"></span>IP<span class="jill"></span>地址和网关信息）</span></div></div><div id="dkNfTAgtGAMB5EfxDMzi33" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-64f827892e31310a1bd0ab02a7ab9e6c_b.jpg" style="width: 576px"/></figure></div><div id="sVswB5UqxMHfNf6tMYWHvs" class="wolai-block wolai-text"><div><span class="inline-wrap">通过命令**&quot;netstat -rn&quot;**查看我的电脑网关设置=&gt;</span></div></div><div id="aEMHhqNXx3JJBgfgAq8dTa" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-00f54ba1ebc75fe3d850ff505b994039_b.jpg" style="width: 918.4px"/></figure></div><div id="kGLaAEu8112PPEBpBQjg1i" class="wolai-block wolai-text"><div><span class="inline-wrap">接下来，我的电脑连续</span><span class="inline-wrap"><b>PING 8.8.8.8<span class="jill"></span>和<span class="jill"></span>114.114.114.114</b></span><span class="inline-wrap">或其他外网地址=&gt;</span></div></div><div id="w3rkrv17e7t2iFo8BXkUUR" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-9b88079d634462b0b53d6504e65bc065_b.jpg" style="width: 576px"/></figure></div><div id="jns7j9x3VK7WsNR3VyRH11" class="wolai-block wolai-text"><div><span class="inline-wrap">重点来了，在我的电脑连续访问这么多外网地址之后，我们来看看</span><span class="inline-wrap"><b>ARP<span class="jill"></span>表项是怎样的，是否有<span class="jill"></span>8.8.8.8、114.114.114.114、</b></span><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.pinginglab.net"><span><b>http://www.pinginglab.net</b></span></a></span><span class="inline-wrap"><b>（120.24.59.68）对应的<span class="jill"></span>MAC<span class="jill"></span>呢？</b></span></div></div><div id="cZVrbVwKxYkLhvwwZiKikC" class="wolai-block wolai-text"><div><span class="inline-wrap">通过命令**&quot;arp -a&quot;**查看电脑的<span class="jill"></span>ARP<span class="jill"></span>缓存信息=&gt;</span></div></div><div id="3vk5am5dLZ6Br3bnV4uova" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-30c9c19de4bbb449eec6562e52dbe00f_b.jpg" style="width: 939.2px"/></figure></div><div id="oqBAEMXsDSvjnfm3YjH1qo" class="wolai-block wolai-text"><div><span class="inline-wrap">从最终的<span class="jill"></span>ARP<span class="jill"></span>内容来看，</span><span class="inline-wrap"><b>我的电脑只记录着本机和网关的<span class="jill"></span>MAC<span class="jill"></span>地址，MAC<span class="jill"></span>地址&quot;d4:ee-07:54:c1:9e&quot;就是上面给大家截图的极路由<span class="jill"></span>MAC。</b></span><span class="inline-wrap"> </span></div></div><div id="ecQQLcpxTS6mpH6zVcdoFT" class="wolai-block wolai-text"><div><span class="inline-wrap">通过这个真实网络的实验，我们可以验证了以下内容：</span></div></div><div id="vtYq9CqNTqm5AirCGpdEcC" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>①真实网络中一般都是正常<span class="jill"></span>ARP，而不是代理<span class="jill"></span>ARP；</b></span></div></div><div id="9rEEW847gEmCyLNR8P8MCJ" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>②当电脑有网关（采用正常<span class="jill"></span>ARP）时，无论跨网段访问谁，都直接问网关的<span class="jill"></span>MAC；</b></span></div></div><div id="oHxkaJwKrL6C8XMZPyjo4n" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>③当第一次获取网关<span class="jill"></span>MAC<span class="jill"></span>之后，后续的通信都不再需要重新进行<span class="jill"></span>ARP<span class="jill"></span>请求。（这个是比较容易忽略的，而代理<span class="jill"></span>ARP<span class="jill"></span>每次访问新的外网地址，都需要再次请求）</b></span></div></div><div id="vD6JozLfsySbXjMETxZkkp" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>（二）虚拟环境下<span class="jill"></span>ARP<span class="jill"></span>与代理<span class="jill"></span>ARP<span class="jill"></span>实验</b></span></div></div><div id="d5S79qxCEJUAuxKLMFQXNz" class="wolai-block wolai-text"><div><span class="inline-wrap">网络拓扑采用</span><span class="inline-wrap"><b>GNS3<span class="jill"></span>搭建</b></span><span class="inline-wrap">，采用<span class="jill"></span>C3640<span class="jill"></span>操作系统镜像=&gt;</span></div></div><div id="hSZssWbNYSLM5Th6SMdc8s" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-61b3ccec4a58f035cf2a5321491b9739_b.jpg" style="width: 1048px"/></figure></div><div id="28riAwpwp5rqKNHNTs8dHy" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>① 首先为各个设备打开接口并配置<span class="jill"></span>IP<span class="jill"></span>地址：</b></span><span class="inline-wrap"> </span></div></div><div id="eackzT9ctUcwUENo52pmCq" class="wolai-block wolai-text"><div><span class="inline-wrap">PC(config)#int f0/0</span></div></div><div id="8W1Z8SLAqjPcxea1D6gHcK" class="wolai-block wolai-text"><div><span class="inline-wrap">PC(config-if)#no shutdown</span></div></div><div id="2zs3vasZAgNTeLHthUh4GQ" class="wolai-block wolai-text"><div><span class="inline-wrap">PC(config-if)#ip address 192.168.1.1 255.255.255.0</span></div></div><div id="6MQ43pYDAjus6N3M1VBmWA" class="wolai-block wolai-text"><div><span class="inline-wrap">Router(config)#int f0/0</span></div></div><div id="kGLHr5BG3oy4vVhDLTV6xG" class="wolai-block wolai-text"><div><span class="inline-wrap">Router(config-if)#no shutdown</span></div></div><div id="6pPJZrf5mS1izRbJPifeXy" class="wolai-block wolai-text"><div><span class="inline-wrap">Router(config-if)#ip address 192.168.1.254 255.255.255.0</span></div></div><div id="61icuzuYStxT7ujEY4NYtV" class="wolai-block wolai-text"><div><span class="inline-wrap">Router(config-if)#int f1/0</span></div></div><div id="mn5emTTormjGPCRxVZZNCk" class="wolai-block wolai-text"><div><span class="inline-wrap">Router(config-if)#no shutdown</span></div></div><div id="2kEeYDAYtTfnmQWQ1DpCeY" class="wolai-block wolai-text"><div><span class="inline-wrap">Router(config-if)#ip address 8.8.8.1 255.255.255.0</span></div></div><div id="mkBaG1eMFX1pa966ioBnBM" class="wolai-block wolai-text"><div><span class="inline-wrap">Server(config)#int f0/0</span></div></div><div id="6m8NEGAnBLebEEc4PfZbag" class="wolai-block wolai-text"><div><span class="inline-wrap">Server(config-if)#no shutdown</span></div></div><div id="d8krdQcYU1f1npcHiZivmn" class="wolai-block wolai-text"><div><span class="inline-wrap">Server(config-if)#ip address 8.8.8.8 255.255.255.0</span></div></div><div id="i2SrMrSB7M3hNHhm4Ppvi6" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>②为各个设备设置路由信息：</b></span><span class="inline-wrap"> </span></div></div><div id="o5oFkWsjCRbh3zPeERR756" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>a.关闭<span class="jill"></span>PC<span class="jill"></span>上路由功能，模拟主机并查看路由表（此时的电脑没有设置网关）</b></span></div></div><div id="r66Tu4zS4t9zEBUTCuzr4b" class="wolai-block wolai-text"><div><span class="inline-wrap">PC(config)#</span><span class="inline-wrap"><b>no ip routing</b></span></div></div><div id="uXxREBNqPRuG7CzDZjCQLz" class="wolai-block wolai-text"><div><span class="inline-wrap">PC#</span><span class="inline-wrap"><b>show ip route</b></span></div></div><div id="gRPLpAwgd5YBCgnvJgdtB5" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Default gateway is not set</b></span></div></div><div id="xeYGeFR3tzVkH7c9WMrpaK" class="wolai-block wolai-text"><div><span class="inline-wrap">Host Gateway Last Use Total Uses Interface</span></div></div><div id="gPQKdj6WrEg6VHNHKBYzqy" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>b.设置并查看<span class="jill"></span>Router<span class="jill"></span>和<span class="jill"></span>Server<span class="jill"></span>路由表，保证联通，模拟互联网</b></span><span class="inline-wrap">（这里<span class="jill"></span>Router<span class="jill"></span>已有全网的直连路由，Server<span class="jill"></span>需要设置返回内网的路由；实际环境应该通过<span class="jill"></span>NAT<span class="jill"></span>返回，这里不再深入）</span></div></div><div id="mWBp9EDccks7WfsUnQmiM4" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Router#show ip route</b></span></div></div><div id="4fciqdSK85CQS1PNf2rsTm" class="wolai-block wolai-text"><div><span class="inline-wrap">Codes: C - connected, S - static, R - RIP, M - mobile, B - BGP</span></div></div><div id="mPx8mqs2dkbn8ne5KbT4qM" class="wolai-block wolai-text"><div><span class="inline-wrap">D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area</span></div></div><div id="vdsc8mpQrYqky7DNDcZPkf" class="wolai-block wolai-text"><div><span class="inline-wrap">N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2</span></div></div><div id="k8gBxXoWBAuCzRrHN2MoKS" class="wolai-block wolai-text"><div><span class="inline-wrap">E1 - OSPF external type 1, E2 - OSPF external type 2</span></div></div><div id="u6vXGLZF9FPG2Yq1zR58kj" class="wolai-block wolai-text"><div><span class="inline-wrap">i - IS-IS, su - IS-IS summary, L1 - IS-IS level-1, L2 - IS-IS level-2</span></div></div><div id="gbNsReta1TPzb5LqjYbXF" class="wolai-block wolai-text"><div><span class="inline-wrap">ia - IS-IS inter area, * - candidate default, U - per-user static route</span></div></div><div id="jQmyV6c8ZeKNKinUycmuCi" class="wolai-block wolai-text"><div><span class="inline-wrap">o - ODR, P - periodic downloaded static route</span></div></div><div id="jgKcpFrADeApdVrzCtGp8K" class="wolai-block wolai-text"><div><span class="inline-wrap">Gateway of last resort is not set</span></div></div><div id="v7AdeRVNWnYkYHC64nw5zb" class="wolai-block wolai-text"><div><span class="inline-wrap">8.0.0.0/24 is subnetted, 1 subnets</span></div></div><div id="5tVt6LCd9SxLhjhzN7qzNE" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>C 8.8.8.0 is directly connected, FastEthernet1/0</b></span></div></div><div id="e6CP5sZsSXdUTqS4ZiH4Pa" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>C 192.168.1.0/24 is directly connected, FastEthernet0/0</b></span></div></div><div id="ii58RpDn4NQoSFtakB3YDp" class="wolai-block wolai-text"><div><span class="inline-wrap">Server(config)#</span><span class="inline-wrap"><b>ip route 192.168.1.0 255.255.255.0 8.8.8.1</b></span></div></div><div id="4RAkocuaA8mFiz9LSRWKZf" class="wolai-block wolai-text"><div><span class="inline-wrap">Server#</span><span class="inline-wrap"><b>show ip route</b></span></div></div><div id="vH4ugHnyaZD5axehC6aLPF" class="wolai-block wolai-text"><div><span class="inline-wrap">Codes: C - connected, S - static, R - RIP, M - mobile, B - BGP</span></div></div><div id="jf2HJGJ3cRNWZ2HKogquZA" class="wolai-block wolai-text"><div><span class="inline-wrap">D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area</span></div></div><div id="fx1NbDjn5w53mMB9EznMXk" class="wolai-block wolai-text"><div><span class="inline-wrap">N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2</span></div></div><div id="7gBQt5Khesfxs9NQqyCRAS" class="wolai-block wolai-text"><div><span class="inline-wrap">E1 - OSPF external type 1, E2 - OSPF external type 2</span></div></div><div id="etLfMfDSweB5FzTNhNtWjg" class="wolai-block wolai-text"><div><span class="inline-wrap">i - IS-IS, su - IS-IS summary, L1 - IS-IS level-1, L2 - IS-IS level-2</span></div></div><div id="aEL9GjubHa8vBR1GNFGsQs" class="wolai-block wolai-text"><div><span class="inline-wrap">ia - IS-IS inter area, * - candidate default, U - per-user static route</span></div></div><div id="7wMggyUyugEbSUB1Jk13aZ" class="wolai-block wolai-text"><div><span class="inline-wrap">o - ODR, P - periodic downloaded static route</span></div></div><div id="9tnWg9eqHQF8x6KixPnoxY" class="wolai-block wolai-text"><div><span class="inline-wrap">Gateway of last resort is not set</span></div></div><div id="qPnW72rpLm7s72chRdJEsU" class="wolai-block wolai-text"><div><span class="inline-wrap">8.0.0.0/24 is subnetted, 1 subnets</span></div></div><div id="9iZpmwi4REhED2JVaWYK4Z" class="wolai-block wolai-text"><div><span class="inline-wrap">C 8.8.8.0 is directly connected, FastEthernet0/0</span></div></div><div id="cupz4QjgMYng4em3FaLDSW" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>S 192.168.1.0/24 [1/0] via 8.8.8.1</b></span></div></div><div id="9zZiQmwuVfjihCpoULst4A" class="wolai-block wolai-text"><div><span class="inline-wrap">③查看<span class="jill"></span>PC/Router/Server<span class="jill"></span>的接口<span class="jill"></span>MAC<span class="jill"></span>地址：</span></div></div><div id="sboKFmdDp9n89S5eWJhGfe" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>PC#show int f0/0</b></span></div></div><div id="iM747PnrNFQrrvQkUJ3XkX" class="wolai-block wolai-text"><div><span class="inline-wrap">FastEthernet0/0 is up, line protocol is up</span></div></div><div id="7G23LbXugK35W8xMk1xUpZ" class="wolai-block wolai-text"><div><span class="inline-wrap">Hardware is AmdFE, address is </span><span class="inline-wrap"><b>cc05.1f56.0000 (bia cc05.1f56.0000)</b></span></div></div><div id="q3J9Go7jdjw4BB5URX5GJc" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet address is 192.168.1.1/24</span></div></div><div id="cafwqU7wbupDnAQ7TrtMtS" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Router#show int f0/0</b></span></div></div><div id="9263C3GFLdj7HzvT4mDXtz" class="wolai-block wolai-text"><div><span class="inline-wrap">FastEthernet0/0 is up, line protocol is up</span></div></div><div id="2cpcc7a1pQtU2GZzwrvS9" class="wolai-block wolai-text"><div><span class="inline-wrap">Hardware is AmdFE, address is </span><span class="inline-wrap"><b>cc07.1f56.0000 (bia cc07.1f56.0000)</b></span></div></div><div id="3t4m4TPT2pPnB4TrGfPxGn" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet address is 192.168.1.254/24</span></div></div><div id="3CxzebswuYdDiTTGCiHVXt" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Router#show int f1/0</b></span></div></div><div id="3WnNnH8ZakQ69Zpt9kagnZ" class="wolai-block wolai-text"><div><span class="inline-wrap">FastEthernet1/0 is up, line protocol is up</span></div></div><div id="d66uctX2HtZ5HhSgt5MtVT" class="wolai-block wolai-text"><div><span class="inline-wrap">Hardware is AmdFE, address is </span><span class="inline-wrap"><b>cc07.1f56.0010 (bia cc07.1f56.0010)</b></span></div></div><div id="aL6oqdQ6i11RRAVdRrmeTd" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet address is 8.8.8.1/24</span></div></div><div id="orRkqGLnFebyUFL7L3H9a4" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Server#show int f0/0</b></span></div></div><div id="whWWEm24ekDryaaJX58Cdv" class="wolai-block wolai-text"><div><span class="inline-wrap">FastEthernet0/0 is up, line protocol is up</span></div></div><div id="3rr6gUzt3gnHnojZZrCC8J" class="wolai-block wolai-text"><div><span class="inline-wrap">Hardware is AmdFE, address is </span><span class="inline-wrap"><b>cc06.1f56.0000 (bia cc06.1f56.0000)</b></span></div></div><div id="g35fRdxChffjUQ4ywj1VBa" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet address is 8.8.8.8/24</span></div></div><div id="9c5Kn6QpvTDqdn7JtcPbGA" class="wolai-block wolai-text"><div><span class="inline-wrap">④通过</span><span class="inline-wrap"><b>Wireshark<span class="jill"></span>抓取<span class="jill"></span>PC<span class="jill"></span>和<span class="jill"></span>Router<span class="jill"></span>链路的数据包</b></span><span class="inline-wrap">，并让<span class="jill"></span>PC ping Server（8.8.8.8），查看<span class="jill"></span>ARP<span class="jill"></span>问答信息：</span></div></div><div id="uHiF4xgZZAUUEgeRJhgUYC" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>PC#ping 8.8.8.8</b></span></div></div><div id="nSBKfguSJRW2VN4QSwRP6n" class="wolai-block wolai-text"><div><span class="inline-wrap">Type escape sequence to abort.</span></div></div><div id="wWpLx5JKBbtNjYcrsQ1eoC" class="wolai-block wolai-text"><div><span class="inline-wrap">Sending 5, 100-byte ICMP Echos to 8.8.8.8, timeout is 2 seconds:</span></div></div><div id="wfffVZ8YuM1bRevAWfz1Jv" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>.!!!! （一个<span class="jill"></span>ping<span class="jill"></span>来回为一个 ! 标识，而第一个点 . 代表此时正在<span class="jill"></span>arp）</b></span></div></div><div id="smSXNgiFh7n5RhGb4bwHVB" class="wolai-block wolai-text"><div><span class="inline-wrap">Success rate is 80 percent (4/5), round-trip min/avg/max = 44/47/48 ms</span></div></div><div id="vmVegZiij4vpmxPBxttyZz" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-c921ead97015579d00390d7d46ab1396_b.jpg" style="width: 576px"/></figure></div><div id="aNv57vEp1mRxxaWZna9wUK" class="wolai-block wolai-text"><div><span class="inline-wrap">从数据包可以看到，</span><span class="inline-wrap"><b>由于<span class="jill"></span>PC<span class="jill"></span>没有设置默认网关，所以直接采用代理<span class="jill"></span>ARP<span class="jill"></span>方式询问：</b></span><span class="inline-wrap"> 即直接询问跨网段目的<span class="jill"></span>8.8.8.8<span class="jill"></span>的<span class="jill"></span>IP<span class="jill"></span>地址。而由于路由器<span class="jill"></span>Router<span class="jill"></span>默认开启了代理<span class="jill"></span>ARP<span class="jill"></span>功能，所以直接用自己的<span class="jill"></span>MAC<span class="jill"></span>地址回应了。</span><span class="inline-wrap"><b>这里的<span class="jill"></span>cc:07:1f:56:00:00<span class="jill"></span>即路由器的<span class="jill"></span>MAC<span class="jill"></span>地址</b></span><span class="inline-wrap">。这里顺便查看下<span class="jill"></span>PC<span class="jill"></span>的<span class="jill"></span>arp<span class="jill"></span>表：</span></div></div><div id="miLxu7yZ9x8VdiERjvgVKc" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>PC#show arp</b></span></div></div><div id="b1ZUwBfhTfCfP9y2xpcAam" class="wolai-block wolai-text"><div><span class="inline-wrap">Protocol Address Age (min) Hardware Addr Type Interface</span></div></div><div id="9NKh1K4zygqdxvGBAKN39f" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Internet 8.8.8.8 9 cc07.1f56.0000 ARPA FastEthernet0/0</b></span></div></div><div id="wccKNk6zqpnogX31VX3brb" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet 192.168.1.1 - cc05.1f56.0000 ARPA FastEthernet0/0</span></div></div><div id="gxRFtvR9vW4Q5gDNuXepEW" class="wolai-block wolai-text"><div><span class="inline-wrap">因此，这里便验证了：</span><span class="inline-wrap"><b>当电脑没有设置网关信息，则采用代理<span class="jill"></span>ARP。</b></span><span class="inline-wrap"> </span></div></div><div id="jpVNFMQDGvt4tHVyLXPVhz" class="wolai-block wolai-text"><div><span class="inline-wrap">我们接着验证另外一个点：</span><span class="inline-wrap"><b>当采用代理<span class="jill"></span>ARP<span class="jill"></span>时，会&quot;受限于沿途网关设备</b></span><span class="inline-wrap">&quot;，例如网关设备（路由器）可能不支持代理<span class="jill"></span>ARP<span class="jill"></span>或关闭代理<span class="jill"></span>ARP<span class="jill"></span>功能，此时电脑就</span><span class="inline-wrap"><b>无法与外网<span class="jill"></span>IP<span class="jill"></span>实现通信</b></span><span class="inline-wrap">。</span></div></div><div id="tJr61tn9J2jf845PovBotL" class="wolai-block wolai-text"><div><span class="inline-wrap">怎么验证呢？这里我们需要</span><span class="inline-wrap"><b>关闭路由器接口的代理<span class="jill"></span>ARP<span class="jill"></span>功能</b></span><span class="inline-wrap">，并且</span><span class="inline-wrap"><b>清空电脑<span class="jill"></span>PC<span class="jill"></span>的<span class="jill"></span>arp<span class="jill"></span>表</b></span><span class="inline-wrap">=&gt;</span></div></div><div id="2AeWAEvprsCbm8Fy9pB4Q1" class="wolai-block wolai-text"><div><span class="inline-wrap">Router(config)#int f0/0</span></div></div><div id="trxPwoghmVwuXne7DRhdYv" class="wolai-block wolai-text"><div><span class="inline-wrap">Router(config-if)#</span><span class="inline-wrap"><b>no ip proxy-arp</b></span></div></div><div id="mpZSpwi9K9qerHXaJhAmMJ" class="wolai-block wolai-text"><div><span class="inline-wrap">PC#</span><span class="inline-wrap"><b>clear arp</b></span></div></div><div id="bRGnw9qPW856VTzPyRc322" class="wolai-block wolai-text"><div><span class="inline-wrap">PC#ping 8.8.8.8</span></div></div><div id="2VCFFTCUjYrJhnvxkZZXFD" class="wolai-block wolai-text"><div><span class="inline-wrap">Type escape sequence to abort.</span></div></div><div id="gW1gV1GdUpXbFpxR28orMf" class="wolai-block wolai-text"><div><span class="inline-wrap">Sending 5, 100-byte ICMP Echos to 8.8.8.8, timeout is 2 seconds:</span></div></div><div id="3y3tDr8WNsEzFosuqoNdMw" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>.....</b></span></div></div><div id="tyotpfHBA6ZtVyYRtdJkP" class="wolai-block wolai-text"><div><span class="inline-wrap">Success rate is 0 percent (0/5)</span></div></div><div id="6SmDFqLQiQgWzQuTzBK1Cy" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>查看底层数据包交互过程=&gt;</b></span></div></div><div id="6SZv5RaSBfcLLVNNhMqddE" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-05f805568b84a1fb4a17ffc759b4e451_b.jpg" style="width: 576px"/></figure></div><div id="r39HkSU2ip5G3WFWKNdYYu" class="wolai-block wolai-text"><div><span class="inline-wrap">当路由器关闭代理<span class="jill"></span>ARP<span class="jill"></span>时，此时电脑&quot;</span><span class="inline-wrap"><b>苦苦哀求</b></span><span class="inline-wrap">&quot;外网<span class="jill"></span>8.8.8.8<span class="jill"></span>的<span class="jill"></span>MAC<span class="jill"></span>地址，而路由器直接丢弃不再返回，</span><span class="inline-wrap"><b>由于电脑没有目标<span class="jill"></span>IP<span class="jill"></span>对应的<span class="jill"></span>MAC<span class="jill"></span>信息，所以通信失败</b></span><span class="inline-wrap">，即 </span><span class="inline-wrap"><b>......</b></span><span class="inline-wrap"> 我们来看下此时<span class="jill"></span>PC<span class="jill"></span>的<span class="jill"></span>arp<span class="jill"></span>表是怎样的=&gt;</span></div></div><div id="wgVXApkVr7TCR72pVvTw4Y" class="wolai-block wolai-text"><div><span class="inline-wrap">PC#</span><span class="inline-wrap"><b>show arp</b></span></div></div><div id="p4VqjN5EjMqKo3Dq46NUpd" class="wolai-block wolai-text"><div><span class="inline-wrap">Protocol Address Age (min) Hardware Addr Type Interface</span></div></div><div id="vEvoiY1khh6bA65GeHAtBt" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Internet 8.8.8.8 0 Incomplete ARPA</b></span></div></div><div id="7yAQFAMqsv6rjyRiHXLeNR" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet 192.168.1.1 - cc05.1f56.0000 ARPA FastEthernet0/0</span></div></div><div id="rh4sNDLEkEJMC1QWGvcaK8" class="wolai-block wolai-text"><div><span class="inline-wrap">⑤为<span class="jill"></span>PC</span><span class="inline-wrap"><b>设置默认网关</b></span><span class="inline-wrap">，重新<span class="jill"></span>ping 8.8.8.8，看看能不能通=&gt;</span></div></div><div id="aJg89MtKBmC47Xg3MnqVcD" class="wolai-block wolai-text"><div><span class="inline-wrap">PC(config)#</span><span class="inline-wrap"><b>ip default-gateway 192.168.1.254</b></span></div></div><div id="oVppBuhxH9xkLKTEdRNHzB" class="wolai-block wolai-text"><div><span class="inline-wrap">PC#</span><span class="inline-wrap"><b>ping 8.8.8.8</b></span></div></div><div id="55dFV6WT2nRirJkPLaGmRo" class="wolai-block wolai-text"><div><span class="inline-wrap">Type escape sequence to abort.</span></div></div><div id="pKqyArKDKeqcWUav9pjRp" class="wolai-block wolai-text"><div><span class="inline-wrap">Sending 5, 100-byte ICMP Echos to 8.8.8.8, timeout is 2 seconds:</span></div></div><div id="5bfe2hRLBSoJB93Sp6NeWD" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>!!!!!</b></span></div></div><div id="tBSDMRntGdsuu5rnaKhr9s" class="wolai-block wolai-text"><div><span class="inline-wrap">Success rate is 100 percent (5/5), round-trip min/avg/max = 44/244/1040 ms</span></div></div><div id="s4hiuziSuNiSLvs5YgExi2" class="wolai-block wolai-text"><div><span class="inline-wrap">可以看到，当电脑具备网关信息之后，此时直接采用<span class="jill"></span>ARP<span class="jill"></span>询问网关的<span class="jill"></span>MAC，即去往<span class="jill"></span>8.8.8.8<span class="jill"></span>的时候直接询问<span class="jill"></span>192.168.1.254<span class="jill"></span>的<span class="jill"></span>MAC，这个时候不管<span class="jill"></span>Router<span class="jill"></span>有没有开启代理<span class="jill"></span>ARP，也会正常回应<span class="jill"></span>PC<span class="jill"></span>的<span class="jill"></span>ARP<span class="jill"></span>询问，我们来看看底层数据包截图=&gt;</span></div></div><div id="7sAuESXGvHTN1fp3DBaA31" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-e8ecedcea3d9ab6112dcdce304914c3f_b.jpg" style="width: 576px"/></figure></div><h2 id="mPKv8BbuAhhx1JRcadJtRY" class="wolai-block"><span class="inline-wrap"><b>五、代理<span class="jill"></span>ARP<span class="jill"></span>总结</b></span></h2><div id="hojtKnfEwvHePiUmGPyB7m" class="wolai-block wolai-text"><div><span class="inline-wrap">① 本章节我们深入学习了代理<span class="jill"></span>ARP<span class="jill"></span>的原理和实践，在文章的开头，我们通过一个引子，帮大家矫正一个误区：跨网段通信时，就一定要用到代理<span class="jill"></span>ARP；</span></div></div><div id="qRfjwvUnUZfXYGPbw7UuoQ" class="wolai-block wolai-text"><div><span class="inline-wrap">②代理<span class="jill"></span>ARP<span class="jill"></span>是一个&quot;善意的欺骗&quot;，当电脑要跨网段访问外网设备时，网关设备用自己的<span class="jill"></span>MAC<span class="jill"></span>返回；</span></div></div><div id="2CwVNL2CqHkQCvJDneg2pV" class="wolai-block wolai-text"><div><span class="inline-wrap">③代理<span class="jill"></span>ARP<span class="jill"></span>和<span class="jill"></span>ARP<span class="jill"></span>的具体实现，跟电脑是否有设置网关有直接的关系；有网关通过<span class="jill"></span>ARP，没网关通过代理<span class="jill"></span>ARP；代理<span class="jill"></span>ARP<span class="jill"></span>可以看成是<span class="jill"></span>ARP<span class="jill"></span>的补充；</span></div></div><div id="qZXRNn9au5Uzz17wL71kyZ" class="wolai-block wolai-text"><div><span class="inline-wrap">④代理<span class="jill"></span>ARP<span class="jill"></span>会&quot;受限于沿途网络设备&quot;，真实网络里面一般都直接用<span class="jill"></span>ARP<span class="jill"></span>获取<span class="jill"></span>MAC<span class="jill"></span>地址。</span></div></div><div id="mbZavJ6ThNoFFCMkCwfmvW" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>预告：</b></span><span class="inline-wrap"> </span></div></div><div id="wS2F8zQzsobkGBdiyxMZtf" class="wolai-block wolai-text"><div><span class="inline-wrap">什么是免费/无故<span class="jill"></span>ARP？</span></div></div><div id="NhWFUffD1fb7ow8LH46Ht" class="wolai-block wolai-text"><div><span class="inline-wrap">免费<span class="jill"></span>ARP<span class="jill"></span>的功能是什么？在什么时候出现？</span></div></div><div id="6h3fuZrTV44uQb217yHv1j" class="wolai-block wolai-text"><div><span class="inline-wrap">免费<span class="jill"></span>ARP<span class="jill"></span>的数据包结构是如何的？</span></div></div><div id="swy9Ai2xyJS8thFzqmWgpA" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>【相关推荐】</b></span><span class="inline-wrap"> </span></div></div><div id="gpXyJV9rayF6j6XGejK8iM" class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://zhuanlan.zhihu.com/p/28865553"><span>图解<span class="jill"></span>ARP<span class="jill"></span>协议（三）ARP<span class="jill"></span>防御篇-如何揪出&quot;内鬼&quot;并&quot;优雅的还手&quot;？</span></a></span></div></div><div id="bYCRLREeERsvgDdWPmqZ7k" class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://zhuanlan.zhihu.com/p/28818627"><span>图解<span class="jill"></span>ARP<span class="jill"></span>协议（二）ARP<span class="jill"></span>攻击篇</span></a></span></div></div><div id="oon1FQRRgSqCX2i3hUJPG3" class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://zhuanlan.zhihu.com/p/28771785"><span>图解<span class="jill"></span>ARP<span class="jill"></span>协议（一）</span></a></span></div></div><div id="uzeiqprtazHxjCG8Qsmwp2" class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.pinginglab.net/course/164"><span>《TCP/IP<span class="jill"></span>协议栈视频教程》</span></a></span></div></div><div id="5nbYr6jJtSxRFu8K6oR2Cn" class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.pinginglab.net/course/3"><span>《Wireshark<span class="jill"></span>协议分析从入门到精通》</span></a></span></div></div><div id="m9RKPbJDbFH7Efq6BVhmMS" class="wolai-block wolai-text"><div><span class="inline-wrap">新浪微博：</span><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.weibo.com/jaykingchen"><span>@<span class="jill"></span>拼客学院陈鑫杰</span></a></span></div></div><div id="7xuoZgxXsWJ4QfuckcLH4C" class="wolai-block wolai-text"><div><span class="inline-wrap">微信公众号：拼客院长陈鑫杰</span></div></div><div id="7ACV9EbZ1FTsoCpxS4ApCv" class="wolai-block wolai-text"><div><span class="inline-wrap">拼客学院：</span><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.pinginglab.net"><span>http://www.pinginglab.net</span></a></span></div></div></article><footer></footer></body></html>