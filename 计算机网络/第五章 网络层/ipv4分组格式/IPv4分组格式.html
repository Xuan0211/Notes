<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../css/wolai.css"/><title>IPv4分组格式 - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body><header><div class="image"></div><div class="title"><div class="banner"><div data-symbol="⭐" class="icon"></div></div><div data-title="IPv4分组格式" class="main-title"></div></div></header><article><div class="block-ref"><div class="decorator"></div><div id="qcyVgs7dxAj2TK1Vz7WkQE" class="wolai-sub-page wolai-block"><div data-symbol="⭐" class="page-icon"></div><a href="ipv4%E5%9C%B0%E5%9D%80/ipv4%E5%9C%B0%E5%9D%80.html"><span>IPv4地址</span></a></div></div><div class="block-ref"><div class="decorator"></div><div id="egh74WgweG72577kPAGKfe" class="wolai-sub-page wolai-block"><div class="page-icon"></div><a href="ipv4%E5%9C%B0%E5%9D%80/cidr/cidr.html"><span>CIDR</span></a></div></div><div class="block-ref"><div class="decorator"></div><div id="uymTvtxHNzkQPExUknpiBS" class="wolai-sub-page wolai-block"><div class="page-icon"></div><a href="ipv4%E5%8D%8F%E8%AE%AE/ipv4%E5%8D%8F%E8%AE%AE.html"><span>IPV4协议</span></a></div></div><h2 id="sB9eZibWmhcbRD3PGxAerQ" class="wolai-block"><span class="inline-wrap">IPv4<span class="jill"></span>分组结构</span></h2><div id="puFwoMLg2BTGsyAwJC1Tee" class="wolai-block wolai-text"><div><span class="inline-wrap">IP<span class="jill"></span>分组由两个部分组成：分组头和数据。</span></div></div><div id="bx2QjnrahcaUpBTvsPK3TL" class="wolai-block wolai-text"><div><span class="inline-wrap">其中分组头有固定长度部分和可选部分。</span></div></div><div id="dvyWn8mEH9mBrw4gkZTwoq" class="wolai-block wolai-text"><div><span class="inline-wrap">与<span class="jill"></span>TCP<span class="jill"></span>报文类似，IP<span class="jill"></span>分组头的基本单位也为<span class="jill"></span>4<span class="jill"></span>字节，即分组头的每行宽度为<span class="jill"></span>4<span class="jill"></span>字节，如下图所示前<span class="jill"></span>5<span class="jill"></span>行是每个分组头必须有的字段，第<span class="jill"></span>6<span class="jill"></span>行是选项字段，因此<span class="jill"></span>IP<span class="jill"></span>分组头的基本长度为<span class="jill"></span>5*4=20<span class="jill"></span>字节，如果加上最长为<span class="jill"></span>40<span class="jill"></span>字节的选项，则<span class="jill"></span>IP<span class="jill"></span>分组头的最大长度为<span class="jill"></span>60<span class="jill"></span>字节。</span></div></div><div id="3u8vcrDTp92ZTxxboGzFW7" class="wolai-block wolai-text"><div><span class="inline-wrap">可见</span><span class="inline-wrap"><b>IP<span class="jill"></span>分组头的长度为<span class="jill"></span>20-60<span class="jill"></span>字节</b></span><span class="inline-wrap">。值得一提的是，TCP<span class="jill"></span>报头长度也为<span class="jill"></span>20-60<span class="jill"></span>字节。</span></div></div><div id="sKKbycTQWPRTvt1mw2Egyv" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://img-blog.csdnimg.cn/20200805171531840.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDE2NDQ4OQ==,size_16,color_FFFFFF,t_70" style="width: 100%"/></figure></div><h2 id="6ZWBK3ADNpMURpJWN1jFhB" class="wolai-block"><span class="inline-wrap">IPv4<span class="jill"></span>分组头格式</span></h2><h3 id="3YHVR6pqiSB4eisi2XmURi" class="wolai-block"><span class="inline-wrap"><b>1、版本字段</b></span></h3><div id="27rzND1czrtwqkbo2nzGnA" class="wolai-block wolai-text"><div><span class="inline-wrap">即上图中的“版本”，表示</span><span class="inline-wrap"><a href="https://so.csdn.net/so/search?q=%E7%BD%91%E7%BB%9C%E5%B1%82&amp;spm=1001.2101.3001.7020"><span>网络层</span></a></span><span class="inline-wrap">IP<span class="jill"></span>协议版本号。字段值为<span class="jill"></span>4<span class="jill"></span>表示<span class="jill"></span>IPv4，字段值为<span class="jill"></span>6<span class="jill"></span>表示<span class="jill"></span>IPv6。</span></div></div><h3 id="6HUZbSt4Pr3xfDUjWjnwAN" class="wolai-block"><span class="inline-wrap"><b>2、协议字段</b></span></h3><aside id="39BVsh3StvfLsYBdRYduLP" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap">这是一种隧道技术</span></aside><div id="29YfqsTkvViBMQ6qWdTSZc" class="wolai-block wolai-text"><div><span class="inline-wrap">•指出此<span class="jill"></span>IP<span class="jill"></span>分组携带的数据使用何种协议</span></div></div><div id="bEjmg5beZeS55mdcFRmdXn" class="wolai-block wolai-text"><div><span class="inline-wrap">•以便目的主机的 IP 层将数据部分上交给哪个处理过程</span></div></div><div id="3oajUadgVP6nMM8U5qxLLc" class="wolai-row"><div id="3H4pjhDnY9BfgkAXtksgFo" class="wolai-col" style="flex-grow: 0.5"><div id="hPCAEsy6CH13mrD8S89UoV" class="wolai-block"><figure class="wolai-left" style="width: 100%"><img src="https://img-blog.csdnimg.cn/20200805173244261.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDE2NDQ4OQ==,size_16,color_FFFFFF,t_70" style="width: 431.2px"/></figure></div></div><div id="nKGxCh6Z8hBV1Zu5Win27L" class="wolai-col" style="flex-grow: 0.5"><div id="aSoW5AMmNZdaoAaBQmzFi6" class="wolai-block"><figure class="wolai-left" style="width: 100%"><img src="media/image.png" style="width: 699.2px"/></figure></div></div></div><div id="uymTvtxHNzkQPExUknpiBS" class="wolai-sub-page wolai-block"><div class="page-icon"></div><a href="ipv4%E5%8D%8F%E8%AE%AE/ipv4%E5%8D%8F%E8%AE%AE.html"><span>IPV4协议</span></a><h1 id="iDqNwp4HRzTit7d2mbwJjo" class="wolai-block"><span class="inline-wrap">地址解析协议<span class="jill"></span>ARP</span></h1><div id="iVNyPWFyHJhmmt7FzCK1x5" class="wolai-sub-page wolai-block"><div class="page-icon"></div><a href="ipv4%E5%8D%8F%E8%AE%AE/arp/arp.html"><span>ARP</span></a><aside id="fFtA92hJ8inLKY7SUUHVD6" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap">P359</span></aside><div id="j7DGRtsBgEiCQJ2JyVVd1S" class="wolai-block wolai-text"><div><span class="inline-wrap">假设在以太网上运行的<span class="jill"></span>IP<span class="jill"></span>协议，把需要发送的数据封装后，要交给数据链路层发送。</span></div></div><div id="9AhuG9Gpf7HNHjY3Ky6cG1" class="wolai-block wolai-text"><div><span class="inline-wrap">以太网上使用<span class="jill"></span>6<span class="jill"></span>字节的<span class="jill"></span>MAC<span class="jill"></span>地址，每一个网卡上使用的<span class="jill"></span>MAC<span class="jill"></span>地址是由网卡的生产厂家设置的，和该接口上的<span class="jill"></span>IP<span class="jill"></span>地址没有对应的关系。</span></div></div><div id="ca4Bpr67zuw7dmLysopEZD" class="wolai-block wolai-text"><div><span class="inline-wrap">IP<span class="jill"></span>层协议只知道要发送的下一站的主机和路由器的<span class="jill"></span>IP<span class="jill"></span>地址，那么链路层如何决定下一站主机的<span class="jill"></span>MAC<span class="jill"></span>地址呢?</span></div></div><div id="dR7YuhRTYwsXuJjWgSJfuD" class="wolai-block wolai-text"><div><span class="inline-wrap">在以太网等局域网上，</span><span class="green inline-wrap"><b>使用<span class="jill"></span>ARP<span class="jill"></span>协议，来实现<span class="jill"></span>IP<span class="jill"></span>地址到<span class="jill"></span>MAC<span class="jill"></span>地址的动态转换</b></span><span class="inline-wrap">。广播询问应答</span></div></div><div id="wSBFRBSK7fKMMqRjYaTs5V" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_1.png" style="width: 100%"/></figure></div><aside id="wUKVDGA1BgugVrJRd9uU45" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap">在一个主机数量较少的子网，不一定非要用<span class="jill"></span>ARP<span class="jill"></span>进行地址解析，用一个配置文件也许更合适；</span><div id="sPwYRugK7GSDtVN97Rahey" class="wolai-block wolai-text"><div><span class="inline-wrap">在主机数量很多的网段使用<span class="jill"></span>ARP<span class="jill"></span>可以克服地址映射关系配置文件更新不及时的问题；</span></div></div></aside><h2 id="jA325tDRJwjArf44pA3jqZ" class="wolai-block"><span class="inline-wrap">基础概念</span></h2><div id="oqDsVqaRQkFpXxDEBaPMvD" class="wolai-sub-page wolai-block"><div class="page-icon"></div><a href="ipv4%E5%8D%8F%E8%AE%AE/arp/%E5%9B%BE%E8%A7%A3arp%E5%8D%8F%E8%AE%AE%EF%BC%88%E4%B8%80%EF%BC%89%20-%20%E7%9F%A5%E4%B9%8E/%E5%9B%BE%E8%A7%A3arp%E5%8D%8F%E8%AE%AE%EF%BC%88%E4%B8%80%EF%BC%89%20-%20%E7%9F%A5%E4%B9%8E.html"><span>图解ARP协议（一） - 知乎</span></a><h2 id="xjAUwv6Ymo9Zpd45mHb5bP" class="wolai-block"><span class="inline-wrap"><b>一、ARP<span class="jill"></span>概述</b></span></h2><div id="p4jqRtxuKdWvVF91Q2Y5X5" class="wolai-block wolai-text"><div><span class="inline-wrap">如果要在<span class="jill"></span>TCP/IP<span class="jill"></span>协议栈中选择一个</span><span class="inline-wrap"><b>&quot;最不安全的协议&quot;</b></span><span class="inline-wrap">，那么我会毫不犹豫把票投给<span class="jill"></span>ARP<span class="jill"></span>协议。我们经常听到的这些术语，包括&quot;网络扫描&quot;、&quot;内网渗透&quot;、&quot;中间人拦截&quot;、&quot;局域网流控&quot;、&quot;流量欺骗&quot;，基本都跟<span class="jill"></span>ARP<span class="jill"></span>脱不了干系。大量的安全工具，例如大名鼎鼎的<span class="jill"></span>Cain、功能完备的<span class="jill"></span>Ettercap、操作傻瓜式的<span class="jill"></span>P2P<span class="jill"></span>终结者，底层都要基于<span class="jill"></span>ARP<span class="jill"></span>实现。</span></div></div><div id="8s2ki4rEcNge9HX2nZQRj5" class="wolai-block wolai-text"><div><span class="inline-wrap">听上去这么&quot;逆天&quot;的协议，其实技术原理又简单的难以置信，例如<span class="jill"></span>ARP<span class="jill"></span>整个完整交互过程仅需要两个包，一问一答即可搞定！但是<span class="jill"></span>ARP<span class="jill"></span>协议也有它令初学者迷惑的地方，例如由它本身延伸出来的&quot;代理<span class="jill"></span>ARP&quot;、&quot;免费<span class="jill"></span>ARP&quot;、&quot;翻转<span class="jill"></span>ARP&quot;、&quot;逆向<span class="jill"></span>ARP&quot;，而这些不同种类的<span class="jill"></span>ARP，又应用于不同的场景。好吧，在深入到技术原理之前，作为初学者，我们先记住下面三句话：</span></div></div><div id="v16PtaGscAFgPSHistHRif" class="wolai-block wolai-text"><div><span class="inline-wrap">①</span><span class="inline-wrap"><b>ARP（Address Resolution Protocol）即地址解析协议， 用于实现从 IP 地址到 MAC 地址的映射，即询问目标<span class="jill"></span>IP<span class="jill"></span>对应的<span class="jill"></span>MAC<span class="jill"></span>地址</b></span><span class="inline-wrap">。</span></div></div><div id="yoAbH46iSkoN1F59MBtA3" class="wolai-block wolai-text"><div><span class="inline-wrap">②在网络通信中，主机和主机通信的数据包需要依据<span class="jill"></span>OSI<span class="jill"></span>模型从上到下进行数据封装，当数据封装完整后，再向外发出。所以在局域网的通信中，不仅需要源目<span class="jill"></span>IP<span class="jill"></span>地址的封装，也需要源目<span class="jill"></span>MAC<span class="jill"></span>的封装。</span></div></div><div id="qr5uaXh1VUe2BAom6Yvkyc" class="wolai-block wolai-text"><div><span class="inline-wrap">③一般情况下，上层应用程序更多关心<span class="jill"></span>IP<span class="jill"></span>地址而不关心<span class="jill"></span>MAC<span class="jill"></span>地址，所以需要通过<span class="jill"></span>ARP<span class="jill"></span>协议来获知目的主机的<span class="jill"></span>MAC<span class="jill"></span>地址，完成数据封装。</span></div></div><div id="w7VmZMvKztnPXJ3E4hYRLk" class="wolai-block wolai-text"><div><span class="inline-wrap">接下来，我们通过图解的方式来深入了解<span class="jill"></span>ARP<span class="jill"></span>协议是如何工作的。</span></div></div><h2 id="8E77BFknutEM1Q1Cha4ubM" class="wolai-block"><span class="inline-wrap"><b>二、ARP<span class="jill"></span>原理之请求应答</b></span></h2><div id="oo94qLiYpZQRkiEUyrMJAE" class="wolai-block wolai-text"><div><span class="inline-wrap">同一个局域网里面，当<span class="jill"></span>PC1<span class="jill"></span>需要跟<span class="jill"></span>PC2<span class="jill"></span>进行通信时，此时<span class="jill"></span>PC1<span class="jill"></span>是如何处理的？</span></div></div><div id="45YKsKtELwEhFMF74Wq524" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-e350c54794f261231f784a973708b9e9_b.jpg" style="width: 1046.4px"/></figure></div><div id="qKoeUko6GHArWJ4AtsCg18" class="wolai-block wolai-text"><div><span class="inline-wrap">根据<span class="jill"></span>OSI<span class="jill"></span>数据封装顺序，发送方会自顶向下（从应用层到物理层）封装数据，然后发送出去，这里以<span class="jill"></span>PC1 ping PC2<span class="jill"></span>的过程举例==&gt;</span></div></div><div id="nmskEjP7ZJU7A7fkgBHC9P" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-482e369fa6a8c4246af0164fbc69e2fc_b.jpg" style="width: 576px"/></figure></div><div id="cK9juhaKWtFgy9rb4Fd4hz" class="wolai-block wolai-text"><div><span class="inline-wrap">PC1<span class="jill"></span>封装数据并且对外发送数据时，上图中出现了&quot;failed&quot;，即数据封装失败了，为什么？</span></div></div><div id="6KRTGxzjUDD626ePmzC3jn" class="wolai-block wolai-text"><div><span class="inline-wrap">我们给<span class="jill"></span>PC1<span class="jill"></span>指令-&quot;ping ip2&quot;，这就告知了目的<span class="jill"></span>IP，此时<span class="jill"></span>PC1<span class="jill"></span>便有了通信需要的源目<span class="jill"></span>IP<span class="jill"></span>地址，但是<span class="jill"></span>PC1<span class="jill"></span>仍然没有通信需要的目的<span class="jill"></span>MAC<span class="jill"></span>地址。</span><span class="inline-wrap"><b>这就好比我们要寄一个快递，如果在快递单上仅仅写了收件人的姓名（IP），却没有写收件人的地址（MAC），那么这个快递就没法寄出，因为信息不完整。</b></span><span class="inline-wrap"> </span></div></div><div id="4aWHMLPPkdiDhqyoojh7u8" class="wolai-block wolai-text"><div><span class="inline-wrap">那么，现在<span class="jill"></span>PC1<span class="jill"></span>已经有了<span class="jill"></span>PC2<span class="jill"></span>的<span class="jill"></span>IP<span class="jill"></span>地址信息，如何获取到<span class="jill"></span>PC2<span class="jill"></span>的<span class="jill"></span>MAC<span class="jill"></span>地址呢？此时，ARP<span class="jill"></span>协议就派上用场了。我们接着上面这张图，继续==&gt;</span></div></div><div id="mdQZuKoxxoRD1n2nTJQvBz" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-12c0720dbf1143fb4ace0cb44398508f_b.jpg" style="width: 576px"/></figure></div><div id="8mDKwND8Ef9vBE6aPUjMDp" class="wolai-block wolai-text"><div><span class="inline-wrap">通过第三和第四步骤，我们看到<span class="jill"></span>PC1<span class="jill"></span>和<span class="jill"></span>PC2<span class="jill"></span>进行了一次<span class="jill"></span>ARP<span class="jill"></span>请求和回复过程，通过这个交互工程，PC1<span class="jill"></span>便具备了<span class="jill"></span>PC2<span class="jill"></span>的<span class="jill"></span>MAC<span class="jill"></span>地址信息。</span></div></div><div id="zcAfi4k5Le7KGD1AZi1mr" class="wolai-block wolai-text"><div><span class="inline-wrap">接下来<span class="jill"></span>PC1<span class="jill"></span>会怎么做呢？在真正进行通信之前，PC1<span class="jill"></span>还会将<span class="jill"></span>PC2<span class="jill"></span>的<span class="jill"></span>MAC<span class="jill"></span>信息放入本地的【ARP<span class="jill"></span>缓存表】，表里面放置了<span class="jill"></span>IP<span class="jill"></span>和<span class="jill"></span>MAC<span class="jill"></span>地址的映射信息，例如 IP2&lt;-&gt;MAC2。接下来，PC1<span class="jill"></span>再次进行数据封装，正式进入<span class="jill"></span>PING<span class="jill"></span>通信，如下==&gt;  </span></div></div><div id="aBJezRqmRgAt5ZmBxwBcMJ" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-27582d8469224d8a28ee148cf3543e5e_b.jpg" style="width: 576px"/></figure></div><div id="mgUpryvvSAs5U7hqq2menM" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>小结：</b></span><span class="inline-wrap"> 经过上面<span class="jill"></span>6<span class="jill"></span>个步骤的处理，PC1<span class="jill"></span>终于把数据包发送出去了，之后便可以进行正常的通信了。看到了吧，ARP<span class="jill"></span>的功能和实现过程是如此的简单：它在发送方需要目标<span class="jill"></span>MAC<span class="jill"></span>地址的时及时出手，通过&quot;一问一答&quot;的方式获取到特定<span class="jill"></span>IP<span class="jill"></span>对应的<span class="jill"></span>MAC<span class="jill"></span>地址，然后存储到本地【</span><span class="inline-wrap"><b>ARP<span class="jill"></span>缓存表</b></span><span class="inline-wrap">】，后续需要的话，就到这里查找。</span></div></div><div id="uryXmPGPiMzu82epxbnyiq" class="wolai-block wolai-text"><div><span class="inline-wrap">既然是&quot;缓存&quot;表，意味着它有</span><span class="inline-wrap"><b>时效性</b></span><span class="inline-wrap">，并且如果电脑或者通信设备重启的话，这张表就会</span><span class="inline-wrap"><b>清空</b></span><span class="inline-wrap">；也就是说，如果下次需要通信，又需要进行<span class="jill"></span>ARP<span class="jill"></span>请求。在我们的<span class="jill"></span>windows/macos<span class="jill"></span>系统下，可以通过命令行&quot;</span><span class="inline-wrap"><b>arp -a</b></span><span class="inline-wrap">&quot;查看具体信息=&gt;</span></div></div><div id="utG6rZ9LrTBjtRxEVd7Lhe" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-7f8bdda04b830562b73cf2b3d932f071_b.jpg" style="width: 900.8px"/></figure></div><h2 id="o3B5rY3xRMHH3AAwqAprLs" class="wolai-block"><span class="inline-wrap"><b>三、ARP<span class="jill"></span>原理之广播请求单播回应</b></span></h2><div id="g4Q2u6vXPD5Qg3xdXraJFy" class="wolai-block wolai-text"><div><span class="inline-wrap">上面的图解过程看上去简单又纯粹，好像我们就已经把这个协议的精髓全部<span class="jill"></span>get<span class="jill"></span>到，但其实，我们只是刚揭开了它的面纱，接下来我们才真正进入正题。例如，上面的图解过程中，整个局域网（LAN）只有<span class="jill"></span>PC1<span class="jill"></span>和<span class="jill"></span>PC2<span class="jill"></span>两个主机，所以这个一问一答过程非常的顺畅。</span></div></div><div id="oj6ACFexbjoQGwojoXwd6Y" class="wolai-block wolai-text"><div><span class="inline-wrap">而实际网络中，这个<span class="jill"></span>LAN<span class="jill"></span>可能有几十上百的主机，那么请问，PC1<span class="jill"></span>如何将这个【ARP<span class="jill"></span>请求包】顺利的交给<span class="jill"></span>PC2，而<span class="jill"></span>PC2<span class="jill"></span>又如何顺利的把【ARP<span class="jill"></span>回应包】返回给<span class="jill"></span>PC1? 我们看下面的图：</span></div></div><div id="92kDkMWQZnkr9hKjQ3TBc7" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-504474cb1210f7d4e72d718cd86148c8_b.jpg" style="width: 576px"/></figure></div><div id="37WhmyaZB1XmSjDksEyg7L" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div id="bVKpJAeLLng681JnTvxqL8" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-83365e93f2f60f5fb83772eca5dc8016_b.jpg" style="width: 576px"/></figure></div><div id="JQ4Y2HhGbNio9fRxs8Rrm" class="wolai-block wolai-text"><div><span class="inline-wrap">为了营造出&quot;几十上百&quot;的效果，这里多添加了<span class="jill"></span>2<span class="jill"></span>个主机进来 ⁄(⁄ ⁄•⁄ω⁄•⁄ ⁄)⁄，并且增加了有线和无线的环境。那么，在多主机环境下，PC1<span class="jill"></span>现在发出的<span class="jill"></span>ARP<span class="jill"></span>请求包，怎么交到<span class="jill"></span>PC2<span class="jill"></span>手里？</span></div></div><div id="w5ZjcaCDx6RV49eySrGyTW" class="wolai-block wolai-text"><div><span class="inline-wrap">这时，ARP<span class="jill"></span>协议就需要采用以太网的&quot;广播&quot;功能：将请求包</span><span class="inline-wrap"><b>以广播的形式</b></span><span class="inline-wrap">发送，交换机或<span class="jill"></span>WiFi<span class="jill"></span>设备（无线路由器）收到广播包时，会将此数据发给同一局域网的其他所有主机。</span></div></div><div id="fvEAXuf4oE63d9doVPF5nW" class="wolai-block wolai-text"><div><span class="inline-wrap">那么，什么是广播？对于初学者而言，我们只需要知道，大部分的广播包，它们有一个共同特征：</span><span class="inline-wrap"><b>二层封装时目的<span class="jill"></span>MAC<span class="jill"></span>是全<span class="jill"></span>f（ffff.ffff.ffff）或三层封装时目的<span class="jill"></span>IP<span class="jill"></span>是全<span class="jill"></span>1（255.255.255.255）</b></span><span class="inline-wrap">。可以这样更方便的记住：目的地址最大的，就是广播。</span></div></div><div id="uVq4DEdSW5PtGgjUHwfgpJ" class="wolai-block wolai-text"><div><span class="inline-wrap">注明：广播根据所在层次可分为二层广播和三层广播，根据发生范围可分为本地广播和定向广播，小伙伴们有兴趣可以自己再去拓展下。</span></div></div><div id="c6WBt8VAKktt1r9nFfurFL" class="wolai-block wolai-text"><div><span class="inline-wrap">接下来我们来看下这个<span class="jill"></span>ARP<span class="jill"></span>广播请求包接下来是如何工作的？</span></div></div><div id="wL7ht2Hnuh6XTkFADiQ9VQ" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-2485a31a69987ced88931c4a876bc4b3_b.jpg" style="width: 576px"/></figure></div><div id="5jaSWouZWiaxPNghckcmpF" class="wolai-block wolai-text"><div><span class="inline-wrap">根据上图我们看到，PC1<span class="jill"></span>发送的请求广播包同时被其他主机收到，然后<span class="jill"></span>PC3<span class="jill"></span>和<span class="jill"></span>PC4<span class="jill"></span>收到之后（发现不是问自己）则丢弃。</span><span class="inline-wrap"><b>而<span class="jill"></span>PC2<span class="jill"></span>收到之后，根据请求包里面的信息（有自己的<span class="jill"></span>IP<span class="jill"></span>地址），判断是给自己的，所以不会做丢弃动作，而是返回<span class="jill"></span>ARP<span class="jill"></span>回应包。</b></span><span class="inline-wrap"> </span></div></div><div id="xtUasQEnePtwPa8ixFaJJe" class="wolai-block wolai-text"><div><span class="inline-wrap">ARP<span class="jill"></span>请求是通过广播方式来实现的，那么，PC2<span class="jill"></span>返回<span class="jill"></span>ARP<span class="jill"></span>回应包，是否也需要通过广播来实现呢？答案是否定的。</span><span class="inline-wrap"><b>大部分网络协议在设计的时候，都需要保持极度克制，不需要的交互就砍掉，能合并的信息就合并，能不用广播就用单播，以此让带宽变得更多让网络变得更快。</b></span><span class="inline-wrap"> </span></div></div><div id="tcwLmh22nFn3aFbtbrFTy9" class="wolai-block wolai-text"><div><span class="inline-wrap">那么，ARP<span class="jill"></span>回应包是如何处理的？这里需要特别关注<span class="jill"></span>ARP<span class="jill"></span>请求包的内容，在上面的图解里面，ARP<span class="jill"></span>请求包的完整信息是：我的<span class="jill"></span>IP<span class="jill"></span>地址是<span class="jill"></span>IP1，MAC<span class="jill"></span>地址是<span class="jill"></span>MAC1，请问谁是<span class="jill"></span>PC2，你的<span class="jill"></span>IP2<span class="jill"></span>对应的<span class="jill"></span>MAC<span class="jill"></span>地址是多少？</span></div></div><div id="nZLdkvYqBJ7oCCdq5cceEb" class="wolai-block wolai-text"><div><span class="inline-wrap">简单来说，</span><span class="inline-wrap"><b>ARP<span class="jill"></span>请求首先有&quot;自我介绍&quot;，然后才是询问</b></span><span class="inline-wrap">。这样的话，PC2<span class="jill"></span>在收到请求之后，就可以将<span class="jill"></span>PC1<span class="jill"></span>的<span class="jill"></span>IP<span class="jill"></span>和<span class="jill"></span>MAC<span class="jill"></span>映射信息存储在本地的【ARP<span class="jill"></span>缓存表】，既然知道<span class="jill"></span>PC1<span class="jill"></span>在哪里，就可以返回<span class="jill"></span>ARP<span class="jill"></span>单播回应包。</span></div></div><div id="eR3RdBTSiDnTgGG7j3XyLH" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-336746c18241ff5e5d8eba2b1ffac1da_b.jpg" style="width: 576px"/></figure></div><div id="dEVce8cFmPTCT2svrdxPyQ" class="wolai-block wolai-text"><div><span class="inline-wrap">这张图我们需要得到两个信息：①被询问者<span class="jill"></span>PC2<span class="jill"></span>先生成了<span class="jill"></span>ARP<span class="jill"></span>映射信息，然后才是询问者<span class="jill"></span>PC1；②PC3<span class="jill"></span>和<span class="jill"></span>PC4<span class="jill"></span>等其他主机，无法收到这个<span class="jill"></span>ARP<span class="jill"></span>回应包，因为是单播形式。</span></div></div><aside id="f35ZcggxGCgybu4qHHGykR" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap"><b>小结：</b></span><span class="inline-wrap"> ARP<span class="jill"></span>协议通过&quot;一问一答&quot;实现交互，但是&quot;问&quot;和&quot;答&quot;都有讲究，&quot;问&quot;是通过广播形式实现，&quot;答&quot;是通过单播形式。</span></aside><h2 id="3ATcSCuFiGifGe87j7BfzT" class="wolai-block"><span class="inline-wrap"><b>四、ARP<span class="jill"></span>数据包解读</b></span></h2><div id="cmEGFDADUnLKSSh6rkdrjM" class="wolai-block wolai-text"><div><span class="inline-wrap">为了让大家更好的理解<span class="jill"></span>ARP<span class="jill"></span>协议以及广播和单播的概念，我们来看一下用<span class="jill"></span>Wireshark<span class="jill"></span>抓取到的真实网络中的<span class="jill"></span>ARP<span class="jill"></span>过程，通过数据包的方式来呈现，地址信息如下，部分<span class="jill"></span>MAC<span class="jill"></span>信息隐去。（建议初学者用<span class="jill"></span>GNS3<span class="jill"></span>配合<span class="jill"></span>Wireshark<span class="jill"></span>来抓取协议包进行分析，相比真实网络更加干净，方便分析）</span></div></div><div id="uyxoPR61t36znFGXBmLV47" class="wolai-block wolai-text"><div><span class="inline-wrap">主机<span class="jill"></span>1 &lt;---&gt; 主机<span class="jill"></span>2</span></div></div><div id="bQd1vK54SofQV4mDna8Cvr" class="wolai-block wolai-text"><div><span class="inline-wrap">主机<span class="jill"></span>1： IP1 10.1.20.64 MAC1：00:08:ca:xx:xx:xx</span></div></div><div id="mggoPiqP6uoCFTywcyBkm" class="wolai-block wolai-text"><div><span class="inline-wrap">主机<span class="jill"></span>2： IP2 10.1.20.109 MAC2：44:6d:57:xx:xx:xx</span></div></div><div id="vPJjyuQySr3guTnF11XgaW" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>【ARP<span class="jill"></span>请求包】</b></span><span class="inline-wrap"> </span></div></div><div id="kZTcta4NV9SeqUWVLWaWCZ" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-5e6176abaacf3839113a116891df9bde_b.jpg" style="width: 576px"/></figure></div><div id="kcFjCMAaSPvqDMaHXs27K5" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>【ARP<span class="jill"></span>回应包】</b></span><span class="inline-wrap"> </span></div></div><div id="r47rGEyYcDoHzefuKUs2xB" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-2216de823ce85a2cb629d2a0c774f9c3_b.jpg" style="width: 576px"/></figure></div><h3 id="8ANEubSikf6ftoC8z5EUGJ" class="wolai-block"><span class="inline-wrap"><b>【ARP<span class="jill"></span>协议字段解读】</b></span><span class="inline-wrap"> </span></h3><div id="pZqhH1mYMU8LBQezrdKgFL" class="wolai-block wolai-text"><div><span class="inline-wrap">Hardware type ：硬件类型，标识链路层协议</span></div></div><div id="ewnRtXP2kBeHfGiAXmzigi" class="wolai-block wolai-text"><div><span class="inline-wrap">Protocol type： 协议类型，标识网络层协议</span></div></div><div id="trb69oRkoJi7EoXonWS7Wn" class="wolai-block wolai-text"><div><span class="inline-wrap">Hardware size ：硬件地址大小，标识<span class="jill"></span>MAC<span class="jill"></span>地址长度，这里是<span class="jill"></span>6<span class="jill"></span>个字节（48bti）</span></div></div><div id="nhwvnm8E8MXoonjULsYyVU" class="wolai-block wolai-text"><div><span class="inline-wrap">Protocol size： 协议地址大小，标识<span class="jill"></span>IP<span class="jill"></span>地址长度，这里是<span class="jill"></span>4<span class="jill"></span>个字节（32bit）</span></div></div><div id="7bjyqqfhyds828frjW9n1M" class="wolai-block wolai-text"><div><span class="inline-wrap">Opcode： 操作代码，标识<span class="jill"></span>ARP<span class="jill"></span>数据包类型，1<span class="jill"></span>表示请求，2<span class="jill"></span>表示回应</span></div></div><div id="bQ242ai664Yv17ip5xFfpx" class="wolai-block wolai-text"><div><span class="inline-wrap">Sender MAC address ：发送者<span class="jill"></span>MAC</span></div></div><div id="dBogTfSQPManUDbgy951Db" class="wolai-block wolai-text"><div><span class="inline-wrap">Sender IP address ：发送者<span class="jill"></span>IP</span></div></div><div id="7sdF5KHYy3J3kG83K69SHJ" class="wolai-block wolai-text"><div><span class="inline-wrap">Target MAC address ：目标<span class="jill"></span>MAC，此处全<span class="jill"></span>0<span class="jill"></span>表示在请求</span></div></div><div id="pGghvBNAMnWWyYv9CRrisJ" class="wolai-block wolai-text"><div><span class="inline-wrap">Target IP address： 目标<span class="jill"></span>IP</span></div></div><h2 id="nY1q8rsYpnJ8rs1d5NdQE9" class="wolai-block"><span class="inline-wrap"><b>五、ARP<span class="jill"></span>到底是链路层还是网络层？</b></span></h2><div id="6MpjetSvcs9i5sGkgqaUsf" class="wolai-block wolai-text"><div><span class="inline-wrap">这个问题的难度堪比另外一个世界级难题：世界上最好的编程语言是什么？</span></div></div><div id="mVC3dJeAzCGTAS2Ps2GrPq" class="wolai-block wolai-text"><div><span class="inline-wrap">其实早在<span class="jill"></span>20<span class="jill"></span>世纪时，W.Richard Stevens<span class="jill"></span>在《TCP/IP<span class="jill"></span>详解卷一》里面就提到了这个难题。这里给出我个人的协议分层思路，给大家作为参考=&gt;</span></div></div><div id="rKQMkxqTHCc1VWGx4nprn4" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>协议到底所属哪一层，可以从应用/功能来考虑，也可以从层次/包封装来考虑。</b></span><span class="inline-wrap"> </span></div></div><div id="pSNtohemqEZcv1h2rxWTM2" class="wolai-block wolai-text"><div><span class="inline-wrap">以<span class="jill"></span>ARP<span class="jill"></span>协议为例，它的功能最终是获取到<span class="jill"></span>MAC<span class="jill"></span>信息，服务于链路层，从这点考虑，ARP<span class="jill"></span>是链路层协议；但是从层次来看，ARP<span class="jill"></span>基于<span class="jill"></span>Ethernet<span class="jill"></span>协议，IP<span class="jill"></span>协议基于<span class="jill"></span>Ethernet<span class="jill"></span>协议，它们在<span class="jill"></span>Ethernet<span class="jill"></span>协议里面有独立的<span class="jill"></span>Type<span class="jill"></span>类型，前者是<span class="jill"></span>0x0806，后者是<span class="jill"></span>0x0800，既然<span class="jill"></span>ARP<span class="jill"></span>和<span class="jill"></span>IP<span class="jill"></span>协议&quot;平起平坐&quot;，那么<span class="jill"></span>IP<span class="jill"></span>是网络层，ARP<span class="jill"></span>难道就不是网络层？</span></div></div><div id="9yNujTqmN3stVRrfcHup7t" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-b62d2021da948c7626cbeafb7ab4e2b3_b.jpg" style="width: 1052.8px"/></figure></div><div id="32CiXrzB2UpL2G8Cjz3Y2o" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>小结：</b></span><span class="inline-wrap"> 基于功能来考虑，ARP<span class="jill"></span>是链路层协议；基于分层/包封装来考虑，ARP<span class="jill"></span>是网络层协议。（此方法对于<span class="jill"></span>ICMP<span class="jill"></span>协议同样管用）</span></div></div><div id="5EFhcsNs1DzzHw9AcFw9XM" class="wolai-block wolai-text"><div><span class="inline-wrap">\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-</span></div></div><div id="cy2Q5WNg61skPRjiLCCZwZ" class="wolai-block wolai-text"><div><span class="inline-wrap">新浪微博：</span><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.weibo.com/jaykingchen"><span>@<span class="jill"></span>拼客学院陈鑫杰</span></a></span></div></div><div id="2yV57bLmwKZFeHKTwSwTX" class="wolai-block wolai-text"><div><span class="inline-wrap">微信公众号：拼客院长陈鑫杰</span></div></div><div id="mnVJPHYkmE54UYN281BiAr" class="wolai-block wolai-text"><div><span class="inline-wrap">拼客学院：</span><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.pinginglab.net/"><span>www.pinginglab.net</span></a></span></div></div></div><h2 id="4w3ZC9evVb1qjpgh8qroS1" class="wolai-block"><span class="inline-wrap">永不上的进阶文章</span></h2><div id="xfcoAenh96LUdHB3vq5RDg" class="wolai-sub-page wolai-block"><div class="page-icon"></div><a href="ipv4%E5%8D%8F%E8%AE%AE/arp/%E5%9B%BE%E8%A7%A3arp%E5%8D%8F%E8%AE%AE%EF%BC%88%E4%BA%8C%EF%BC%89arp%E6%94%BB%E5%87%BB%E7%AF%87%20-%20%E7%9F%A5/%E5%9B%BE%E8%A7%A3arp%E5%8D%8F%E8%AE%AE%EF%BC%88%E4%BA%8C%EF%BC%89arp%E6%94%BB%E5%87%BB%E7%AF%87%20-%20%E7%9F%A5.html"><span>图解ARP协议（二）ARP攻击篇 - 知乎</span></a><div id="6tXCLuS4bwqkH7R5AoS2ER" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>一、ARP<span class="jill"></span>攻击概述</b></span></div></div><div id="bvfGhHBS5SVkukKGihLQWz" class="wolai-block wolai-text"><div><span class="inline-wrap">在上篇文章里，我给大家普及了<span class="jill"></span>ARP<span class="jill"></span>协议的基本原理，包括<span class="jill"></span>ARP<span class="jill"></span>请求应答、数据包结构以及协议分层标准，今天我们继续讨论大家最感兴趣的话题：</span><span class="inline-wrap"><b>ARP<span class="jill"></span>攻击原理是什么？通过<span class="jill"></span>ARP<span class="jill"></span>攻击可以做什么，账号是否可以被窃取？有哪些常见的<span class="jill"></span>ARP<span class="jill"></span>渗透（攻击）工具可以用来练手？ARP<span class="jill"></span>扫描和攻击有什么区别，底层数据包特征是怎样的？</b></span></div></div><div id="i3ymuydMwx3kvpJy93wCua" class="wolai-block wolai-text"><div><span class="inline-wrap">接下来，我们通过图解的方式来深入了解<span class="jill"></span>ARP<span class="jill"></span>攻击是如何实现的。</span></div></div><div id="49YbWTGuBqvM7L3gDbkjQi" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>二、ARP<span class="jill"></span>攻击原理</b></span></div></div><div id="bH9pWd2DENSh6HNWrtFSH8" class="wolai-block wolai-text"><div><span class="inline-wrap">但凡局域网存在<span class="jill"></span>ARP<span class="jill"></span>攻击，都说明网络存在&quot;中间人&quot;，我们可以用下图来解释。</span></div></div><div id="f7MQx8G4uw4EuSZzv4fruF" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-816508f970cea1daf14f0610569c53db_b.jpg"/></figure></div><div id="4oRDXDTRrtUsa5L3gq5QbX" class="wolai-block wolai-text"><div><span class="inline-wrap">在这个局域网里面，PC1、PC2、PC3<span class="jill"></span>三台主机共同连接到交换机<span class="jill"></span>SW1<span class="jill"></span>上面，对应<span class="jill"></span>3<span class="jill"></span>个接口<span class="jill"></span>port1/2/3。假设<span class="jill"></span>PC3<span class="jill"></span>这台主机安装了<span class="jill"></span>ARP<span class="jill"></span>攻击软件或遭受<span class="jill"></span>ARP<span class="jill"></span>病毒，成为这个网络的攻击者（hacker），接下来，PC3<span class="jill"></span>是如何攻击的？先不急，先来回顾下<span class="jill"></span>PC1<span class="jill"></span>和<span class="jill"></span>PC2<span class="jill"></span>是如何通信的。</span></div></div><div id="8XXSMu8fLitT3fX83VCsV6" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-6522b0e3e1b7e7058152e70953428c74_b.jpg"/></figure></div><div id="2mWCorCdt9sE9eX63oNQTu" class="wolai-block wolai-text"><div><span class="inline-wrap">①PC1<span class="jill"></span>需要跟<span class="jill"></span>PC2<span class="jill"></span>通信，通过<span class="jill"></span>ARP<span class="jill"></span>请求包询问<span class="jill"></span>PC2<span class="jill"></span>的<span class="jill"></span>MAC<span class="jill"></span>地址，由于采用广播形式，所以交换机将<span class="jill"></span>ARP<span class="jill"></span>请求包从接口<span class="jill"></span>P1<span class="jill"></span>广播到<span class="jill"></span>P2<span class="jill"></span>和<span class="jill"></span>PC3。（注：</span><span class="inline-wrap"><b>交换机收到广播/组播/未知帧都会其他接口泛洪</b></span><span class="inline-wrap">）</span></div></div><div id="czbFpHAuYz8sRZUj7P3vv5" class="wolai-block wolai-text"><div><span class="inline-wrap">②PC2<span class="jill"></span>根据询问信息，返回<span class="jill"></span>ARP<span class="jill"></span>单播回应包；此时<span class="jill"></span>PC3<span class="jill"></span>作为攻击者，没有返回<span class="jill"></span>ARP<span class="jill"></span>包，但是处于&quot;</span><span class="inline-wrap"><b>监听</b></span><span class="inline-wrap">&quot;状态，为后续攻击做准备。</span></div></div><div id="aXCH16r7eayDTrms1pFCdQ" class="wolai-block wolai-text"><div><span class="inline-wrap">③PC1<span class="jill"></span>和<span class="jill"></span>PC2<span class="jill"></span>根据<span class="jill"></span>ARP<span class="jill"></span>问答，将各自的<span class="jill"></span>ARP<span class="jill"></span>映射信息（IP-MAC）存储在本地<span class="jill"></span>ARP<span class="jill"></span>缓存表。</span></div></div><div id="9qbxqfGjbKSFFx1dConkc" class="wolai-block wolai-text"><div><span class="inline-wrap">④交换机根据其学习机制，记录<span class="jill"></span>MAC<span class="jill"></span>地址对应的接口信息，存储在</span><span class="inline-wrap"><b>CAM<span class="jill"></span>缓存表</b></span><span class="inline-wrap">（也称为<span class="jill"></span>MAC<span class="jill"></span>地址表）。交换机收到数据包时，会解封装数据包，根据</span><span class="inline-wrap"><b>目标<span class="jill"></span>MAC</b></span><span class="inline-wrap">字段进行转发。</span></div></div><div id="fcBnPWqeFg83gQVhiSaHuj" class="wolai-block wolai-text"><div><span class="inline-wrap">关于上面的图解，我们要记住这些关键知识（敲黑板！）：</span></div></div><div id="7PTVpchvRqi5fbqYhK6yQ4" class="wolai-block wolai-text"><div><span class="inline-wrap">①主机通信需要查找<span class="jill"></span>ARP<span class="jill"></span>表，而交换机通信需要查找<span class="jill"></span>CAM<span class="jill"></span>表（路由器则查找<span class="jill"></span>Route<span class="jill"></span>表）。</span></div></div><div id="hDNcdMVt1fia7Z5i8dodbr" class="wolai-block wolai-text"><div><span class="inline-wrap">注：ARP<span class="jill"></span>表：ip&lt;-&gt;mac CAM<span class="jill"></span>表：mac&lt;-&gt;port （Route<span class="jill"></span>表：route&lt;-&gt;port）</span></div></div><div id="mzoY2vSGYwqRej6o2WZyAr" class="wolai-block wolai-text"><div><span class="inline-wrap">②交换机基于源<span class="jill"></span>MAC<span class="jill"></span>地址学习，基于目的<span class="jill"></span>MAC<span class="jill"></span>地址转发。</span></div></div><div id="oFyvhVkqE8u6r16bPjmhec" class="wolai-block wolai-text"><div><span class="inline-wrap">③同一局域网内，攻击者可以根据主机的<span class="jill"></span>ARP<span class="jill"></span>广播请求监听其<span class="jill"></span>IP<span class="jill"></span>和<span class="jill"></span>MAC<span class="jill"></span>信息。</span></div></div><div id="n3KnzV6WEmndYAjqXjNvNz" class="wolai-block wolai-text"><div><span class="inline-wrap">注：这里是&quot;被动监听&quot;，跟后面要谈到的&quot;主动扫描&quot;，原理上有区分，这里先埋个坑）</span></div></div><div id="59nMFHjfyqv8wKFwiYMrsX" class="wolai-block wolai-text"><div><span class="inline-wrap">接下来是重点，我们来看看<span class="jill"></span>PC3（Hacker）是如何发起<span class="jill"></span>ARP<span class="jill"></span>攻击的=&gt;</span></div></div><div id="9dqzKfNWbJmnYBqymRByi" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-383f86e253b689d40ff20d648ce7afac_b.jpg"/></figure></div><div id="t7rYXrRqpitVWKq9PpwBf8" class="wolai-block wolai-text"><div><span class="inline-wrap">正常情况下，若收到的<span class="jill"></span>ARP<span class="jill"></span>请求不是给自己的，则直接丢弃；而这里<span class="jill"></span>PC3（Hacker）在监听之后，发起了<span class="jill"></span>ARP<span class="jill"></span>回应包：</span><span class="inline-wrap"><b>我就是<span class="jill"></span>PC2（IP2-MAC3）</b></span><span class="inline-wrap">。</span></div></div><div id="2unPUTGBZumkD2Ti5XnAvg" class="wolai-block wolai-text"><div><span class="inline-wrap">从拓扑可以出现，PC3<span class="jill"></span>明明是<span class="jill"></span>IP3<span class="jill"></span>对应<span class="jill"></span>MAC3，很显然这就是一个<span class="jill"></span>ARP<span class="jill"></span>欺骗行为。于此同时，PC2<span class="jill"></span>正常的<span class="jill"></span>ARP<span class="jill"></span>回应包也交到了<span class="jill"></span>PC1<span class="jill"></span>手中，我们来看<span class="jill"></span>PC1<span class="jill"></span>接下来如何处理的：</span></div></div><div id="nGcgyz1fBrtz6Lys7NtMtM" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-d234cb3ec99e072f16c7000358284641_b.jpg"/></figure></div><div id="jJzFzQUtm6myRW2FkF2wiP" class="wolai-block wolai-text"><div><span class="inline-wrap">PC1<span class="jill"></span>收到两个<span class="jill"></span>ARP<span class="jill"></span>回应包，内容分别如下：</span></div></div><div id="wWJkEm2rMbgFYCoWB85bdZ" class="wolai-block wolai-text"><div><span class="inline-wrap">③我是<span class="jill"></span>PC2，我的<span class="jill"></span>IP<span class="jill"></span>地址是</span><span class="inline-wrap"><b>IP2</b></span><span class="inline-wrap">，我的<span class="jill"></span>MAC<span class="jill"></span>地址是</span><span class="inline-wrap"><b>MAC2</b></span><span class="inline-wrap">；</span></div></div><div id="rM82ziV5GF2NYF8hbSvajy" class="wolai-block wolai-text"><div><span class="inline-wrap">③我是<span class="jill"></span>PC2，我的<span class="jill"></span>IP<span class="jill"></span>地址是</span><span class="inline-wrap"><b>IP2</b></span><span class="inline-wrap">，我的<span class="jill"></span>MAC<span class="jill"></span>地址是</span><span class="inline-wrap"><b>MAC3</b></span><span class="inline-wrap">；</span></div></div><div id="sxLNcJZitWshqUt5XMYF5A" class="wolai-block wolai-text"><div><span class="inline-wrap">PC1<span class="jill"></span>一脸懵：</span><span class="inline-wrap"><b>咋回事？还有这操作？不管了，我选最新的！（后到优先）</b></span></div></div><div id="6naizkzM5F2g3hPkdBdpH5" class="wolai-block wolai-text"><div><span class="inline-wrap">这里给大家顺便普及下网络协议里各种表在处理缓存信息的方式：</span></div></div><div id="7BaGg7hvQpjWdebK7myLxi" class="wolai-block wolai-text"><div><span class="inline-wrap">要么&quot;先到先得&quot;，要么&quot;后到优先&quot;。上面提到的<span class="jill"></span>ARP<span class="jill"></span>和<span class="jill"></span>CAM<span class="jill"></span>表，就是遵循&quot;后到优先&quot;原则，而后面章节我们会讲到的<span class="jill"></span>DHCP<span class="jill"></span>表，则遵循&quot;先到先得&quot;原则。</span></div></div><div id="ow2aGnnYQ8GFyDi6tFqrph" class="wolai-block wolai-text"><div><span class="inline-wrap">那么问题来了，上面两个<span class="jill"></span>ARP<span class="jill"></span>回应包到底哪个先到哪个后到呢？</span></div></div><div id="kq8dK1BCALALMXP8XNvE4s" class="wolai-block wolai-text"><div><span class="inline-wrap">作为初学者，可能还在纠结前后这种<span class="jill"></span>naive<span class="jill"></span>的问题；而作为<span class="jill"></span>hacker，只要持续不停发出<span class="jill"></span>ARP<span class="jill"></span>欺骗包，就一定能够覆盖掉正常的<span class="jill"></span>ARP<span class="jill"></span>回应包。</span><span class="inline-wrap"><b>稳健的<span class="jill"></span>ARP<span class="jill"></span>嗅探/渗透工具，能在短时间内高并发做网络扫描（例如<span class="jill"></span>1<span class="jill"></span>秒钟成千上百的数据包），能够持续对外发送欺骗包。</b></span><span class="inline-wrap"> </span></div></div><div id="wsJ4NeyH2LhfdQUNzfr7XQ" class="wolai-block wolai-text"><div><span class="inline-wrap">无论如何，当<span class="jill"></span>PC1<span class="jill"></span>和<span class="jill"></span>PC2<span class="jill"></span>这种&quot;小白&quot;用户遇到<span class="jill"></span>PC3（hacker）时，最终的结果一定是这样的：</span></div></div><div id="bxd54XQVdPgBMmhuPxz4YV" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-f898793fd3a4f37272dfc31d2ecbaa55_b.jpg"/></figure></div><div id="7Nt2Qdj3ztzDF9GYZfDjC5" class="wolai-block wolai-text"><div><span class="inline-wrap">小白 vs 黑客，很明显的较量，PC1<span class="jill"></span>最终记录的是虚假的<span class="jill"></span>ARP<span class="jill"></span>映射：IP2&lt;-&gt;MAC3，得到错误信息的<span class="jill"></span>PC1，接下来会发生什么情况呢？（我们以<span class="jill"></span>PC1 ping PC2<span class="jill"></span>为例）</span></div></div><div id="7ihFTchzVyRXx4wQZegC1k" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-bade17b91e12c9f9ad5536858abf1350_b.jpg"/></figure></div><div id="ijmBCfxNjXv58QScTi945E" class="wolai-block wolai-text"><div><span class="inline-wrap">根据数据封装规则，当<span class="jill"></span>PC1<span class="jill"></span>要跟<span class="jill"></span>PC2<span class="jill"></span>进行通信时，无论是发生<span class="jill"></span>PING<span class="jill"></span>包还是发送其他数据，首先要查找<span class="jill"></span>ARP<span class="jill"></span>表，然后在网络层打上源目<span class="jill"></span>IP，在链路层打上源目<span class="jill"></span>MAC，然后将数据包发送给交换机。交换机收到之后对数据进行解封装，并且查看<span class="jill"></span>CAM<span class="jill"></span>表（基于目的<span class="jill"></span>MAC<span class="jill"></span>转发），由于目标<span class="jill"></span>MAC3<span class="jill"></span>对应<span class="jill"></span>Port3，所以交换机自然而然将其转发给<span class="jill"></span>PC3。</span></div></div><div id="pPgggeXgvUAPrHXMRuYMMz" class="wolai-block wolai-text"><div><span class="inline-wrap">就这样，PC1<span class="jill"></span>本来要发给<span class="jill"></span>PC2<span class="jill"></span>的数据包，落到了<span class="jill"></span>PC3（Hacker）手里，这就完成了一次完整的<span class="jill"></span>ARP<span class="jill"></span>攻击。反过来，</span><span class="inline-wrap"><b>如果<span class="jill"></span>PC2<span class="jill"></span>要将数据包发送给<span class="jill"></span>PC1，PC3<span class="jill"></span>仍然可以以同样的<span class="jill"></span>ARP<span class="jill"></span>欺骗实现攻击</b></span><span class="inline-wrap">，这就有了下面这张图（PC3<span class="jill"></span>既欺骗了<span class="jill"></span>PC1，也欺骗了<span class="jill"></span>PC2）。</span></div></div><div id="rUcGjQSaPzx2VdMMJi4kqN" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-317858c5badea87786011cb8eda6d3fd_b.jpg"/></figure></div><div id="iF5Z88MXTeVvuL1r74gPDN" class="wolai-block wolai-text"><div><span class="inline-wrap">此时，PC1<span class="jill"></span>和<span class="jill"></span>PC2<span class="jill"></span>的通信数据流被<span class="jill"></span>PC3<span class="jill"></span>拦截，形成了典型的&quot;</span><span class="inline-wrap"><b>中间人攻击</b></span><span class="inline-wrap">&quot;。那么，一旦被攻击并拦截，攻击者能做什么，普通用户又会遭受什么损失？这里给大家举几个常见的例子=&gt;</span></div></div><div id="c68KLvJ12jNCXNcQ2BiMGk" class="wolai-block wolai-text"><div><span class="inline-wrap">①攻击者既然操控了数据流，那么直接断开通信是轻而易举的，即**&quot;断网攻击&quot;**，例如，PC1<span class="jill"></span>发给<span class="jill"></span>PC2<span class="jill"></span>的数据在<span class="jill"></span>PC3<span class="jill"></span>这里可以直接丢弃，而如果这里的<span class="jill"></span>PC2<span class="jill"></span>是一台出口路由器（无线路由器），那就意味着<span class="jill"></span>PC1<span class="jill"></span>直接无法连上互联网。</span></div></div><div id="2hEmLT3snrKGSgPtSHGn7q" class="wolai-block wolai-text"><div><span class="inline-wrap">②&quot;断网攻击&quot;显然容易被发现，而且比较&quot;残忍&quot;，所以就有了更加常见的应用-</span><span class="inline-wrap"><b>&quot;限速&quot;</b></span><span class="inline-wrap">。例如，在宿舍上网突然很慢，在网吧上网突然打不开网页，如果这个网络没有安全防御，那么很有可能有&quot;内鬼&quot;。</span></div></div><div id="dR6e455353PiBrDtWyMtw7" class="wolai-block wolai-text"><div><span class="inline-wrap">③其实无论是&quot;断网攻击&quot;还是&quot;限速&quot;，整体还是比较&quot;善良&quot;，因为这里流量里面的核心数据还没有被&quot;提取&quot;出来。如果攻击者是一名真正的黑客，他的目的一定不会这么无聊，因为内网流量对于黑客是没有太大价值的，而只有**&quot;用户隐私&quot;**，例如常见网站的登录账号密码，这些才是最有价值的。</span></div></div><div id="udveoVQkUkJSvki2hDretv" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>问：遭受<span class="jill"></span>ARP<span class="jill"></span>攻击之后，哪些账号可能被窃取？</b></span></div></div><div id="qD1WuqvNCtQLJE16ks7LVk" class="wolai-block wolai-text"><div><span class="inline-wrap">答：</span><span class="inline-wrap"><b>任何基于明文传输的应用，都可以被窃取。</b></span><span class="inline-wrap"> 例如，如果一个网站不是<span class="jill"></span>HTTPS<span class="jill"></span>协议，而是基于<span class="jill"></span>HTTP<span class="jill"></span>明文传输，那么当你登录这个网站时，你的密码就会被窃取。除了<span class="jill"></span>http（web<span class="jill"></span>应用），常见的还有<span class="jill"></span>telnet、ftp、pop3/smtp/imap（邮箱）等应用，都很容易泄露密码。</span></div></div><div id="2GEwFN8zPfwAjjQDBndyUz" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>三、常见<span class="jill"></span>ARP<span class="jill"></span>渗透工具与底层原理分析</b></span></div></div><div id="3FQdJTzHyP2jkfN8JCNLjs" class="wolai-block wolai-text"><div><span class="inline-wrap">基于<span class="jill"></span>ARP<span class="jill"></span>欺骗原理设计出来的渗透/攻击工具非常多，而最终能实现什么功能则各有差异，简单举几个例子：</span></div></div><div id="iJKXzXFscvmpHhvvJeuhy6" class="wolai-block wolai-text"><div><span class="inline-wrap">①无毒无害型的</span><span class="inline-wrap"><b>仅具备<span class="jill"></span>ARP<span class="jill"></span>扫描</b></span><span class="inline-wrap">功能，用来发现内网主机；例如<span class="jill"></span>Metasploit<span class="jill"></span>里面的<span class="jill"></span>arping/arpscan<span class="jill"></span>相关模块；</span></div></div><div id="kNM9TKQ8crsdAbs7DPhu9x" class="wolai-block wolai-text"><div><span class="inline-wrap">②</span><span class="inline-wrap"><b>ARP<span class="jill"></span>扫描<span class="jill"></span>+<span class="jill"></span>流量控制</b></span><span class="inline-wrap">（限速或限制能上哪些网站和应用）；例如<span class="jill"></span>Windows<span class="jill"></span>下的<span class="jill"></span>P2P<span class="jill"></span>终结者；</span></div></div><div id="dCt64adLsYAV89ZLczcwXq" class="wolai-block wolai-text"><div><span class="inline-wrap">③</span><span class="inline-wrap"><b>ARP<span class="jill"></span>扫描<span class="jill"></span>+<span class="jill"></span>账号窃取</b></span><span class="inline-wrap">（网站、邮箱、各种）；最强的莫过于<span class="jill"></span>Windows<span class="jill"></span>下的<span class="jill"></span>Cain，当然还有跨平台的<span class="jill"></span>Ettercap（需配合其他工具）；</span></div></div><div id="hxQNAQ2WiDJdkayinCXafw" class="wolai-block wolai-text"><div><span class="inline-wrap">当然，如果攻击者足够强悍，也可以基于协议底层原理，编写自己的<span class="jill"></span>ARP<span class="jill"></span>工具。这里我</span><span class="inline-wrap"><b>通过<span class="jill"></span>wirehshark<span class="jill"></span>给大家还原真实网络中常见的<span class="jill"></span>ARP<span class="jill"></span>扫描和欺骗攻击</b></span><span class="inline-wrap">（具体的软件使用这里暂时不出现，大家重点关注底层实现）。</span></div></div><div id="hqR9vhysRsgZHuaywkMsqf" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-af057558ef563955ede46f22ea77c335_b.jpg"/></figure></div><div id="phaiKevw113KjF86LwT78F" class="wolai-block wolai-text"><div><span class="inline-wrap">在这张图里面，Hacker（就是我...）接入了一个<span class="jill"></span>WiFi<span class="jill"></span>网络，这个<span class="jill"></span>10.1.20.0/24<span class="jill"></span>便是所在的网段。刚进来一个陌生网络，Hacker<span class="jill"></span>只知道自己的<span class="jill"></span>IP<span class="jill"></span>信息，例如<span class="jill"></span>IP<span class="jill"></span>地址是<span class="jill"></span>10.1.20.253，网关地址是<span class="jill"></span>10.1.20.254，而这个局域网的其他设备是什么？有多少台？地址分布是多少？Hacker<span class="jill"></span>都不知道，接下来怎么办呢？是不是要直接发动<span class="jill"></span>ARP<span class="jill"></span>攻击了？</span></div></div><div id="iyDmYnkdFvnSkFKra6Ynhk" class="wolai-block wolai-text"><div><span class="inline-wrap">不用这么着急，咋们至少要先了解下这个网络，进行基本的</span><span class="inline-wrap"><b>扫描和踩点</b></span><span class="inline-wrap">。这个时候通过<span class="jill"></span>ARP<span class="jill"></span>工具对这个<span class="jill"></span>WiFi<span class="jill"></span>网络进行扫描，具体的数据包截图如下：</span></div></div><div id="6yBZLJRaYpzD7yWJwX8pXn" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-4be85864ff433d20b9e1165fe7cc36c3_b.jpg"/></figure></div><div id="aTD4CUFckdkmXSN2VwphoQ" class="wolai-block wolai-text"><div><span class="inline-wrap">上面的<span class="jill"></span>ARP<span class="jill"></span>扫描过程，大概的情况是这样的=&gt;</span></div></div><div id="sPR3QgHzCkTzoyXWyyESf3" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-bc0c22f0043748b52cceaf185804694b_b.jpg"/></figure></div><div id="jPm4863eYNnwkFC6rzTi7i" class="wolai-block wolai-text"><div><span class="inline-wrap">其实，这就是典型的&quot;盲扫&quot;或者&quot;暴力扫描&quot;：反正我不知道网络到底有多少主机，那我就尝试一下把整个网段全部问一遍得了。</span><span class="inline-wrap"><b>好比老师上课点名，把每个学生的桌位号念一遍，谁举手就到勤，没举手就算逃课。</b></span><span class="inline-wrap"> </span></div></div><div id="oxwSHrJ4Rg3JjHye6SPJV4" class="wolai-block wolai-text"><div><span class="inline-wrap">那么，这个实际网络里面，到底谁&quot;举手&quot;了呢？我们来看<span class="jill"></span>Wireshark<span class="jill"></span>抓包情况。</span></div></div><div id="9Srtu6ijo2tR8aHzao6aUp" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-c2b83eee5c96827c133c45a25d570c56_b.jpg"/></figure></div><div id="gDw1vP9GVfNo4xyyxGawdP" class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>ARP<span class="jill"></span>应答信息里面，除了<span class="jill"></span>IP<span class="jill"></span>地址和<span class="jill"></span>MAC<span class="jill"></span>信息，我们还能看到相关的设备厂商信息，例如<span class="jill"></span>cisco、meizu、apple、xiaomi<span class="jill"></span>等，这其实就是依靠<span class="jill"></span>MAC<span class="jill"></span>地址前面<span class="jill"></span>24<span class="jill"></span>位的**OUI（机构唯一标识符）**来识别的。</span></div></div><div id="nwPjz6UMnXBQg1nNrFhHpJ" class="wolai-block wolai-text"><div><span class="inline-wrap">Wireshark<span class="jill"></span>或扫描器能够帮我们将<span class="jill"></span>OUI<span class="jill"></span>转为对应的厂商（还有一些扫描器基于<span class="jill"></span>Netbios<span class="jill"></span>协议，还能找到电脑的主机名），所以，扫描之后可以得到下面这张图片=&gt;</span></div></div><div id="rkP7TGS2mJkjJCPETVRXTM" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-0f25c1953baf27d3770c4267ee5d5972_b.jpg"/></figure></div><div id="quXRPbKXXGbCJG7vYuK9zn" class="wolai-block wolai-text"><div><span class="inline-wrap">通过扫描，我们已经知道了整个网络的主机信息，例如<span class="jill"></span>20.254<span class="jill"></span>对应<span class="jill"></span>cisco，应该是路由器，20.248<span class="jill"></span>对应<span class="jill"></span>apple，是苹果手机，20.249<span class="jill"></span>对应<span class="jill"></span>xiaomi，是小米手机，以此类推.....</span></div></div><div id="jFdmoZEgiXcKYNpFzDsvD1" class="wolai-block wolai-text"><div><span class="inline-wrap">接下来，如何进行<span class="jill"></span>ARP<span class="jill"></span>欺骗攻击呢？这里将最重点的数据包截取出来=&gt;</span></div></div><div id="ok8Cjhga92YhLxEXMKtW4L" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-2788e3e061f7ee8af394dea99a5e732c_b.jpg"/></figure></div><div id="hrLNJDC15SkdtHHCBFuwmi" class="wolai-block wolai-text"><div><span class="inline-wrap">根据之前的信息，我们知道<span class="jill"></span>00:08:ca:86:f8:0f<span class="jill"></span>其实就是<span class="jill"></span>hacker<span class="jill"></span>的<span class="jill"></span>mac<span class="jill"></span>地址，并且对应的真正的<span class="jill"></span>IP<span class="jill"></span>地址应该是<span class="jill"></span>10.1.20.253。而这里很明显是</span><span class="inline-wrap"><b>hacker<span class="jill"></span>在欺骗局域网其他主机，它对外声称：自己就是&quot;所有人&quot;</b></span><span class="inline-wrap">。尤其是上面标红的主机，我们已经知道是小米、思科、苹果等设备，但是<span class="jill"></span>hacker<span class="jill"></span>都声明是自己！这样做的意义在于覆盖掉其他主机的<span class="jill"></span>ARP<span class="jill"></span>缓存表信息，并生成错误的<span class="jill"></span>ARP<span class="jill"></span>映射，最终将通信流量交给<span class="jill"></span>hacker。</span></div></div><div id="9tazfghCiMPPsNacrgZoEC" class="wolai-block wolai-text"><div><span class="inline-wrap">当然，还有另外一种<span class="jill"></span>ARP<span class="jill"></span>欺骗的做法：</span><span class="inline-wrap"><b>hacker<span class="jill"></span>告诉所有人，自己就是网关</b></span><span class="inline-wrap">。因为其他主机访问互联网必经之路便是网关（出口路由器/无线路由器），通过这种方式，同样可以截取到用户数据流，这里给出另外一个网络的实现过程=&gt;</span></div></div><div id="g6vTGSD2qdrDzPSVmyNEKH" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Hacker<span class="jill"></span>欺骗主机<span class="jill"></span>Honhai，告诉它：我就是网关（10.1.1.254）</b></span></div></div><div id="mXsr2n4kuqc2KR8BVugWep" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-412742914a0c84bb53a020e66a771ecb_b.jpg"/></figure></div><div id="njhKzP1VXZrg2SGC8HXkxK" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Hacker<span class="jill"></span>欺骗主机<span class="jill"></span>Apple，告诉它：我就是网关（10.1.1.254）</b></span></div></div><div id="h4v97qzJn6HWcC7hNETHva" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-1185c84e361ae6e5be13a78d917cec20_b.jpg"/></figure></div><div id="hT3t8LW999TVP7Y8HvcwD4" class="wolai-block wolai-text"><div><span class="inline-wrap">依此类推，Hacker<span class="jill"></span>会告诉局域网所有主机：自己就是网关，并且后续可以把数据都丢给我，我来转发到互联网。</span></div></div><div id="hAhFSdNvLNuTXvh6CP2V6N" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>四、ARP<span class="jill"></span>攻击总结</b></span></div></div><div id="roNpo5mYnBk4BhtTzS4R8C" class="wolai-block wolai-text"><div><span class="inline-wrap">①ARP<span class="jill"></span>缓存表基于&quot;后到优先&quot;原则，IP<span class="jill"></span>与<span class="jill"></span>MAC<span class="jill"></span>的映射信息能被覆盖；</span></div></div><div id="5geiipKk6JdAVzHt3qzE8H" class="wolai-block wolai-text"><div><span class="inline-wrap">②ARP<span class="jill"></span>攻击基于伪造的<span class="jill"></span>ARP<span class="jill"></span>回应包，黑客通过构造&quot;错位&quot;的<span class="jill"></span>IP<span class="jill"></span>和<span class="jill"></span>MAC<span class="jill"></span>映射，覆盖主机的<span class="jill"></span>ARP<span class="jill"></span>表（也被称为&quot;ARP<span class="jill"></span>毒化&quot;），最终截取用户的数据流；</span></div></div><div id="4J1gebtniE1ecMDQm88D4A" class="wolai-block wolai-text"><div><span class="inline-wrap">③一旦遭受<span class="jill"></span>ARP<span class="jill"></span>攻击，账号密码都可能被窃取（如果通信协议不是加密的）；</span></div></div><div id="buNTTkzUxAbJSVgynSkUpu" class="wolai-block wolai-text"><div><span class="inline-wrap">④通过<span class="jill"></span>Wireshark<span class="jill"></span>数据包分析，我们掌握了真实网络中<span class="jill"></span>ARP<span class="jill"></span>底层攻击原理及数据包组成。</span></div></div><div id="f7wk5sPe589bBTvknNn41b" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>预告：ARP<span class="jill"></span>防御篇</b></span></div></div><div id="GWRcBCYUKao7XxqmMhnZA" class="wolai-block wolai-text"><div><span class="inline-wrap">如何防御<span class="jill"></span>ARP<span class="jill"></span>攻击？</span></div></div><div id="qaq8ku5WcTjWafqqFeyNcN" class="wolai-block wolai-text"><div><span class="inline-wrap">有哪些<span class="jill"></span>ARP<span class="jill"></span>防御软件？</span></div></div><div id="7RkSSu8gySkPP27zYXDTmK" class="wolai-block wolai-text"><div><span class="inline-wrap">如果被<span class="jill"></span>ARP<span class="jill"></span>攻击了，如何揪出&quot;内鬼&quot;，应该如何&quot;还手&quot;？</span></div></div><div id="hcHjP9KdJdHMyCS3vMFRAe" class="wolai-block wolai-text"><div><span class="inline-wrap">企业网/家庭网的防御方法有什么区别？</span></div></div><div id="5iSpsyUo3Ak7m8QaXXWGGZ" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>【相关推荐】</b></span><span class="inline-wrap"> </span></div></div><div id="7HoHMs3Uw4p9UgcybcoaXC" class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://zhuanlan.zhihu.com/p/28771785"><span>图解<span class="jill"></span>ARP<span class="jill"></span>协议（一）</span></a></span></div></div><div id="nQX1xSk6hntb39CwAPpeNp" class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.pinginglab.net/course/164"><span>《TCP/IP<span class="jill"></span>协议栈视频教程》</span></a></span></div></div><div id="wTC1QJL3WHw343mr7xgbhb" class="wolai-block wolai-text"><div><span class="inline-wrap">新浪微博：</span><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.weibo.com/jaykingchen"><span>@<span class="jill"></span>拼客学院陈鑫杰</span></a></span></div></div><div id="i625ajhDKWr8qbxqjsuJDG" class="wolai-block wolai-text"><div><span class="inline-wrap">微信公众号：拼客院长陈鑫杰</span></div></div><div id="xiKPdTSsKcam59mzAVXN46" class="wolai-block wolai-text"><div><span class="inline-wrap">拼客学院：</span><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.pinginglab.net"><span>http://www.pinginglab.net</span></a></span></div></div></div><div id="krhQ9EPTDDAMxL9XepuiNq" class="wolai-sub-page wolai-block"><div class="page-icon"></div><a href="ipv4%E5%8D%8F%E8%AE%AE/arp/%E5%9B%BE%E8%A7%A3arp%E5%8D%8F%E8%AE%AE%EF%BC%88%E4%B8%89%EF%BC%89arp%E9%98%B2%E5%BE%A1%E7%AF%87-%E5%A6%82%E4%BD%95%E6%8F%AA/%E5%9B%BE%E8%A7%A3arp%E5%8D%8F%E8%AE%AE%EF%BC%88%E4%B8%89%EF%BC%89arp%E9%98%B2%E5%BE%A1%E7%AF%87-%E5%A6%82%E4%BD%95%E6%8F%AA.html"><span>图解ARP协议（三）ARP防御篇-如何揪出"内鬼"并"优雅的还手"？ - 知乎</span></a><div id="wmNMa3yh54H8qtH6w9DPLv" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>一、ARP<span class="jill"></span>防御概述</b></span></div></div><div id="3vvApwMcAEgVwY6BhZKezE" class="wolai-block wolai-text"><div><span class="inline-wrap">通过之前的文章，我们已经了解了<span class="jill"></span>ARP<span class="jill"></span>攻击的危害，黑客采用<span class="jill"></span>ARP<span class="jill"></span>软件进行扫描并发送欺骗应答，同处一个局域网的普通用户就可能遭受断网攻击、流量被限、账号被窃的危险。由于攻击门槛非常低，普通人只要拿到攻击软件就可以扰乱网络秩序，导致现在的公共网络、家庭网络、校园网、企业内网等变得脆弱无比。  </span></div></div><div id="6XSvJxtwcquNuowP3eRm4Z" class="wolai-block wolai-text"><div><span class="inline-wrap">所以，</span><span class="inline-wrap"><b>如何进行有效的<span class="jill"></span>ARP<span class="jill"></span>防御？作为普通用户怎么防御？作为网络/安全管理员又怎么防御？有哪些<span class="jill"></span>ARP<span class="jill"></span>防御软件？如果被<span class="jill"></span>ARP<span class="jill"></span>攻击了，如何揪出&quot;内鬼&quot;并&quot;优雅的还手&quot;？</b></span></div></div><div id="s2CHoiPSm937tHVih9mRkQ" class="wolai-block wolai-text"><div><span class="inline-wrap">接下来，我们通过图解的方式来深入了解<span class="jill"></span>ARP<span class="jill"></span>防御原理与解决方案。</span></div></div><div id="7knwLBvgnB1XPfQxs9rJ8m" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>二、ARP<span class="jill"></span>防御原理与解决方案</b></span></div></div><div id="iw7gVGDjF1CGYZLLXRSnMc" class="wolai-block wolai-text"><div><span class="inline-wrap">在讲解<span class="jill"></span>ARP<span class="jill"></span>防御之前，我们先回顾下<span class="jill"></span>ARP<span class="jill"></span>攻击最经典的一幕=&gt;</span></div></div><div id="br238yrUWun5hghYLcrVjS" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-6bdada4a155db5af615bf606c757919b_b.jpg"/></figure></div><div id="eQLYiYnzk66MAxpGKTbCA2" class="wolai-block wolai-text"><div><span class="inline-wrap">当<span class="jill"></span>PC1<span class="jill"></span>询问<span class="jill"></span>PC2<span class="jill"></span>的<span class="jill"></span>MAC<span class="jill"></span>地址时，攻击者<span class="jill"></span>PC3<span class="jill"></span>返回</span><span class="inline-wrap"><b>ARP<span class="jill"></span>欺骗回应包</b></span><span class="inline-wrap">：</span><span class="inline-wrap"><b>我的<span class="jill"></span>IP<span class="jill"></span>地址是<span class="jill"></span>IP2，MAC<span class="jill"></span>地址是<span class="jill"></span>MAC3</b></span><span class="inline-wrap">。一旦<span class="jill"></span>PC1<span class="jill"></span>记录了错误的<span class="jill"></span>ARP<span class="jill"></span>映射，则发给与<span class="jill"></span>PC2<span class="jill"></span>的数据，都会落到<span class="jill"></span>PC3<span class="jill"></span>手里。</span></div></div><div id="ekbLwHo4MWi8rpdgJUyz64" class="wolai-block wolai-text"><div><span class="inline-wrap">也就是说，</span><span class="inline-wrap"><b>ARP<span class="jill"></span>攻击的罪魁祸首便是这种&quot;欺骗包&quot;</b></span><span class="inline-wrap">，若针对欺骗包的处理是不相信或不接收的话，则不会出现问题。处理这种欺骗行为我们没法提前在黑客端做手脚，因为&quot;</span><span class="inline-wrap"><b>敌在暗处我在明处</b></span><span class="inline-wrap">&quot;。这样的话，我们就剩下两个解决方法：</span></div></div><div id="jkYxayCHwTDMaMiAm1QDv6" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>①保证电脑不接收欺骗包</b></span></div></div><div id="fyxwvkxMXDtrc7UxnWdQAm" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>②保证电脑收到欺骗包之后不相信</b></span></div></div><div id="nw5unpNPT5aB7AX8hHgn4Q" class="wolai-block wolai-text"><div><span class="inline-wrap">目前网络安全行业现有的<span class="jill"></span>ARP<span class="jill"></span>防御方案，基本都是上面两个方法的具体实现。我们来看看这张防御图：</span></div></div><div id="jCa57NB9R21gMQtScoenK2" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-0f3d333a7235540a9071d1be4827b14e_b.jpg"/></figure></div><div id="oVgYbBGn5A5JJps66vtpYd" class="wolai-block wolai-text"><div><span class="inline-wrap">①当黑客发起<span class="jill"></span>ARP<span class="jill"></span>欺骗包时，会途径局域网里面的交换机或无线路由器等网络设备；</span></div></div><div id="5wEEtMJpkz6cCohduvsRb1" class="wolai-block wolai-text"><div><span class="inline-wrap">②如果网络设备能够识别这种欺骗包，并且提前丢弃掉，则电脑/手机端就不会被欺骗；</span></div></div><div id="ebRkUcPKHj5smqpBH3nAUw" class="wolai-block wolai-text"><div><span class="inline-wrap">③如果网络设备没有拦截这种欺骗包，则电脑/手机端需要做安全防御，然后再丢弃。</span></div></div><div id="pKdh8gsxxjw8eNtozw3KkT" class="wolai-block wolai-text"><div><span class="inline-wrap">简单来说，</span><span class="inline-wrap"><b>ARP<span class="jill"></span>防御可以在网络设备上实现，也可以在用户端实现，更可以在网络设备和用户端同时实现</b></span><span class="inline-wrap">。接下来，我们先来了解下网络设备（例如这里的交换机）的防御技术。</span></div></div><div id="36nzcswyFVybetECAmJemJ" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-80f7fb94356f4885ccb5945944b41bdc_b.jpg"/></figure></div><div id="wyfq2aqGXCkUGHYLGoh5hC" class="wolai-block wolai-text"><div><span class="inline-wrap">上面这张图，展现的是交换机的<span class="jill"></span>ARP<span class="jill"></span>防御能力，当<span class="jill"></span>PC2<span class="jill"></span>发送<span class="jill"></span>ARP<span class="jill"></span>回应包时，交换机将其转发给<span class="jill"></span>PC1，而当<span class="jill"></span>PC3<span class="jill"></span>发送<span class="jill"></span>ARP<span class="jill"></span>回应包（欺骗）时，交换机直接丢弃。</span></div></div><div id="ffT9G95JPNpVHYnDxmEw2E" class="wolai-block wolai-text"><div><span class="inline-wrap">但是，**人家<span class="jill"></span>PC3<span class="jill"></span>上脸上又没有写着&quot;hacker&quot;，凭什么交换机要丢弃它的<span class="jill"></span>ARP<span class="jill"></span>回应包？**凭什么判断它的包就是&quot;欺骗&quot;的呢？</span></div></div><div id="fHE6YZS742Yz1qpJgNyNEc" class="wolai-block wolai-text"><div><span class="inline-wrap">接下来，我就要给大家介绍下局域网安全里比较常用的防御技术，这种防御技术被称为</span><span class="inline-wrap"><b>DAI（Dynamic ARP Inspection）- 动态<span class="jill"></span>ARP<span class="jill"></span>检测</b></span><span class="inline-wrap">，原理可以用两句话简单概括：</span></div></div><div id="9P4DC7zZ6RNXaZrrynqEnd" class="wolai-block wolai-text"><div><span class="inline-wrap">①交换机记录每个接口对应的<span class="jill"></span>IP<span class="jill"></span>地址和<span class="jill"></span>MAC，即</span><span class="inline-wrap"><b>port&lt;-&gt;mac&lt;-&gt;ip</b></span><span class="inline-wrap">，生成<span class="jill"></span>DAI<span class="jill"></span>检测表；</span></div></div><div id="6fBHcXFTQQYRXUaYnDsYa9" class="wolai-block wolai-text"><div><span class="inline-wrap">②交换机检测每个接口发送过来的<span class="jill"></span>ARP<span class="jill"></span>回应包，根据<span class="jill"></span>DAI<span class="jill"></span>表判断是否违规，若违规则丢弃此数据包并对接口进行惩罚。</span></div></div><div id="iAV9JkMoAF2EbgX7WqZk4g" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-eb118e62462a86087600685992c67ca3_b.jpg"/></figure></div><div id="dSGRHUHjLckdzFqpyworSn" class="wolai-block wolai-text"><div><span class="inline-wrap">我们知道，PC3<span class="jill"></span>是在交换机的<span class="jill"></span>Port3、MAC<span class="jill"></span>地址是<span class="jill"></span>MAC3，IP<span class="jill"></span>地址是<span class="jill"></span>IP3，所以本地<span class="jill"></span>DAI<span class="jill"></span>表项内容是**&lt;port3-mac3-ip3&gt;</span><span class="inline-wrap"><b>。当交换机从接口<span class="jill"></span>Port3<span class="jill"></span>收到<span class="jill"></span>ARP<span class="jill"></span>回应包，内容却是<span class="jill"></span>IP2<span class="jill"></span>和<span class="jill"></span>MAC3<span class="jill"></span>映射，即</b></span><span class="inline-wrap">&lt;port3-mac3-ip2&gt;。** </span></div></div><div id="2iT39nLmiiXu9paUNC2AR5" class="wolai-block wolai-text"><div><span class="inline-wrap">经判断，这个包就是虚假的欺骗包，交换机马上丢弃这个包，并且可以对接口做惩罚（不同设备的惩罚方式有所不同，可以直接将接口&quot;</span><span class="inline-wrap"><b>软关闭</b></span><span class="inline-wrap">&quot;，直接将攻击者断网；也可以&quot;</span><span class="inline-wrap"><b>静默处理</b></span><span class="inline-wrap">&quot;，仅丢弃欺骗包，其他通信正常）</span></div></div><div id="fCbKCfEfiABqZXEYxPjsdR" class="wolai-block wolai-text"><div><span class="inline-wrap">上面这个动态<span class="jill"></span>ARP<span class="jill"></span>监测技术，可以说是目前防御<span class="jill"></span>ARP<span class="jill"></span>攻击最有效的方法之一。但是，作为初学者，大家可能还会有疑问：</span></div></div><div id="gfBTeXfGF29iiMqdM9rQiy" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>①一般的交换机或网络设备能部署动态<span class="jill"></span>ARP<span class="jill"></span>监测技术吗？</b></span></div></div><div id="bKiXcfHE9rK6Z8fbRXZtZf" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>②连接用户的交换机，怎么能识别<span class="jill"></span>IP<span class="jill"></span>地址信息呢？</b></span></div></div><div id="5PWLXh5e8AwMq8z4A5FN2E" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>③上面这张<span class="jill"></span>DAI<span class="jill"></span>表是如何生成的？是不是像<span class="jill"></span>CAM<span class="jill"></span>表一样能自动识别？</b></span></div></div><div id="8CCG5gZrT5VemjLnNaUnGf" class="wolai-block wolai-text"><div><span class="inline-wrap">这里要给大家说个稍微悲伤一点的事实，</span><span class="inline-wrap"><b>大部分能支持这种动态<span class="jill"></span>ARP<span class="jill"></span>监测技术的交换机或者无线路由器，都基本是企业级的产品。</b></span><span class="inline-wrap"> 即便是企业级交换机，具备局域网安全防御功能的设备，价格都要高出不少，所以很多中小型企业网或校园网，基本都愿意买&quot;阉割版&quot;网络接入产品，因为&quot;能通就行&quot;，至于安全性怎样，这是另外要考虑的问题。</span></div></div><div id="qGf1eRqt26gLh472mKuHyH" class="wolai-block wolai-text"><div><span class="inline-wrap">所以，</span><span class="inline-wrap"><b>简单的交换机不具备动态<span class="jill"></span>ARP<span class="jill"></span>监测技术</b></span><span class="inline-wrap">，即便市面上有带安全防御的网络产品，企业、学校、医院等大量网络，仍然在早期采购的时候，用的是比较基础版本的交换机。当然，随着网络与安全市场的激烈竞争和网络安全意识的增强，以后会越来越好。</span></div></div><div id="sG3GcnCKYmb7eFKzoHfdEN" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>另外，交换机能识别<span class="jill"></span>IP<span class="jill"></span>地址信息吗？</b></span></div></div><div id="8GiKhpdjKZyfnyoE3SGfuL" class="wolai-block wolai-text"><div><span class="inline-wrap">从现在的网络技术来看，分层界限越来越模糊，融合式的网络设备才是主流，现在的接入交换机基本能被<span class="jill"></span>Telnet/SSH/Web<span class="jill"></span>管理，更专业的交换机同时支持动态<span class="jill"></span>ARP<span class="jill"></span>监测（dai）、IP<span class="jill"></span>源防护（ipsg）、DHCP<span class="jill"></span>侦听（dhcp snooping）、端口安全、AAA、802.1x<span class="jill"></span>等局域网安全技术，已经超越了原有二层交换机的定义。</span></div></div><div id="aMzDNG6crhseLDiF6EmjBZ" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>所以，交换机能读三层甚至七层的数据包已经不是什么新鲜事了，不要被&quot;交换机就是二层设备&quot;给束缚了</b></span><span class="inline-wrap">，这只是纸面上的定义。</span></div></div><div id="mYLrUU9r6NqrX4AUqQknTd" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>最后一个问题，DAI<span class="jill"></span>检测表是如何生成的？</b></span></div></div><div id="dP6fBZL9vaYdYgQM8XkoBn" class="wolai-block wolai-text"><div><span class="inline-wrap">在上面图解中，我们看到交换机查看的表已经不是原来的<span class="jill"></span>CAM<span class="jill"></span>表了，内容也不太一样，CAM<span class="jill"></span>表的内容主要是<span class="jill"></span>MAC<span class="jill"></span>和<span class="jill"></span>Port<span class="jill"></span>的映射，而<span class="jill"></span>DAI<span class="jill"></span>检测表则是<span class="jill"></span>Port、MAC、IP<span class="jill"></span>三个信息映射。</span></div></div><div id="qNwTcvcEkxJQ7wr3EiWBMT" class="wolai-block wolai-text"><div><span class="inline-wrap">目前这张表支持两种方式来生成=&gt;</span></div></div><div id="cNR7CYaTFQBvkPXQ6W7rCi" class="wolai-block wolai-text"><div><span class="inline-wrap">第一种方式就是</span><span class="inline-wrap"><b>手工静态绑定</b></span><span class="inline-wrap">：即用户接入网络之后，管理员根据此用户电脑的<span class="jill"></span>MAC<span class="jill"></span>和<span class="jill"></span>IP<span class="jill"></span>地址，然后在接口上绑死，缺点就是用户数太多的话，手工绑定管不过来。</span></div></div><div id="6KCZgvU7Ha7Z1tvvutaNq9" class="wolai-block wolai-text"><div><span class="inline-wrap">第二种方式就是目前最主流的做法，即</span><span class="inline-wrap"><b>在交换机上开启<span class="jill"></span>DHCP<span class="jill"></span>侦听</b></span><span class="inline-wrap">技术，当用户第一次通过<span class="jill"></span>DHCP<span class="jill"></span>获取到地址的时候，交换机就把用户电脑的<span class="jill"></span>IP、MAC、Port<span class="jill"></span>信息记录在<span class="jill"></span>DHCP<span class="jill"></span>侦听表，后面<span class="jill"></span>ARP<span class="jill"></span>检测直接</span><span class="inline-wrap"><b>调用</b></span><span class="inline-wrap">这张<span class="jill"></span>DHCP<span class="jill"></span>侦听表即可。</span></div></div><div id="gkUE4YkcpELDvmhNGjkKGT" class="wolai-block wolai-text"><div><span class="inline-wrap">小结：以上便是在网络设备上部署的<span class="jill"></span>ARP<span class="jill"></span>防御技术，通过动态<span class="jill"></span>ARP<span class="jill"></span>监测技术（DAI），可以很好的解决<span class="jill"></span>ARP<span class="jill"></span>欺骗问题。技术虽好，但局域网内的交换机、无线路由器是否支持<span class="jill"></span>DAI，这个则取决于实际网络情况，尤其是</span><span class="inline-wrap"><b>十面埋伏的公共<span class="jill"></span>WiFi<span class="jill"></span>网络、脆弱无比的家庭网络、能通就行的校园网络......</b></span><span class="inline-wrap"> </span><span class="inline-wrap"><b>我们都应该持怀疑态度，至少不能完全信任这些网络。</b></span><span class="inline-wrap"> </span></div></div><div id="q8JiXNa5amccUoe2xD89V6" class="wolai-block wolai-text"><div><span class="inline-wrap">既然这样的话，**普通用户有没有&quot;自救&quot;的方法，能够抵挡<span class="jill"></span>ARP<span class="jill"></span>攻击呢？**答案是肯定的=&gt;</span></div></div><div id="rPkUhznDqb6HfxZDyzEAtE" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-846c8cfc88733c94b09d4a8d9c66bce8_b.jpg"/></figure></div><div id="ww8k4DZ2z8xDuwNBwD4zVQ" class="wolai-block wolai-text"><div><span class="inline-wrap">对于普通用户，陌生网络不要随意接入，肯定是首选考虑的；当然，这里研究的是用户已经接入了网络，如何做安全防御的问题。从上图可以看到，</span><span class="inline-wrap"><b>用户（电脑或手机）最重要的便是通过安装<span class="jill"></span>ARP<span class="jill"></span>防火墙做安全防御，很多普通用户甚至“以电脑裸奔为豪，以骂安全厂商为荣”，这是对技术的严重藐视，对自己隐私的不负责任。</b></span><span class="inline-wrap"> 普通小白一定要记住一句话：你没有被黑，只是你还没有到达被黑的价值。</span></div></div><div id="3u1hx9FuUrVS4omyov3BqS" class="wolai-block wolai-text"><div><span class="inline-wrap">ARP<span class="jill"></span>防火墙在技术实现上，一般都有以下功能：</span></div></div><div id="wrWburHGUB4oZPE2mvesFx" class="wolai-block wolai-text"><div><span class="inline-wrap">①绑定正确的的<span class="jill"></span>IP<span class="jill"></span>和<span class="jill"></span>MAC<span class="jill"></span>映射，收到攻击包时不被欺骗。</span></div></div><div id="9nYjPRJA1sqKsrCoojwkrd" class="wolai-block wolai-text"><div><span class="inline-wrap">②能够根据网络数据包特征（参考上一篇讲解的<span class="jill"></span>ARP<span class="jill"></span>攻击数据包溯源分析），自动识别局域网存在的<span class="jill"></span>ARP<span class="jill"></span>扫描和欺骗行为，并做出攻击判断（哪个主机做了攻击，IP<span class="jill"></span>和<span class="jill"></span>MAC<span class="jill"></span>是多少）。</span></div></div><div id="7eXCp9tE7sSJp41kmwxna7" class="wolai-block wolai-text"><div><span class="inline-wrap">那么，</span><span class="inline-wrap"><b>有哪些常见的<span class="jill"></span>ARP<span class="jill"></span>安全产品呢？</b></span></div></div><div id="ur5Gkdjx4yN8iZQH22Fgje" class="wolai-block wolai-text"><div><span class="inline-wrap">自带<span class="jill"></span>ARP<span class="jill"></span>防御功能：腾讯电脑管家、360<span class="jill"></span>安全卫士……</span></div></div><div id="mHAsrZPBTY7ySBRDfWzKDD" class="wolai-block wolai-text"><div><span class="inline-wrap">专业的<span class="jill"></span>ARP<span class="jill"></span>防火墙：彩影<span class="jill"></span>ARP、金山贝壳、360ARP<span class="jill"></span>防火墙……</span></div></div><div id="eu1Y2MU4wxygXXxR2vwamL" class="wolai-block wolai-text"><div><span class="inline-wrap">采用安全产品肯定是普通用户最省时省力的做法，而对于技术人/工程师而言，如果不屑于使用安全产品，并且希望解决<span class="jill"></span>ARP<span class="jill"></span>攻击行为，也可以通过&quot;ARP<span class="jill"></span>双向绑定&quot;的技术来实现。</span><span class="inline-wrap"><b>什么是&quot;ARP<span class="jill"></span>双向绑定&quot;呢？</b></span></div></div><div id="sFxAV8KSsiQRLhFbrEwLkk" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-39641f7892e108d90110b2f245f69097_b.jpg"/></figure></div><div id="nLXr98DiPEdSAuHn4YKgYP" class="wolai-block wolai-text"><div><span class="inline-wrap">从上图可以看到，PC1<span class="jill"></span>和<span class="jill"></span>PC2<span class="jill"></span>通信双方都</span><span class="inline-wrap"><b>静态绑定对方的<span class="jill"></span>IP<span class="jill"></span>和<span class="jill"></span>MAC<span class="jill"></span>映射</b></span><span class="inline-wrap">，即便收到<span class="jill"></span>ARP<span class="jill"></span>欺骗包，由于静态绑定的<span class="jill"></span>ARP<span class="jill"></span>映射条目优先级高于动态学习到的，所以可以保证不被欺骗。</span></div></div><div id="tHAYiYCg1KvVSgmt5fsbGh" class="wolai-block wolai-text"><div><span class="inline-wrap">这种做法非常&quot;</span><span class="inline-wrap"><b>绿色无污染</b></span><span class="inline-wrap">&quot;，因为不需要额外的软件安装，但是缺点也非常明显，例如普通用户不知道如何在电脑上做<span class="jill"></span>ARP<span class="jill"></span>静态绑定，另外工作量也比较大，每个主机和网关设备都需要绑定整个局域网的<span class="jill"></span>ARP<span class="jill"></span>静态映射。以下面的家庭<span class="jill"></span>WiFi<span class="jill"></span>网络为例：</span></div></div><div id="r1uh8BgnBG9hpMPBYnqqEW" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-24846f31cf60d1e8b67f9256c3d2b48e_b.jpg"/></figure></div><div id="c5hmPXar9D6qnzRJfNdSNX" class="wolai-block wolai-text"><div><span class="inline-wrap">像这个<span class="jill"></span>WiFi<span class="jill"></span>网络，如果通过<span class="jill"></span>ARP<span class="jill"></span>双向绑定来解决安全问题，配置量其实蛮大的，当然，这就基本能够保障内网主机间通过以及主机访问互联网的安全性了。</span></div></div><div id="ehkGkR3KyAxV5aqe1WSYSa" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Windows arp<span class="jill"></span>静态绑定方法=&gt;</b></span></div></div><div id="h8EhJ7C8YX2r1K15S3pFxD" class="wolai-block wolai-text"><div><span class="inline-wrap">①进入命令行<span class="jill"></span>cmd<span class="jill"></span>界面；</span></div></div><div id="6LW86rhNroizjuXbMUiDCT" class="wolai-block wolai-text"><div><span class="inline-wrap">② \[arp -s ip<span class="jill"></span>地址 mac<span class="jill"></span>地址\]，例如：arp -s 192.168.1.1 00-11-22-a1-c6-09</span></div></div><div id="22uNgoQ9f5Fgtf54tSYdBB" class="wolai-block wolai-text"><div><span class="inline-wrap">注：家用无线路由器若要进行<span class="jill"></span>ARP<span class="jill"></span>绑定，则需要通过<span class="jill"></span>web<span class="jill"></span>登录并进行图形操作</span></div></div><div id="qKJhz9RTW5FFjRygyVkZsW" class="wolai-block wolai-text"><div><span class="inline-wrap">小结：</span><span class="inline-wrap"><b>用户端的<span class="jill"></span>ARP<span class="jill"></span>防御方法，要么安装<span class="jill"></span>ARP<span class="jill"></span>防火墙，要么做<span class="jill"></span>ARP<span class="jill"></span>双向绑定</b></span><span class="inline-wrap">。对于绝大部分用户来讲，虽然安装防火墙不是保证百分百安全了，但是能够解决很大一部分的隐患。</span></div></div><div id="qimPgUrdVDJdaANzKADMuy" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>三、如果被<span class="jill"></span>ARP<span class="jill"></span>攻击了，如何揪出&quot;内鬼&quot;并&quot;优雅的还手&quot;？</b></span></div></div><div id="q6K5Psjcv1fqdLrsKdarL2" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>相比&quot;如何防御<span class="jill"></span>ARP<span class="jill"></span>攻击&quot;，我相信更多人感兴趣的是&quot;如何揪出内鬼并进行还手&quot;，因为&quot;揪出内鬼&quot;的时候，我们充当着&quot;网络警察&quot;的角色（把小偷逮住），而&quot;优雅的还手&quot;又充当着&quot;法官&quot;的角色（惩治小偷）。</b></span><span class="inline-wrap"> </span></div></div><div id="CRrmGVT6fVR9VohR2SGx1" class="wolai-block wolai-text"><div><span class="inline-wrap">而充当网络警察或法官这种角色，我可能算是比较有经验的...... 从我刚接触网络/安全到现在，充当的次数多的数不过来：在学校外面租房的时候（别想歪）、在网吧上网的时候、在音乐餐吧吃饭的时候、在麦当劳/德克士蹭网的时候......可能普通用户觉得稀疏平常的地方，在网络世界里实则暗流涌动。</span></div></div><div id="uzCwGfPXebr2iftE2JbSnf" class="wolai-block wolai-text"><div><span class="inline-wrap">我第一次&quot;抓内鬼当法官&quot;应该是在<span class="jill"></span>2010<span class="jill"></span>年的时候，当时在学校旁边租了一个房子自己做技术研究。有一天晚上，网速变得特别慢，网页基本没法打开，QQ<span class="jill"></span>勉强还能挂着，但是租房以来网络一直还可以，虽然不算快，但是也至少满足平常上网需求啊。我心想：算了，毕竟租的房子一般，每个月网费也就<span class="jill"></span>30<span class="jill"></span>快，房东拉的宽带可能比较垃圾不稳定吧，明天再看看。</span></div></div><div id="hRp1MXUEyvE5kJU4DVbQ27" class="wolai-block wolai-text"><div><span class="inline-wrap">第二天早上爬起来，发现网络一点问题都没有，该开的网页，该下载的资料，都没有任何影响，恩，心情不错，不用专门跑回学校一趟下载资源之类的。但是到了晚上七八点的时候，网络又出现问题了，跟昨天晚上的情况一模一样，基本没法上网，但是网卡又显示连接着，这让我非常的郁闷。</span></div></div><div id="pUzAY1w4sZXYU6pLX9iXdK" class="wolai-block wolai-text"><div><span class="inline-wrap">然后我突然想起这几天，这栋楼好像新来了一个租客，这栋楼一共就四层，一层就<span class="jill"></span>3<span class="jill"></span>户租客，一共也就<span class="jill"></span>10<span class="jill"></span>来户，而一楼还是房东自己一家人住，我自己住二楼。基本上这栋楼里的租客都能记得七七八八，所以如果有陌生面孔的话，一眼就能认出来，我们暂且把这个人称为<span class="jill"></span>H，看上去是个上班族。</span></div></div><div id="tn95QEXcXTtKEZMuRdgCHv" class="wolai-block wolai-text"><div><span class="inline-wrap">虽然当时还是个小菜鸟，但是毕竟学这块的，还是有点敏感：擦，会不会是这个人白天去上班，晚上回来宿舍，就开始限制我们的网速啊？</span></div></div><div id="txBh8jyPB2nDXYWA8GAT6M" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>你不犯我，相安无事，你若范我，我必搞你。</b></span><span class="inline-wrap"> （年轻人还是有点浮躁啊....）</span></div></div><div id="6PYPaeY5RvfZXGvnRFfEYU" class="wolai-block wolai-text"><div><span class="inline-wrap">行，开干吧，多想没用。然后便拿出了<span class="jill"></span>P2P<span class="jill"></span>终结者（忘了当时用什么软件了，不过八九不离十）一扫描，想探探网络究竟。</span></div></div><div id="pZwm14ioSZcQjU28QfcDxM" class="wolai-block wolai-text"><div><span class="inline-wrap">万万没想到啊，居然遇到老司机了，人家局域网权限比我还高（很多局域网流控软件都有权限的概念，若同一个局域网同时有多个使用这个流控软件，则权限高的优先控制，其他人的软件会自动退出），网络扫描进行一半，就提示&quot;</span><span class="inline-wrap"><b>局域网有多人使用，由于你权限较低暂停退出</b></span><span class="inline-wrap">&quot;这样的提示，这样一来，就验证了我的判断，这个内鬼应该是<span class="jill"></span>H。自从他来了之后，这个网络就出了问题。这栋楼的网络拓扑结构是这样的=&gt;</span></div></div><div id="nB1pquf732eFwvSkHg7Xd6" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-c93ffbd81db217ad2e90316a7d5f1b1c_b.jpg"/></figure></div><div id="usoRt2MuaDdraPCW9Mma1w" class="wolai-block wolai-text"><div><span class="inline-wrap">普通小白遇到这种情况，装个<span class="jill"></span>ARP<span class="jill"></span>防火墙，咬咬牙也就过去了**。但是咋们学网络和安全的，遇到这种情况，感觉就好像被人骑在头上一样**。那咋办呢？作为一个理科男，做事情还是得按步骤走，不能被脾气牵着走，虽然当时已经非常生气了，但是基本定下来这个解决流程：</span></div></div><div id="vFp5wLJcgxPjotroL9fw5A" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>第一：马上给电脑安装防火墙，先脱离<span class="jill"></span>H<span class="jill"></span>的控制（当时电脑居然是裸奔的...）；</b></span></div></div><div id="w4G9P4t7N29phJxmhyvvSA" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>第二：想尽办法找到<span class="jill"></span>H<span class="jill"></span>的<span class="jill"></span>IP<span class="jill"></span>和<span class="jill"></span>MAC<span class="jill"></span>地址（很多小伙伴看到这里可能会想：直接上去楼上揍他一顿不就得了，还费什么劲找地址啊。这个有必要说明下：①我个头没人家大只 ②人家要是问：你有证据吗，你取证了吗？ 所以，武力不能解决问题，但是技术能力可以。）</b></span></div></div><div id="mG1H4K8sLWJ6KeTe16V5nH" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>第三：想方设法拿到网络控制权，把他踢下去。</b></span><span class="inline-wrap"> </span></div></div><div id="6RZyB28CrnudtrdoagXthV" class="wolai-block wolai-text"><div><span class="inline-wrap">第一步：具体就不说了，也忘了当时装的什么安全软件了；</span></div></div><div id="ipHBPpEMYKjxHcNDvJ2jvG" class="wolai-block wolai-text"><div><span class="inline-wrap">**第二步：怎么找到攻击者的<span class="jill"></span>IP<span class="jill"></span>和<span class="jill"></span>MAC<span class="jill"></span>地址呢？**2010<span class="jill"></span>年的安全软件，不像现在的<span class="jill"></span>ARP<span class="jill"></span>防火墙，能够主动告警，并且说明攻击次数和攻击源，所以还是需要自己折腾下：</span><span class="inline-wrap"><b>熟练的打开电脑之前安装好了的<span class="jill"></span>wireshark，监听自己电脑网卡的流量，设置流量过滤器（仅过滤<span class="jill"></span>arp<span class="jill"></span>协议）</b></span><span class="inline-wrap">，不出意外，接下来就是一堆&quot;</span><span class="inline-wrap"><b>带有节奏的<span class="jill"></span>ARP<span class="jill"></span>扫描包</b></span><span class="inline-wrap">&quot;（还记不记得之前章节说过的，ARP<span class="jill"></span>攻击一般会涉及到持续的内网扫描和欺骗攻击）。当时收到的数据包大概这样的：</span></div></div><div id="WzFsQbX85LYQznHorXmtb" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-8671f9c51384ca633fac10e98759f1d0_b.jpg"/></figure></div><div id="qNXPsfy4uV8vNVPf9xjdec" class="wolai-block wolai-text"><div><span class="inline-wrap">通过流量数据包分析，很快就确定了攻击者的<span class="jill"></span>IP<span class="jill"></span>和<span class="jill"></span>MAC<span class="jill"></span>地址。这里要注意：</span><span class="inline-wrap"><b>虽然抓到了攻击者的<span class="jill"></span>IP<span class="jill"></span>和<span class="jill"></span>MAC<span class="jill"></span>地址，但是！我们还是没法实锤的证明：攻击者就是<span class="jill"></span>H。</b></span><span class="inline-wrap"> </span></div></div><div id="x7NMrhFYvF9CiJXdpXBDvf" class="wolai-block wolai-text"><div><span class="inline-wrap">这个攻击者是不是真的<span class="jill"></span>H<span class="jill"></span>啊？怎么确定就是这个人干的呢？如何把虚拟世界里的地址跟真实世界的人匹配起来？</span></div></div><div id="cqDX2TXtohUofj9sQBmm3r" class="wolai-block wolai-text"><div><span class="inline-wrap">接下来我便想到了一个方法：如果我们能先拿到网络的控制权，然后把攻击者给踢下去直接断网，同时保证其他人网络连通；然后，谁要是下去跟房东沟通反馈不能上网，不就可以基本断定这个人就是攻击者？ </span><span class="inline-wrap"><b>说白了，就是&quot;谁叫谁小狗&quot;......</b></span></div></div><div id="kytFUci4n1xdEN8cdhfqBo" class="wolai-block wolai-text"><div><span class="inline-wrap">**好，到了计划的第三步：如何拿到整个网络的控制权？**这里就没走的那么顺畅了：现在的实际情况是：我和攻击者同时开启局域网流控软件，而是我被踢下来了，因为我权限低一些。当时的第一个想法是：我换一个流控软件不就得了？这样我不跟你拼这个软件的权限。但是仔细想了想，即便换一个流控软件能用，但是顶多也就是打个平手，我控制不了你，你也控制不了我，但最终遭殃的还是其他普通小白，这个方法不能&quot;</span><span class="inline-wrap"><b>斩草除根</b></span><span class="inline-wrap">&quot;啊。</span></div></div><div id="iCEianVGCrqDtp21pkcK2u" class="wolai-block wolai-text"><div><span class="inline-wrap">怎么办呢？是不是只能跟他打个平手。在这里卡了很久但又心有不甘，然后到了大半夜了突然顿悟：擦，为什么要跟他&quot;限来限去&quot;呢，直接上整栋楼的出口路由器，把他踢出去不就得了？路由器（应该是<span class="jill"></span>TP-LINK）就在一楼楼梯口，然后其他楼层加一个<span class="jill"></span>hub<span class="jill"></span>级联上去，所以大家都在一个网络里面。</span></div></div><div id="6Awgj5hDP57EtJvBk7nPgx" class="wolai-block wolai-text"><div><span class="inline-wrap">但问题是没有路由器的后台登录密码，怎么解决呢？抱着侥幸的心理，查看电脑网关地址，然后浏览器输入网关地址，弹出了登录页面，尝试<span class="jill"></span>admin/admin？不行，再尝试<span class="jill"></span>admin/123456？还是不行...... 就这样尝试了常见的十几二十个账号密码，都提示账号密码错误，看来运气不是很好。</span></div></div><div id="qywkjYae1nLzfED6GKAcH4" class="wolai-block wolai-text"><div><span class="inline-wrap">既然这样的话，就只能拿出暴力破解软件跑几个词典看看，</span><span class="inline-wrap"><b>用<span class="jill"></span>hydra<span class="jill"></span>挂着用户名和密码词典</b></span><span class="inline-wrap">，慢慢的看着命令行输出，但输出结果基本都是<span class="jill"></span>failed...... 所以，第二天晚上虽然发现了攻击者的<span class="jill"></span>IP<span class="jill"></span>和<span class="jill"></span>MAC<span class="jill"></span>地址信息，但是拿他没办法，只能先忍着。</span></div></div><div id="dfiMSEiyCkwHWQcFUqLaM2" class="wolai-block wolai-text"><div><span class="inline-wrap">到了第三天白天，脑子里想的都是如何登录这个路由器后台管理界面，尝试跑了几个词典都没法登录，心理又在想：房东不应该会设置太复杂的密码啊，四五十岁的阿姨，完全不懂技术啊，网络应该也是叫人搞的，即便别人设置密码也应该给阿姨设置比较简单的让她好记的，方便后面维护之类的...... 一想到这里，赶紧从柜子里掏出之前的租房合约和房东名片，然后把房东的手机号码、房东的姓名拼音等信息做成简单的密码词典，再重新跑一次，还没反应过来，就显示密码尝试成功：</span><span class="inline-wrap"><b>admin/房东手机号码。万万没想到，以为只要<span class="jill"></span>6<span class="jill"></span>位或者<span class="jill"></span>8<span class="jill"></span>位的密码，居然是一个<span class="jill"></span>11<span class="jill"></span>位的手机号码，之前尝试的词典都是<span class="jill"></span>8<span class="jill"></span>位以内的</b></span><span class="inline-wrap">。</span></div></div><div id="jTNbX3H1qhu5gJq9ZU2bdf" class="wolai-block wolai-text"><div><span class="inline-wrap">接下来用浏览器访问路由器后台管理界面，进入主机列表，还没发现这个昨晚攻击者的<span class="jill"></span>IP<span class="jill"></span>地址上线。等到了晚上七八点的时候，终于在路由器上发现这个<span class="jill"></span>IP<span class="jill"></span>地址，而且，wireshark<span class="jill"></span>同时也抓到了这个攻击者发起的扫描包。看来是攻击者一回到宿舍，打开电脑，就直接挂着攻击软件，确实是个**&quot;惯犯&quot;**啊。好吧，看到这个情况，我直接在出口路由器上把这个<span class="jill"></span>IP<span class="jill"></span>和<span class="jill"></span>MAC<span class="jill"></span>地址禁用，看接下来发生什么。</span></div></div><div id="3iFSr8SHEUAEtHVHSN9Mfv" class="wolai-block wolai-text"><div><span class="inline-wrap">果然，大概过了半个钟，有人从楼上下来，直接去一楼找房东阿姨去了，具体说什么这个不清楚，但是应该是询问是不是宽带欠费之类的导致不能上网。</span></div></div><div id="pYBsgg6usS6rwBX6gMPztr" class="wolai-block wolai-text"><div><span class="inline-wrap">过了一会，阿姨带着他上来二楼..... 然后敲门询问：你们二楼能不能上网啊？大家都陆续回答：可以啊、没问题啊。与此同时，我已经确定了：</span><span class="inline-wrap"><b>眼前的这个人，H<span class="jill"></span>就是攻击者！他大概没料到，自己已经控制了内网，怎么可能被踢掉之类呢。</b></span><span class="inline-wrap"> </span></div></div><div id="uDXFM54pDKJ8jctWnpMx3" class="wolai-block wolai-text"><div><span class="inline-wrap">阿姨也不知道怎么办，只能说明天看看吧。看着他无辜的眼神回楼上去了，我也觉得抓到内鬼也就算了，先把他解禁看看。然后&quot;惯犯&quot;又上线了，看来没有吃够苦头啊，当天晚上直接让他断网。之后的几个晚上类似的情况慢慢少了，因为只要他一扫描发起攻击，我这边就断他网，然后隔<span class="jill"></span>10<span class="jill"></span>分钟或者半个钟看看他反应，就这样慢慢地把他制服了，整栋楼的网络也就逐渐恢复了平静……</span></div></div><div id="mTEfaoX7tgz7SGd5GBjNC4" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>四、ARP<span class="jill"></span>防御总结</b></span></div></div><div id="gdxvYdbWhsm9MTqKFa7SeB" class="wolai-block wolai-text"><div><span class="inline-wrap">①ARP<span class="jill"></span>攻击非常低门槛，但是造成的影响却很大，包括断网攻击、流量被限、账号被盗等；</span></div></div><div id="fkR87DGgXFpLwJgdzgCXqA" class="wolai-block wolai-text"><div><span class="inline-wrap">②ARP<span class="jill"></span>防御可以在网络端（网络设备）上部署，也可以在用户端（电脑/手机）上部署；</span></div></div><div id="sRtm7VrrWu2WtP9wfgnoAT" class="wolai-block wolai-text"><div><span class="inline-wrap">③网络设备（例如交换机）部署<span class="jill"></span>ARP<span class="jill"></span>防御，通常需要用到<span class="jill"></span>DAI（动态<span class="jill"></span>ARP<span class="jill"></span>监测）技术，更加专业的局域网安全防御，还可能结合<span class="jill"></span>DHCP<span class="jill"></span>侦听、IP<span class="jill"></span>源防护、端口安全、AAA、802.1X<span class="jill"></span>等技术，这些专业的防御技术，是由网络运维和安全运维工程师来实施的。</span></div></div><div id="reLhx9vx9FE2LPxAfr8sMg" class="wolai-block wolai-text"><div><span class="inline-wrap">④用户端（电脑/手机）实施<span class="jill"></span>ARP<span class="jill"></span>防御，最好的方法就是不要随意接入陌生网络，并且安装<span class="jill"></span>ARP<span class="jill"></span>防火墙。当然，技术宅的话，可以采用&quot;ARP<span class="jill"></span>双向绑定&quot;的方法，相对比较麻烦，但是也奏效。</span></div></div><div id="6VPNDRhCpgZcg4u4PeSt5K" class="wolai-block wolai-text"><div><span class="inline-wrap">⑤作为一名有素养的网络/安全工程师，应该不作恶。但是如果遭受攻击，应该揪出内鬼并&quot;优雅的还手&quot;，做一个网络警察，还普通用户一个干净的网络环境。</span></div></div><div id="2Rg7BqnmqGZ39LavYeM2eA" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>【相关推荐】</b></span><span class="inline-wrap"> </span></div></div><div id="dXNLCHKMPJGZYhe9HtdAsH" class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://zhuanlan.zhihu.com/p/28771785"><span>图解<span class="jill"></span>ARP<span class="jill"></span>协议（一）</span></a></span></div></div><div id="pCQm1JM4xEgACs7iZDr35B" class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://zhuanlan.zhihu.com/p/28818627"><span>图解<span class="jill"></span>ARP<span class="jill"></span>协议（二）ARP<span class="jill"></span>攻击篇</span></a></span></div></div><div id="8KkB6wv7EPEirTdC6jaQYL" class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.pinginglab.net/course/164"><span>《TCP/IP<span class="jill"></span>协议栈视频教程》</span></a></span></div></div><div id="feE5ZJc3CnH26h3gJ93ZKK" class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.pinginglab.net/course/3"><span>《Wireshark<span class="jill"></span>协议分析从入门到精通》</span></a></span></div></div><div id="9TGPSAJrZm7w8ymGwrZRWz" class="wolai-block wolai-text"><div><span class="inline-wrap">新浪微博：</span><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.weibo.com/jaykingchen"><span>@<span class="jill"></span>拼客学院陈鑫杰</span></a></span></div></div><div id="pssFygpdeu1Pg9rp972szk" class="wolai-block wolai-text"><div><span class="inline-wrap">微信公众号：拼客院长陈鑫杰</span></div></div><div id="iT1ZprVWKKR33LyJiDts6B" class="wolai-block wolai-text"><div><span class="inline-wrap">拼客学院：</span><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.pinginglab.net"><span>http://www.pinginglab.net</span></a></span></div></div></div><div id="eV3QcuEfuyUWMUntcBfB4o" class="wolai-sub-page wolai-block"><div class="page-icon"></div><a href="ipv4%E5%8D%8F%E8%AE%AE/arp/%E5%9B%BE%E8%A7%A3arp%E5%8D%8F%E8%AE%AE%EF%BC%88%E5%9B%9B%EF%BC%89%E4%BB%A3%E7%90%86arp%EF%BC%9A%E5%96%84%E6%84%8F%E7%9A%84%E6%AC%BA/%E5%9B%BE%E8%A7%A3arp%E5%8D%8F%E8%AE%AE%EF%BC%88%E5%9B%9B%EF%BC%89%E4%BB%A3%E7%90%86arp%EF%BC%9A%E5%96%84%E6%84%8F%E7%9A%84%E6%AC%BA.html"><span>图解ARP协议（四）代理ARP：善意的欺骗 - 知乎</span></a><h2 id="3pnkWw6mVGKgg78qC3xeSW" class="wolai-block"><span class="inline-wrap"><b>一、代理<span class="jill"></span>ARP<span class="jill"></span>概述</b></span></h2><div id="8k51K5sUEbAWBo2QgR5nrE" class="wolai-block wolai-text"><div><span class="inline-wrap">我：</span><span class="inline-wrap"><b>当电脑要访问互联网上的服务器，目标<span class="jill"></span>MAC<span class="jill"></span>是什么？</b></span></div></div><div id="vMafcVQVTSywcU9WJ7VGpc" class="wolai-block wolai-text"><div><span class="inline-wrap">很多小伙伴在刚学习网络协议的时候，经常这样直接回应：</span><span class="inline-wrap"><b>不就是服务器的<span class="jill"></span>MAC<span class="jill"></span>嘛!</b></span></div></div><div id="bdFFLVAXSJqCAcP6NfMVFW" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-1949cb89d4fcefeac613a12ffaea7ebc_b.jpg" style="width: 1116.8px"/></figure></div><div id="kda3217fBpASSEn4j53zDA" class="wolai-block wolai-text"><div><span class="inline-wrap">这时我会反问：</span><span class="inline-wrap"><b>那电脑怎么拿到这个服务器的<span class="jill"></span>MAC<span class="jill"></span>地址呢？</b></span></div></div><div id="wbfZd8u6atKiqjhi9wK9Mn" class="wolai-block wolai-text"><div><span class="inline-wrap">小伙伴一般都自信的抛出下面两个点：</span></div></div><div id="oR7XitWUZRoHcHLaysiVtA" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>①根据网络通信中数据封装的原则，通信双方需要封装源目<span class="jill"></span>IP<span class="jill"></span>和<span class="jill"></span>MAC<span class="jill"></span>地址；</b></span></div></div><div id="mNaLQgZicyagHft1kG4wGa" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>②如果要拿到目标<span class="jill"></span>MAC<span class="jill"></span>地址，就需要通过<span class="jill"></span>ARP<span class="jill"></span>协议进行交互。</b></span><span class="inline-wrap"> </span></div></div><div id="2Vb5kVRDER9PdsZrDADc8U" class="wolai-block wolai-text"><div><span class="inline-wrap">我：好，确实没毛病，你是指的下面这个意思吧 ==&gt;</span></div></div><div id="gNzUVaHxjiqTDjBHD4qyKx" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-9e9c13063eb151a49015afb76a262cff_b.jpg" style="width: 576px"/></figure></div><div id="mchtb8VKK7z1R38xntb7j8" class="wolai-block wolai-text"><div><span class="inline-wrap">小伙伴：对对对，是这个意思的。</span></div></div><div id="jgdhJqkv2mk21kinceiCqc" class="wolai-block wolai-text"><div><span class="inline-wrap">我：好，你再看看下面这个图，再确认下。</span></div></div><div id="89XsSejDk14Tqy7Y4MUJCF" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-272f753039f57ce31f7a5fea5dff43de_b.jpg" style="width: 576px"/></figure></div><div id="aJWbA3PoecGjivj3gvK3GF" class="wolai-block wolai-text"><div><span class="inline-wrap">小伙伴：好像不太对唉，刚才没注意看...... 互联网这么多路由器，根据之前学过的：</span></div></div><div id="nWFiw2obsLLq3jy3DuUusC" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>①路由器隔离广播域，每个接口/网段都是独立的广播域；</b></span></div></div><div id="5vuAhsQpWQRn3LbGu43GLC" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>②ARP<span class="jill"></span>请求是二层广播包，广播包没法过路由器，</b></span></div></div><div id="dJKQrp1tuGLg3jtP1RWDS4" class="wolai-block wolai-text"><div><span class="inline-wrap">这样的话，ARP<span class="jill"></span>请求广播包根本没法穿越互联网到达目标服务器。</span></div></div><div id="iVfsfq2hRDpxsfrorDiyP2" class="wolai-block wolai-text"><div><span class="inline-wrap">我：那我们平常上微博逛知乎去京东剁手基本都依据上面这张图，</span><span class="inline-wrap"><b>通过<span class="jill"></span>DNS<span class="jill"></span>协议将域名解析为<span class="jill"></span>IP<span class="jill"></span>地址，通过<span class="jill"></span>ARP<span class="jill"></span>协议将<span class="jill"></span>IP<span class="jill"></span>解析为<span class="jill"></span>MAC<span class="jill"></span>地址</b></span><span class="inline-wrap">。现在<span class="jill"></span>ARP<span class="jill"></span>请求无法穿越过去，电脑便无法获取目标服务器的<span class="jill"></span>MAC<span class="jill"></span>地址，怎么跟它通信呢？</span></div></div><div id="hAgWhZHmR1WGxpJxnS4LDU" class="wolai-block wolai-text"><div><span class="inline-wrap">小伙伴：</span><span class="inline-wrap"><b>。。。。。。</b></span><span class="inline-wrap"> </span></div></div><div id="sZBsVgxobuT1C4RDJpLHyS" class="wolai-block wolai-text"><div><span class="inline-wrap">上面这个疑惑，我相信每个学习网络协议的初学者经常会问到，更普遍的情况是，很多工作多年的工程师，也未必能够将下面这几个问题完全搞清楚：</span></div></div><div id="g2x1jhbg2WjVzgd48qgWw3" class="wolai-block wolai-text"><div><span class="inline-wrap">①电脑访问互联网服务器的时候，ARP<span class="jill"></span>询问的内容，真的是问服务器的吗？</span></div></div><div id="pUmNiLQiGzMJQDmUbMXdha" class="wolai-block wolai-text"><div><span class="inline-wrap">②什么是代理<span class="jill"></span>ARP？跟<span class="jill"></span>ARP<span class="jill"></span>有什么区别？什么场景下会用到代理<span class="jill"></span>ARP？</span></div></div><div id="zhTVnYc7FK1LcJRZFFpcY" class="wolai-block wolai-text"><div><span class="inline-wrap">③代理<span class="jill"></span>ARP<span class="jill"></span>跟网关（默认路由）设置有什么关系？</span></div></div><div id="5pBqrxqLLehZenMxawPgGC" class="wolai-block wolai-text"><div><span class="inline-wrap">所以，这一篇文章虽然是讲代理<span class="jill"></span>ARP，但其实核心内容是</span><span class="inline-wrap"><b>围绕代理<span class="jill"></span>ARP，解读跨网段通信过程中，ARP/代理<span class="jill"></span>ARP/网关（默认路由）/数据封装等相关问题</b></span><span class="inline-wrap">。</span></div></div><h2 id="g575SZRBysSdzzMxF7fycQ" class="wolai-block"><span class="inline-wrap"><b>二、代理<span class="jill"></span>ARP<span class="jill"></span>原理</b></span></h2><div id="pWRiFPTcLvj9TX7d4NmBSV" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>当<span class="jill"></span>ARP<span class="jill"></span>请求目标跨网段时，网关设备收到此<span class="jill"></span>ARP<span class="jill"></span>请求，会用自己的<span class="jill"></span>MAC<span class="jill"></span>地址返回给请求者，这便是代理<span class="jill"></span>ARP（Proxy ARP）。</b></span></div></div><div id="pvNP8zT2mQH79PSBktPA9j" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-cf490c2868b7bcae3fed22a65d07dcfa_b.jpg" style="width: 576px"/></figure></div><div id="gWLhzwikbAsu2FQb8L7FxK" class="wolai-block wolai-text"><div><span class="inline-wrap">上面这张图中，电脑发送<span class="jill"></span>ARP<span class="jill"></span>请求服务器<span class="jill"></span>8.8.8.8<span class="jill"></span>的<span class="jill"></span>MAC<span class="jill"></span>地址，路由器（网关）收到这个请求时会进行判断，由于目标<span class="jill"></span>8.8.8.8<span class="jill"></span>不属于本网段（即跨网段），此时便返回自己的接口<span class="jill"></span>MAC<span class="jill"></span>地址给<span class="jill"></span>PC，后续电脑访问服务器时，目标<span class="jill"></span>MAC<span class="jill"></span>直接封装为<span class="jill"></span>MAC254。</span></div></div><div id="qdnTpD7mikveUDrte9p8JR" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>代理<span class="jill"></span>ARP<span class="jill"></span>本质是一个&quot;善意的欺骗&quot;，是一个&quot;错位&quot;的映射</b></span><span class="inline-wrap">。从图中我们看到服务器地址的正常映射是&lt;8.8.8.8-MAC2&gt;，而路由器返回给电脑的，却是 &lt;8.8.8.8-MAC254&gt;。</span><span class="inline-wrap"><b>不管是不是&quot;欺骗&quot;，至少最终电脑可以与外网的服务器实现通信</b></span><span class="inline-wrap">，以<span class="jill"></span>PC Ping Server<span class="jill"></span>为例=&gt;</span></div></div><div id="iou7jzypr17VjNUoFRR6ew" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-7890a7e816dee27fb135c1855cdc57ae_b.jpg" style="width: 576px"/></figure></div><div id="kEB3hMeP6eU5Pza2HFutx7" class="wolai-block wolai-text"><div><span class="inline-wrap">实际网络中，代理<span class="jill"></span>ARP<span class="jill"></span>由网络中的网关设备来执行，包括路由器、多层交换机、无线路由器、防火墙等设备。并且，网关即便有代理<span class="jill"></span>ARP<span class="jill"></span>功能，也未必一定执行，还必须满足两个条件：</span><span class="inline-wrap"><b>①网关已经开启代理<span class="jill"></span>ARP<span class="jill"></span>功能；②网关有目标的路由信息。</b></span><span class="inline-wrap"> 我们来看下面这张图=&gt;</span></div></div><div id="b3EXcoPrHPiMm1PYw8bEkm" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-3ad1bab63d9deff26258d9af8f08acc0_b.jpg" style="width: 576px"/></figure></div><div id="6T8nY83CD8uYp3JJEb4wZQ" class="wolai-block wolai-text"><div><span class="inline-wrap">上面这张图中，我们假设路由器已具备全网的路由，但</span><span class="inline-wrap"><b>连接电脑的接口没有开启（或不支持）代理<span class="jill"></span>ARP<span class="jill"></span>功能</b></span><span class="inline-wrap">，此时便造成一个尴尬的情况：电脑反复询问到<span class="jill"></span>8.8.8.8<span class="jill"></span>的<span class="jill"></span>MAC<span class="jill"></span>地址，路由器收到之后，处理流程跟正常<span class="jill"></span>ARP<span class="jill"></span>是一致的，&quot;问自己的回复，不是问自己的丢弃&quot;。因此，</span><span class="inline-wrap"><b>当网络通信采用代理<span class="jill"></span>ARP<span class="jill"></span>时，可能会&quot;受制于沿途网关设备&quot;，造成网络通信故障</b></span><span class="inline-wrap">。</span></div></div><div id="wfqrrnBK5AEE2JewNdNTg1" class="wolai-block wolai-text"><div><span class="inline-wrap">进一步思考：</span><span class="inline-wrap"><b>既然代理<span class="jill"></span>ARP<span class="jill"></span>不是一种特别流畅的实现，会&quot;受限于别人&quot;，那我们没必要一定要使用它。甚至，这里我们需要搞清一个事实：实际网络中，无论是同网段还是跨网段通信（例如访问互联网），绝大情况下都是使用正常的<span class="jill"></span>ARP，而不是代理<span class="jill"></span>ARP。</b></span><span class="inline-wrap"> 生活中的上网的经验也已经告诉我们，好像从来没有遇到或听到过&quot;XXX<span class="jill"></span>设备不支持代理<span class="jill"></span>ARP<span class="jill"></span>功能，导致通信故障&quot;这样的问题。</span></div></div><div id="dWzXQkZXyKB18e2ySgp49F" class="wolai-block wolai-text"><div><span class="inline-wrap">很多小伙伴看到这里，会有大大的疑惑：</span></div></div><div id="rMAVSEsqLSTZtnRwjRU73d" class="wolai-block wolai-text"><div><span class="inline-wrap">① &quot;什么! 我们才刚学习了代理<span class="jill"></span>ARP<span class="jill"></span>的实现原理，现在居然告诉说它没怎么用？&quot;</span></div></div><div id="4FZywStxSC8jMncBjyA3Bj" class="wolai-block wolai-text"><div><span class="inline-wrap">② 那</span><span class="inline-wrap"><b>为什么要创造代理<span class="jill"></span>ARP，它的真正使用场景在哪里？？</b></span></div></div><div id="5gXw7jRhTiLyGKjz6k9Cwh" class="wolai-block wolai-text"><div><span class="inline-wrap">③ 上述图解中，</span><span class="inline-wrap"><b>电脑跨网段通信时<span class="jill"></span>ARP<span class="jill"></span>到底是如何工作的？？？</b></span></div></div><div id="7Xx1TVFbiSjfUgxTNVtB24" class="wolai-block wolai-text"><div><span class="inline-wrap">接下来给大家划重点：</span></div></div><div id="2ACus33FSaJEgjqbPnQR63" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>第一，代理<span class="jill"></span>ARP<span class="jill"></span>仅仅是正常<span class="jill"></span>ARP<span class="jill"></span>的一个拓展使用，是可选项而不是必要项；</b></span></div></div><div id="2MQQrekS32eU7n3Us2YwTb" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>第二：代理<span class="jill"></span>ARP<span class="jill"></span>有特定的应用场景，与网关/路由的设置有直接关系：当电脑没有网关/路由功能时，并且需要跨网站通信时，则会触发代理<span class="jill"></span>ARP。换句话说，如果有网关/路由功能，则不需要代理<span class="jill"></span>ARP；</b></span></div></div><div id="upUr7GAuZ2Wm4HWx17y2B5" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>第三：正常环境下，当用户接入网络时，都会通过<span class="jill"></span>DHCP<span class="jill"></span>协议或手工配置的方式得到<span class="jill"></span>IP<span class="jill"></span>和网关信息（所以不需要代理<span class="jill"></span>ARP）。</b></span><span class="inline-wrap"> </span></div></div><h2 id="fda87R5s7N5nut9ETietbV" class="wolai-block"><span class="inline-wrap"><b>三、ARP<span class="jill"></span>与代理<span class="jill"></span>ARP：不是互斥而是互补</b></span></h2><div id="dzjwzGst9L4BQRAEjhKGdD" class="wolai-block wolai-text"><div><span class="inline-wrap">在大家理解了代理<span class="jill"></span>ARP<span class="jill"></span>的工作原理和应用场景之后，接下来我们终于可以更加全面的分析开篇的这个经典问题：</span><span class="inline-wrap"><b>当用户访问互联网的时候，到底用<span class="jill"></span>ARP<span class="jill"></span>还是代理<span class="jill"></span>ARP？跟网关/路由设置有什么关系？数据封装又有什么区别？</b></span></div></div><div id="jCH5d6nCRqwhCf5zAJ7qT1" class="wolai-block wolai-text"><div><span class="inline-wrap">我们通过下面两张图做个对比=&gt;</span></div></div><div id="r5wLqMueTEMjHmDUkPbVUi" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>当电脑没有网关时，PC Ping 8.8.8.8，采用代理<span class="jill"></span>ARP =&gt;</b></span></div></div><div id="p5f8LKMeUU8TTBhL2gehHa" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-7199b1ecd19e2e0f8c96674fb5cc08c0_b.jpg" style="width: 576px"/></figure></div><div id="2WkTYpEDLYDaMBbRDmcCd8" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>当电脑有网关时，PC Ping 8.8.8.8，采用正常<span class="jill"></span>ARP =&gt;</b></span></div></div><div id="xiSEHHXem3mNVgXQfV5Tmb" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-372458f6469f7a4e845e84f0f9bdf199_b.jpg" style="width: 576px"/></figure></div><div id="mAy18An3BrTY1NEGe12oma" class="wolai-block wolai-text"><div><span class="inline-wrap">通过上面的对比，我们得到以下信息：</span></div></div><div id="eqmJAmEH3kXsk8SqooKFVa" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>①电脑没有网关时，ARP<span class="jill"></span>直接询问目标<span class="jill"></span>IP<span class="jill"></span>对应的<span class="jill"></span>MAC<span class="jill"></span>地址（跨网段），采用代理<span class="jill"></span>ARP；</b></span></div></div><div id="eVMQ3yDYpLutdUAEiDmjHs" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>②电脑有网关时，ARP<span class="jill"></span>只需询问网关<span class="jill"></span>IP<span class="jill"></span>对应的<span class="jill"></span>MAC<span class="jill"></span>地址（同网段），采用正常<span class="jill"></span>ARP；</b></span></div></div><div id="9zidUaiWWSDY7g3qihnozo" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>③无论是正常<span class="jill"></span>ARP<span class="jill"></span>还是代理<span class="jill"></span>ARP，电脑最终都拿到同一个目标<span class="jill"></span>MAC<span class="jill"></span>地址：网关<span class="jill"></span>MAC。</b></span><span class="inline-wrap"> </span></div></div><div id="mNPx67Qqst5N3J2xdDb9Fb" class="wolai-block wolai-text"><div><span class="inline-wrap">为了让上面这个总结更加的通用性，我们将原有的网络拓扑稍微复杂化 =&gt;  </span></div></div><div id="qdhus9cmwKMtfpTBTZR5Hp" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>当电脑没有网关时（采用代理<span class="jill"></span>ARP ），PC 依次<span class="jill"></span>Ping 8.8.8.8、8.8.4.4、114.114.114.114=&gt;</b></span></div></div><div id="otFkP1Kk453U9hbfosn3di" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-b11fb72b4a000e399d9a45f2c8f5d013_b.jpg" style="width: 576px"/></figure></div><div id="wS9E7rGT3TdfEbVPhmCmFG" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>当电脑有网关时（采用正常<span class="jill"></span>ARP ），PC 依次<span class="jill"></span>Ping 8.8.8.8、8.8.4.4、114.114.114.114=&gt;</b></span></div></div><div id="55TVg5mPmdTxTnFpHPQMp9" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-749ffbf5dd00e47b19b4c8351880de33_b.jpg" style="width: 576px"/></figure></div><div id="2p52tZ2v3jLm8LYy4hPgkA" class="wolai-block wolai-text"><div><span class="inline-wrap">通过上面的拓扑，我们可以得到更加通用性的总结，归纳如下：</span></div></div><div id="cyEgdaMUsH7chLg49nQVwg" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>①当电脑没有网关（采用代理<span class="jill"></span>ARP）时：&quot;跨网段访问谁，就问谁的<span class="jill"></span>MAC&quot;</b></span></div></div><div id="6qrWBqRPNh5ZypdEN8PWGi" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>②当电脑有网关（采用正常<span class="jill"></span>ARP）时：&quot;跨网段访问谁，都问网关的<span class="jill"></span>MAC&quot;</b></span></div></div><div id="3Wd1GR7Gy4wceLhBeSBKxB" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>③无论哪种<span class="jill"></span>ARP，跨网段通信时，发送方请求得到的目标<span class="jill"></span>MAC<span class="jill"></span>地址都是网关<span class="jill"></span>MAC。</b></span><span class="inline-wrap"> </span></div></div><div id="osxPk91rEkn6Azv5rw3hJU" class="wolai-block wolai-text"><div><span class="inline-wrap">注明：</span><span class="inline-wrap"><b>网关（Gateway）、下一跳（Next-hop）、路由器（Router）都指的是离发送方最近的三层（或多层）设备，具备三层和路由转发功能。</b></span><span class="inline-wrap"> 举例：我们通过<span class="jill"></span>WiFi<span class="jill"></span>上网时，网关就是无线路由器，它帮忙将电脑和手机的数据转发到互联网；</span><span class="inline-wrap"><b>所以，我们访问互联网时（无论访问谁），电脑和手机采用的目的<span class="jill"></span>MAC，都是无线路由器的<span class="jill"></span>MAC</b></span><span class="inline-wrap">。有兴趣的小伙伴都可以跟着我验证下（请见下面章节）。</span></div></div><h2 id="9we2tL1Hdcpk34owCVuq5f" class="wolai-block"><span class="inline-wrap"><b>四、ARP<span class="jill"></span>与代理<span class="jill"></span>ARP<span class="jill"></span>实战指南</b></span></h2><div id="ov9FFB1xpkd5YNDUTaihb7" class="wolai-block wolai-text"><div><span class="inline-wrap">为了让大家更直观理解，真正**&quot;亲眼所见&quot;</span><span class="inline-wrap"><b>上面学到的技术原理，这里我带大家</b></span><span class="inline-wrap">在真实网络和虚拟环境分别验证**。第一个实验，主要是针对没任何命令基础的小伙伴，大家可以在家就可以实验；第二个实验，主要针对有一定网络和安全基础的小伙伴，通过构造网络虚拟实验环境来验证。</span></div></div><div id="kvv8apNwv6bZ7c5BaoiWq1" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>（一）真实网络下<span class="jill"></span>ARP<span class="jill"></span>与代理<span class="jill"></span>ARP<span class="jill"></span>实验</b></span></div></div><div id="wCAhxxYhxaX7bpj6nYn84x" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-c950317c70003e20fd2f05616af3e24d_b.png" style="width: 576px"/></figure></div><div id="meRSUfKiUCes3ZpxV3oRk7" class="wolai-block wolai-text"><div><span class="inline-wrap">这个网络中，我的电脑地址是<span class="jill"></span>192.168.199.177，连接到极路由（无线路由器），通过极路由器访问互联网。这个<span class="jill"></span>WiFi<span class="jill"></span>网络的主机列表情况如下，这里的<span class="jill"></span>PC<span class="jill"></span>就是我的<span class="jill"></span>Macbook。</span></div></div><div id="gnPDE7QsUbCjRgHDp2eV2s" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-712c8b1f06f48272407c7db44cfa8f31_b.jpg" style="width: 576px"/></figure></div><div id="mAQtyjJ4eW8vVeEdTouPQF" class="wolai-block wolai-text"><div><span class="inline-wrap">接下来再看看极路由<span class="jill"></span>MAC<span class="jill"></span>地址=&gt;</span></div></div><div id="4sSSiWwgMmp6GSRXkPRgwF" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-9cc3faa98096af00a1728c5238fdb26d_b.jpg" style="width: 888px"/></figure></div><div id="wrJzz4LVN2uZQs8SUEZ6H1" class="wolai-block wolai-text"><div><span class="inline-wrap">查看我的电脑(Macox<span class="jill"></span>系统）IP<span class="jill"></span>地址和网关信息，通过命令**&quot;ifconfig&quot;</span><span class="inline-wrap"><b>查看<span class="jill"></span>ip<span class="jill"></span>地址=&gt;（Windows<span class="jill"></span>系统则通过</b></span><span class="inline-wrap">&quot;ipconfig /all&quot;**查看<span class="jill"></span>IP<span class="jill"></span>地址和网关信息）</span></div></div><div id="dkNfTAgtGAMB5EfxDMzi33" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-64f827892e31310a1bd0ab02a7ab9e6c_b.jpg" style="width: 576px"/></figure></div><div id="sVswB5UqxMHfNf6tMYWHvs" class="wolai-block wolai-text"><div><span class="inline-wrap">通过命令**&quot;netstat -rn&quot;**查看我的电脑网关设置=&gt;</span></div></div><div id="aEMHhqNXx3JJBgfgAq8dTa" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-00f54ba1ebc75fe3d850ff505b994039_b.jpg" style="width: 918.4px"/></figure></div><div id="kGLaAEu8112PPEBpBQjg1i" class="wolai-block wolai-text"><div><span class="inline-wrap">接下来，我的电脑连续</span><span class="inline-wrap"><b>PING 8.8.8.8<span class="jill"></span>和<span class="jill"></span>114.114.114.114</b></span><span class="inline-wrap">或其他外网地址=&gt;</span></div></div><div id="w3rkrv17e7t2iFo8BXkUUR" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-9b88079d634462b0b53d6504e65bc065_b.jpg" style="width: 576px"/></figure></div><div id="jns7j9x3VK7WsNR3VyRH11" class="wolai-block wolai-text"><div><span class="inline-wrap">重点来了，在我的电脑连续访问这么多外网地址之后，我们来看看</span><span class="inline-wrap"><b>ARP<span class="jill"></span>表项是怎样的，是否有<span class="jill"></span>8.8.8.8、114.114.114.114、</b></span><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.pinginglab.net"><span><b>http://www.pinginglab.net</b></span></a></span><span class="inline-wrap"><b>（120.24.59.68）对应的<span class="jill"></span>MAC<span class="jill"></span>呢？</b></span></div></div><div id="cZVrbVwKxYkLhvwwZiKikC" class="wolai-block wolai-text"><div><span class="inline-wrap">通过命令**&quot;arp -a&quot;**查看电脑的<span class="jill"></span>ARP<span class="jill"></span>缓存信息=&gt;</span></div></div><div id="3vk5am5dLZ6Br3bnV4uova" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-30c9c19de4bbb449eec6562e52dbe00f_b.jpg" style="width: 939.2px"/></figure></div><div id="oqBAEMXsDSvjnfm3YjH1qo" class="wolai-block wolai-text"><div><span class="inline-wrap">从最终的<span class="jill"></span>ARP<span class="jill"></span>内容来看，</span><span class="inline-wrap"><b>我的电脑只记录着本机和网关的<span class="jill"></span>MAC<span class="jill"></span>地址，MAC<span class="jill"></span>地址&quot;d4:ee-07:54:c1:9e&quot;就是上面给大家截图的极路由<span class="jill"></span>MAC。</b></span><span class="inline-wrap"> </span></div></div><div id="ecQQLcpxTS6mpH6zVcdoFT" class="wolai-block wolai-text"><div><span class="inline-wrap">通过这个真实网络的实验，我们可以验证了以下内容：</span></div></div><div id="vtYq9CqNTqm5AirCGpdEcC" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>①真实网络中一般都是正常<span class="jill"></span>ARP，而不是代理<span class="jill"></span>ARP；</b></span></div></div><div id="9rEEW847gEmCyLNR8P8MCJ" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>②当电脑有网关（采用正常<span class="jill"></span>ARP）时，无论跨网段访问谁，都直接问网关的<span class="jill"></span>MAC；</b></span></div></div><div id="oHxkaJwKrL6C8XMZPyjo4n" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>③当第一次获取网关<span class="jill"></span>MAC<span class="jill"></span>之后，后续的通信都不再需要重新进行<span class="jill"></span>ARP<span class="jill"></span>请求。（这个是比较容易忽略的，而代理<span class="jill"></span>ARP<span class="jill"></span>每次访问新的外网地址，都需要再次请求）</b></span></div></div><div id="vD6JozLfsySbXjMETxZkkp" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>（二）虚拟环境下<span class="jill"></span>ARP<span class="jill"></span>与代理<span class="jill"></span>ARP<span class="jill"></span>实验</b></span></div></div><div id="d5S79qxCEJUAuxKLMFQXNz" class="wolai-block wolai-text"><div><span class="inline-wrap">网络拓扑采用</span><span class="inline-wrap"><b>GNS3<span class="jill"></span>搭建</b></span><span class="inline-wrap">，采用<span class="jill"></span>C3640<span class="jill"></span>操作系统镜像=&gt;</span></div></div><div id="hSZssWbNYSLM5Th6SMdc8s" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-61b3ccec4a58f035cf2a5321491b9739_b.jpg" style="width: 1048px"/></figure></div><div id="28riAwpwp5rqKNHNTs8dHy" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>① 首先为各个设备打开接口并配置<span class="jill"></span>IP<span class="jill"></span>地址：</b></span><span class="inline-wrap"> </span></div></div><div id="eackzT9ctUcwUENo52pmCq" class="wolai-block wolai-text"><div><span class="inline-wrap">PC(config)#int f0/0</span></div></div><div id="8W1Z8SLAqjPcxea1D6gHcK" class="wolai-block wolai-text"><div><span class="inline-wrap">PC(config-if)#no shutdown</span></div></div><div id="2zs3vasZAgNTeLHthUh4GQ" class="wolai-block wolai-text"><div><span class="inline-wrap">PC(config-if)#ip address 192.168.1.1 255.255.255.0</span></div></div><div id="6MQ43pYDAjus6N3M1VBmWA" class="wolai-block wolai-text"><div><span class="inline-wrap">Router(config)#int f0/0</span></div></div><div id="kGLHr5BG3oy4vVhDLTV6xG" class="wolai-block wolai-text"><div><span class="inline-wrap">Router(config-if)#no shutdown</span></div></div><div id="6pPJZrf5mS1izRbJPifeXy" class="wolai-block wolai-text"><div><span class="inline-wrap">Router(config-if)#ip address 192.168.1.254 255.255.255.0</span></div></div><div id="61icuzuYStxT7ujEY4NYtV" class="wolai-block wolai-text"><div><span class="inline-wrap">Router(config-if)#int f1/0</span></div></div><div id="mn5emTTormjGPCRxVZZNCk" class="wolai-block wolai-text"><div><span class="inline-wrap">Router(config-if)#no shutdown</span></div></div><div id="2kEeYDAYtTfnmQWQ1DpCeY" class="wolai-block wolai-text"><div><span class="inline-wrap">Router(config-if)#ip address 8.8.8.1 255.255.255.0</span></div></div><div id="mkBaG1eMFX1pa966ioBnBM" class="wolai-block wolai-text"><div><span class="inline-wrap">Server(config)#int f0/0</span></div></div><div id="6m8NEGAnBLebEEc4PfZbag" class="wolai-block wolai-text"><div><span class="inline-wrap">Server(config-if)#no shutdown</span></div></div><div id="d8krdQcYU1f1npcHiZivmn" class="wolai-block wolai-text"><div><span class="inline-wrap">Server(config-if)#ip address 8.8.8.8 255.255.255.0</span></div></div><div id="i2SrMrSB7M3hNHhm4Ppvi6" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>②为各个设备设置路由信息：</b></span><span class="inline-wrap"> </span></div></div><div id="o5oFkWsjCRbh3zPeERR756" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>a.关闭<span class="jill"></span>PC<span class="jill"></span>上路由功能，模拟主机并查看路由表（此时的电脑没有设置网关）</b></span></div></div><div id="r66Tu4zS4t9zEBUTCuzr4b" class="wolai-block wolai-text"><div><span class="inline-wrap">PC(config)#</span><span class="inline-wrap"><b>no ip routing</b></span></div></div><div id="uXxREBNqPRuG7CzDZjCQLz" class="wolai-block wolai-text"><div><span class="inline-wrap">PC#</span><span class="inline-wrap"><b>show ip route</b></span></div></div><div id="gRPLpAwgd5YBCgnvJgdtB5" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Default gateway is not set</b></span></div></div><div id="xeYGeFR3tzVkH7c9WMrpaK" class="wolai-block wolai-text"><div><span class="inline-wrap">Host Gateway Last Use Total Uses Interface</span></div></div><div id="gPQKdj6WrEg6VHNHKBYzqy" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>b.设置并查看<span class="jill"></span>Router<span class="jill"></span>和<span class="jill"></span>Server<span class="jill"></span>路由表，保证联通，模拟互联网</b></span><span class="inline-wrap">（这里<span class="jill"></span>Router<span class="jill"></span>已有全网的直连路由，Server<span class="jill"></span>需要设置返回内网的路由；实际环境应该通过<span class="jill"></span>NAT<span class="jill"></span>返回，这里不再深入）</span></div></div><div id="mWBp9EDccks7WfsUnQmiM4" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Router#show ip route</b></span></div></div><div id="4fciqdSK85CQS1PNf2rsTm" class="wolai-block wolai-text"><div><span class="inline-wrap">Codes: C - connected, S - static, R - RIP, M - mobile, B - BGP</span></div></div><div id="mPx8mqs2dkbn8ne5KbT4qM" class="wolai-block wolai-text"><div><span class="inline-wrap">D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area</span></div></div><div id="vdsc8mpQrYqky7DNDcZPkf" class="wolai-block wolai-text"><div><span class="inline-wrap">N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2</span></div></div><div id="k8gBxXoWBAuCzRrHN2MoKS" class="wolai-block wolai-text"><div><span class="inline-wrap">E1 - OSPF external type 1, E2 - OSPF external type 2</span></div></div><div id="u6vXGLZF9FPG2Yq1zR58kj" class="wolai-block wolai-text"><div><span class="inline-wrap">i - IS-IS, su - IS-IS summary, L1 - IS-IS level-1, L2 - IS-IS level-2</span></div></div><div id="gbNsReta1TPzb5LqjYbXF" class="wolai-block wolai-text"><div><span class="inline-wrap">ia - IS-IS inter area, * - candidate default, U - per-user static route</span></div></div><div id="jQmyV6c8ZeKNKinUycmuCi" class="wolai-block wolai-text"><div><span class="inline-wrap">o - ODR, P - periodic downloaded static route</span></div></div><div id="jgKcpFrADeApdVrzCtGp8K" class="wolai-block wolai-text"><div><span class="inline-wrap">Gateway of last resort is not set</span></div></div><div id="v7AdeRVNWnYkYHC64nw5zb" class="wolai-block wolai-text"><div><span class="inline-wrap">8.0.0.0/24 is subnetted, 1 subnets</span></div></div><div id="5tVt6LCd9SxLhjhzN7qzNE" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>C 8.8.8.0 is directly connected, FastEthernet1/0</b></span></div></div><div id="e6CP5sZsSXdUTqS4ZiH4Pa" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>C 192.168.1.0/24 is directly connected, FastEthernet0/0</b></span></div></div><div id="ii58RpDn4NQoSFtakB3YDp" class="wolai-block wolai-text"><div><span class="inline-wrap">Server(config)#</span><span class="inline-wrap"><b>ip route 192.168.1.0 255.255.255.0 8.8.8.1</b></span></div></div><div id="4RAkocuaA8mFiz9LSRWKZf" class="wolai-block wolai-text"><div><span class="inline-wrap">Server#</span><span class="inline-wrap"><b>show ip route</b></span></div></div><div id="vH4ugHnyaZD5axehC6aLPF" class="wolai-block wolai-text"><div><span class="inline-wrap">Codes: C - connected, S - static, R - RIP, M - mobile, B - BGP</span></div></div><div id="jf2HJGJ3cRNWZ2HKogquZA" class="wolai-block wolai-text"><div><span class="inline-wrap">D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area</span></div></div><div id="fx1NbDjn5w53mMB9EznMXk" class="wolai-block wolai-text"><div><span class="inline-wrap">N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2</span></div></div><div id="7gBQt5Khesfxs9NQqyCRAS" class="wolai-block wolai-text"><div><span class="inline-wrap">E1 - OSPF external type 1, E2 - OSPF external type 2</span></div></div><div id="etLfMfDSweB5FzTNhNtWjg" class="wolai-block wolai-text"><div><span class="inline-wrap">i - IS-IS, su - IS-IS summary, L1 - IS-IS level-1, L2 - IS-IS level-2</span></div></div><div id="aEL9GjubHa8vBR1GNFGsQs" class="wolai-block wolai-text"><div><span class="inline-wrap">ia - IS-IS inter area, * - candidate default, U - per-user static route</span></div></div><div id="7wMggyUyugEbSUB1Jk13aZ" class="wolai-block wolai-text"><div><span class="inline-wrap">o - ODR, P - periodic downloaded static route</span></div></div><div id="9tnWg9eqHQF8x6KixPnoxY" class="wolai-block wolai-text"><div><span class="inline-wrap">Gateway of last resort is not set</span></div></div><div id="qPnW72rpLm7s72chRdJEsU" class="wolai-block wolai-text"><div><span class="inline-wrap">8.0.0.0/24 is subnetted, 1 subnets</span></div></div><div id="9iZpmwi4REhED2JVaWYK4Z" class="wolai-block wolai-text"><div><span class="inline-wrap">C 8.8.8.0 is directly connected, FastEthernet0/0</span></div></div><div id="cupz4QjgMYng4em3FaLDSW" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>S 192.168.1.0/24 [1/0] via 8.8.8.1</b></span></div></div><div id="9zZiQmwuVfjihCpoULst4A" class="wolai-block wolai-text"><div><span class="inline-wrap">③查看<span class="jill"></span>PC/Router/Server<span class="jill"></span>的接口<span class="jill"></span>MAC<span class="jill"></span>地址：</span></div></div><div id="sboKFmdDp9n89S5eWJhGfe" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>PC#show int f0/0</b></span></div></div><div id="iM747PnrNFQrrvQkUJ3XkX" class="wolai-block wolai-text"><div><span class="inline-wrap">FastEthernet0/0 is up, line protocol is up</span></div></div><div id="7G23LbXugK35W8xMk1xUpZ" class="wolai-block wolai-text"><div><span class="inline-wrap">Hardware is AmdFE, address is </span><span class="inline-wrap"><b>cc05.1f56.0000 (bia cc05.1f56.0000)</b></span></div></div><div id="q3J9Go7jdjw4BB5URX5GJc" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet address is 192.168.1.1/24</span></div></div><div id="cafwqU7wbupDnAQ7TrtMtS" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Router#show int f0/0</b></span></div></div><div id="9263C3GFLdj7HzvT4mDXtz" class="wolai-block wolai-text"><div><span class="inline-wrap">FastEthernet0/0 is up, line protocol is up</span></div></div><div id="2cpcc7a1pQtU2GZzwrvS9" class="wolai-block wolai-text"><div><span class="inline-wrap">Hardware is AmdFE, address is </span><span class="inline-wrap"><b>cc07.1f56.0000 (bia cc07.1f56.0000)</b></span></div></div><div id="3t4m4TPT2pPnB4TrGfPxGn" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet address is 192.168.1.254/24</span></div></div><div id="3CxzebswuYdDiTTGCiHVXt" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Router#show int f1/0</b></span></div></div><div id="3WnNnH8ZakQ69Zpt9kagnZ" class="wolai-block wolai-text"><div><span class="inline-wrap">FastEthernet1/0 is up, line protocol is up</span></div></div><div id="d66uctX2HtZ5HhSgt5MtVT" class="wolai-block wolai-text"><div><span class="inline-wrap">Hardware is AmdFE, address is </span><span class="inline-wrap"><b>cc07.1f56.0010 (bia cc07.1f56.0010)</b></span></div></div><div id="aL6oqdQ6i11RRAVdRrmeTd" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet address is 8.8.8.1/24</span></div></div><div id="orRkqGLnFebyUFL7L3H9a4" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Server#show int f0/0</b></span></div></div><div id="whWWEm24ekDryaaJX58Cdv" class="wolai-block wolai-text"><div><span class="inline-wrap">FastEthernet0/0 is up, line protocol is up</span></div></div><div id="3rr6gUzt3gnHnojZZrCC8J" class="wolai-block wolai-text"><div><span class="inline-wrap">Hardware is AmdFE, address is </span><span class="inline-wrap"><b>cc06.1f56.0000 (bia cc06.1f56.0000)</b></span></div></div><div id="g35fRdxChffjUQ4ywj1VBa" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet address is 8.8.8.8/24</span></div></div><div id="9c5Kn6QpvTDqdn7JtcPbGA" class="wolai-block wolai-text"><div><span class="inline-wrap">④通过</span><span class="inline-wrap"><b>Wireshark<span class="jill"></span>抓取<span class="jill"></span>PC<span class="jill"></span>和<span class="jill"></span>Router<span class="jill"></span>链路的数据包</b></span><span class="inline-wrap">，并让<span class="jill"></span>PC ping Server（8.8.8.8），查看<span class="jill"></span>ARP<span class="jill"></span>问答信息：</span></div></div><div id="uHiF4xgZZAUUEgeRJhgUYC" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>PC#ping 8.8.8.8</b></span></div></div><div id="nSBKfguSJRW2VN4QSwRP6n" class="wolai-block wolai-text"><div><span class="inline-wrap">Type escape sequence to abort.</span></div></div><div id="wWpLx5JKBbtNjYcrsQ1eoC" class="wolai-block wolai-text"><div><span class="inline-wrap">Sending 5, 100-byte ICMP Echos to 8.8.8.8, timeout is 2 seconds:</span></div></div><div id="wfffVZ8YuM1bRevAWfz1Jv" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>.!!!! （一个<span class="jill"></span>ping<span class="jill"></span>来回为一个 ! 标识，而第一个点 . 代表此时正在<span class="jill"></span>arp）</b></span></div></div><div id="smSXNgiFh7n5RhGb4bwHVB" class="wolai-block wolai-text"><div><span class="inline-wrap">Success rate is 80 percent (4/5), round-trip min/avg/max = 44/47/48 ms</span></div></div><div id="vmVegZiij4vpmxPBxttyZz" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-c921ead97015579d00390d7d46ab1396_b.jpg" style="width: 576px"/></figure></div><div id="aNv57vEp1mRxxaWZna9wUK" class="wolai-block wolai-text"><div><span class="inline-wrap">从数据包可以看到，</span><span class="inline-wrap"><b>由于<span class="jill"></span>PC<span class="jill"></span>没有设置默认网关，所以直接采用代理<span class="jill"></span>ARP<span class="jill"></span>方式询问：</b></span><span class="inline-wrap"> 即直接询问跨网段目的<span class="jill"></span>8.8.8.8<span class="jill"></span>的<span class="jill"></span>IP<span class="jill"></span>地址。而由于路由器<span class="jill"></span>Router<span class="jill"></span>默认开启了代理<span class="jill"></span>ARP<span class="jill"></span>功能，所以直接用自己的<span class="jill"></span>MAC<span class="jill"></span>地址回应了。</span><span class="inline-wrap"><b>这里的<span class="jill"></span>cc:07:1f:56:00:00<span class="jill"></span>即路由器的<span class="jill"></span>MAC<span class="jill"></span>地址</b></span><span class="inline-wrap">。这里顺便查看下<span class="jill"></span>PC<span class="jill"></span>的<span class="jill"></span>arp<span class="jill"></span>表：</span></div></div><div id="miLxu7yZ9x8VdiERjvgVKc" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>PC#show arp</b></span></div></div><div id="b1ZUwBfhTfCfP9y2xpcAam" class="wolai-block wolai-text"><div><span class="inline-wrap">Protocol Address Age (min) Hardware Addr Type Interface</span></div></div><div id="9NKh1K4zygqdxvGBAKN39f" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Internet 8.8.8.8 9 cc07.1f56.0000 ARPA FastEthernet0/0</b></span></div></div><div id="wccKNk6zqpnogX31VX3brb" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet 192.168.1.1 - cc05.1f56.0000 ARPA FastEthernet0/0</span></div></div><div id="gxRFtvR9vW4Q5gDNuXepEW" class="wolai-block wolai-text"><div><span class="inline-wrap">因此，这里便验证了：</span><span class="inline-wrap"><b>当电脑没有设置网关信息，则采用代理<span class="jill"></span>ARP。</b></span><span class="inline-wrap"> </span></div></div><div id="jpVNFMQDGvt4tHVyLXPVhz" class="wolai-block wolai-text"><div><span class="inline-wrap">我们接着验证另外一个点：</span><span class="inline-wrap"><b>当采用代理<span class="jill"></span>ARP<span class="jill"></span>时，会&quot;受限于沿途网关设备</b></span><span class="inline-wrap">&quot;，例如网关设备（路由器）可能不支持代理<span class="jill"></span>ARP<span class="jill"></span>或关闭代理<span class="jill"></span>ARP<span class="jill"></span>功能，此时电脑就</span><span class="inline-wrap"><b>无法与外网<span class="jill"></span>IP<span class="jill"></span>实现通信</b></span><span class="inline-wrap">。</span></div></div><div id="tJr61tn9J2jf845PovBotL" class="wolai-block wolai-text"><div><span class="inline-wrap">怎么验证呢？这里我们需要</span><span class="inline-wrap"><b>关闭路由器接口的代理<span class="jill"></span>ARP<span class="jill"></span>功能</b></span><span class="inline-wrap">，并且</span><span class="inline-wrap"><b>清空电脑<span class="jill"></span>PC<span class="jill"></span>的<span class="jill"></span>arp<span class="jill"></span>表</b></span><span class="inline-wrap">=&gt;</span></div></div><div id="2AeWAEvprsCbm8Fy9pB4Q1" class="wolai-block wolai-text"><div><span class="inline-wrap">Router(config)#int f0/0</span></div></div><div id="trxPwoghmVwuXne7DRhdYv" class="wolai-block wolai-text"><div><span class="inline-wrap">Router(config-if)#</span><span class="inline-wrap"><b>no ip proxy-arp</b></span></div></div><div id="mpZSpwi9K9qerHXaJhAmMJ" class="wolai-block wolai-text"><div><span class="inline-wrap">PC#</span><span class="inline-wrap"><b>clear arp</b></span></div></div><div id="bRGnw9qPW856VTzPyRc322" class="wolai-block wolai-text"><div><span class="inline-wrap">PC#ping 8.8.8.8</span></div></div><div id="2VCFFTCUjYrJhnvxkZZXFD" class="wolai-block wolai-text"><div><span class="inline-wrap">Type escape sequence to abort.</span></div></div><div id="gW1gV1GdUpXbFpxR28orMf" class="wolai-block wolai-text"><div><span class="inline-wrap">Sending 5, 100-byte ICMP Echos to 8.8.8.8, timeout is 2 seconds:</span></div></div><div id="3y3tDr8WNsEzFosuqoNdMw" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>.....</b></span></div></div><div id="tyotpfHBA6ZtVyYRtdJkP" class="wolai-block wolai-text"><div><span class="inline-wrap">Success rate is 0 percent (0/5)</span></div></div><div id="6SmDFqLQiQgWzQuTzBK1Cy" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>查看底层数据包交互过程=&gt;</b></span></div></div><div id="6SZv5RaSBfcLLVNNhMqddE" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-05f805568b84a1fb4a17ffc759b4e451_b.jpg" style="width: 576px"/></figure></div><div id="r39HkSU2ip5G3WFWKNdYYu" class="wolai-block wolai-text"><div><span class="inline-wrap">当路由器关闭代理<span class="jill"></span>ARP<span class="jill"></span>时，此时电脑&quot;</span><span class="inline-wrap"><b>苦苦哀求</b></span><span class="inline-wrap">&quot;外网<span class="jill"></span>8.8.8.8<span class="jill"></span>的<span class="jill"></span>MAC<span class="jill"></span>地址，而路由器直接丢弃不再返回，</span><span class="inline-wrap"><b>由于电脑没有目标<span class="jill"></span>IP<span class="jill"></span>对应的<span class="jill"></span>MAC<span class="jill"></span>信息，所以通信失败</b></span><span class="inline-wrap">，即 </span><span class="inline-wrap"><b>......</b></span><span class="inline-wrap"> 我们来看下此时<span class="jill"></span>PC<span class="jill"></span>的<span class="jill"></span>arp<span class="jill"></span>表是怎样的=&gt;</span></div></div><div id="wgVXApkVr7TCR72pVvTw4Y" class="wolai-block wolai-text"><div><span class="inline-wrap">PC#</span><span class="inline-wrap"><b>show arp</b></span></div></div><div id="p4VqjN5EjMqKo3Dq46NUpd" class="wolai-block wolai-text"><div><span class="inline-wrap">Protocol Address Age (min) Hardware Addr Type Interface</span></div></div><div id="vEvoiY1khh6bA65GeHAtBt" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Internet 8.8.8.8 0 Incomplete ARPA</b></span></div></div><div id="7yAQFAMqsv6rjyRiHXLeNR" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet 192.168.1.1 - cc05.1f56.0000 ARPA FastEthernet0/0</span></div></div><div id="rh4sNDLEkEJMC1QWGvcaK8" class="wolai-block wolai-text"><div><span class="inline-wrap">⑤为<span class="jill"></span>PC</span><span class="inline-wrap"><b>设置默认网关</b></span><span class="inline-wrap">，重新<span class="jill"></span>ping 8.8.8.8，看看能不能通=&gt;</span></div></div><div id="aJg89MtKBmC47Xg3MnqVcD" class="wolai-block wolai-text"><div><span class="inline-wrap">PC(config)#</span><span class="inline-wrap"><b>ip default-gateway 192.168.1.254</b></span></div></div><div id="oVppBuhxH9xkLKTEdRNHzB" class="wolai-block wolai-text"><div><span class="inline-wrap">PC#</span><span class="inline-wrap"><b>ping 8.8.8.8</b></span></div></div><div id="55dFV6WT2nRirJkPLaGmRo" class="wolai-block wolai-text"><div><span class="inline-wrap">Type escape sequence to abort.</span></div></div><div id="pKqyArKDKeqcWUav9pjRp" class="wolai-block wolai-text"><div><span class="inline-wrap">Sending 5, 100-byte ICMP Echos to 8.8.8.8, timeout is 2 seconds:</span></div></div><div id="5bfe2hRLBSoJB93Sp6NeWD" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>!!!!!</b></span></div></div><div id="tBSDMRntGdsuu5rnaKhr9s" class="wolai-block wolai-text"><div><span class="inline-wrap">Success rate is 100 percent (5/5), round-trip min/avg/max = 44/244/1040 ms</span></div></div><div id="s4hiuziSuNiSLvs5YgExi2" class="wolai-block wolai-text"><div><span class="inline-wrap">可以看到，当电脑具备网关信息之后，此时直接采用<span class="jill"></span>ARP<span class="jill"></span>询问网关的<span class="jill"></span>MAC，即去往<span class="jill"></span>8.8.8.8<span class="jill"></span>的时候直接询问<span class="jill"></span>192.168.1.254<span class="jill"></span>的<span class="jill"></span>MAC，这个时候不管<span class="jill"></span>Router<span class="jill"></span>有没有开启代理<span class="jill"></span>ARP，也会正常回应<span class="jill"></span>PC<span class="jill"></span>的<span class="jill"></span>ARP<span class="jill"></span>询问，我们来看看底层数据包截图=&gt;</span></div></div><div id="7sAuESXGvHTN1fp3DBaA31" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-e8ecedcea3d9ab6112dcdce304914c3f_b.jpg" style="width: 576px"/></figure></div><h2 id="mPKv8BbuAhhx1JRcadJtRY" class="wolai-block"><span class="inline-wrap"><b>五、代理<span class="jill"></span>ARP<span class="jill"></span>总结</b></span></h2><div id="hojtKnfEwvHePiUmGPyB7m" class="wolai-block wolai-text"><div><span class="inline-wrap">① 本章节我们深入学习了代理<span class="jill"></span>ARP<span class="jill"></span>的原理和实践，在文章的开头，我们通过一个引子，帮大家矫正一个误区：跨网段通信时，就一定要用到代理<span class="jill"></span>ARP；</span></div></div><div id="qRfjwvUnUZfXYGPbw7UuoQ" class="wolai-block wolai-text"><div><span class="inline-wrap">②代理<span class="jill"></span>ARP<span class="jill"></span>是一个&quot;善意的欺骗&quot;，当电脑要跨网段访问外网设备时，网关设备用自己的<span class="jill"></span>MAC<span class="jill"></span>返回；</span></div></div><div id="2CwVNL2CqHkQCvJDneg2pV" class="wolai-block wolai-text"><div><span class="inline-wrap">③代理<span class="jill"></span>ARP<span class="jill"></span>和<span class="jill"></span>ARP<span class="jill"></span>的具体实现，跟电脑是否有设置网关有直接的关系；有网关通过<span class="jill"></span>ARP，没网关通过代理<span class="jill"></span>ARP；代理<span class="jill"></span>ARP<span class="jill"></span>可以看成是<span class="jill"></span>ARP<span class="jill"></span>的补充；</span></div></div><div id="qZXRNn9au5Uzz17wL71kyZ" class="wolai-block wolai-text"><div><span class="inline-wrap">④代理<span class="jill"></span>ARP<span class="jill"></span>会&quot;受限于沿途网络设备&quot;，真实网络里面一般都直接用<span class="jill"></span>ARP<span class="jill"></span>获取<span class="jill"></span>MAC<span class="jill"></span>地址。</span></div></div><div id="mbZavJ6ThNoFFCMkCwfmvW" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>预告：</b></span><span class="inline-wrap"> </span></div></div><div id="wS2F8zQzsobkGBdiyxMZtf" class="wolai-block wolai-text"><div><span class="inline-wrap">什么是免费/无故<span class="jill"></span>ARP？</span></div></div><div id="NhWFUffD1fb7ow8LH46Ht" class="wolai-block wolai-text"><div><span class="inline-wrap">免费<span class="jill"></span>ARP<span class="jill"></span>的功能是什么？在什么时候出现？</span></div></div><div id="6h3fuZrTV44uQb217yHv1j" class="wolai-block wolai-text"><div><span class="inline-wrap">免费<span class="jill"></span>ARP<span class="jill"></span>的数据包结构是如何的？</span></div></div><div id="swy9Ai2xyJS8thFzqmWgpA" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>【相关推荐】</b></span><span class="inline-wrap"> </span></div></div><div id="gpXyJV9rayF6j6XGejK8iM" class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://zhuanlan.zhihu.com/p/28865553"><span>图解<span class="jill"></span>ARP<span class="jill"></span>协议（三）ARP<span class="jill"></span>防御篇-如何揪出&quot;内鬼&quot;并&quot;优雅的还手&quot;？</span></a></span></div></div><div id="bYCRLREeERsvgDdWPmqZ7k" class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://zhuanlan.zhihu.com/p/28818627"><span>图解<span class="jill"></span>ARP<span class="jill"></span>协议（二）ARP<span class="jill"></span>攻击篇</span></a></span></div></div><div id="oon1FQRRgSqCX2i3hUJPG3" class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://zhuanlan.zhihu.com/p/28771785"><span>图解<span class="jill"></span>ARP<span class="jill"></span>协议（一）</span></a></span></div></div><div id="uzeiqprtazHxjCG8Qsmwp2" class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.pinginglab.net/course/164"><span>《TCP/IP<span class="jill"></span>协议栈视频教程》</span></a></span></div></div><div id="5nbYr6jJtSxRFu8K6oR2Cn" class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.pinginglab.net/course/3"><span>《Wireshark<span class="jill"></span>协议分析从入门到精通》</span></a></span></div></div><div id="m9RKPbJDbFH7Efq6BVhmMS" class="wolai-block wolai-text"><div><span class="inline-wrap">新浪微博：</span><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.weibo.com/jaykingchen"><span>@<span class="jill"></span>拼客学院陈鑫杰</span></a></span></div></div><div id="7xuoZgxXsWJ4QfuckcLH4C" class="wolai-block wolai-text"><div><span class="inline-wrap">微信公众号：拼客院长陈鑫杰</span></div></div><div id="7ACV9EbZ1FTsoCpxS4ApCv" class="wolai-block wolai-text"><div><span class="inline-wrap">拼客学院：</span><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.pinginglab.net"><span>http://www.pinginglab.net</span></a></span></div></div></div><div id="cNLM4icJFzyyq54kUFv32y" class="wolai-sub-page wolai-block"><div class="page-icon"></div><a href="ipv4%E5%8D%8F%E8%AE%AE/arp/%E5%9B%BE%E8%A7%A3arp%E5%8D%8F%E8%AE%AE%EF%BC%88%E4%BA%94%EF%BC%89%E5%85%8D%E8%B4%B9arp%EF%BC%9A%E5%9C%B0%E5%9D%80%E5%86%B2%E7%AA%81/%E5%9B%BE%E8%A7%A3arp%E5%8D%8F%E8%AE%AE%EF%BC%88%E4%BA%94%EF%BC%89%E5%85%8D%E8%B4%B9arp%EF%BC%9A%E5%9C%B0%E5%9D%80%E5%86%B2%E7%AA%81.html"><span>图解ARP协议（五）免费ARP：地址冲突了肿么办？ - 知乎</span></a><h2 id="8ThCgDqei1twZ6b6Rf8fVM" class="wolai-block"><span class="inline-wrap"><b>一、免费<span class="jill"></span>ARP<span class="jill"></span>概述</b></span></h2><div id="7rW5M3gKddGYhGoou8354g" class="wolai-block wolai-text"><div><span class="inline-wrap">网络世界纷繁复杂，除了各种黑客攻击行为对网络能造成实际破坏之外，还有一类安全问题或泛安全问题，看上去问题不大，但其实仍然可以造成极大的杀伤力。今天跟大家探讨的，也是技术原理比较简单，但实际防范比较头疼的一个问题：</span><span class="inline-wrap"><b>地址冲突</b></span><span class="inline-wrap">。</span></div></div><div id="wv9GkAje2eHJd5hkKVCfud" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-c596ff81f272c76e75c042efe4268ba9_b.jpg" style="width: 576px"/></figure></div><div id="wUJCTPUYqHsJpSZTG7xpnf" class="wolai-block wolai-text"><div><span class="inline-wrap">这个局域网中，大家所在<span class="jill"></span>IP<span class="jill"></span>网段是<span class="jill"></span>192.168.1.0/24，PC1<span class="jill"></span>的地址是<span class="jill"></span>192.168.1.1，而<span class="jill"></span>PC2<span class="jill"></span>和<span class="jill"></span>PC3<span class="jill"></span>的地址发生冲突，都是<span class="jill"></span>192.168.1.2。那么，如果<span class="jill"></span>PC1<span class="jill"></span>需要将数据包发送给<span class="jill"></span>192.168.1.2，数据包最终到了<span class="jill"></span>PC2<span class="jill"></span>还是<span class="jill"></span>PC3<span class="jill"></span>手里？还是负载均衡？不管结果如何，这里的地址冲突肯定会对正常通信造成麻烦。</span></div></div><div id="isHF6Qo7eYVTBUm62nAkFV" class="wolai-block wolai-text"><div><span class="inline-wrap">上面这个电脑/手机之间的地址冲突，大家可能觉得没什么太大的问题，那么接下来再看下面这个图片=&gt;</span></div></div><div id="6kfvzWdkzEcK9EVXuzHrXu" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-cbf4f15aa6be1a12a86360bdd4e1e469_b.jpg" style="width: 576px"/></figure></div><div id="vCXEmegXikZNqo38NAZjBY" class="wolai-block wolai-text"><div><span class="inline-wrap">这里的<span class="jill"></span>Server1<span class="jill"></span>和<span class="jill"></span>Server2<span class="jill"></span>处在 [服务集群]中，提供着企业的某种服务，例如<span class="jill"></span>Web<span class="jill"></span>网站、邮箱系统、FTP<span class="jill"></span>文件服务器等，此时服务器的地址发生了冲突，都是<span class="jill"></span>10.1.1.1。这种地址冲突则会影响大规模的用户无法访问这个服务器，</span><span class="inline-wrap"><b>若服务器承载的是核心业务，对于企业则会造成极大的影响</b></span><span class="inline-wrap">。</span></div></div><div id="kG7eaeVAJkcomW3oipShK3" class="wolai-block wolai-text"><div><span class="inline-wrap">所以，</span><span class="inline-wrap"><b>地址冲突问题可大可小，可能网络运维人员部署上的疏忽，也可能是普通电脑小白无意导致的，更有可能是主动的黑客行为</b></span><span class="inline-wrap">，例如攻击者制造地址冲突场景，扰乱正常业务，导致业务服务中断。</span></div></div><div id="8nDpJwSj4f6Rxmc1boGpii" class="wolai-block wolai-text"><div><span class="inline-wrap">因此，</span><span class="inline-wrap"><b>如何在<span class="jill"></span>IP<span class="jill"></span>地址冲突的时候及时检测，并且做出解决方案呢？</b></span></div></div><h2 id="hMQgmey6tcrTBtKLdXo1Fr" class="wolai-block"><span class="inline-wrap"><b>二、免费<span class="jill"></span>ARP<span class="jill"></span>原理</b></span></h2><div id="tjTaUyQtD4ybwxk8PzSp2v" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Gratuitous ARP，被翻译为『免费<span class="jill"></span>ARP』也被称为『无故<span class="jill"></span>ARP』，用于检测局域网内的<span class="jill"></span>IP<span class="jill"></span>地址冲突</b></span><span class="inline-wrap">，在一定程度上能够给用户和网络运维人员提供帮助。相比『免费』这个翻译，『无故』这个词其实会更加好理解：&quot;</span><span class="inline-wrap"><b>在没有人问自己的情况下，无缘无故自问自答</b></span><span class="inline-wrap">&quot;。</span></div></div><div id="aM1suhy5ojgbtnFx1e6zpi" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-f2ab93fe622b32c57e50524e1f11fb74_b.jpg" style="width: 576px"/></figure></div><div id="gHB8mN5UzdQzSH7WuD4zev" class="wolai-block wolai-text"><div><span class="inline-wrap">这项技术不需要电脑和服务器安装什么安全软件或产品例如防火墙之类的，也不需要交换机和路由器购买什么<span class="jill"></span>license，只要设备具备联网功能（有网卡）就内置了这项功能，由于免费<span class="jill"></span>ARP<span class="jill"></span>本质是<span class="jill"></span>ARP<span class="jill"></span>协议的实现，所以只要有<span class="jill"></span>TCP/IP<span class="jill"></span>协议栈的网卡，就能支持。相比其他安全防御技术，</span><span class="inline-wrap"><b>免费<span class="jill"></span>ARP<span class="jill"></span>是一项轻量级的&quot;用户无感知&quot;的技术。</b></span><span class="inline-wrap"> </span></div></div><div id="hsX2rY1pZQ8L87cUWdYbAV" class="wolai-block wolai-text"><div><span class="inline-wrap">接下来，我们来回顾下之前的图片=&gt;</span></div></div><div id="77nivVCJS92sfYjiq13uDf" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-f72af8ecc7c0572b5b608cdf399649c1_b.jpg" style="width: 658px"/></figure></div><div id="92tp1RdgL7q7i8sVXjwnE7" class="wolai-block wolai-text"><div><span class="inline-wrap">当用户发送数据包给<span class="jill"></span>192.168.1.2<span class="jill"></span>的时候，交换机会将数据包转发给谁呢？</span></div></div><div id="adL337o1vU99BttvCgNtd7" class="wolai-block wolai-text"><div><span class="inline-wrap">①根据我们之前学过的<span class="jill"></span>ARP<span class="jill"></span>原理，交换机会拆开这个数据包，并且</span><span class="inline-wrap"><b>根据目的<span class="jill"></span>MAC<span class="jill"></span>进行转发</b></span><span class="inline-wrap">；</span></div></div><div id="n9hLuBVfTShEsFBHRajh9d" class="wolai-block wolai-text"><div><span class="inline-wrap">②那么<span class="jill"></span>PC1<span class="jill"></span>在数据封装的时候，</span><span class="inline-wrap"><b>目的<span class="jill"></span>MAC<span class="jill"></span>是封装<span class="jill"></span>PC2<span class="jill"></span>还是<span class="jill"></span>PC3<span class="jill"></span>的<span class="jill"></span>MAC</b></span><span class="inline-wrap">？</span></div></div><div id="nmoFV3jHcwndLtGyeNAJUy" class="wolai-block wolai-text"><div><span class="inline-wrap">③</span><span class="inline-wrap"><b>目标<span class="jill"></span>MAC<span class="jill"></span>则取决于电脑本地的<span class="jill"></span>ARP<span class="jill"></span>缓存表</b></span><span class="inline-wrap">，所以<span class="jill"></span>PC1<span class="jill"></span>最终把数据包给<span class="jill"></span>PC2<span class="jill"></span>还是<span class="jill"></span>PC3，则取决于收到的<span class="jill"></span>ARP<span class="jill"></span>回应，并且根据&quot;</span><span class="inline-wrap"><b>后到优先</b></span><span class="inline-wrap">&quot;原则作出选择。</span></div></div><div id="omXWNEu2ys4NBWjdThGKKb" class="wolai-block wolai-text"><div><span class="inline-wrap">所以，若<span class="jill"></span>PC2<span class="jill"></span>提前回应<span class="jill"></span>ARP，则<span class="jill"></span>PC1<span class="jill"></span>一直发给<span class="jill"></span>PC3；若<span class="jill"></span>PC3<span class="jill"></span>提前回应<span class="jill"></span>ARP，则<span class="jill"></span>PC1<span class="jill"></span>一直发送给<span class="jill"></span>PC2。还有一种情况，PC2<span class="jill"></span>和<span class="jill"></span>PC3<span class="jill"></span>交替回应<span class="jill"></span>ARP，PC1<span class="jill"></span>有可能将部分数据给<span class="jill"></span>PC2，部分数据给<span class="jill"></span>PC3（而<span class="jill"></span>PC1<span class="jill"></span>则处于懵逼状态，因为关于<span class="jill"></span>192.168.1.2<span class="jill"></span>的<span class="jill"></span>MAC<span class="jill"></span>映射一直在变动）。这个更多是理论推导，</span><span class="inline-wrap"><b>实际情况不同设备测试出来的效果有些差异，后面章节我会带大家做真实和虚拟网络的实验</b></span><span class="inline-wrap">。</span></div></div><div id="pMgXjte1abVhNXSkG2jhxs" class="wolai-block wolai-text"><div><span class="inline-wrap">我们来看看免费<span class="jill"></span>ARP<span class="jill"></span>是如何工作的并介入这场冲突的？</span></div></div><div id="xi613Na6uXBx8v9CprcjQo" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-41c5818c2ad4c2c1645cba4e5c6d58c3_b.jpg" style="width: 684px"/></figure></div><div id="f9oaxTwsPY1MijL53PMoaT" class="wolai-block wolai-text"><div><span class="inline-wrap">当电脑检测到自己的<span class="jill"></span>IP<span class="jill"></span>地址跟其他电脑冲突时，它们会相互发送</span><span class="inline-wrap"><b>免费<span class="jill"></span>ARP（&quot;互怼&quot;）</b></span><span class="inline-wrap">，用来提醒对方：</span><span class="inline-wrap"><b>你的<span class="jill"></span>IP<span class="jill"></span>地址跟我的冲突啦！</b></span><span class="inline-wrap"> 这里要注意一点：免费<span class="jill"></span>ARP<span class="jill"></span>是</span><span class="inline-wrap"><b>以<span class="jill"></span>ARP Request<span class="jill"></span>或<span class="jill"></span>Reply<span class="jill"></span>广播形式</b></span><span class="inline-wrap">发送，将<span class="jill"></span>IP<span class="jill"></span>和<span class="jill"></span>MAC<span class="jill"></span>地址信息绑定，并宣告到整个局域网。如果在宣告的过程中，其他电脑监听到，并且地址跟自己一样，也会直接参与这个&quot;互怼&quot;过程。</span></div></div><div id="wD9hEuEYggAg1fCmgMJUyd" class="wolai-block wolai-text"><div><span class="inline-wrap">上面<span class="jill"></span>PC2<span class="jill"></span>和<span class="jill"></span>PC3<span class="jill"></span>一直不停地对外发送免费<span class="jill"></span>ARP：我的地址是<span class="jill"></span>192.168.1.2，MAC<span class="jill"></span>是<span class="jill"></span>xxx。与此同时，同一局域网的其他主机，则根据这两个免费<span class="jill"></span>ARP<span class="jill"></span>信息不断的修改本地<span class="jill"></span>ARP<span class="jill"></span>表，192.168.1.2<span class="jill"></span>一会映射到<span class="jill"></span>MAC2，一会映射到<span class="jill"></span>MAC3。</span></div></div><div id="pWuwMBw5jHYHhSb6cccw2Q" class="wolai-block wolai-text"><div><span class="inline-wrap">那么，</span><span class="inline-wrap"><b>这个混乱的争抢过程，会不会停下来呢？</b></span></div></div><div id="afoDbJaPxfnGecejf1JAJH" class="wolai-block wolai-text"><div><span class="inline-wrap">可能会持续一段时间，也可能一直持续下去（后面有实验验证）。冲突方之间可能会一直发送，直到有一边做出让步并修改<span class="jill"></span>IP<span class="jill"></span>地址。（不同系统解决方法不同）</span></div></div><div id="tpHB1jac1TFbZEw2chnqwh" class="wolai-block wolai-text"><div><span class="inline-wrap">很多人在这里开始有疑惑，即便免费<span class="jill"></span>ARP<span class="jill"></span>帮我们检测到了地址冲突，但是也是在协议底层在&quot;互怼&quot;，**我们作为&quot;主人&quot;，如何收到地址冲突提示，并且做出修改和让步呢？**因为无论是普通用户还是专业工程师，也不可能天天挂在<span class="jill"></span>wireshark<span class="jill"></span>这种抓包软件，时时刻刻盯着免费<span class="jill"></span>ARP<span class="jill"></span>包，判断是否有人跟我们地址冲突了。所以，这又涉及到电脑（操作系统）如何根据免费<span class="jill"></span>ARP<span class="jill"></span>的地址冲突检测，更好的提示或帮助用户了。</span></div></div><div id="gmRS5jCVYNGPF6eeCKmtPU" class="wolai-block wolai-text"><div><span class="inline-wrap">目前行业的解决方案是这样的：如果是</span><span class="inline-wrap"><b>图形化</b></span><span class="inline-wrap">操作系统，例如<span class="jill"></span>Windows<span class="jill"></span>或者<span class="jill"></span>MacOS，是通过系统</span><span class="inline-wrap"><b>弹框</b></span><span class="inline-wrap">的方式提示用户；而如果是</span><span class="inline-wrap"><b>命令行</b></span><span class="inline-wrap">操作系统（交换机/路由器/防火墙），则通过</span><span class="inline-wrap"><b>日志</b></span><span class="inline-wrap">报错信息提示用户。</span></div></div><div id="dThPcuttD1GC1gRre19jrx" class="wolai-block wolai-text"><div><span class="inline-wrap">也就是说，无论普通电脑还是专业的防火墙设备，通过免费<span class="jill"></span>ARP<span class="jill"></span>检测到地址冲突之后，设备都会弹出来跟他说：</span><span class="inline-wrap"><b>喂，主人，你地址跟人家冲突了，该改改了！</b></span></div></div><div id="GYoAXgSu8NkpK7GHATfhq" class="wolai-block wolai-text"><div><span class="inline-wrap">这是<span class="jill"></span>Windows<span class="jill"></span>和<span class="jill"></span>MacOS<span class="jill"></span>的地址冲突弹框告警，引导用户修改本机<span class="jill"></span>IP<span class="jill"></span>地址=&gt;  </span></div></div><div id="n3eLG91bFGjKgaqaQ7mVQ9" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-83bc2661bb6d2ba7007513357d5584f7_b.jpg" style="width: 576px"/></figure></div><div id="bbpeYn3AbiW7GBj2LniVa" class="wolai-block wolai-text"><div><span class="inline-wrap">这是思科路由器<span class="jill"></span>IOS（网际操作系统）的地址冲突日志信息，引导网络运维人员修改<span class="jill"></span>IP<span class="jill"></span>地址=&gt;</span></div></div><div id="foAVj4gEe8jMpH3EfUztcf" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>%IP-4-DUPADDR: Duplicate address</b></span><span class="inline-wrap"> 192.168.1.2 on FastEthernet0/0, sourced by cc02.394f.0000</span></div></div><div id="jqSQ22nP7yuwXBBHTyqa2q" class="wolai-block wolai-text"><div><span class="inline-wrap">所以，当地址发生冲突时，根据免费<span class="jill"></span>ARP<span class="jill"></span>引起的弹框和日志告警，用户或者管理员便可以对<span class="jill"></span>IP<span class="jill"></span>地址进行修改，从而解决通信问题。例如，下面的<span class="jill"></span>PC2<span class="jill"></span>和<span class="jill"></span>PC3，只要一方修改了地址即可 =&gt;</span></div></div><div id="dB2AcCFyk3Pr79Li4yBu8t" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-c0ccd54288808752b50ae90a40e6f986_b.jpg" style="width: 576px"/></figure></div><h2 id="poX8MS2JQRrS9Fk36yDxZA" class="wolai-block"><span class="inline-wrap"><b>三、免费<span class="jill"></span>ARP<span class="jill"></span>实战指南</b></span></h2><div id="nAGLBtbKfeukXKuMcpDxeD" class="wolai-block wolai-text"><div><span class="inline-wrap">免费<span class="jill"></span>ARP<span class="jill"></span>出现的场景非常多，例如</span><span class="inline-wrap"><b>地址冲突时、地址修改或变更时、DHCP<span class="jill"></span>分发地址时、网关冗余协议交互时（例如<span class="jill"></span>HSRP）、TFTP<span class="jill"></span>传输数据时</b></span><span class="inline-wrap">……</span></div></div><div id="ujNa4nNbSGPAaVDLCEE1wH" class="wolai-block wolai-text"><div><span class="inline-wrap">不同的场景，抓到的免费<span class="jill"></span>ARP<span class="jill"></span>数据包，底层结构都会有所差异，可能是基于<span class="jill"></span>ARP<span class="jill"></span>请求广播发送的，也可能是基于<span class="jill"></span>ARP<span class="jill"></span>回应广播发送的（没看错！ARP<span class="jill"></span>回应这里是广播方式）</span></div></div><div id="iKTU8qxcYaWLEWnRFeHfCT" class="wolai-block wolai-text"><div><span class="inline-wrap">为了让大家&quot;亲眼所见&quot;，同时可跟着我一起实践，更好吸收这块的知识，这里我设计了真实和虚拟网络来进行实战，并抓取免费<span class="jill"></span>ARP<span class="jill"></span>数据包，通过数据包解构原理。</span></div></div><div id="8nPj8pXh86Gu1QnZzsnM25" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>（一）真实网络下 免费<span class="jill"></span>ARP<span class="jill"></span>实战</b></span></div></div><div id="oisn9vLP9u9n9uA6bRC4rt" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>① 跟上一篇文章中代理<span class="jill"></span>ARP<span class="jill"></span>的真实网络一样，我的网络拓扑是这样的：</b></span><span class="inline-wrap"> </span></div></div><div id="pb4GfffQMQNZdLp7vvyA5o" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-23b2f1e5e51ce53642b217e6d696cc13_b.jpg" style="width: 576px"/></figure></div><div id="wYtY8iY6jotpvhR61Keesp" class="wolai-block wolai-text"><div><span class="inline-wrap">为了让这个实验更有通用性，我加入了一台<span class="jill"></span>Windows<span class="jill"></span>电脑。此时登录无线路由器（极路由）查看局域网主机列表：</span></div></div><div id="psiLdFVDrabTCQTDMWMQ8F" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-a3ca2596fc8de941f7bda5e1a760d49b_b.jpg" style="width: 576px"/></figure></div><div id="sqyVXYDewRx1WYscKNDGNV" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>还是原来的配方.... 苹果全家桶和一台<span class="jill"></span>Windows<span class="jill"></span>电脑。</b></span><span class="inline-wrap"> 实物图大概是这样的：</span></div></div><div id="nBgjHfmB5ja4eRNce6V7aL" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-ab50aabaa042494abf31a9da3cfb43ab_b.jpg" style="width: 576px"/></figure></div><div id="pwVLLLSqivQrGLmeQhYebv" class="wolai-block wolai-text"><div><span class="inline-wrap">② 接下来，为了看到地址冲突时，免费<span class="jill"></span>ARP<span class="jill"></span>的数据包交互，我们在<span class="jill"></span>Windows<span class="jill"></span>和<span class="jill"></span>MacOS<span class="jill"></span>同时开启<span class="jill"></span>Wireshark<span class="jill"></span>并抓包本机电脑的数据包，设置<span class="jill"></span>arp<span class="jill"></span>过滤。</span></div></div><div id="9CE511EbbPVKodzD3kRSnf" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>macbook<span class="jill"></span>端截图如下：</b></span><span class="inline-wrap"> </span></div></div><div id="mao9pHCUpZySFE7r669jRw" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-bc5a4ccea5eccf78b0a0b6343d9269d4_b.jpg" style="width: 961.6px"/></figure></div><div id="eyd3TJyin3WEEyV2BjiX5H" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Windows<span class="jill"></span>端截图如下：</b></span><span class="inline-wrap"> （Windows 10<span class="jill"></span>跟无线路由器一直在交互）</span></div></div><div id="o2BhiArMAjRPAYaVVpYZpf" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-d8287e3876e8763e6465bc8831417bf1_b.jpg" style="width: 576px"/></figure></div><div id="v91859MBpMN6WUyNDTsJvj" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>③在<span class="jill"></span>Mac<span class="jill"></span>端，将<span class="jill"></span>IP<span class="jill"></span>地址设置为跟<span class="jill"></span>Windows<span class="jill"></span>地址一样</b></span><span class="inline-wrap">，</span><span class="inline-wrap"><b>从<span class="jill"></span>192.168.199.177<span class="jill"></span>改为<span class="jill"></span>192.168.199.152</b></span></div></div><div id="8PVMgW7JaRzuEoAvEw2chW" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-b23a3f127bb2a3afdfa23946877a9d99_b.jpg" style="width: 832px"/></figure></div><div id="6xCrJUmj2Dn1aWLQ96UNJV" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div id="4Pj8xz28sEL7RgD9feg6DB" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-b287c94c0611b32e2e55fa91105b20db_b.jpg" style="width: 827.2px"/></figure></div><div id="46TNDbx5r4vACoMGxKr5wL" class="wolai-block wolai-text"><div><span class="inline-wrap">点击应用之后，开始观察两边电脑弹框和<span class="jill"></span>wireshark<span class="jill"></span>的<span class="jill"></span>ARP<span class="jill"></span>包交互过程=&gt;</span></div></div><div id="9iuHiwxxAsm3W7QeAC9xfY" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-66ff0ff69022026f9de918769e8cd2c1_b.jpg" style="width: 576px"/></figure></div><div id="mnWvr54ThgZcRvgFRHJs17" class="wolai-block wolai-text"><div><span class="inline-wrap">上图可以看到<span class="jill"></span>macbook<span class="jill"></span>的弹框告警了，接下来我们来分析下此时<span class="jill"></span>Mac<span class="jill"></span>和<span class="jill"></span>windows<span class="jill"></span>抓到的数据交互过程=&gt;</span></div></div><div id="rYRNrb6N2dT1bKmc2mjYmK" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-a0de09b36c871cdb62cd66c134eff25b_b.jpg" style="width: 576px"/></figure></div><div id="u4eCiwqoYQvs1z4qGLu5JS" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div id="c2WBmCan9aFdpozJ5mS7dq" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-fdb130c3bed93cba852e20325cfce669_b.jpg" style="width: 576px"/></figure></div><div id="qQd4s85Eba8GAzo1rxrETn" class="wolai-block wolai-text"><div><span class="inline-wrap">我的<span class="jill"></span>windows<span class="jill"></span>电脑很明确的回应<span class="jill"></span>Mac<span class="jill"></span>电脑：</span><span class="inline-wrap"><b>这个地址<span class="jill"></span>199.152，已经被我用了</b></span><span class="inline-wrap">。这个过程重复了<span class="jill"></span>3<span class="jill"></span>次。根据抓包，</span><span class="inline-wrap"><b>这个过程后面还在不断的持续中，不管在<span class="jill"></span>win<span class="jill"></span>还是<span class="jill"></span>mac，都能抓到类似的问答过程</b></span><span class="inline-wrap">。</span></div></div><div id="gmAJLyzhpNHJzAJd7eQkGu" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-01e9ff6f9614614faf95e160f217f947_b.jpg" style="width: 576px"/></figure></div><div id="fSckk7AEx9j9EgR33vFNg" class="wolai-block wolai-text"><div><span class="inline-wrap">由于<span class="jill"></span>macbook<span class="jill"></span>电脑</span><span class="inline-wrap"><b>此刻不能上网</b></span><span class="inline-wrap">，所以还&quot;</span><span class="inline-wrap"><b>不屈不挠</b></span><span class="inline-wrap">&quot;的询问着，它在想：没准<span class="jill"></span>windows<span class="jill"></span>下线了，没有回应了呢？（如果<span class="jill"></span>win<span class="jill"></span>没有回应，则说明它下线了或改为其他地址了，那么<span class="jill"></span>mac<span class="jill"></span>就可以使用）</span></div></div><div id="q8CnYiQDEuHSt8uTKNNfS5" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic2.zhimg.com/v2-1dd7a2975a0c2fce99cc8e9cd6a5fd49_b.jpg" style="width: 582.4px"/></figure></div><div id="nsRjjdmrwhkketbMmUPTGH" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>④ 接下来，我们将<span class="jill"></span>windows<span class="jill"></span>的网络断开，然后在<span class="jill"></span>macbook<span class="jill"></span>这端观察<span class="jill"></span>arp<span class="jill"></span>交互和网络连接状态：</b></span><span class="inline-wrap"> </span></div></div><div id="oE2ckmZchGY3tx6LAn8Qed" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-8006ecef56d9e6b44b668ef1c554356a_b.jpg" style="width: 576px"/></figure></div><div id="t78PaqK71TrCDbqcx1RrgM" class="wolai-block wolai-text"><div><span class="inline-wrap">此时，macbook<span class="jill"></span>跟往常一样发生三个<span class="jill"></span>arp<span class="jill"></span>请求，询问<span class="jill"></span>152<span class="jill"></span>这个地址是否有人使用，</span><span class="inline-wrap"><b>由于<span class="jill"></span>windows<span class="jill"></span>已经下线，所以三次都没有应答</b></span><span class="inline-wrap">。紧接着有三个<span class="jill"></span>gratuitous arp<span class="jill"></span>数据包，跟上面三个请求包几乎是一样的，只有一个区别，就是发送者的<span class="jill"></span>IP<span class="jill"></span>地址此时从<span class="jill"></span>0.0.0.0<span class="jill"></span>修改为<span class="jill"></span>192.168.199.152。这意味着</span><span class="inline-wrap"><b>mac<span class="jill"></span>确认了<span class="jill"></span>152<span class="jill"></span>没有其他人使用，并且认为此刻自己有资格用上<span class="jill"></span>152<span class="jill"></span>这个地址了</b></span><span class="inline-wrap">。</span></div></div><div id="pDz6iZmBWwbNJvLtXGLt45" class="wolai-block wolai-text"><div><span class="inline-wrap">从<span class="jill"></span>wireshark<span class="jill"></span>抓包来看，之前的<span class="jill"></span>arp<span class="jill"></span>请求好像没有标记**&quot;gratuitous&quot;</span><span class="inline-wrap"><b>这个关键词，那么算不是是免费<span class="jill"></span>arp<span class="jill"></span>或者无故<span class="jill"></span>arp<span class="jill"></span>呢？这个其实也是比较多讨论和争议。如果从</b></span><span class="inline-wrap">&quot;自己问自己的角度**&quot;出发，这两种<span class="jill"></span>arp<span class="jill"></span>都算是免费<span class="jill"></span>arp，因为都是在问自己配置的这个新地址<span class="jill"></span>192.168.199.152，而且</span><span class="inline-wrap"><b>目的都是一致的，都是为了检测是否地址可用是否存在冲突</b></span><span class="inline-wrap">。</span></div></div><div id="4d6S4PL2BzYgFS1o5qoxAE" class="wolai-block wolai-text"><div><span class="inline-wrap">当然，更严谨的的免费<span class="jill"></span>arp<span class="jill"></span>包，则是</span><span class="inline-wrap"><b>需要&quot;发送方<span class="jill"></span>ip&quot;和&quot;接收者<span class="jill"></span>ip&quot;是一致的</b></span><span class="inline-wrap">，就是下面这种<span class="jill"></span>arp<span class="jill"></span>请求包，都有<span class="jill"></span>192.168.199.152<span class="jill"></span>这个地址。所以，这一小知识点的话，我个人觉得不用太纠结，通过数据包结构还原整个免费<span class="jill"></span>arp<span class="jill"></span>工作原理才是最重要的。</span></div></div><div id="pYeoVvaLDMBHLhY7b3fGqF" class="wolai-block wolai-text"><div><span class="inline-wrap">从<span class="jill"></span>wireshark<span class="jill"></span>截图可以看到，经过了上面这些免费<span class="jill"></span>ARP<span class="jill"></span>的请求之后，由于一直没有其他设备回应<span class="jill"></span>152<span class="jill"></span>这个地址，所以<span class="jill"></span>macbook<span class="jill"></span>电脑再次询问网关<span class="jill"></span>192.168.199.1<span class="jill"></span>的物理地址，拿到网关的<span class="jill"></span>ARP<span class="jill"></span>回应之后，我的<span class="jill"></span>macbook<span class="jill"></span>便可以正常通信了。</span></div></div><div id="bw1Ez31pFWcKdwn4beiyRN" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-2952396d466a1e9236149a2d13b5980b_b.jpg" style="width: 726.4px"/></figure></div><div id="kQjWk8tGDx1iqVBFqMGeWU" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>⑤【接下来是拓展内容，涉及<span class="jill"></span>dhcp<span class="jill"></span>协议，新手的话可暂时忽略这一小段...】</b></span><span class="inline-wrap"> </span></div></div><div id="7KLocqx5GCztUH7gHHn3Sw" class="wolai-block wolai-text"><div><span class="inline-wrap">这个实验还可以继续深挖下来，此时</span><span class="inline-wrap"><b>让<span class="jill"></span>windows<span class="jill"></span>电脑重新接入这个<span class="jill"></span>wifi<span class="jill"></span>网络</b></span><span class="inline-wrap">，之后同样会出现免费<span class="jill"></span>arp<span class="jill"></span>的交互过程，只不过多了一个<span class="jill"></span>dhcp<span class="jill"></span>协议交互，并且最终<span class="jill"></span>windows<span class="jill"></span>使用了<span class="jill"></span>192.168.199.153<span class="jill"></span>这个地址接入<span class="jill"></span>wifi<span class="jill"></span>网络。先整理下流程再截核心数据包=&gt;</span></div></div><ol class="wolai-block"><li id="dFccsxhgowuFVCAQLa3qxE"><div class="marker"></div><span class="inline-wrap">当<span class="jill"></span>windows<span class="jill"></span>重新接入网络之后，会通过<span class="jill"></span>dhcp<span class="jill"></span>重新获取<span class="jill"></span>192.168.199.152<span class="jill"></span>这个地址（由于<span class="jill"></span>macbook<span class="jill"></span>的<span class="jill"></span>152<span class="jill"></span>这个地址是由我手工静态指定的而不是路由器分配，所有路由器仍然通过<span class="jill"></span>dhcp<span class="jill"></span>地址池分配）；</span></li><li id="h1vubZpoWauNLdMw1VKiEG"><div class="marker"></div><span class="inline-wrap">windows<span class="jill"></span>收到这个地址之后，第一时间便发送免费<span class="jill"></span>arp<span class="jill"></span>包进行地址检测，但是发现这个地址已经被<span class="jill"></span>macbook<span class="jill"></span>占用了！因此，通过<span class="jill"></span>dhcp decline<span class="jill"></span>数据包向无线路由器取消这个地址；</span></li><li id="uRh5cFw2vAjb6jxeBJQcFx"><div class="marker"></div><span class="inline-wrap">windows<span class="jill"></span>重新获取<span class="jill"></span>192.168.199.153<span class="jill"></span>这个地址，通过免费<span class="jill"></span>arp<span class="jill"></span>重新检测，发现没有人回应了，说明这个地址可用，后续用这个地址接入<span class="jill"></span>wifi<span class="jill"></span>网络。</span></li></ol><div id="qwKVFewiu7ZMxzt2KAko4S" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>windows<span class="jill"></span>重新接入网络的<span class="jill"></span>dhcp<span class="jill"></span>交互包=&gt;</b></span></div></div><div id="5wr56KMAdER9WB97XBxQHU" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-41c51ac01a48f0c1dec7e212618d6ff8_b.jpg" style="width: 576px"/></figure></div><div id="csQEuu6A9ZSVcoAiz5xwGF" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>windows<span class="jill"></span>获取地址后通过免费<span class="jill"></span>arp<span class="jill"></span>检测到<span class="jill"></span>macbook=&gt;</b></span></div></div><div id="gSukR4DGkAtynfnsKw6Ssf" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-856a2e5567a0bf0da1e5ae5ffe11fdbf_b.jpg" style="width: 576px"/></figure></div><div id="hPpCGovWbKGr61KUSe4af6" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>windows<span class="jill"></span>通过<span class="jill"></span>dhcp decline<span class="jill"></span>放弃<span class="jill"></span>152，并重新获取<span class="jill"></span>153<span class="jill"></span>这个地址=&gt;</b></span></div></div><div id="gYKefgTmZ9eaT3WXpHibUr" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-7023a63ddc3c622ac3a9ddd93793273f_b.jpg" style="width: 576px"/></figure></div><div id="qGRr9RNccouH49NVycgUpv" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>windows<span class="jill"></span>通过免费<span class="jill"></span>arp<span class="jill"></span>检测，发现<span class="jill"></span>153<span class="jill"></span>地址没其他人用，所以接入了网络=&gt;</b></span></div></div><div id="aPB8GxhZvD985dVVu6xNxA" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-177b0efe8d4f17d1cdfc96891bfb42b7_b.jpg" style="width: 576px"/></figure></div><div id="hCTZZaduaAwn3b35viHBiB" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>总结：</b></span><span class="inline-wrap"> 通过这个真实网络，我们构造了<span class="jill"></span>windows<span class="jill"></span>和<span class="jill"></span>macbook<span class="jill"></span>地址冲突的环境，通过<span class="jill"></span>wireshark<span class="jill"></span>抓取免费<span class="jill"></span>arp<span class="jill"></span>数据包，学习了免费<span class="jill"></span>arp<span class="jill"></span>的地址检测功能以及数据包结构。</span></div></div><div id="icc69ah8UREunZdMz26Zqp" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>①当电脑（手工）修改的地址跟局域网其他主机地址一样的时候，通过免费<span class="jill"></span>arp<span class="jill"></span>协议，电脑会弹框提醒并无法上网；</b></span></div></div><div id="suvmQbhWjVsr3EUb1abLMk" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>②当相同地址的电脑其中一台下线时，通过免费<span class="jill"></span>arp<span class="jill"></span>可以证明此地址可使用（没人争抢/回应），此时便可接入网络；</b></span></div></div><div id="euiuYdKgNY3JN2sHVd7Ti3" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>③当电脑通过<span class="jill"></span>DHCP<span class="jill"></span>获取地址时，会通过免费<span class="jill"></span>arp<span class="jill"></span>检测这个地址是否可用，若已经被使用，则重新通过<span class="jill"></span>dhcp<span class="jill"></span>获取新的地址，再接入互联网。</b></span><span class="inline-wrap"> </span></div></div><div id="wyyVHYpLFNZNpyZ12RYwBx" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>④这里抓取的免费<span class="jill"></span>ARP<span class="jill"></span>包是请求广播包，并且特征是&quot;自己问自己&quot;。</b></span><span class="inline-wrap"> （&quot;自己答自己&quot;的回应广播包，在下面的实验有）</span></div></div><div id="3xCB8CkaxU8MK3mqxBnN63" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>（二）虚拟网络下 免费<span class="jill"></span>ARP<span class="jill"></span>实战</b></span></div></div><div id="4MnKbvhXbB2yaNu3jrTg7P" class="wolai-block wolai-text"><div><span class="inline-wrap">网络拓扑采用<span class="jill"></span>GNS3<span class="jill"></span>搭建，采用<span class="jill"></span>C3640<span class="jill"></span>操作系统镜像=&gt;</span></div></div><div id="2stjroDeyMAMrpM4mE5f9U" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-6d6ed12ed7978ef7345579e16abaeb04_b.jpg" style="width: 896px"/></figure></div><div id="sMrV7xdWnQaRvfmMHjb5fv" class="wolai-block wolai-text"><div><span class="inline-wrap">①为每个路由器配置<span class="jill"></span>IP<span class="jill"></span>地址，所在网段为<span class="jill"></span>192.168.1.0/24=&gt;</span></div></div><div id="kGC9usCFa2b5Ey9pdGHMS4" class="wolai-block wolai-text"><div><span class="inline-wrap">R1(config)#int f0/0</span></div></div><div id="iT9uHqzLwxTHaKnqb2vQCZ" class="wolai-block wolai-text"><div><span class="inline-wrap">R1(config-if)#no sh</span></div></div><div id="61Pnpd1kEbRBpcUMiZ3uuQ" class="wolai-block wolai-text"><div><span class="inline-wrap">R1(config-if)#</span><span class="inline-wrap"><b>ip add 192.168.1.1 255.255.255.0</b></span></div></div><div id="9Hjfguj5GkeZpR33ZBeEbM" class="wolai-block wolai-text"><div><span class="inline-wrap">R2(config)#int f0/0</span></div></div><div id="b3mzD37uwR3pjFXwaFdYFm" class="wolai-block wolai-text"><div><span class="inline-wrap">R2(config-if)#no sh</span></div></div><div id="9W9UYdci6DuoBJdyouWrdp" class="wolai-block wolai-text"><div><span class="inline-wrap">R2(config-if)#</span><span class="inline-wrap"><b>ip add 192.168.1.2 255.255.255.0</b></span></div></div><div id="qz2rS3q667hVAG31PqwEh2" class="wolai-block wolai-text"><div><span class="inline-wrap">R3(config)#int f0/0</span></div></div><div id="c7196ukdPXsP7nnVNRbiFG" class="wolai-block wolai-text"><div><span class="inline-wrap">R3(config-if)#no sh</span></div></div><div id="kvCmMMVFguPzyVdHRfvW3G" class="wolai-block wolai-text"><div><span class="inline-wrap">R3(config-if)#</span><span class="inline-wrap"><b>ip add 192.168.1.3 255.255.255.0</b></span></div></div><div id="3AN6S8sN1oqU5cCtYezaVg" class="wolai-block wolai-text"><div><span class="inline-wrap">②在路由器相连链路上抓包，路由器相互<span class="jill"></span>PING<span class="jill"></span>通，并查看<span class="jill"></span>ARP<span class="jill"></span>表=&gt;</span></div></div><div id="kjHcXaFq6EUNWBT9yE5UzY" class="wolai-block wolai-text"><div><span class="inline-wrap">（这里用<span class="jill"></span>R1<span class="jill"></span>举例，其他类似）</span></div></div><div id="8rqzWgeqK4TLPNkz4tTqea" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>R1#ping 192.168.1.2</b></span></div></div><div id="i4Yh61DBJr1CXmtkY5ZEPi" class="wolai-block wolai-text"><div><span class="inline-wrap">Type escape sequence to abort.</span></div></div><div id="doLaY389VaaHbkCJDx7ns2" class="wolai-block wolai-text"><div><span class="inline-wrap">Sending 5, 100-byte ICMP Echos to 192.168.1.2, timeout is 2 seconds:</span></div></div><div id="2qK9RH4UT1LxPhLj9Frwap" class="wolai-block wolai-text"><div><span class="inline-wrap">!!!!!</span></div></div><div id="4jxsrLCNepTQExgXR6WMQA" class="wolai-block wolai-text"><div><span class="inline-wrap">Success rate is 100 percent (5/5), round-trip min/avg/max = 64/64/64 ms</span></div></div><div id="fjTxmbMH2EGhusBKfZ8h4G" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>R1#ping 192.168.1.3</b></span></div></div><div id="h5cFeCFvcEPc7heQCyDnVY" class="wolai-block wolai-text"><div><span class="inline-wrap">Type escape sequence to abort.</span></div></div><div id="si85cABQFyK1cPYHMUJLdb" class="wolai-block wolai-text"><div><span class="inline-wrap">Sending 5, 100-byte ICMP Echos to 192.168.1.3, timeout is 2 seconds:</span></div></div><div id="t4TU5ZBvmScyUQUHygaPjR" class="wolai-block wolai-text"><div><span class="inline-wrap">!!!!!</span></div></div><div id="p4gqRAjG658wXWYErphsyY" class="wolai-block wolai-text"><div><span class="inline-wrap">Success rate is 100 percent (5/5), round-trip min/avg/max = 64/64/68 ms</span></div></div><div id="s34KGvX96FEnATWXj1rDNx" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>R1#show arp</b></span></div></div><div id="qkYyAboQYRLEe4ifhLb3fS" class="wolai-block wolai-text"><div><span class="inline-wrap">Protocol Address Age (min) Hardware Addr Type Interface</span></div></div><div id="k8WRjwpRR79wbzJYTWUa5y" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet 192.168.1.1 - cc00.394f.0000 ARPA FastEthernet0/0</span></div></div><div id="aoNLBVK2WrBNz4tVX1iJhx" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet 192.168.1.3 0 cc02.394f.0000 ARPA FastEthernet0/0</span></div></div><div id="45H62LeUscHPJGFyYjwCHS" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet 192.168.1.2 0 cc01.394f.0000 ARPA FastEthernet0/0</span></div></div><div id="7voC8Qxjkh2zXJLHuK7fVY" class="wolai-block wolai-text"><div><span class="inline-wrap">③让<span class="jill"></span>R3<span class="jill"></span>和<span class="jill"></span>R2<span class="jill"></span>的地址冲突，例如将<span class="jill"></span>R3<span class="jill"></span>的地址从<span class="jill"></span>192.168.1.3<span class="jill"></span>配置为<span class="jill"></span>192.168.1.2，在<span class="jill"></span>R2<span class="jill"></span>和<span class="jill"></span>R3<span class="jill"></span>上面开启<span class="jill"></span>arp<span class="jill"></span>调试&quot;</span><span class="inline-wrap"><b>debug arp</b></span><span class="inline-wrap">&quot;，在<span class="jill"></span>R1<span class="jill"></span>上面查看<span class="jill"></span>ARP<span class="jill"></span>表，通过<span class="jill"></span>wireshark<span class="jill"></span>观察底层免费<span class="jill"></span>ARP<span class="jill"></span>包交互过程=&gt;</span></div></div><div id="5hSgYvoLbyEYiUkE5mmsyx" class="wolai-block wolai-text"><div><span class="inline-wrap">R3(config)#int f0/0</span></div></div><div id="tXEuT7pxy35cj5Ff8jJWzj" class="wolai-block wolai-text"><div><span class="inline-wrap">R3(config-if)#</span><span class="inline-wrap"><b>ip add 192.168.1.2 255.255.255.0</b></span></div></div><div id="k1MJYn23Z7nYF5qiCaMAtn" class="wolai-block wolai-text"><div><span class="inline-wrap">一旦<span class="jill"></span>R3<span class="jill"></span>设置了上面的地址，跟<span class="jill"></span>R2<span class="jill"></span>冲突之后，此时<span class="jill"></span>R2<span class="jill"></span>和<span class="jill"></span>R3<span class="jill"></span>的命令行界面开始</span><span class="inline-wrap"><b>不停断&quot;刷屏&quot;</b></span><span class="inline-wrap">=&gt;</span></div></div><div id="xxUTkHneyxmWPNNTDJc753" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-92f846cbeda69b3925b8bf9db0407f73_b.jpg" style="width: 576px"/></figure></div><div id="kEZSrJDz5oPRhHaPxuMZM8" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>核心日志信息：</b></span><span class="inline-wrap"> </span></div></div><div id="pbjebgDQatTwEexwUM4Arw" class="wolai-block wolai-text"><div><span class="inline-wrap">R2#</span></div></div><div id="agANHfBuovuHrwCyHBCT5S" class="wolai-block wolai-text"><div><span class="inline-wrap">*Mar 1 00:13:25.519: %IP-4-DUPADDR: Duplicate address 192.168.1.2 on FastEthernet0/0, sourced by cc02.394f.0000</span></div></div><div id="qLLrh9ZGeTZG4mCP2cSWr6" class="wolai-block wolai-text"><div><span class="inline-wrap">R2#</span></div></div><div id="cv2WvHJXW6VGdsTonkBgz7" class="wolai-block wolai-text"><div><span class="inline-wrap">*Mar 1 00:13:56.259: %IP-4-DUPADDR: Duplicate address 192.168.1.2 on FastEthernet0/0, sourced by cc02.394f.0000</span></div></div><div id="hDneSD4c2h9yuStDrQwPfV" class="wolai-block wolai-text"><div><span class="inline-wrap">R2#</span></div></div><div id="mwmkYaxCtPBgmnX7e12N7c" class="wolai-block wolai-text"><div><span class="inline-wrap">*Mar 1 00:14:27.167: %IP-4-DUPADDR: Duplicate address 192.168.1.2 on FastEthernet0/0, sourced by cc02.394f.0000</span></div></div><div id="vdxuVy4ghNnmuFqh6kvVBh" class="wolai-block wolai-text"><div><span class="inline-wrap">虽然网络设备没法像<span class="jill"></span>Windows<span class="jill"></span>或者<span class="jill"></span>Macos<span class="jill"></span>弹框告警，但是通过日志提示同样可以达到同样的目的，让网络运维人员作出修改。</span></div></div><div id="snURS4wCdgqWFR7ACVkGu3" class="wolai-block wolai-text"><div><span class="inline-wrap">Cisco IOS<span class="jill"></span>通过免费<span class="jill"></span>ARP<span class="jill"></span>检测到地址冲突之后，解决的方法</span><span class="inline-wrap"><b>相对&quot;暴力&quot;</b></span><span class="inline-wrap">，例如，R2<span class="jill"></span>和<span class="jill"></span>R3<span class="jill"></span>直接会持续发送</span><span class="inline-wrap"><b>免费<span class="jill"></span>ARP（reply<span class="jill"></span>广播包）</b></span><span class="inline-wrap">，直到地址冲突问题被解决掉。可以通过<span class="jill"></span>wireshark<span class="jill"></span>数据包观察=&gt;</span></div></div><div id="v85DHKJWcj4CZjyrzEf9hm" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-0b30c30a8efcb09fcf26351f822dff12_b.jpg" style="width: 576px"/></figure></div><div id="vJLv3c5us2DcA8VZP8t7L7" class="wolai-block wolai-text"><div><span class="inline-wrap">此时再观察<span class="jill"></span>R1<span class="jill"></span>上面的<span class="jill"></span>ARP<span class="jill"></span>表，关于<span class="jill"></span>192.168.1.2<span class="jill"></span>这个地址的映射信息：</span></div></div><div id="rKrs2NyMEUUp9PbXcP9VRR" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>R1#show arp</b></span></div></div><div id="8T8HWEaVqNBBzgpDP6mfpg" class="wolai-block wolai-text"><div><span class="inline-wrap">Protocol Address Age (min) Hardware Addr Type Interface</span></div></div><div id="q9eXrtvXLtyadJstLR5e4V" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet 192.168.1.1 - cc00.394f.0000 ARPA FastEthernet0/0</span></div></div><div id="jfjpJeFYmNFNDu2XkXKpPz" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet 192.168.1.3 6 cc02.394f.0000 ARPA FastEthernet0/0</span></div></div><div id="nqotVeJnjwyoUadLaYNTnZ" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Internet 192.168.1.2 0 cc02.394f.0000 ARPA FastEthernet0/0</b></span></div></div><div id="rvimmCPMhrMraiVaS5wQxN" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>R1#show arp</b></span></div></div><div id="npaWVNkfUXWpJFAUbkUbRH" class="wolai-block wolai-text"><div><span class="inline-wrap">Protocol Address Age (min) Hardware Addr Type Interface</span></div></div><div id="ghtioYiq6XoSG81ZvmdSU1" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet 192.168.1.1 - cc00.394f.0000 ARPA FastEthernet0/0</span></div></div><div id="oP8XhGzqBQxoTAUy1RCpuo" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet 192.168.1.3 6 cc02.394f.0000 ARPA FastEthernet0/0</span></div></div><div id="2NZmmjod8i2zLDmKAWgb96" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Internet 192.168.1.2 0 cc01.394f.0000 ARPA FastEthernet0/0</b></span></div></div><div id="pEepfgcAC2q6VW4GaVp8uC" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>R1#show arp</b></span></div></div><div id="mwG4d6pwVF2saXG1eDKKXR" class="wolai-block wolai-text"><div><span class="inline-wrap">Protocol Address Age (min) Hardware Addr Type Interface</span></div></div><div id="fodVgFeU89khFf6TzcYEcJ" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet 192.168.1.1 - cc00.394f.0000 ARPA FastEthernet0/0</span></div></div><div id="rn8W2DB7VoLoNbcwMsntr5" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet 192.168.1.3 6 cc02.394f.0000 ARPA FastEthernet0/0</span></div></div><div id="fkjtHmTTPoZRKPaA67bbX2" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Internet 192.168.1.2 0 cc02.394f.0000 ARPA FastEthernet0/0</b></span></div></div><div id="wkLMr6Y6xiyXAUooRM3ckt" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>R1#show arp</b></span></div></div><div id="7kJA4nXexq2PK6BqhwdDZC" class="wolai-block wolai-text"><div><span class="inline-wrap">Protocol Address Age (min) Hardware Addr Type Interface</span></div></div><div id="j15h4xj9n46FzTXAmLHRTw" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet 192.168.1.1 - cc00.394f.0000 ARPA FastEthernet0/0</span></div></div><div id="mLVhoFwQF59YhgYw1sBdxD" class="wolai-block wolai-text"><div><span class="inline-wrap">Internet 192.168.1.3 6 cc02.394f.0000 ARPA FastEthernet0/0</span></div></div><div id="av7cnyJLKwhDZEpmbRrSg3" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>Internet 192.168.1.2 0 cc01.394f.0000 ARPA FastEthernet0/0</b></span></div></div><div id="dfurhSdhB2zKTyyhzBuCLz" class="wolai-block wolai-text"><div><span class="inline-wrap">……</span></div></div><div id="fnB1bFESjJQqh92xevC524" class="wolai-block wolai-text"><div><span class="inline-wrap">可以看到，由于</span><span class="inline-wrap"><b>免费<span class="jill"></span>ARP<span class="jill"></span>是一种广播的形式，所以<span class="jill"></span>R1<span class="jill"></span>同处一个局域网可以收到，并且<span class="jill"></span>ARP<span class="jill"></span>信息被不断修改，一会将<span class="jill"></span>192.168.1.2<span class="jill"></span>指向<span class="jill"></span>R2<span class="jill"></span>的<span class="jill"></span>MAC<span class="jill"></span>地址，一会指向<span class="jill"></span>R3<span class="jill"></span>的<span class="jill"></span>MAC<span class="jill"></span>地址</b></span><span class="inline-wrap">。</span></div></div><div id="siC78U7EVAmAoMvBPJ92iB" class="wolai-block wolai-text"><div><span class="inline-wrap">这个过程会一种持续下去，直到地址做了修改，这里我们将<span class="jill"></span>R3<span class="jill"></span>的<span class="jill"></span>IP<span class="jill"></span>地址重新修改为<span class="jill"></span>192.168.1.3，之后网络便恢复了平静。</span></div></div><div id="ghAxobnzWomeY3xtKekV1r" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>总结：</b></span><span class="inline-wrap"> 通过这个虚拟网络，我们构造了路由器地址冲突的环境，同样验证了免费<span class="jill"></span>ARP<span class="jill"></span>能够检测<span class="jill"></span>IP<span class="jill"></span>地址冲突的功能，当然，这里跟<span class="jill"></span>Windows<span class="jill"></span>和<span class="jill"></span>Macos<span class="jill"></span>的处理方式有一些差别，例如<span class="jill"></span>Cisco<span class="jill"></span>路由器检测到免费<span class="jill"></span>ARP<span class="jill"></span>之后，会保持非常</span><span class="inline-wrap"><b>高频率的&quot;互怼&quot;过程</b></span><span class="inline-wrap">，然后不断报出错日志，督促管理员感觉修改地址。除此之外，数据包结构也有差异，</span><span class="inline-wrap"><b>Windows<span class="jill"></span>和<span class="jill"></span>Macos<span class="jill"></span>是&quot;自己问自己&quot;的<span class="jill"></span>arp request<span class="jill"></span>包，而<span class="jill"></span>cisco ios<span class="jill"></span>是&quot;自己答自己&quot;的<span class="jill"></span>arp reply<span class="jill"></span>包</b></span><span class="inline-wrap">。</span></div></div><h2 id="4vMpoQFQgnwrCRU2YCZ5PX" class="wolai-block"><span class="inline-wrap"><b>四、总结：地址冲突了怎么办？</b></span></h2><div id="hWVxFDuGutin9zgabRLLTV" class="wolai-block wolai-text"><div><span class="inline-wrap">①对于普通用户而言，当看到电脑弹框告警说明地址有冲突时，在不懂技术的情况下，可以</span><span class="inline-wrap"><b>尝试重启家里的路由器</b></span><span class="inline-wrap">，这样可以重新为局域网的电脑分配地址；</span></div></div><div id="df3SmrjhabsRuFQTLMUpJH" class="wolai-block wolai-text"><div><span class="inline-wrap">②路由器不是自己的，接入的是租房网络、校园网络等第三方网络，当看到电脑弹框告警说明地址有冲突时并且无法管理路由器的时候，</span><span class="inline-wrap"><b>可以尝试手工修改本机电脑的<span class="jill"></span>IP<span class="jill"></span>地址</b></span><span class="inline-wrap">，无论是<span class="jill"></span>Windows<span class="jill"></span>还是<span class="jill"></span>Macos，直接进入网卡设置修改即可，怎么做手工修改呢？例如电脑地址是<span class="jill"></span>192.168.1.1，提示冲突的话，那么</span><span class="inline-wrap"><b>可以在原有数字的基础上递增<span class="jill"></span>1<span class="jill"></span>或者<span class="jill"></span>10，直到显示不冲突</b></span><span class="inline-wrap">，例如修改为<span class="jill"></span>192.168.1.2、192.168.1.3<span class="jill"></span>或者<span class="jill"></span>192.168.1.11、192.168.1.21，以此类推..... （这种方法未必能保证解决，但是在管理员介入之前，至少算是一种解决方案）；</span></div></div><div id="VrFZi16eCa3bmkd1SnpLP" class="wolai-block wolai-text"><div><span class="inline-wrap">③对于专业的网络和安全运维人员而言，当看到网络地址冲突，则需要</span><span class="inline-wrap"><b>考虑自己的<span class="jill"></span>DHCP<span class="jill"></span>部署、IP<span class="jill"></span>地址规划有没有问题</b></span><span class="inline-wrap">，或者找出网络中是否有&quot;捣蛋鬼&quot;自己私设<span class="jill"></span>IP<span class="jill"></span>之类的；</span></div></div><div id="dyFW9u34F4vRH7wWDghoRa" class="wolai-block wolai-text"><div><span class="inline-wrap">④通过本章节的学习，我们掌握了免费<span class="jill"></span>ARP<span class="jill"></span>不同网络环境下的实现，例如&quot;自己问自己&quot;和&quot;自己答自己&quot;两种广播包方式，也了解了电脑和网络设备的不同机制。</span></div></div><div id="ghHTay95Nk3ZBEmLaqZ7LU" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>【相关推荐】</b></span><span class="inline-wrap"> </span></div></div><div id="7AuivgyG8CFQjLRGuMTuig" class="wolai-block wolai-text"><div><span class="inline-wrap">微信公众号：拼客院长陈鑫杰（搜索&quot;</span><span class="inline-wrap"><b>pingsec</b></span><span class="inline-wrap">&quot;，即刻关注）</span></div></div><div id="GAoqjpX7JnNHU1yiAem35" class="wolai-block wolai-text"><div><span class="inline-wrap">新浪微博：</span><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.weibo.com/jaykingchen"><span>@<span class="jill"></span>拼客学院陈鑫杰</span></a></span></div></div><div id="iNvpYrevrcVZyU5Exe8Vqf" class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://zhuanlan.zhihu.com/p/28865553"><span>图解<span class="jill"></span>ARP<span class="jill"></span>协议（三）ARP<span class="jill"></span>防御篇-如何揪出&quot;内鬼&quot;并&quot;优雅的还手&quot;？</span></a></span></div></div><div id="2zCSYyztbLoD6E4J2XiYrH" class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.pinginglab.net/course/4"><span>《GNS3<span class="jill"></span>从入门到精通》(精品免费视频教程）</span></a></span></div></div><div id="uBnHir6HSM4YNxASUAidND" class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.pinginglab.net/course/164"><span>《TCP/IP<span class="jill"></span>协议栈视频教程》</span></a></span><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.pinginglab.net/course/4"><span>(精品免费视频教程）</span></a></span></div></div><div id="iRZP42DCsT7UpQSW1pHAd4" class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.pinginglab.net/course/3"><span>《Wireshark<span class="jill"></span>协议分析从入门到精通》</span></a></span><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.pinginglab.net/course/4"><span>(精品免费视频教程）</span></a></span></div></div></div><div id="r1GuDUrKMU4MqXws7g7oz" class="wolai-sub-page wolai-block"><div class="page-icon"></div><a href="ipv4%E5%8D%8F%E8%AE%AE/arp/%E5%9B%BE%E8%A7%A3arp%E5%8D%8F%E8%AE%AE%EF%BC%88%E5%85%AD%EF%BC%89rarp%E4%B8%8Eiarp%EF%BC%9A/%E5%9B%BE%E8%A7%A3arp%E5%8D%8F%E8%AE%AE%EF%BC%88%E5%85%AD%EF%BC%89rarp%E4%B8%8Eiarp%EF%BC%9A.html"><span>图解ARP协议（六）RARP与IARP：被遗忘的兄弟协议 - 知乎</span></a><h2 id="oUX5YfNDXELWj1CY5m8671" class="wolai-block"><span class="inline-wrap"><b>一、概述</b></span></h2><div id="6bFLYqNnucEUsCvV5RAnMT" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-901388a916a81b98961884d89de5a594_b.jpg" style="width: 1120px"/></figure></div><div id="xk5Tvz2BPwLDJcR7md4uSi" class="wolai-block wolai-text"><div><span class="inline-wrap">在我第一次接触<span class="jill"></span>ARP<span class="jill"></span>协议的时候，发现这协议挺简单的，&quot;</span><span class="inline-wrap"><b>一去一回通过<span class="jill"></span>IP<span class="jill"></span>拿到<span class="jill"></span>MAC<span class="jill"></span>地址</b></span><span class="inline-wrap">&quot;，整个过程在<span class="jill"></span>1s<span class="jill"></span>内就搞定了。后面学到了</span><span class="inline-wrap"><b>代理<span class="jill"></span>ARP</b></span><span class="inline-wrap">，发现也不过是变了个法子，做了次**&quot;欺骗&quot;</span><span class="inline-wrap"><b>，本质还是一样。接下来又学到了</b></span><span class="inline-wrap">免费<span class="jill"></span>ARP**，顿时觉得网络协议设计者太牛了，一个协议居然能折腾出这么多玩法，连**&quot;地址检测&quot;</span><span class="inline-wrap"><b>都能实现。等学到了</b></span><span class="inline-wrap">ARP<span class="jill"></span>嗅探和欺骗**，又发现其实黑帽子更爱折腾，谁能想到这么简单的协议，居然能制造工具出来做</span><span class="inline-wrap"><b>内网探测</b></span><span class="inline-wrap">和</span><span class="inline-wrap"><b>欺骗攻击</b></span><span class="inline-wrap">，引发这么大的危害。</span></div></div><div id="fiG5H1qWfqG2K3TLCRoXfy" class="wolai-block wolai-text"><div><span class="inline-wrap">当我以为<span class="jill"></span>ARP<span class="jill"></span>这一知识点在我的技术旅途中应该就此翻篇了的时候，又冒出了</span><span class="inline-wrap"><b>RARP<span class="jill"></span>和<span class="jill"></span>IARP</b></span><span class="inline-wrap">这两，对比其他<span class="jill"></span>ARP<span class="jill"></span>协议的研究，当时学这两个协议是</span><span class="inline-wrap"><b>心不甘情不愿</b></span><span class="inline-wrap">的：</span></div></div><div id="hpjLFtMvcjEaaZYwTDTrZp" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>第一</b></span><span class="inline-wrap">，无论学习还是工作，极少碰到，真正**&quot;翻篇&quot;**了的协议；</span></div></div><div id="mzEtyVqY6HNbZQg74VwRG3" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>第二</b></span><span class="inline-wrap">，名字记不住，&quot;翻转&quot;&quot;反转&quot;&quot;逆向&quot;&quot;反向&quot;，不同技术文档的中文翻译有时候完全相反，没法记。毕竟汉语这么博大精深，就记住英文就好了，后面发现更加糟糕，因为</span><span class="inline-wrap"><b>reverse<span class="jill"></span>和<span class="jill"></span>inverse<span class="jill"></span>这两个单词仅仅<span class="jill"></span>2<span class="jill"></span>个字母之差</b></span><span class="inline-wrap">，老外太欺负人了，这根本没法记。</span></div></div><div id="rdD1iD3wfzg8oE6HPvCiHx" class="wolai-block wolai-text"><div><span class="inline-wrap">我在想，肯定也有很多朋友学到这个时候遇到了上面同样的问题和纠结，有些坚持研究通透有些中途离开。然后我又思考了一番：**ARP<span class="jill"></span>协议通过几个字段的细微调整，便能够适用于这么多不同场景，例如<span class="jill"></span>ARP、PARP、GARP、RARP、IARP，这是不是证明了它在<span class="jill"></span>TCP/IP<span class="jill"></span>协议栈里面独特的位置，有哪个协议能做到这一点，有这么多花样？**所以，我的建议是：既然到了这一步了，就继续搞清楚吧，否管它是否用的上。</span></div></div><div id="ec7Qh3bXmJhwtxNvscBr1H" class="wolai-block wolai-text"><div><span class="inline-wrap">那么，</span><span class="inline-wrap"><b>什么是<span class="jill"></span>RARP<span class="jill"></span>和<span class="jill"></span>IARP？中文叫法是什么？它们各自的应用场景在哪里？数据包又是怎样的</b></span><span class="inline-wrap">？</span></div></div><h2 id="cP9t63Re29mhAwuSUvT8pF" class="wolai-block"><span class="inline-wrap"><b>二、RARP<span class="jill"></span>原理与实践</b></span></h2><div id="uAYnjBUbnQfEa28XM77aTR" class="wolai-block wolai-text"><div><span class="inline-wrap">RARP（Reverse ARP）即反向<span class="jill"></span>ARP<span class="jill"></span>或者翻转<span class="jill"></span>ARP，顾名思义，它跟常规的<span class="jill"></span>ARP<span class="jill"></span>功能恰恰是相反的，</span><span class="inline-wrap"><b>ARP<span class="jill"></span>是实现<span class="jill"></span>IP<span class="jill"></span>到<span class="jill"></span>MAC<span class="jill"></span>地址的映射，而<span class="jill"></span>RARP<span class="jill"></span>是实现<span class="jill"></span>MAC<span class="jill"></span>到<span class="jill"></span>IP<span class="jill"></span>地址的映射</b></span><span class="inline-wrap">。</span></div></div><div id="32yoFZ1d2a56uyxohy3jsi" class="wolai-block wolai-text"><div><span class="inline-wrap">什么样的设备或者场景需要用到<span class="jill"></span>RARP<span class="jill"></span>呢？其实<span class="jill"></span>RARP<span class="jill"></span>原先在设计的时候，是适用于大部分终端设备的，不仅仅是无盘工作站，它的功能就是</span><span class="inline-wrap"><b>根据<span class="jill"></span>MAC<span class="jill"></span>获取<span class="jill"></span>IP<span class="jill"></span>地址，功能跟<span class="jill"></span>DHCP<span class="jill"></span>是一样的</b></span><span class="inline-wrap">。</span></div></div><div id="hfwMcMixXzknzwxCPHJYMx" class="wolai-block wolai-text"><div><span class="inline-wrap">例如，一个电脑刚接入网络，没有<span class="jill"></span>IP<span class="jill"></span>地址就无法上网，此时它便会通过本地<span class="jill"></span>MAC<span class="jill"></span>地址，对外发送<span class="jill"></span>RARP Request<span class="jill"></span>广播请求，看看局域网里面是否有<span class="jill"></span>RARP Server，若<span class="jill"></span>Server<span class="jill"></span>上面有关于此<span class="jill"></span>MAC<span class="jill"></span>地址的映射<span class="jill"></span>IP，则会向此电脑返回<span class="jill"></span>RARP Reply<span class="jill"></span>回应，电脑便获取了<span class="jill"></span>IP<span class="jill"></span>地址=&gt;</span></div></div><div id="mFKN4gkaqbCeYGi5M67R3s" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-e077ab99c0163a4ff13238dde1d59837_b.jpg" style="width: 576px"/></figure></div><div id="3j5oXN52z9BTkf4qsyseUc" class="wolai-block wolai-text"><div><span class="inline-wrap">RARP<span class="jill"></span>通过非常精简的交互实现了<span class="jill"></span>IP<span class="jill"></span>地址的获取，但同时也暴露了一些问题：</span></div></div><div id="gWmg3b4bVTs2fR3nFeVhHG" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>①RARP Server<span class="jill"></span>必须提前将<span class="jill"></span>MAC<span class="jill"></span>和<span class="jill"></span>IP<span class="jill"></span>的映射静态绑定在本地；若没有提前绑定，则电脑用自己<span class="jill"></span>MAC<span class="jill"></span>询问时，Server<span class="jill"></span>也不会回应；</b></span></div></div><div id="gYgba9XWScVtDMVfv1BS8K" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>②RARP Server<span class="jill"></span>只能给电脑分配<span class="jill"></span>IP<span class="jill"></span>地址，不包括其他信息，包括网关、DNS<span class="jill"></span>等信息；</b></span></div></div><div id="gxdz1svTfBkeBCeVS1M298" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>③RARP<span class="jill"></span>基于二层封装，只能运行在同一网段；每个网段分配地址，都需要一个<span class="jill"></span>RARP Server。</b></span><span class="inline-wrap"> </span></div></div><div id="v6PUkbxMeRySsjF1i3Tp3r" class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>RARP<span class="jill"></span>的基础上，后面又有了</span><span class="inline-wrap"><b>Bootp<span class="jill"></span>协议</b></span><span class="inline-wrap">，直译过来便是**&quot;启动协议&quot;**，功能同<span class="jill"></span>RARP，也是用于电脑接入网络时，用来获取<span class="jill"></span>IP<span class="jill"></span>地址的。但是毕竟做了增强，Bootp<span class="jill"></span>协议能让电脑启动时，</span><span class="inline-wrap"><b>不仅仅获取<span class="jill"></span>IP<span class="jill"></span>地址，而且能获取到网关地址</b></span><span class="inline-wrap">，从而让电脑实现跨网段通信。</span></div></div><div id="hibbYx65tfe1sw8CGsjcYT" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-f00934ef8ef7e7dda199e708af888ee8_b.jpg" style="width: 576px"/></figure></div><div id="4k5hKAeAjBsFiHDxDft9iX" class="wolai-block wolai-text"><div><span class="inline-wrap">Bootp<span class="jill"></span>协议虽然让电脑能够获取到更多的信息，但是仍然没有解决最大的问题：</span></div></div><div id="mAEaTc2dzDhVdQ6hR9sPQM" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>服务器仍然需要提前手工绑定<span class="jill"></span>MAC<span class="jill"></span>和<span class="jill"></span>IP<span class="jill"></span>地址，而对于现在的移动网络或者公共网络而言，这根本无法实现。</b></span><span class="inline-wrap"> </span></div></div><div id="8qZVAzNjaeCQXnt8cjFHjF" class="wolai-block wolai-text"><div><span class="inline-wrap">因为用户什么时候接入，接入的<span class="jill"></span>MAC<span class="jill"></span>是多少，管理员没法提前知道。这就有了后面的<span class="jill"></span>DHCP，DHCP<span class="jill"></span>通过动态分配的方式解决了这个诟病，并且通过<span class="jill"></span>DHCP<span class="jill"></span>中继技术实现了跨网段地址分配，实现了全网<span class="jill"></span>IP<span class="jill"></span>地址的统一管理。</span></div></div><div id="9FbvKZrEFqoxGMfrjVRWdr" class="wolai-block wolai-text"><div><span class="inline-wrap">小结：</span><span class="inline-wrap"><b>RARP<span class="jill"></span>是一种逝去的地址分配技术，是<span class="jill"></span>Bootp<span class="jill"></span>和<span class="jill"></span>DHCP<span class="jill"></span>的鼻祖，目前我们的电脑基本不会用到这个协议，只有部分无盘工作站等情况需要用到</b></span><span class="inline-wrap">。</span></div></div><div id="8NjRju9EFXC7oKCBDBFaqs" class="wolai-block wolai-text"><div><span class="inline-wrap">为了让大家更深入理解<span class="jill"></span>RARP，这里我们从数据包结构来解构它的功能。RARP<span class="jill"></span>的数据包比较难抓取，不像常规的<span class="jill"></span>ARP<span class="jill"></span>和<span class="jill"></span>DHCP<span class="jill"></span>协议，这里给大家提供一个思路：对于比较难找的协议数据包，除了搭建特殊的实验环境抓取之外，也可以借助一些**[数据包生成工具]</span><span class="inline-wrap"><b>来实现，例如<span class="jill"></span>nmap<span class="jill"></span>扫描器里面集成的</b></span><span class="inline-wrap">nping<span class="jill"></span>工具，可以生成非常多的协议包，包括<span class="jill"></span>arp、icmp、udp、tcp<span class="jill"></span>等等**。</span></div></div><div id="jZWKmfFuBxbNT1c6DZm9TZ" class="wolai-block wolai-text"><div><span class="inline-wrap">nmap<span class="jill"></span>的安装以及<span class="jill"></span>nping<span class="jill"></span>的使用，可以到</span><span class="inline-wrap"><a href="https://link.zhihu.com/?target=https%3A//nmap.org/nping"><span>https://nmap.org/nping</span></a></span><span class="inline-wrap">下查询。这里给大家演示如何用<span class="jill"></span>nping<span class="jill"></span>生成<span class="jill"></span>rarp<span class="jill"></span>数据包，下图是我们要**&quot;人为&quot;构造**出来的交互场景=&gt;</span></div></div><div id="4RvMQVdBDqUuow1JE3oaAr" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-432ed6086876e946bdd1dd004843794a_b.jpg" style="width: 576px"/></figure></div><div id="bqEBEiCC4zsfmC2ZVq1XXo" class="wolai-block wolai-text"><div><span class="inline-wrap">我的<span class="jill"></span>Macbook<span class="jill"></span>已经安装了<span class="jill"></span>nmap，自带了<span class="jill"></span>nping<span class="jill"></span>工具，跟<span class="jill"></span>ARP/RARP<span class="jill"></span>相关的帮助命令如下：</span></div></div><code-block id="e3agG9PKjcBA1UkfdEUUxW" class="wolai-block"><div class="wolai-pre"><div data-lang="Text" class="marker"></div><pre>jayking:~ jaykingchen$ nping
Nping 0.7.60 ( https://nmap.org/nping )
Usage: nping [Probe mode] [Options] {target specification}

TARGET SPECIFICATION:
 Targets may be specified as hostnames, IP addresses, networks, etc.
 Ex: scanme.nmap.org, microsoft.com/24, 192.168.0.1; 10.0.*.1-24

ARP/RARP PROBE MODE:
 --arp-type &lt;type>                : Type: ARP, ARP-reply, RARP, RARP-reply.
 --arp-sender-mac &lt;mac>           : Set sender MAC address.
 --arp-sender-ip  &lt;addr>          : Set sender IP address.
 --arp-target-mac &lt;mac>           : Set target MAC address.
 --arp-target-ip  &lt;addr>          : Set target IP address.</pre></div></code-block><div id="5dojckP2HPaYk91Vae2cUg" class="wolai-block wolai-text"><div><span class="inline-wrap">为了能够抓取到<span class="jill"></span>rarp<span class="jill"></span>的请求和回复包，首先打开<span class="jill"></span>wireshark<span class="jill"></span>抓取电脑网卡流量并设置<span class="jill"></span>arp<span class="jill"></span>过滤，然后采用两条命令：</span><span class="inline-wrap"><b>第一条命令模拟我的电脑发起的<span class="jill"></span>RARP<span class="jill"></span>请求包，第二条命令模拟局域网网关设备（极路由）返回的<span class="jill"></span>RARP<span class="jill"></span>回复包</b></span><span class="inline-wrap">。  </span></div></div><code-block id="9RLmuFNu9QWLgN5uB2VYqj" class="wolai-block"><div class="wolai-pre"><div data-lang="Text" class="marker"></div><pre>jayking:~ jaykingchen$ sudo nping --arp-type RARP  --arp-sender-mac ac:bc:32:8b:56:df --arp-sender-ip 0.0.0.0 --arp-target-mac ac:bc:32:8b:56:df --arp-target-ip 0.0.0.0 192.168.199.255
Starting Nping 0.7.60 ( https://nmap.org/nping ) at 2017-09-04 23:57 CST
SENT (0.0077s) RARP who is AC:BC:32:8B:56:DF? Tell AC:BC:32:8B:56:DF
SENT (1.0079s) RARP who is AC:BC:32:8B:56:DF? Tell AC:BC:32:8B:56:DF
SENT (2.0084s) RARP who is AC:BC:32:8B:56:DF? Tell AC:BC:32:8B:56:DF
SENT (3.0111s) RARP who is AC:BC:32:8B:56:DF? Tell AC:BC:32:8B:56:DF
SENT (4.0159s) RARP who is AC:BC:32:8B:56:DF? Tell AC:BC:32:8B:56:DF
Max rtt: N/A | Min rtt: N/A | Avg rtt: N/A
Raw packets sent: 5 (210B) | Rcvd: 0 (0B) | Lost: 5 (100.00%)
Nping done: 1 IP address pinged in 5.02 seconds</pre></div></code-block><code-block id="xbz9mc9o4iWEiTPLDFkxXx" class="wolai-block"><div class="wolai-pre"><div data-lang="Text" class="marker"></div><pre>jayking:~ jaykingchen$ sudo nping --arp-type RARP-reply  --arp-sender-mac d4:ee:07:54:c1:9e --arp-sender-ip 192.168.199.1 --arp-target-mac ac:bc:32:8b:56:df --arp-target-ip 192.168.199.153 192.168.199.153
Starting Nping 0.7.60 ( https://nmap.org/nping ) at 2017-09-05 00:03 CST
SENT (0.8094s) RARP reply: AC:BC:32:8B:56:DF is at 192.168.199.153
SENT (1.8107s) RARP reply: AC:BC:32:8B:56:DF is at 192.168.199.153
SENT (2.8114s) RARP reply: AC:BC:32:8B:56:DF is at 192.168.199.153
SENT (3.8138s) RARP reply: AC:BC:32:8B:56:DF is at 192.168.199.153
SENT (4.8159s) RARP reply: AC:BC:32:8B:56:DF is at 192.168.199.153
Max rtt: N/A | Min rtt: N/A | Avg rtt: N/A
Raw packets sent: 5 (210B) | Rcvd: 0 (0B) | Lost: 5 (100.00%)
Nping done: 1 IP address pinged in 5.82 seconds</pre></div></code-block><div id="gi7cz97iF2Nb9gpTDiDJB6" class="wolai-block wolai-text"><div><span class="inline-wrap">此时，从<span class="jill"></span>Wireshark<span class="jill"></span>抓取到的<span class="jill"></span>RARP<span class="jill"></span>请求和回复包如下=&gt;</span></div></div><div id="t9S9jt8iW3r91ybFLhfuuE" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-b518456ecf43425776056db944b07998_b.jpg" style="width: 576px"/></figure></div><div id="PotryS3Z856E6HGbZnnc7" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div id="9FVKkvuMp8cy5wMJDxJcRu" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-c888aa5f4b8cbee5020f70f633ed7c83_b.jpg" style="width: 576px"/></figure></div><div id="9TKtSrETKmmwdTBdDBzHqw" class="wolai-block wolai-text"><div><span class="inline-wrap">至此，关于<span class="jill"></span>RARP<span class="jill"></span>的原理和数据包分析便完成了。  </span></div></div><h2 id="5avVe8KeNjgXPNZNZAjNKG" class="wolai-block"><span class="inline-wrap"><b>三、IARP<span class="jill"></span>原理与实践</b></span></h2><div id="mydy3TTDrJ2muJ7ensNA8c" class="wolai-block wolai-text"><div><span class="inline-wrap">IARP（Inverse ARP）即逆向<span class="jill"></span>ARP，这个没法&quot;顾名思义&quot;，因为它既不是<span class="jill"></span>IP<span class="jill"></span>到<span class="jill"></span>MAC<span class="jill"></span>的映射，也不是<span class="jill"></span>MAC<span class="jill"></span>到<span class="jill"></span>IP<span class="jill"></span>的映射，而是</span><span class="inline-wrap"><b>DLCI<span class="jill"></span>到<span class="jill"></span>IP<span class="jill"></span>的映射</b></span><span class="inline-wrap">。相比前面所有其他<span class="jill"></span>ARP<span class="jill"></span>协议，IARP<span class="jill"></span>的应用场景不是在以太网（局域网）里面，而是**在帧中继网络（广域网）**里面。</span></div></div><div id="jBWQNPteAGyVWwWuy72skB" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-c7b3acc810bcfbda086a82da0939e490_b.jpg" style="width: 1121.6px"/></figure></div><div id="xkUoXRzDk8BsxfaKG4HxM1" class="wolai-block wolai-text"><div><span class="inline-wrap">要真正理解<span class="jill"></span>DLCI<span class="jill"></span>和<span class="jill"></span>IARP，需要有一些帧中继网络技术背景，这里简单说下：</span></div></div><div id="rQekX3Gve93dQ37GHvmuNV" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>DLCI（Data Link Connection Identifier）数据链接连接标识，是帧中继网络里面的二层地址，好比以太网里面的<span class="jill"></span>MAC<span class="jill"></span>地址，用于标记帧中继网络里面的虚拟专线</b></span><span class="inline-wrap">。示图如下：</span></div></div><div id="w9GXswTp68WtpFbHtnCa5x" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-08e437ebfe988061684773b8aa15ae92_b.jpg" style="width: 576px"/></figure></div><div id="vDQKczBYyDYP7FkpEk5W8p" class="wolai-block wolai-text"><div><span class="inline-wrap">图中<span class="jill"></span>R1<span class="jill"></span>和<span class="jill"></span>R2<span class="jill"></span>通过专线连接到帧中继交换机，对应的<span class="jill"></span>DLCI<span class="jill"></span>号分别是<span class="jill"></span>102<span class="jill"></span>和<span class="jill"></span>201。交换机通过转发表进行数据交换：</span><span class="inline-wrap"><b>根据接口收到数据包的<span class="jill"></span>DLCI，查看对应的接口，转发到匹配的线路</b></span><span class="inline-wrap">。</span></div></div><div id="wSYPSMdgnZW58kRNgeWLSy" class="wolai-block wolai-text"><div><span class="inline-wrap">所以说，帧中继网络里面，DLCI<span class="jill"></span>类似<span class="jill"></span>MAC，决定了数据包的去向。那么，DLCI<span class="jill"></span>和<span class="jill"></span>IP<span class="jill"></span>的映射关系又是如何的呢？我们来看下帧中继网络里面的数据封装，以<span class="jill"></span>R1 ping R2<span class="jill"></span>为例：</span></div></div><div id="esfNuGcBd1qffrLXfdbLAp" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-83e23299924d441f38defaf497cc9b3c_b.jpg" style="width: 576px"/></figure></div><div id="ucV271uDBWc4BMcNbXPpeG" class="wolai-block wolai-text"><div><span class="inline-wrap">从这里我们可以看到帧中继网络的数据封装和转发模式都不同于以太网：</span></div></div><div id="mXspS6hNnhvCkVxJS8UNKN" class="wolai-block wolai-text"><div><span class="inline-wrap">①二层封装的时候，不需要源目地址，只需要本地<span class="jill"></span>DLCI；例如<span class="jill"></span>10.1.1.1 ping 10.1.1.2，源目<span class="jill"></span>IP<span class="jill"></span>地址这个跟以太网的封装是一样的，但是链路层封装不需要目标<span class="jill"></span>DLCI 201。</span></div></div><div id="rBuHwfwEw2DWJuwXyMEV3F" class="wolai-block wolai-text"><div><span class="inline-wrap">②交换机会改变二层地址信息，例如这里的<span class="jill"></span>DLCI<span class="jill"></span>从左边的<span class="jill"></span>102，变成了右边的<span class="jill"></span>201。</span></div></div><div id="jWegm2hHSeBQUmwyKjJm6N" class="wolai-block wolai-text"><div><span class="inline-wrap">理解了这些差异，我们才能得到这里<span class="jill"></span>DLCI<span class="jill"></span>和<span class="jill"></span>IP<span class="jill"></span>的映射关系：</span><span class="inline-wrap"><b>即目标<span class="jill"></span>IP<span class="jill"></span>地址与本地<span class="jill"></span>DLCI<span class="jill"></span>的映射</b></span><span class="inline-wrap">。例如<span class="jill"></span>R1<span class="jill"></span>要访问<span class="jill"></span>10.1.1.2，此时需要映射到本地的<span class="jill"></span>102；而<span class="jill"></span>R2<span class="jill"></span>要访问<span class="jill"></span>10.1.1.1，则需要映射到本地的<span class="jill"></span>201。</span></div></div><div id="uBmxwbMLK6YtM3C9Ceq3c3" class="wolai-block wolai-text"><div><span class="inline-wrap">更完整的说明：</span><span class="inline-wrap"><b>逆向<span class="jill"></span>ARP<span class="jill"></span>解决帧中继网络里目标<span class="jill"></span>IP<span class="jill"></span>地址与本地<span class="jill"></span>DLCI<span class="jill"></span>的映射，并且让通信双方生成帧中继映射表（frame-relay map）。好比<span class="jill"></span>ARP<span class="jill"></span>解决了以太网里面目的<span class="jill"></span>IP<span class="jill"></span>与目标<span class="jill"></span>MAC<span class="jill"></span>的映射，并且让通信方生成<span class="jill"></span>ARP<span class="jill"></span>映射表</b></span><span class="inline-wrap">。</span></div></div><div id="4RzEn66up3UPvnXVPnqMyr" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-739bf93afd7444f6ac075b16708440bb_b.jpg" style="width: 576px"/></figure></div><div id="5UNMeZThEpjsHbJH8U8b5t" class="wolai-block wolai-text"><div><span class="inline-wrap">接下来，我们通过实验环境来验证，这里可以通过<span class="jill"></span>GNS3<span class="jill"></span>模拟器搭建以上环境，并且抓包验证=&gt;</span></div></div><div id="kbXJNCd9yUjc3K8wrdxcir" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-a85389259931b554288f8cf10238605f_b.jpg" style="width: 1120px"/></figure></div><div id="xA8mVJWQDKLNiun8upa6Mw" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>①为<span class="jill"></span>R1<span class="jill"></span>和<span class="jill"></span>R2<span class="jill"></span>打开接口，封装帧中继，并配置<span class="jill"></span>IP<span class="jill"></span>地址：</b></span><span class="inline-wrap"> </span></div></div><code-block id="7sjP3HJ1RJCKTK7f5cFdpf" class="wolai-block"><div class="wolai-pre"><div data-lang="Text" class="marker"></div><pre>R1(config)#int s0/0
R1(config-if)#no shutdown
R1(config-if)#encapsulation frame-relay
R1(config-if)#ip address 10.1.1.1 255.255.255.0

R2(config)#int s0/0
R2(config-if)#no shutdown
R2(config-if)#encapsulation frame-relay
R2(config-if)#ip address 10.1.1.2 255.255.255.0</pre></div></code-block><div id="ts5CVjUXmUiPu4fbC3ab5r" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>② 开启<span class="jill"></span>wireshark<span class="jill"></span>抓包，抓取<span class="jill"></span>IARP<span class="jill"></span>请求和回复包：</b></span><span class="inline-wrap"> </span></div></div><div id="tjXhjrrHb8Cv1qJRrymJJE" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-58752322584a92634433161e627852aa_b.jpg" style="width: 576px"/></figure></div><div id="7auPLRzLmbEUqPsCG5SsAJ" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div id="6oDm4PfmfJYtT8u12cqFbg" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-442de029cfdab7cd2cbc46dd37768236_b.jpg" style="width: 576px"/></figure></div><div id="m36s49Zaxs5ujiZMPx7evX" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>③查看<span class="jill"></span>R1<span class="jill"></span>和<span class="jill"></span>R2<span class="jill"></span>本地生成的<span class="jill"></span>IARP<span class="jill"></span>映射表：</b></span><span class="inline-wrap"> </span></div></div><code-block id="fkWS3atZ3PFow8Zeu1dG1p" class="wolai-block"><div class="wolai-pre"><div data-lang="Text" class="marker"></div><pre>R1#show frame-relay map
Serial0/0 (up): ip 10.1.1.2 dlci 102(0x66,0x1860), dynamic,
             broadcast,, status defined, active

R2#show frame-relay map
Serial0/0 (up): ip 10.1.1.1 dlci 201(0xC9,0x3090), dynamic,
             broadcast,, status defined, active</pre></div></code-block><div id="pXrG5WXgxkq3DfY5VvZSA6" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>④测试<span class="jill"></span>R1<span class="jill"></span>和<span class="jill"></span>R2<span class="jill"></span>之间的联通并抓取<span class="jill"></span>ICMP<span class="jill"></span>包：</b></span><span class="inline-wrap"> </span></div></div><code-block id="vCAxjjVJUwP3nzqJgmWCNm" class="wolai-block"><div class="wolai-pre"><div data-lang="Text" class="marker"></div><pre>R1#ping 10.1.1.2
Type escape sequence to abort.
Sending 5, 100-byte ICMP Echos to 10.1.1.2, timeout is 2 seconds:
!!!!!
Success rate is 100 percent (5/5), round-trip min/avg/max = 68/75/88 ms
</pre></div></code-block><div id="vD6FjzDdjk4f3nVSWvtpok" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-09d288d4413ef032f63ae3b2d137ea4f_b.jpg" style="width: 576px"/></figure></div><div id="qVNWtjbB2mHb3QXxj8U4y1" class="wolai-block wolai-text"><div><span class="inline-wrap">至此，IARP<span class="jill"></span>的原理与实践并完成了。那么，既然<span class="jill"></span>IARP<span class="jill"></span>能够实现帧中继的通信，为什么在文章开头，我们提到说<span class="jill"></span>IARP<span class="jill"></span>跟<span class="jill"></span>RARP<span class="jill"></span>一样，在工作中已经不常见了呢？</span></div></div><div id="pWKrnF1gwLrMDTy7tgmvR3" class="wolai-block wolai-text"><div><span class="inline-wrap">①帧中继作为一种广域网远程连接技术，正在慢慢</span><span class="inline-wrap"><b>被其他技术代替</b></span><span class="inline-wrap">；</span></div></div><div id="mSQFhhEYi2Tyx5Sm2BkpeA" class="wolai-block wolai-text"><div><span class="inline-wrap">②IARP<span class="jill"></span>不像<span class="jill"></span>ARP<span class="jill"></span>协议可以实时交互，它是</span><span class="inline-wrap"><b>周期性运行</b></span><span class="inline-wrap">的，通信双方若丢失<span class="jill"></span>IARP<span class="jill"></span>映射表，则需要等待到固定的时间交互才能重新生成并通信。另外不同厂商不同型号对<span class="jill"></span>IARP<span class="jill"></span>的</span><span class="inline-wrap"><b>兼容性也可能不同</b></span><span class="inline-wrap">。基于这些原因，</span><span class="inline-wrap"><b>一般建议直接关闭<span class="jill"></span>IARP<span class="jill"></span>协议，采用静态绑定的方式生成映射表</b></span><span class="inline-wrap">，这里不再深入。（有兴趣的小伙伴可以观看我之前的技术视频教程，有深入讲解了如何关闭<span class="jill"></span>IARP<span class="jill"></span>和静态绑定的做法。）</span></div></div><h2 id="pAgJdMws1e7EmNpKUQq694" class="wolai-block"><span class="inline-wrap"><b>四、RARP<span class="jill"></span>与<span class="jill"></span>IARP<span class="jill"></span>协议总结</b></span></h2><div id="sLDxZoXaBr7oSSRLM5MCvz" class="wolai-block wolai-text"><div><span class="inline-wrap">①RARP<span class="jill"></span>用于实现<span class="jill"></span>MAC<span class="jill"></span>到<span class="jill"></span>IP<span class="jill"></span>的映射，本质就是为了获取<span class="jill"></span>IP<span class="jill"></span>地址，是<span class="jill"></span>Bootp<span class="jill"></span>和<span class="jill"></span>DHCP<span class="jill"></span>协议的鼻祖；</span></div></div><div id="cS1DHevh34tckLe4VP5SRv" class="wolai-block wolai-text"><div><span class="inline-wrap">②IARP<span class="jill"></span>用于实现帧中继网络中<span class="jill"></span>DLCI<span class="jill"></span>到<span class="jill"></span>IP<span class="jill"></span>地址的映射，生成帧中继映射表（类似<span class="jill"></span>ARP<span class="jill"></span>表），实现数据封装与通信；</span></div></div><div id="ihZhdc7rfuLQ5fcRYx3JAn" class="wolai-block wolai-text"><div><span class="inline-wrap">③相比<span class="jill"></span>ARP、免费<span class="jill"></span>ARP、代理<span class="jill"></span>ARP、ARP<span class="jill"></span>攻防等技术，RARP<span class="jill"></span>和<span class="jill"></span>IARP<span class="jill"></span>随着技术的更新迭代正在退出历史舞台，成为**&quot;被遗忘的兄弟协议&quot;** 。（对于初学者来说，也算是个好事，因为终于不用&quot;翻转&quot;&quot;反向&quot;&quot;逆向&quot;各种分不清了）</span></div></div><div id="fFWju7khv6NTikTCRXr6js" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>ARP<span class="jill"></span>协议大总结及下一阶段预告</b></span></div></div><div id="uQR7raxNHr9edbv4aAgEvg" class="wolai-block wolai-text"><div><span class="inline-wrap">到这里，我们通过六篇文章终于搞定了<span class="jill"></span>ARP<span class="jill"></span>协议的方方面面，包括它们的应用场景、设计思想、数据包结构、实验验证等等。</span></div></div><div id="ffX888sqNXy5Wff1SvMFWP" class="wolai-block wolai-text"><div><span class="inline-wrap">另外，为什么这次图解系列的开头是从<span class="jill"></span>ARP<span class="jill"></span>协议开始写，而不是从<span class="jill"></span>Ethernet、IP、TCP、HTTP<span class="jill"></span>或其他呢？</span></div></div><div id="8FRWeaWqUdc23X7ue92WqX" class="wolai-block wolai-text"><div><span class="inline-wrap">主要是因为**&quot;ARP<span class="jill"></span>太简单了&quot;**，简单到大家在学网络和安全的时候，都容易去忽略协议背后的很多细节，例如很多人认为\[ARP<span class="jill"></span>的请求就一定是广播的，回复就一定是单播的\]，但&quot;常识&quot;背后也有另外一些特殊的情况。所以，通过这一个足够简单的协议，为大家解构背后相对复杂的机制，为后续深入研究开个好头。</span></div></div><div id="inHxPzPLJ7reUNR6Atbp8V" class="wolai-block wolai-text"><div><span class="inline-wrap">另外一个原因就是**&quot;ARP<span class="jill"></span>很有趣&quot;**，例如协议设计者通过不同的操作代码(opcode)，做了非常多的变种（arp<span class="jill"></span>是<span class="jill"></span>1<span class="jill"></span>和<span class="jill"></span>2，rarp<span class="jill"></span>是<span class="jill"></span>3<span class="jill"></span>和<span class="jill"></span>4，iarp<span class="jill"></span>是<span class="jill"></span>8<span class="jill"></span>和<span class="jill"></span>9），做一个模型便可以多处应用；而且通过精巧的构造，就可以在内网造成极大的杀伤力。</span></div></div><div id="mjCzuKEtR8XNsEQBg4akg4" class="wolai-block wolai-text"><div><span class="inline-wrap">anyway，图解<span class="jill"></span>ARP<span class="jill"></span>协议只是整个系列的开篇，下一阶段，我们将进入<span class="jill"></span>IP<span class="jill"></span>协议，探讨<span class="jill"></span>IP<span class="jill"></span>协议原理、数据包结构、优缺点、地址结构、IP<span class="jill"></span>攻击与防御（分片攻击、欺骗攻击）……</span></div></div><div id="5qMGWJinYzPUxqJ5AMeEpE" class="wolai-block wolai-text"><div><span class="inline-wrap">\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-</span></div></div><div id="iCfUp9AJZbmWPwkjQsVBZu" class="wolai-block wolai-text"><div><span class="inline-wrap">知乎专栏：</span><span class="inline-wrap"><a href="https://zhuanlan.zhihu.com/jaykingchen"><span>跟杰哥学网络与安全</span></a></span></div></div><div id="6V4dFkAri7yf35tHR6gXjT" class="wolai-block wolai-text"><div><span class="inline-wrap">新浪微博：</span><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.weibo.com/jaykingchen"><span>@<span class="jill"></span>拼客学院陈鑫杰</span></a></span></div></div><div id="6H6S8LgndHHt7YjGBw9fqr" class="wolai-block wolai-text"><div><span class="inline-wrap">微信公众号：拼客院长陈鑫杰（搜索&quot;</span><span class="inline-wrap"><b>pingsec</b></span><span class="inline-wrap">&quot;即可关注，大牛都在看）</span></div></div><div id="pE9JYTkLRKqQGkzHWEQh7H" class="wolai-block wolai-text"><div><span class="inline-wrap">拼客学院：</span><span class="inline-wrap"><a href="https://link.zhihu.com/?target=http%3A//www.pinginglab.net"><span>http://www.pinginglab.net</span></a></span><span class="inline-wrap">（专注网络<span class="jill"></span>|<span class="jill"></span>安全<span class="jill"></span>|<span class="jill"></span>运维的<span class="jill"></span>IT<span class="jill"></span>学院）</span></div></div></div><h2 id="4aGAHLSmy7wkTNFkQAKZVe" class="wolai-block"><span class="inline-wrap">跨网段传输</span></h2><div id="nu9ZiACq7PERpSFD4szP6t" class="wolai-block wolai-text"><div><span class="inline-wrap">ARP</span><span class="green inline-wrap"><b>用于解决同一个局域网上</b></span><span class="inline-wrap">的主机或路由器的<span class="jill"></span>IP 地址和硬件地址的映射问题。</span></div></div><div id="s8PJoU99a76hxa5phExJmh" class="wolai-block wolai-text"><div><span class="inline-wrap">•方案<span class="jill"></span>1: 设置<span class="jill"></span>ARP<span class="jill"></span>代理,让路由器充当其他网络的<span class="jill"></span>ARP<span class="jill"></span>代理</span></div><div id="4shY6BafRmUrL1P2KHJJgs" class="wolai-block wolai-text"><div><span class="inline-wrap">如果所要找的主机和源主机不在同一个局域网上，那么就要通过<span class="jill"></span>ARP 找到一个位于本局域网上的某个路由器的硬件地址，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络。剩下的工作就由下一个网络来做。</span></div></div><div class="block-ref"><div class="decorator"></div><div id="eV3QcuEfuyUWMUntcBfB4o" class="wolai-sub-page wolai-block"><div class="page-icon"></div><a href="ipv4%E5%8D%8F%E8%AE%AE/arp/%E5%9B%BE%E8%A7%A3arp%E5%8D%8F%E8%AE%AE%EF%BC%88%E5%9B%9B%EF%BC%89%E4%BB%A3%E7%90%86arp%EF%BC%9A%E5%96%84%E6%84%8F%E7%9A%84%E6%AC%BA/%E5%9B%BE%E8%A7%A3arp%E5%8D%8F%E8%AE%AE%EF%BC%88%E5%9B%9B%EF%BC%89%E4%BB%A3%E7%90%86arp%EF%BC%9A%E5%96%84%E6%84%8F%E7%9A%84%E6%AC%BA.html"><span>图解ARP协议（四）代理ARP：善意的欺骗 - 知乎</span></a></div></div></div><div id="kPVVa2EJwBXwNk1dhnbVCi" class="wolai-block wolai-text"><div><span class="inline-wrap">•方案<span class="jill"></span>2:发送主机知道是发往外网段的包,直接发送给默认的以太网地址.</span></div></div><h2 id="9iybPQVud3PnHLyJEmU9T8" class="wolai-block"><span class="inline-wrap">数据包格式</span></h2><div id="eHG8EUw1LhvdAFFbKorr9L" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_2.png" style="width: 100%"/></figure></div><div id="imXybA1KhHnGNHz6JGuoYB" class="wolai-row"><div id="ArEKUACsWFBqZ7j7jgt9u" class="wolai-col" style="flex-grow: 0.5"><div id="5mt9VXoqWzKoHDQnVanKdQ" class="wolai-block wolai-text"><div><span class="inline-wrap">•硬件类型：表示其他物理网络的类型是以太网还是<span class="jill"></span>FDDI<span class="jill"></span>网等；</span></div></div><div id="f1VFaf5jWGPDdsRago7Sz8" class="wolai-block wolai-text"><div><span class="inline-wrap">•协议类型：表示网络协议类型；</span></div></div><div id="gxgtw8seQ6UtYJzNaYHAoi" class="wolai-block wolai-text"><div><span class="inline-wrap">•头长度：表示<span class="jill"></span>ARP<span class="jill"></span>报文的总长度；</span></div></div><div id="7oQdW4SxHyQD8uJv96d73T" class="wolai-block wolai-text"><div><span class="inline-wrap">•协议地址长度：对于<span class="jill"></span>IP<span class="jill"></span>协议来说，该域的值应该为<span class="jill"></span>4；</span></div></div><div id="4g3wSVHZvTJHFdCJtQ2gVr" class="wolai-block wolai-text"><div><span class="inline-wrap">•操作：表示<span class="jill"></span>ARP<span class="jill"></span>请求与响应；</span></div></div><div id="vsCx5EUSisWn2gbPrFckZk" class="wolai-block wolai-text"><div><span class="inline-wrap">•源端物理地址：源端的物理地址，由请求者填充；</span></div></div><div id="2C57fZYkutkcB6R5RFHntD" class="wolai-block wolai-text"><div><span class="inline-wrap">•源端协议地址：源端的<span class="jill"></span>IP<span class="jill"></span>地址，由请求者填充；</span></div></div><div id="w8VeYk9FcVsW5W5DJbLCuo" class="wolai-block wolai-text"><div><span class="inline-wrap">•目的端物理地址：目的端的物理地址，在请求包中应该为<span class="jill"></span>0，在响应包中则被设置为目的端的物理地址，由发送响应包的主机填充；</span></div></div><div id="v1pZXXPocR3PhbuZggLvV8" class="wolai-block wolai-text"><div><span class="inline-wrap">•目的端协议地址：由<span class="jill"></span>ARP<span class="jill"></span>请求者填充，其中含有所希望知道的主机的<span class="jill"></span>IP<span class="jill"></span>地址。仅有和该地址匹配的主机才发送响应。</span></div></div></div><div id="dWsUdNVXtdKEiT6mW6XiVt" class="wolai-col" style="flex-grow: 0.5"><div class="block-ref"><div class="decorator"></div><div id="pZqhH1mYMU8LBQezrdKgFL" class="wolai-block wolai-text"><div><span class="inline-wrap">Hardware type ：硬件类型，标识链路层协议</span></div></div></div><div class="block-ref"><div class="decorator"></div><div id="ewnRtXP2kBeHfGiAXmzigi" class="wolai-block wolai-text"><div><span class="inline-wrap">Protocol type： 协议类型，标识网络层协议</span></div></div></div><div class="block-ref"><div class="decorator"></div><div id="trb69oRkoJi7EoXonWS7Wn" class="wolai-block wolai-text"><div><span class="inline-wrap">Hardware size ：硬件地址大小，标识<span class="jill"></span>MAC<span class="jill"></span>地址长度，这里是<span class="jill"></span>6<span class="jill"></span>个字节（48bti）</span></div></div></div><div class="block-ref"><div class="decorator"></div><div id="nhwvnm8E8MXoonjULsYyVU" class="wolai-block wolai-text"><div><span class="inline-wrap">Protocol size： 协议地址大小，标识<span class="jill"></span>IP<span class="jill"></span>地址长度，这里是<span class="jill"></span>4<span class="jill"></span>个字节（32bit）</span></div></div></div><div class="block-ref"><div class="decorator"></div><div id="7bjyqqfhyds828frjW9n1M" class="wolai-block wolai-text"><div><span class="inline-wrap">Opcode： 操作代码，标识<span class="jill"></span>ARP<span class="jill"></span>数据包类型，1<span class="jill"></span>表示请求，2<span class="jill"></span>表示回应</span></div></div></div><div class="block-ref"><div class="decorator"></div><div id="bQ242ai664Yv17ip5xFfpx" class="wolai-block wolai-text"><div><span class="inline-wrap">Sender MAC address ：发送者<span class="jill"></span>MAC</span></div></div></div><div class="block-ref"><div class="decorator"></div><div id="dBogTfSQPManUDbgy951Db" class="wolai-block wolai-text"><div><span class="inline-wrap">Sender IP address ：发送者<span class="jill"></span>IP</span></div></div></div><div class="block-ref"><div class="decorator"></div><div id="7sdF5KHYy3J3kG83K69SHJ" class="wolai-block wolai-text"><div><span class="inline-wrap">Target MAC address ：目标<span class="jill"></span>MAC，此处全<span class="jill"></span>0<span class="jill"></span>表示在请求</span></div></div></div><div class="block-ref"><div class="decorator"></div><div id="pGghvBNAMnWWyYv9CRrisJ" class="wolai-block wolai-text"><div><span class="inline-wrap">Target IP address： 目标<span class="jill"></span>IP</span></div></div></div></div></div><hr id="mjcWrqsbBJWPscQDpiDBvF" class="wolai-block"/><div id="ckPRESNh8EEFA7K2zHo6KH" class="wolai-block wolai-text"><div><span class="inline-wrap">ARP<span class="jill"></span>请求分组：包含发送方硬件地址/发送方<span class="jill"></span>IP<span class="jill"></span>地址/目标方硬件地址(未知时填<span class="jill"></span>0)/ 目标方<span class="jill"></span>IP<span class="jill"></span>地址。</span></div></div><div id="rzMMstzEYhrJKRMXduyAiA" class="wolai-block wolai-text"><div><span class="inline-wrap">本地广播<span class="jill"></span>ARP 请求（路由器不转发<span class="jill"></span>ARP<span class="jill"></span>请求）。</span></div></div><div id="caca6fWxVpxS7vVhzHrEC4" class="wolai-block wolai-text"><div><span class="inline-wrap">ARP<span class="jill"></span>响应分组：包含发送方硬件地址/发送方<span class="jill"></span>IP<span class="jill"></span>地址 / 目标方硬件地址/目标方<span class="jill"></span>IP<span class="jill"></span>地址。</span></div></div><div id="onTuwWgqDhxSGSKtVXQDdy" class="wolai-block wolai-text"><div><span class="inline-wrap">ARP<span class="jill"></span>分组封装在物理网络的帧中传输。</span></div></div><hr id="nRvQrMUDwSCxwFR6Dx7z1t" class="wolai-block"/><div class="block-ref"><div class="decorator"></div><div id="vPJjyuQySr3guTnF11XgaW" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>【ARP<span class="jill"></span>请求包】</b></span><span class="inline-wrap"> </span></div></div></div><div class="block-ref"><div class="decorator"></div><div id="kZTcta4NV9SeqUWVLWaWCZ" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-5e6176abaacf3839113a116891df9bde_b.jpg" style="width: 576px"/></figure></div></div><div class="block-ref"><div class="decorator"></div><div id="kcFjCMAaSPvqDMaHXs27K5" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>【ARP<span class="jill"></span>回应包】</b></span><span class="inline-wrap"> </span></div></div></div><div class="block-ref"><div class="decorator"></div><div id="r47rGEyYcDoHzefuKUs2xB" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-2216de823ce85a2cb629d2a0c774f9c3_b.jpg" style="width: 576px"/></figure></div></div><div id="bFwmFZ2FtfkRBGuoGq46ZR" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_3.png" style="width: 100%"/></figure></div><h2 id="a3fosnL5B7Ezo9oVyF2UTM" class="wolai-block"><span class="inline-wrap">问：广播 答：单播</span></h2><div id="8VfYixdAmAGcPGtx67RqF" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_4.png" style="width: 100%"/></figure></div><h2 id="3eHCxpZz9T2qZigf3MhPfE" class="wolai-block"><span class="inline-wrap">IP 地址与硬件地址 </span></h2><h3 id="ejrGLbsXZWXRHtocMfEB2e" class="wolai-block"><span class="inline-wrap">为什么不直接使用硬件地址进行通信？ </span></h3><div id="wLTCG9CLmngJdSfSvM537c" class="wolai-block wolai-text"><div><span class="inline-wrap">由于全世界存在着各式各样的网络，它们使用不同的硬件地址。要使这些异构网络能够互相通信就必须进行非常复杂的硬件地址转换工作，因此几乎是不可能的事。</span></div></div><div id="g2agu2xa6CcvuqkpoddKG3" class="wolai-block wolai-text"><div><span class="inline-wrap">IP<span class="jill"></span>编址把这个复杂问题解决了。连接到互联网的主机只需各自拥有一个唯一的 IP 地址，它们之间的通信就像连接在同一个网络上那样简单方便，因为上述的调用<span class="jill"></span>ARP<span class="jill"></span>的复杂过程都是由计算机软件自动进行的，对用户来说是看不见这种调用过程的。</span></div></div><div id="kJUa8Wpxg34WjdfqA6YJq6" class="wolai-block wolai-text"><div><span class="inline-wrap">因此，在虚拟的<span class="jill"></span>IP 网络上用 IP 地址进行通信给广大的计算机用户带来了很大的方便。</span></div></div><div id="tkfrQ9Mx5JHXZGptDSsa1P" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_5.png" style="width: 100%"/></figure></div><h2 id="hTSVtaF5xkRfn1JgW5J3Cm" class="wolai-block"><span class="inline-wrap">ARP 高速缓存 (ARP cache)</span></h2><div id="wK8KaoMpoibPfcFDjWp4Bj" class="wolai-block wolai-text"><div><span class="inline-wrap">里面有所在的局域网上的各主机和路由器的 IP 地址到硬件地址的映射表。</span></div></div><div id="bUjzpQ7BAyPvxnLk2ojzvd" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_6.png" style="width: 100%"/></figure></div><div id="cWpxpvu24HkKNPRS2zBYeE" class="wolai-block wolai-text"><div><span class="inline-wrap">当主机 A 欲向本局域网上的某个主机<span class="jill"></span>B<span class="jill"></span>发送<span class="jill"></span>IP<span class="jill"></span>数据报时，就先在其<span class="jill"></span>ARP<span class="jill"></span>高速缓存中查看有无主机<span class="jill"></span>B<span class="jill"></span>的<span class="jill"></span>IP<span class="jill"></span>地址。</span></div><div id="mYoqfZNACTkfGcNtmZPwGV" class="wolai-block wolai-text"><div><span class="inline-wrap">1.如有，就可查出其对应的硬件地址，再将此硬件地址写入<span class="jill"></span>MAC<span class="jill"></span>帧，然后通过局域网将该<span class="jill"></span>MAC<span class="jill"></span>帧发往此硬件地址。</span></div></div><div id="mUwG1Ru8ymGu7myK7tFgpr" class="wolai-block wolai-text"><div><span class="inline-wrap">2.如没有，ARP<span class="jill"></span>进程在本局域网上广播发送一个 ARP<span class="jill"></span>请求分组。收到<span class="jill"></span>ARP 响应分组后，将得到的<span class="jill"></span>IP<span class="jill"></span>地址到硬件地址的映射写入<span class="jill"></span>ARP<span class="jill"></span>高速缓存。</span></div></div></div><h3 id="5RgewDpiB5wguW5q2UP7Ae" class="wolai-block"><span class="inline-wrap">作用</span></h3><div id="88eHhkLSUykEc3iE7CNYzE" class="wolai-block wolai-text"><div><span class="inline-wrap">存放最近获得的<span class="jill"></span>IP 地址到 MAC 地址的绑定，以减少 ARP 广播的数量。</span></div></div><aside id="a1osxuyfJyEq9QTWZ48nBj" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap">ARP<span class="jill"></span>缓存可以减少发送<span class="jill"></span>ARP<span class="jill"></span>广播包的次数；</span></aside><div id="4h3yqpbr84u3YWbiQujWZp" class="wolai-block wolai-text"><div><span class="inline-wrap">为了减少网络上的通信量，主机<span class="jill"></span>A<span class="jill"></span>在发送其<span class="jill"></span>ARP<span class="jill"></span>请求分组时，就将自己的<span class="jill"></span>IP<span class="jill"></span>地址到硬件地址的映射写入<span class="jill"></span>ARP<span class="jill"></span>请求分组。</span></div></div><div id="mLYxLVC8zGY7D3QRNP2qxF" class="wolai-block wolai-text"><div><span class="inline-wrap">当主机<span class="jill"></span>B<span class="jill"></span>收到<span class="jill"></span>A<span class="jill"></span>的<span class="jill"></span>ARP<span class="jill"></span>请求分组时，就将主机<span class="jill"></span>A<span class="jill"></span>的这一地址映射写入主机<span class="jill"></span>B<span class="jill"></span>自己的<span class="jill"></span>ARP<span class="jill"></span>高速缓存中。这对主机<span class="jill"></span>B<span class="jill"></span>以后向<span class="jill"></span>A<span class="jill"></span>发送数据报时就更方便了。</span></div></div><h2 id="kvpefVEwaqyNnvD88muAjg" class="wolai-block"><span class="inline-wrap">代理<span class="jill"></span>ARP<span class="jill"></span>技术</span></h2><div class="block-ref"><div class="decorator"></div><div id="eV3QcuEfuyUWMUntcBfB4o" class="wolai-sub-page wolai-block"><div class="page-icon"></div><a href="ipv4%E5%8D%8F%E8%AE%AE/arp/%E5%9B%BE%E8%A7%A3arp%E5%8D%8F%E8%AE%AE%EF%BC%88%E5%9B%9B%EF%BC%89%E4%BB%A3%E7%90%86arp%EF%BC%9A%E5%96%84%E6%84%8F%E7%9A%84%E6%AC%BA/%E5%9B%BE%E8%A7%A3arp%E5%8D%8F%E8%AE%AE%EF%BC%88%E5%9B%9B%EF%BC%89%E4%BB%A3%E7%90%86arp%EF%BC%9A%E5%96%84%E6%84%8F%E7%9A%84%E6%AC%BA.html"><span>图解ARP协议（四）代理ARP：善意的欺骗 - 知乎</span></a></div></div><div id="sZmMbFVEiNkhLFZaKmzSzQ" class="wolai-block wolai-text"><div><span class="inline-wrap">通过代理<span class="jill"></span>ARP<span class="jill"></span>路由器去完成网络内一组主机的<span class="jill"></span>ARP<span class="jill"></span>服务</span></div></div><div id="mahCNq3YHfh9ny86tYY27D" class="wolai-block wolai-text"><div><span class="inline-wrap">当代理<span class="jill"></span>ARP<span class="jill"></span>收到请求时，首先判断是否属于他代理的网络</span></div></div><div id="iEcb6iEiqbL3AQQ5tCQaaK" class="wolai-block wolai-text"><div><span class="inline-wrap">如果属于，代理<span class="jill"></span>ARP<span class="jill"></span>通过发送一个<span class="jill"></span>ARP<span class="jill"></span>应答，公布其物理地址</span></div></div><div id="dNKsnYmsduhsRHJU4NK4ME" class="wolai-block wolai-text"><div><span class="inline-wrap">以后在他收到真正传送给子网内一个主机的<span class="jill"></span>IP<span class="jill"></span>数据报时，它再将分组转发到子网的目的主机</span></div></div><h2 id="brWwUFiTcxYBP5qq4CF3FM" class="wolai-block"><span class="inline-wrap">使用 ARP 的四种典型情况</span></h2><div id="poqRkD15PG2hbKMjMGaHPA" class="wolai-row"><div id="c9DE3N1NnnfvXnzwDVQiD" class="wolai-col" style="flex-grow: 0.5"><ul class="wolai-block"><li id="iehfCNRMaZF6cpqdFHFfZy"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">发送方是主机，要把<span class="jill"></span>IP<span class="jill"></span>数据报发送到本网络上的另一个主机。这时用<span class="jill"></span>ARP<span class="jill"></span>找到目的主机的硬件地址。</span></li><li id="amDxw4xvnjwSwG65pPcVJ7"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">发送方是主机，要把<span class="jill"></span>IP<span class="jill"></span>数据报发送到另一个网络上的一个主机。这时用<span class="jill"></span>ARP<span class="jill"></span>找到本网络上的一个路由器的硬件地址。剩下的工作由这个路由器来完成。</span></li><li id="uHs47PsMM1KEMSNa86RVKi"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">发送方是路由器，要把<span class="jill"></span>IP<span class="jill"></span>数据报转发到本网络上的一个主机。这时用<span class="jill"></span>ARP<span class="jill"></span>找到目的主机的硬件地址。</span></li><li id="ntisc7neVPjieeKWpAdHgL"><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">发送方是路由器，要把<span class="jill"></span>IP<span class="jill"></span>数据报转发到另一个网络上的一个主机。这时用<span class="jill"></span>ARP<span class="jill"></span>找到本网络上另一个路由器的硬件地址。剩下的工作由这个路由器来完成。</span></li></ul></div><div id="wtT3cWmAjqBi28U42orTTt" class="wolai-col" style="flex-grow: 0.5"><div id="9u8rq9qNryeQ7zfaRt4xa5" class="wolai-block"><figure class="wolai-left" style="width: 100%"><img src="media/image_7.png" style="width: 633.6px"/></figure></div></div></div><div id="ojej6x8c4yEBn9RQVwnvHF" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_8.png" style="width: 100%"/></figure></div><div id="kcnGLqQNEbZZ7sH4ftwogk" class="wolai-block wolai-text"><div></div></div></div><h1 id="94YHY9aJ5vqMbWmWvXReKo" class="wolai-block"><span class="inline-wrap">动态主机配置协议<span class="jill"></span>DHCP </span></h1><div id="qbhDwDt8Aoy6UrnxXTjYxE" class="wolai-sub-page wolai-block"><div class="page-icon"></div><a href="ipv4%E5%8D%8F%E8%AE%AE/dhcp/dhcp.html"><span>DHCP </span></a><aside id="kW3EiA1q61zLdzSzZfJDK4" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap">P361</span></aside><h2 id="nzkRm8SQQ5LqdzAtWx6qiB" class="wolai-block"><span class="inline-wrap">预备</span></h2><details id="5QYruLBVTXu8fPuFidWHSU" class="wolai-block"><summary><div class="marker"></div><h3><span class="inline-wrap">什么是配置</span></h3></summary><div id="3nuCFM83CJbzTJ53mdsxTj" class="wolai-block wolai-text"><div><span class="inline-wrap">在协议软件中，给协议参数赋值的动作叫做协议配置。</span></div></div><div id="fpWVvqgJegQRCwtd1xY5PC" class="wolai-block wolai-text"><div><span class="inline-wrap">一个协议软件在使用之前必须是已正确配置的。</span></div></div><div id="kEcgBKTj1qz67NqZBq3eCH" class="wolai-block wolai-text"><div><span class="inline-wrap">连接到互联网的计算机的协议软件需要配置的参数包括：</span></div><div id="93VCdkgEfMXW8gMR616n5U" class="wolai-block wolai-text"><div><span class="inline-wrap">1.IP 地址</span></div></div><div id="p4HxKmhNTLjRFMbad4ad3f" class="wolai-block wolai-text"><div><span class="inline-wrap">2.子网掩码</span></div></div><div id="hdVfviXZHMTSBg7shvm5hJ" class="wolai-block wolai-text"><div><span class="inline-wrap">3.默认路由器的<span class="jill"></span>IP<span class="jill"></span>地址</span></div></div><div id="hjD1fAHvyVhs6J4wgjKFtb" class="wolai-block wolai-text"><div><span class="inline-wrap">4.域名服务器的<span class="jill"></span>IP<span class="jill"></span>地址</span></div></div></div><div id="4XCh5EFocaUwYCjiNPrYhC" class="wolai-block wolai-text"><div><span class="inline-wrap">这些信息通常存储在一个配置文件中，计算机在引导过程中可以对这个文件进行存取。 </span></div></div></details><h2 id="2kEgfgNgD1noM96ftjCQKd" class="wolai-block"><span class="inline-wrap">简介</span></h2><div id="vQV5HyAkUmk2NTdRzZeqHp" class="wolai-block wolai-text"><div><span class="inline-wrap">互联网广泛使用的动态主机配置协议<span class="jill"></span>DHCP (DynamicHost Configuration Protocol) 提供了即插即用连网 (plug-and-playnetworking) 的机制。</span></div></div><div id="mFncSYZB6wXocWp5NiaBN3" class="wolai-block wolai-text"><div><span class="inline-wrap">这种机制允许一台计算机加入新的网络和获取<span class="jill"></span>IP<span class="jill"></span>地址，而不用手工配置。</span></div></div><div id="4EQCz4B7QVgwy6HeSJqP4b" class="wolai-block wolai-text"><div><span class="inline-wrap">DHCP<span class="jill"></span>给运行服务器软件、且位置固定的计算机指派一个永久地址，给运行客户端软件的计算机分配一个临时地址。</span></div></div><aside id="fPMcwbCgEmnDxp8NHQ7Twe" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap">DHCP<span class="jill"></span>是替代了死去的反向地址转换协议<span class="jill"></span>RARP</span><div class="block-ref"><div class="decorator"></div><div id="r1GuDUrKMU4MqXws7g7oz" class="wolai-sub-page wolai-block"><div class="page-icon"></div><a href="ipv4%E5%8D%8F%E8%AE%AE/arp/%E5%9B%BE%E8%A7%A3arp%E5%8D%8F%E8%AE%AE%EF%BC%88%E5%85%AD%EF%BC%89rarp%E4%B8%8Eiarp%EF%BC%9A/%E5%9B%BE%E8%A7%A3arp%E5%8D%8F%E8%AE%AE%EF%BC%88%E5%85%AD%EF%BC%89rarp%E4%B8%8Eiarp%EF%BC%9A.html"><span>图解ARP协议（六）RARP与IARP：被遗忘的兄弟协议 - 知乎</span></a></div></div></aside><div id="rMS8cqNKPs7JZwTDt5GoBz" class="wolai-sub-page wolai-block"><div class="page-icon"></div><a href="ipv4%E5%8D%8F%E8%AE%AE/dhcp/dhcp%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/dhcp%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3.html"><span> DHCP协议详解</span></a><h2 id="qtpaUdXUZ4S9sPkgPq9Jmd" class="wolai-block"><span class="inline-wrap">1.1 DHCP<span class="jill"></span>协议理解</span></h2><div id="kw861BdDKR15JqsQPbcKfc" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>定义</b></span><span class="inline-wrap">：</span><span class="inline-wrap"><a href="https://so.csdn.net/so/search?q=DHCP&amp;spm=1001.2101.3001.7020"><span>DHCP</span></a></span><span class="inline-wrap">：Dynamic Host Configuration Protocol，动态主机配置协议，是一个应用在局域网中的网络协议，它使用<span class="jill"></span>UDP<span class="jill"></span>协议工作。</span></div></div><div id="w4zPAGP8c7wtvjb4mgXdUP" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>理解</b></span><span class="inline-wrap">**：** DHCP<span class="jill"></span>协议就是一个基于<span class="jill"></span>UDP<span class="jill"></span>协议工作在局域网内的</span><span class="inline-wrap"><a href="https://so.csdn.net/so/search?q=%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE&amp;spm=1001.2101.3001.7020"><span>网络协议</span></a></span><span class="inline-wrap">，其最终的目的就是获取响应的<span class="jill"></span>IP<span class="jill"></span>地址，其中这过程中有多种分配方式，以及发送报文的格式要求等。</span></div></div><div id="5zBhwUYFUPt6ZwAAP2AB5u" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>作用</b></span><span class="inline-wrap">**：** 动态分配<span class="jill"></span>IP<span class="jill"></span>地址，过程自动化，终端无需一一手工配置，配置信息统一管理（DNS,网关），IP<span class="jill"></span>地址有限、需要大量配置<span class="jill"></span>IP<span class="jill"></span>地址、经常移动终端。</span></div></div><div id="sW7KfiZVvmskcfd4Z4kLoh" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>好处：</b></span><span class="inline-wrap"> 提高配置<span class="jill"></span>IP<span class="jill"></span>地址效率，减少配置工作量，减少<span class="jill"></span>IP<span class="jill"></span>地址冲突。</span></div></div><div id="dpq3KRGtgMKZDxJ8redNJz" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>分配<span class="jill"></span>IP</b></span><span class="inline-wrap">地址方式： </span></div></div><div id="kKXq8ZyLGniCuATEpdRicj" class="wolai-block wolai-text"><div><span class="inline-wrap">（1）</span><span class="inline-wrap"><b>手工配置方式：</b></span><span class="inline-wrap"> 通过网络管理员手工配置某台客户端特定的<span class="jill"></span>IP<span class="jill"></span>地址，当客户端请求分配时，DHCP<span class="jill"></span>服务器就将手动配置的<span class="jill"></span>IP<span class="jill"></span>地址分配给客户端。。</span></div></div><div id="m43Qjya6V3B1owGU6qRNew" class="wolai-block wolai-text"><div><span class="inline-wrap">（2）</span><span class="inline-wrap"><b>自动配置方式：</b></span><span class="inline-wrap"> 当<span class="jill"></span>DHCP<span class="jill"></span>客户端第一次想服务端租用到第一个<span class="jill"></span>IP<span class="jill"></span>地址后，就将这个<span class="jill"></span>IP<span class="jill"></span>地址永久分配给客户端使用。</span></div></div><div id="9ULhJm8K8FaZ2RqQtq46iu" class="wolai-block wolai-text"><div><span class="inline-wrap">（3）</span><span class="inline-wrap"><b>动态配置方式：</b></span><span class="inline-wrap"> 服务器暂时分配一个<span class="jill"></span>IP<span class="jill"></span>地址给客户端，根据租约到期或者续约租期的方式来管理分配的<span class="jill"></span>IP<span class="jill"></span>地址。</span></div></div><h4 id="8gQFq6tjyk2x41Xj3EQUab" class="wolai-block"><span class="inline-wrap">报文格式</span></h4><div id="7fyrXAmkG4kwGnrq7mRSse" class="wolai-block wolai-simple-table"><table><thead><tr><th style="width: 100px"><span class="inline-wrap">链路层头</span></th><th style="width: 137px"><span class="inline-wrap">IP<span class="jill"></span>头<span class="jill"></span>  20bytes</span></th><th style="width: 100px"><span class="inline-wrap">UDP<span class="jill"></span>头</span></th><th style="width: 167px"><span class="inline-wrap">DHCP<span class="jill"></span>报文</span></th></tr></thead></table></div><div id="pLYtAVr4Wo4tarioNfF3na" class="wolai-block wolai-text"><div><span class="inline-wrap">图<span class="jill"></span>1 DHCP<span class="jill"></span>报文封装格式</span></div></div><div id="vu7MV5vXTFmgHuS8BzWwEL" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://img-blog.csdnimg.cn/20190420130143187.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NjYW5mX2xpbnV4,size_16,color_FFFFFF,t_70" style="width: 445.6px"/></figure></div><div id="6nWfjSpFnGGmoQPcerWYs8" class="wolai-block wolai-text"><div><span class="inline-wrap">图<span class="jill"></span>2 DHCP<span class="jill"></span>报文格式</span></div></div><div id="aJzwZJpgDoQDf5m31dSpaS" class="wolai-block wolai-text"><div><span class="inline-wrap">图<span class="jill"></span>1<span class="jill"></span>是<span class="jill"></span>dhcp<span class="jill"></span>整个报文的封装格式，包括链路层头、IP<span class="jill"></span>头、UDP<span class="jill"></span>头和<span class="jill"></span>DHCP<span class="jill"></span>报文，其中<span class="jill"></span>dhcp<span class="jill"></span>主要的数据都封装在<span class="jill"></span>dhcp<span class="jill"></span>报文中。</span></div></div><div id="pqBGE1gxmrp1XT37qVdsap" class="wolai-block wolai-text"><div><span class="inline-wrap">图<span class="jill"></span>2 就是<span class="jill"></span>DHCP<span class="jill"></span>报文的格式，各字段的说明如下：</span></div></div><div id="vrkzm1AX6Ptctg1LaNzA6T" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>op</b></span><span class="inline-wrap">：1byte,是报文的操作类型，分为请求报文和响应报文，1<span class="jill"></span>为请求报文；2<span class="jill"></span>为响应报文。具体的报文类型在<span class="jill"></span>option<span class="jill"></span>字段中标识。</span></div></div><div id="m86XtqeorGFoXPfH8Pkw63" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>htype</b></span><span class="inline-wrap">：1byte,表示<span class="jill"></span>client<span class="jill"></span>硬件地址的类型，1<span class="jill"></span>表示以太网类型。</span></div></div><div id="4R9woBjw9jjdAsKnLHzEMN" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>hlen</b></span><span class="inline-wrap">：1byte，硬件地址的长度，以太网的硬件地址长度为<span class="jill"></span>6bytes。</span></div></div><div id="k8p6znh53FxL4N7P2RgoKP" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>hops</b></span><span class="inline-wrap">：1byte，表示当前<span class="jill"></span>dhcp<span class="jill"></span>报文经过的<span class="jill"></span>DHCP<span class="jill"></span>中继的数目，每经过一个<span class="jill"></span>DHCP<span class="jill"></span>中继这个字段就加<span class="jill"></span>1.</span></div></div><div id="8pP6hrjTFVUbZ6YwuX244A" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>xid</b></span><span class="inline-wrap">：4bytes，由<span class="jill"></span>client<span class="jill"></span>端产生的随机数，用于匹配请求和应答报文，就是匹配应答报文是对哪个请求报文做出应答。</span></div></div><div id="oeeiTiGkfXW6TxYDyH7cRU" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>secs</b></span><span class="inline-wrap">：2bytes，客户端进入<span class="jill"></span>IP<span class="jill"></span>地址申请进程的时间或者更新<span class="jill"></span>IP<span class="jill"></span>地址进程的时间；由客户端软件根据情况设定。目前没有使用，固定为<span class="jill"></span>0。</span></div></div><div id="5S68MhYecNzAajsr12tL5P" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>flags</b></span><span class="inline-wrap">：2bytes，是标志字段，16<span class="jill"></span>比特中只使用了最高位比特（即最左边的比特），这个个比特是广播响应标识位，用来标识<span class="jill"></span>DHCP<span class="jill"></span>服务器发出的响应报文是广播还是单播，0<span class="jill"></span>是单播，1<span class="jill"></span>是广播。其余的比特位保留不用，都为<span class="jill"></span>0.</span></div></div><div id="wgUvmgzWnyGXhZZVk6pSwW" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>ciaddr</b></span><span class="inline-wrap">：4bytes，是客户端的<span class="jill"></span>IP<span class="jill"></span>地址，可以是<span class="jill"></span>client<span class="jill"></span>自己的<span class="jill"></span>IP<span class="jill"></span>地址，也可以是<span class="jill"></span>server<span class="jill"></span>分配给<span class="jill"></span>client<span class="jill"></span>的<span class="jill"></span>IP<span class="jill"></span>地址。</span></div></div><div id="9crg3tcciyetMvgMqCKy4t" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>yiaddr</b></span><span class="inline-wrap">(Your IP Address)：4bytes，是<span class="jill"></span>server<span class="jill"></span>分配给<span class="jill"></span>client<span class="jill"></span>的<span class="jill"></span>IP<span class="jill"></span>地址。</span></div></div><div id="oGTY5fArmNNZKazj4bkdz3" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>siaddr</b></span><span class="inline-wrap">：4bytes，是<span class="jill"></span>client<span class="jill"></span>端获取<span class="jill"></span>IP<span class="jill"></span>地址等信息的<span class="jill"></span>server<span class="jill"></span>端的地址。</span></div></div><div id="jx2EaG6ZoZa42xeEsZ3qoH" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>giaddr</b></span><span class="inline-wrap">：4bytes，是<span class="jill"></span>client<span class="jill"></span>发出请求报文后经过的第一个中继的<span class="jill"></span>IP<span class="jill"></span>地址。</span></div></div><div id="f8xDPg1k3jDCm5Sk7UTpnf" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>chaddr</b></span><span class="inline-wrap">：16bytes，是<span class="jill"></span>client<span class="jill"></span>端的硬件地址，在<span class="jill"></span>client<span class="jill"></span>发出报文时会把自己网卡的硬件地址写进这个字段。</span></div></div><div id="8Uo7tFE5Dru6L9shX8Fcyr" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>sname</b></span><span class="inline-wrap">：64bytes，服务器主机名，是<span class="jill"></span>client<span class="jill"></span>端获取<span class="jill"></span>IP<span class="jill"></span>地址等信息的服务器名称。</span></div></div><div id="fFrYksr3NkCKC2V1ju1goJ" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>file</b></span><span class="inline-wrap">：128bytes，是<span class="jill"></span>client<span class="jill"></span>的启动配置文件名，是服务器为<span class="jill"></span>client<span class="jill"></span>指定的启动配置文件名及路径信息，由服务器填写。</span></div></div><div id="kuE6SaSseCFaEx1uDGcb5d" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>options</b></span><span class="inline-wrap">：是可选变长的选项字段，这个字段包含了终端的初始配置信息和网络配置信息，包括报文类型，有效租期，DNS<span class="jill"></span>服务器的<span class="jill"></span>IP<span class="jill"></span>地址等配置信息。</span></div></div><div id="uZNb9oo9TXHvPcFE8MCdb4" class="wolai-block wolai-text"><div><span class="inline-wrap">这个字段的结构采用“CLV”结构，如图<span class="jill"></span>4：</span></div></div><div id="4iJ4udDrs4yFynMnHKwYyd" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://img-blog.csdnimg.cn/20190420130236205.png" style="width: 530.4px"/></figure></div><div id="uTd78vSwGDHZ384ysBT7Yb" class="wolai-block wolai-text"><div><span class="inline-wrap">图<span class="jill"></span>4 option<span class="jill"></span>字段编码方式</span></div></div><div id="c8ockuj1DC8puQoCPEe413" class="wolai-block wolai-text"><div><span class="inline-wrap">其中”code”是标识号，唯一标识后面的信息内容(vlaue),1bytes；</span></div></div><div id="4595eUm3E63Q6hTsPhUoZB" class="wolai-block wolai-text"><div><span class="inline-wrap">“length”表示后面的<span class="jill"></span>value<span class="jill"></span>值的长度，1bytes</span></div></div><div id="fMzTAHBibmCTh4WWMDqXW3" class="wolai-block wolai-text"><div><span class="inline-wrap">“vlaue”是信息内容</span></div></div><div id="cxEf2pr4bonX5aPsxc54oY" class="wolai-block wolai-text"><div><span class="inline-wrap">Options<span class="jill"></span>字段有很多项，是可选的，不同的报文<span class="jill"></span>option<span class="jill"></span>项可能不同，图<span class="jill"></span>5<span class="jill"></span>是一个<span class="jill"></span>DHCP request<span class="jill"></span>报文的<span class="jill"></span>option<span class="jill"></span>项：</span></div></div><div id="qeDdKrH4Zi8HcofmcFYSxU" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://img-blog.csdnimg.cn/20190420130252714.png" style="width: 356.8px"/></figure></div><div id="eTihKk9vNFRetEYRgNiQa" class="wolai-block wolai-text"><div><span class="inline-wrap">图<span class="jill"></span>5 option<span class="jill"></span>项</span></div></div><div id="jVi6XZo2NWodwyEisdyVaM" class="wolai-block wolai-text"><div><span class="inline-wrap">不同的<span class="jill"></span>option<span class="jill"></span>项有不同的含义，下面是一些常见的<span class="jill"></span>option<span class="jill"></span>项：</span></div></div><div id="7RYANSPW3negFn9kvCqDBM" class="wolai-block wolai-text"><div><span class="inline-wrap">（1）DHCP Message Type： code=53  length=1 表示<span class="jill"></span>DHCP<span class="jill"></span>的报文类型。</span></div></div><div id="o8GBYR4xkh4zoi2B8D9ZWm" class="wolai-block wolai-text"><div><span class="inline-wrap">（2）Client identifier:      code=61   client<span class="jill"></span>端的硬件地址</span></div></div><div id="kRgVxgK4QChB3rJfEfhExj" class="wolai-block wolai-text"><div><span class="inline-wrap">（3）Server identifier:     code=54   服务器的<span class="jill"></span>IP<span class="jill"></span>地址</span></div></div><div id="dNW7di6JCYkMagESE3RuXw" class="wolai-block wolai-text"><div><span class="inline-wrap">（4）Subnet Mask:     code=1      子网掩码</span></div></div><div id="rtBdTzbbwobrZ8GoegjHxx" class="wolai-block wolai-text"><div><span class="inline-wrap">（5）route:           code=3      网关<span class="jill"></span>IP<span class="jill"></span>地址</span></div></div><div id="4fwXHSD5H5JuRVpEG1dUeU" class="wolai-block wolai-text"><div><span class="inline-wrap">（6）Domain Name Server: code=6    DNS<span class="jill"></span>服务器的<span class="jill"></span>IP<span class="jill"></span>地址</span></div></div><div id="qyyTPmvLd8eNjtbGktrj4Y" class="wolai-block wolai-text"><div><span class="inline-wrap">（7）IP Address Lease Time: code=51  租约时间</span></div></div><div id="6pPxA1fArCZy5354r7FHyM" class="wolai-block wolai-text"><div><span class="inline-wrap">Dhcp<span class="jill"></span>协议一共有<span class="jill"></span>8<span class="jill"></span>中报文，包括：DHCPDISCOVERY，DHCPOFFER，DHCPREQUEST，DHCPACK，DHCPNAK，DHCPRELEASE，DHCPDECLINE，DHCPINFORM。</span></div></div><div id="iGULfT5z4QepUaWxGJwBHK" class="wolai-block wolai-text"><div><span class="inline-wrap">报文类型由<span class="jill"></span>options<span class="jill"></span>字段中的<span class="jill"></span>option53“DHCP Message Type”选项来确定。各报文的具体含义如下：</span></div></div><div id="n76eV2zPKqrL1HFdk4r4Yi" class="wolai-block wolai-text"><div><span class="inline-wrap">（1），</span><span class="inline-wrap"><b>DHCP-DISCOVER****报文</b></span><span class="inline-wrap">：0x01  </span><span class="inline-wrap"><b>客户端请求包</b></span></div></div><div id="KTrCq5SfCJCYRfwY5aEoj" class="wolai-block wolai-text"><div><span class="inline-wrap">这个报文是<span class="jill"></span>client<span class="jill"></span>端开始<span class="jill"></span>dhcp<span class="jill"></span>过程的第一个请求报文，client<span class="jill"></span>在请求地址时，并不知道<span class="jill"></span>server<span class="jill"></span>端的位置，所以<span class="jill"></span>client<span class="jill"></span>会以广播的方式发送请求报文，它的目的是发现网络中的服务器。</span></div></div><div id="3ifdCknaoEDTSnQL4CSeh1" class="wolai-block wolai-text"><div><span class="inline-wrap">（2），</span><span class="inline-wrap"><b>DHCP-OFFER****报文</b></span><span class="inline-wrap">： 0x02  </span><span class="inline-wrap"><b>服务器响应包</b></span></div></div><div id="8gN2mSHx2riNtdTLHNH1MB" class="wolai-block wolai-text"><div><span class="inline-wrap">这个报文<span class="jill"></span>server<span class="jill"></span>端对<span class="jill"></span>DISCOVERY<span class="jill"></span>报文的响应报文。会在所配置的地址池中查找一个合适的<span class="jill"></span>IP<span class="jill"></span>地址，加上相应的租约期限和其他配置信息（如<span class="jill"></span>GATEWAY，DNS SERVER<span class="jill"></span>等），构造一个<span class="jill"></span>OFFER<span class="jill"></span>报文，发送给用户，告知用户本<span class="jill"></span>SERVER<span class="jill"></span>可以为其提供<span class="jill"></span>IP<span class="jill"></span>地址的分配，并且。发<span class="jill"></span>OFFER<span class="jill"></span>报文一般是单播的方式发送。</span></div></div><div id="eT7H83x5wWPS5ASAMyzskG" class="wolai-block wolai-text"><div><span class="inline-wrap">（3），</span><span class="inline-wrap"><b>DHCP-REQUEST****报文</b></span><span class="inline-wrap">：0x03 </span><span class="inline-wrap"><b>客户端选择包</b></span></div></div><div id="ejB1KvrFQabCBVWVXdtnNb" class="wolai-block wolai-text"><div><span class="inline-wrap">在一个子网中可能有多台服务器，所有收到<span class="jill"></span>DISCOVER<span class="jill"></span>报文的服务器都会回应<span class="jill"></span>OFFER<span class="jill"></span>报文，所以<span class="jill"></span>client<span class="jill"></span>端可能收到多个<span class="jill"></span>OFFER<span class="jill"></span>报文，通常会选择第一个<span class="jill"></span>OFFER<span class="jill"></span>报文的服务器作为自己的目标服务器，并回应一个<span class="jill"></span>REQUEST<span class="jill"></span>请求报文。在续租约的时候<span class="jill"></span>client<span class="jill"></span>端也会发送<span class="jill"></span>REQUEST<span class="jill"></span>报文<span class="jill"></span>  请求续租期。</span></div></div><div id="5qdTdpR8MgKyz16EpHxqtd" class="wolai-block wolai-text"><div><span class="inline-wrap">（4），</span><span class="inline-wrap"><b>DHCP-ACK****报文</b></span><span class="inline-wrap">：0x05  </span><span class="inline-wrap"><b>服务器确认包</b></span></div></div><div id="nW6TbvQsRzuEWo5o7LQrTR" class="wolai-block wolai-text"><div><span class="inline-wrap">是<span class="jill"></span>server<span class="jill"></span>对<span class="jill"></span>client<span class="jill"></span>端的<span class="jill"></span>REQUEST<span class="jill"></span>报文的确认响应报文，server<span class="jill"></span>在收到<span class="jill"></span>REQUEST<span class="jill"></span>报文后，根据<span class="jill"></span>REQUEST<span class="jill"></span>报文中携带的<span class="jill"></span>client MAC<span class="jill"></span>来查找有没有相应的租约记录，如果有则发送<span class="jill"></span>ACK<span class="jill"></span>报文作为回应，通知<span class="jill"></span>client<span class="jill"></span>可以使用分配的<span class="jill"></span>IP<span class="jill"></span>地址。</span></div></div><div id="jHkj3WGg1zSHukCLGENwSG" class="wolai-block wolai-text"><div><span class="inline-wrap">（5），</span><span class="inline-wrap"><b>DHCP-NAK****报文</b></span><span class="inline-wrap">：0x06  </span><span class="inline-wrap"><b>服务器拒绝包</b></span></div></div><div id="dZ1aCyDEZUZwhuLzMvajK4" class="wolai-block wolai-text"><div><span class="inline-wrap">Server<span class="jill"></span>端对<span class="jill"></span>client<span class="jill"></span>端的<span class="jill"></span>REQUEST<span class="jill"></span>报文的拒绝响应报文，如果服务器没有相应的租约记录，就会发送<span class="jill"></span>NAK<span class="jill"></span>报文给<span class="jill"></span>client<span class="jill"></span>端。</span></div></div><div id="tDLLz3qhpkFxs7zFuB4rK4" class="wolai-block wolai-text"><div><span class="inline-wrap">（6），</span><span class="inline-wrap"><b>DHCP-RELEASE****报文</b></span><span class="inline-wrap">：0x07 </span><span class="inline-wrap"><b>客户端释放包</b></span></div></div><div id="Agad1FjT4ERkoBcyL8iGv" class="wolai-block wolai-text"><div><span class="inline-wrap">Client<span class="jill"></span>端主动释放<span class="jill"></span>server<span class="jill"></span>端分配给它的<span class="jill"></span>IP<span class="jill"></span>是，就会发送<span class="jill"></span>DHCP-RELEASE<span class="jill"></span>报文给<span class="jill"></span>server，server<span class="jill"></span>收到这个报文后，就会回收这个<span class="jill"></span>IP<span class="jill"></span>地址。</span></div></div><div id="7XQKXAvowGdABe7QUhRjP7" class="wolai-block wolai-text"><div><span class="inline-wrap">（7），</span><span class="inline-wrap"><b>DHCP-DECLINE****报文</b></span><span class="inline-wrap">：0x04</span></div></div><div id="sJyC87QZEp3FXPRLKDuPVR" class="wolai-block wolai-text"><div><span class="inline-wrap">client<span class="jill"></span>收到<span class="jill"></span>server<span class="jill"></span>回应的<span class="jill"></span>ACK<span class="jill"></span>报文后，通过地址冲突检测发现 SERVER<span class="jill"></span>分配的地址冲突或由于其它原因导致不能使用，则发送<span class="jill"></span>DHCP-DECLINE<span class="jill"></span>报文，通知<span class="jill"></span>server<span class="jill"></span>所分配的<span class="jill"></span>IP<span class="jill"></span>地址不可用。</span></div></div><div id="hVXXuBXK7D7xyJRj7B8UNx" class="wolai-block wolai-text"><div><span class="inline-wrap">（8），</span><span class="inline-wrap"><b>DHCP-INFORM****报文</b></span><span class="inline-wrap">：0x08</span></div></div><div id="wWhNE15WG1wNBhc7zux8MX" class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>client<span class="jill"></span>已经获得了<span class="jill"></span>IP<span class="jill"></span>地址，需要从<span class="jill"></span>server<span class="jill"></span>端获得更详细的配置信息时，就会发送<span class="jill"></span>DHCP-INFORM<span class="jill"></span>报文向<span class="jill"></span>server<span class="jill"></span>请求，server<span class="jill"></span>在收到这个报文后，会根据租约查找，找到相应的配置信息后，就会回应<span class="jill"></span>DHCP-ACK<span class="jill"></span>报文给<span class="jill"></span>client。</span></div></div><h2 id="9nZ7uJynmSjWa45PQ1yNxi" class="wolai-block"><span class="inline-wrap">1.4 DHCP<span class="jill"></span>协议工作过程</span></h2><h3 id="wPBzK1VadHEgc5yHAtn6m2" class="wolai-block"><span class="inline-wrap">1.4.1 动态获取<span class="jill"></span>IP<span class="jill"></span>过程</span></h3><div id="mWgRg48WzPQtQTWVBaoRtW" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://img-blog.csdnimg.cn/20190420125726564.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NjYW5mX2xpbnV4,size_16,color_FFFFFF,t_70" style="width: 446.4px"/></figure></div><div id="3tRJz12bbse9kvPsb2HRZE" class="wolai-block wolai-text"><div><span class="inline-wrap">图<span class="jill"></span>5 DHCP<span class="jill"></span>工作流程</span></div></div><div id="fAFNXkHm3YyNvH1ByFTHWu" class="wolai-block wolai-text"><div><span class="inline-wrap">1.2.1.1 抓包过程</span></div></div><div id="wsWsXiv97c9FsQvhxHaUKD" class="wolai-block wolai-text"><div><span class="inline-wrap">(1)在<span class="jill"></span>Wireshark<span class="jill"></span>中点击<span class="jill"></span>start<span class="jill"></span>开始抓包，在过滤栏输入<span class="jill"></span>bootp，使其只显示<span class="jill"></span>DHCP<span class="jill"></span>数据包</span></div></div><div id="o3gqQcXUFVC1MxB8DmixgM" class="wolai-block wolai-text"><div><span class="inline-wrap">（2）在<span class="jill"></span>win10 中的<span class="jill"></span>cmd<span class="jill"></span>输入<span class="jill"></span>ipconfig /release <span class="jill"></span>先断开当前的网络连接，主机号变为<span class="jill"></span>0.0.0.0，主机与网络断开，不能访问网络。</span></div></div><div id="d4dJwCQvztgNjBsx9Ma71Z" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://img-blog.csdnimg.cn/2019042012582478.png" style="width: 249.6px"/></figure></div><div id="uZvBA1KfVfURv4Tjmkkc32" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://img-blog.csdnimg.cn/20190420125835106.png" style="width: 446.4px"/></figure></div><div id="iyrtHsNAfmsC5ZL3TW9793" class="wolai-block wolai-text"><div><span class="inline-wrap">图<span class="jill"></span>6 断开网络配置图</span></div></div><div id="iJBvbFjH3xsUkvZ4Vw27nE" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://img-blog.csdnimg.cn/20190420125841219.png" style="width: 441.6px"/></figure></div><div id="o6YxZRrRRLUREydxV26CSS" class="wolai-block wolai-text"><div><span class="inline-wrap">图<span class="jill"></span>7 释放包</span></div></div><div id="f6SNKKCF5P1zAXQrQ8LmZw" class="wolai-block wolai-text"><div><span class="inline-wrap">（3）在<span class="jill"></span>cmd<span class="jill"></span>中输入<span class="jill"></span>ipconfig /renew 请求网络连接，也为客户端分配了<span class="jill"></span>IP<span class="jill"></span>地址。</span></div></div><div id="7SwHbh8nqTefRDbUsdi3Vg" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://img-blog.csdnimg.cn/20190420125847263.png" style="width: 291.2724px"/></figure></div><div id="juAbwaHLoV1QUvcPP9pNke" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://img-blog.csdnimg.cn/20190420125858502.png" style="width: 446.4px"/></figure></div><div id="7r3nq6KTowFCD9QkHyycj4" class="wolai-block wolai-text"><div><span class="inline-wrap">图<span class="jill"></span>8 再次请求网络配置图</span></div></div><div id="9Vf8UwoyVMNC6A4kAtdrBG" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://img-blog.csdnimg.cn/20190420125903916.png" style="width: 446.4px"/></figure></div><div id="qbcjDk144JupRae23LbggJ" class="wolai-block wolai-text"><div><span class="inline-wrap">图<span class="jill"></span>9 新增数据包</span></div></div><div id="9YEEHb4V7bY37vMYLrS1qC" class="wolai-block wolai-text"><div><span class="inline-wrap">此时，可以看到在<span class="jill"></span>Wireshark<span class="jill"></span>中新增了<span class="jill"></span>4<span class="jill"></span>个<span class="jill"></span>DHCP<span class="jill"></span>数据包：   
数据包<span class="jill"></span>1：DHCP Discover   
数据包<span class="jill"></span>2：DHCP Offer   
数据包<span class="jill"></span>3：DHCP Request   
数据包<span class="jill"></span>4：DHCP ACK</span></div></div><div id="kvLaDAjVGARUmoZAEwZM3o" class="wolai-block wolai-text"><div><span class="inline-wrap">1.4.1.2 DHCP<span class="jill"></span>四个阶段</span></div></div><div id="4W3hVhmQyDvm7XkVGbobU4" class="wolai-block wolai-text"><div><span class="inline-wrap">DHCP<span class="jill"></span>动态获取<span class="jill"></span>IP<span class="jill"></span>地址的过程主要分为发现阶段、提供阶段、选择阶段、确认阶段四个阶段。</span></div></div><div id="amF54WfP97E4xrzdew2AXZ" class="wolai-block wolai-text"><div><span class="inline-wrap">(1)</span><span class="inline-wrap"><b>发现阶段：</b></span><span class="inline-wrap"> client<span class="jill"></span>端在局域网内以广播的方式发起一个<span class="jill"></span>DHCP Discover<span class="jill"></span>包，目的是在子网络中发现能够给<span class="jill"></span>client<span class="jill"></span>端提供<span class="jill"></span>IP<span class="jill"></span>地址的<span class="jill"></span>server<span class="jill"></span>端。</span></div></div><div id="onTVZXmgnF1ioqvgqnnabf" class="wolai-block wolai-text"><div><span class="inline-wrap">UDP 目标端口号为<span class="jill"></span>67 源<span class="jill"></span>IP 地址<span class="jill"></span>0.0.0.0    <span class="jill"></span>目的<span class="jill"></span>IP:255.255.255.255</span></div></div><div id="prTMsJ5kYYs1t8Ma9XWou2" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://img-blog.csdnimg.cn/20190420131641284.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NjYW5mX2xpbnV4,size_16,color_FFFFFF,t_70" style="width: 445.6px"/></figure></div><div id="bAm6H24GS3Fp1ACFFujnhD" class="wolai-block wolai-text"><div><span class="inline-wrap">图<span class="jill"></span>10  DHCP discover<span class="jill"></span>包</span></div></div><div id="4B1FYhHJb6p1Zq2LoqMT7d" class="wolai-block wolai-text"><div><span class="inline-wrap">(2)</span><span class="inline-wrap"><b>提供阶段：</b></span><span class="inline-wrap"> 局域网中<span class="jill"></span>DHCP server<span class="jill"></span>接受到<span class="jill"></span>Discover<span class="jill"></span>包之后，通过发送<span class="jill"></span>DHCP offer<span class="jill"></span>包给<span class="jill"></span>client<span class="jill"></span>端应答，主要是告知<span class="jill"></span>client<span class="jill"></span>端可以提供<span class="jill"></span>IP<span class="jill"></span>地址，以及相应的<span class="jill"></span>IP<span class="jill"></span>地址租约信息和其他配置信息也会在其中。</span></div></div><div id="vVsEERjoAbaqKAEHAvoMAs" class="wolai-block wolai-text"><div><span class="inline-wrap">UDP 目标<span class="jill"></span>68    源<span class="jill"></span>IP<span class="jill"></span>为<span class="jill"></span>DHCP<span class="jill"></span>服务器的<span class="jill"></span>IP   目的<span class="jill"></span>IP:255.255.255.255</span></div></div><div id="oasffxHqna561sg6ATxkKU" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://img-blog.csdnimg.cn/20190420131657476.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NjYW5mX2xpbnV4,size_16,color_FFFFFF,t_70" style="width: 445.6px"/></figure></div><div id="vfqUqPoSBLSSQeF8uHR35x" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div id="h7hVEBV8FJaXCzuvnhga3" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://img-blog.csdnimg.cn/2019042013194075.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NjYW5mX2xpbnV4,size_16,color_FFFFFF,t_70" style="width: 319.2px"/></figure></div><div id="iQbk9AWt2rWy926xAo2SYe" class="wolai-block wolai-text"><div><span class="inline-wrap">图<span class="jill"></span>11 DHCP offer<span class="jill"></span>包</span></div></div><div id="ibZPXiWHBf6txJF2vgTt2U" class="wolai-block wolai-text"><div><span class="inline-wrap">(3)</span><span class="inline-wrap"><b>选择阶段：</b></span><span class="inline-wrap"> 在<span class="jill"></span>client<span class="jill"></span>端可能会接受到多个<span class="jill"></span>offer<span class="jill"></span>包，通常<span class="jill"></span>clientdaunt<span class="jill"></span>只会接受收到的第一个<span class="jill"></span>DHCP offer<span class="jill"></span>报文，然后<span class="jill"></span>client<span class="jill"></span>端就会以广播的方式发送一个<span class="jill"></span>DHCP request<span class="jill"></span>报文请求分配<span class="jill"></span>IP<span class="jill"></span>地址。</span></div></div><div id="29fuz5p2qS2TEyUCcXXiLw" class="wolai-block wolai-text"><div><span class="inline-wrap">UDP 目标<span class="jill"></span>67    源<span class="jill"></span>IP<span class="jill"></span>为<span class="jill"></span>0.0.0.0   目的<span class="jill"></span>IP:255.255.255.255</span></div></div><div id="f9nGGKqjXyuWLk6NhMFirT" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://img-blog.csdnimg.cn/20190420132015698.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NjYW5mX2xpbnV4,size_16,color_FFFFFF,t_70" style="width: 445.6px"/></figure></div><div id="uvLTHwHLekxAjrTCEdgGM" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div id="pZqeuPvyvm8keH9MmxqGdA" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://img-blog.csdnimg.cn/20190420132024830.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NjYW5mX2xpbnV4,size_16,color_FFFFFF,t_70" style="width: 374.4px"/></figure></div><div id="bnTRrT1TihrCFyEAGJHWmh" class="wolai-block wolai-text"><div><span class="inline-wrap">图<span class="jill"></span>12 DHCP REQUEST<span class="jill"></span>包</span></div></div><div id="ebAXVLnwgoJQjcyngTmcuk" class="wolai-block wolai-text"><div><span class="inline-wrap">(4)确认阶段：server<span class="jill"></span>端在收到<span class="jill"></span>DHCP request<span class="jill"></span>报文之后，会判断”option”字段的<span class="jill"></span>serverIP<span class="jill"></span>地址是否是自己的<span class="jill"></span>IP<span class="jill"></span>地址，如果符合分配<span class="jill"></span>IP<span class="jill"></span>地址的条件，就会给<span class="jill"></span>client<span class="jill"></span>发送一个<span class="jill"></span>DHCP ACK<span class="jill"></span>包，如果不满足就发挥发送一个<span class="jill"></span>DHCP NAK 包。</span></div></div><div id="pPMcUErEnX2VnY4aer5FnP" class="wolai-block wolai-text"><div><span class="inline-wrap">UDP 目标<span class="jill"></span>68 源<span class="jill"></span>IP<span class="jill"></span>为<span class="jill"></span>DHCP<span class="jill"></span>服务器的<span class="jill"></span>IP 目的<span class="jill"></span>IP:255.255.255.255</span></div></div><div id="jvUGhoX2VWuLL2EY4utM5b" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://img-blog.csdnimg.cn/20190420132032688.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NjYW5mX2xpbnV4,size_16,color_FFFFFF,t_70" style="width: 446.4px"/></figure></div><div id="wqhbqyjT5sSvjVfbypJxAK" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div id="fJ5KQw3FZVCAmJf6GoH3AC" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://img-blog.csdnimg.cn/20190420132037540.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NjYW5mX2xpbnV4,size_16,color_FFFFFF,t_70" style="width: 445.6px"/></figure></div><div id="qyFNZ5Bc8sgDNCwZx8L8b3" class="wolai-block wolai-text"><div><span class="inline-wrap">图<span class="jill"></span>13 DHCP ACK 包</span></div></div><div id="3DrHJ5moktdqGs6Fef4TaD" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>注意：客户端执行<span class="jill"></span>DHCP-DISCOVER</b></span><span class="inline-wrap">后，如果没有</span><span class="inline-wrap"><b>DHCP</b></span><span class="inline-wrap">服务器响应客户端的请求，客户端会随机使用</span><span class="inline-wrap"><b>169.254.0.0/16</b></span><span class="inline-wrap">网段中的一个</span><span class="inline-wrap"><b>IP</b></span><span class="inline-wrap">地址配置到本机地址。 </span></div></div><div id="e4HGADAEgRDAF5cKHLcdJk" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>169.254.0.0/16<span class="jill"></span>是</b></span><span class="inline-wrap">Windows</span><span class="inline-wrap"><b>的自动专有</b></span><span class="inline-wrap">IP</span><span class="inline-wrap"><b>寻址范围，也就是在无法通过</b></span><span class="inline-wrap">DHCP</span><span class="inline-wrap"><b>获取</b></span><span class="inline-wrap">IP</span><span class="inline-wrap"><b>地址时，由系统自动分配的</b></span><span class="inline-wrap">IP****地址段。 </span></div></div><h3 id="rSf3Zur7EiHU9pQJGaKsKF" class="wolai-block"><span class="inline-wrap">1.4.2 续约租期</span></h3><div id="8wppB4cvURjekKRCVUXj6V" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://img-blog.csdnimg.cn/20190420125944958.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NjYW5mX2xpbnV4,size_16,color_FFFFFF,t_70" style="width: 446.4px"/></figure></div><div id="dB54EWRzM5HTAxvnLXSR4B" class="wolai-block wolai-text"><div><span class="inline-wrap">图<span class="jill"></span>14 续约租期过程</span></div></div><div id="irYCwiE6f9JrLiwDtMjGvK" class="wolai-block wolai-text"><div><span class="inline-wrap">（1）当<span class="jill"></span>clientIP<span class="jill"></span>地址已经用到<span class="jill"></span>50%<span class="jill"></span>的时间，续租一下，client<span class="jill"></span>端就会以单播形式向服务端发送一个<span class="jill"></span>DHCP Request<span class="jill"></span>包，当<span class="jill"></span>server<span class="jill"></span>响应时就会回应一个<span class="jill"></span>ACK<span class="jill"></span>包，会重新约定一个时间。</span></div></div><div id="vCrx6ZoxgPJBaUDEVXGpJN" class="wolai-block wolai-text"><div><span class="inline-wrap">（2）当<span class="jill"></span>clientIP<span class="jill"></span>地址已经用到<span class="jill"></span>50%<span class="jill"></span>的时间，续租一下，client<span class="jill"></span>端就会以单播形式向服务端发送一个<span class="jill"></span>DHCP Request<span class="jill"></span>包，server<span class="jill"></span>没有响应，client<span class="jill"></span>会继续使用，当使用到<span class="jill"></span>87.5%<span class="jill"></span>时，会在续租一次，同时就以广播的方式是发送一个<span class="jill"></span>request<span class="jill"></span>包，server<span class="jill"></span>这时收到响应以后，就会回应一个<span class="jill"></span>ACK<span class="jill"></span>包，重新约定一个时间。</span></div></div><div id="6uyZrMPa5KbmJVqCTRy89V" class="wolai-block wolai-text"><div><span class="inline-wrap">（3）当<span class="jill"></span>clientIP<span class="jill"></span>地址已经用到<span class="jill"></span>50%<span class="jill"></span>的时间，续租一下，client<span class="jill"></span>端就会以单播形式向服务端发送一个<span class="jill"></span>DHCP Request<span class="jill"></span>包，server<span class="jill"></span>没有响应，client<span class="jill"></span>会继续使用，当使用到<span class="jill"></span>87.5%<span class="jill"></span>时，会在续租一次，同时就以广播的方式是发送一个<span class="jill"></span>request<span class="jill"></span>包，如果<span class="jill"></span>server<span class="jill"></span>还是没有响应，client<span class="jill"></span>那就直接使用到过期。      </span></div></div><h3 id="ctd1aeyjjgxQzErAh9PyyP" class="wolai-block"><span class="inline-wrap">1.4.3 重新连接使用<span class="jill"></span>IP<span class="jill"></span>地址</span></h3><div id="4T5oo1gsJDy3abeG6qrrEk" class="wolai-block wolai-text"><div><span class="inline-wrap">Client<span class="jill"></span>端在重新登录网络的时候，可以不需要从初始阶段发送<span class="jill"></span>DHCP DISCOVER<span class="jill"></span>报文开始，可以直接广播发送<span class="jill"></span>DHCP REQUEST<span class="jill"></span>报文给服务器。</span></div></div><div id="sLVvLTzdPfjvJGM1KgkHVa" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://img-blog.csdnimg.cn/20190420132101571.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NjYW5mX2xpbnV4,size_16,color_FFFFFF,t_70" style="width: 412px"/></figure></div><h3 id="jpMrpR2J5Los7z41xoDXqK" class="wolai-block"><span class="inline-wrap">1.4.4 client<span class="jill"></span>主动释放<span class="jill"></span>IP<span class="jill"></span>地址</span></h3><div id="cLf5dZQPK6rhMkXHE4cMz1" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://img-blog.csdnimg.cn/20190420125952598.png" style="width: 446.4px"/></figure></div><div id="2aJLfoefPzSvVwEfDA9Vkg" class="wolai-block wolai-text"><div><span class="inline-wrap">图<span class="jill"></span>16 DHCP release<span class="jill"></span>报文</span></div></div></div><h2 id="fCxn1B88tgR9t9Et65XGrS" class="wolai-block"><span class="inline-wrap">工作方式</span></h2><div id="vLqfbeLkCmTSqvTyBCHvgY" class="wolai-block wolai-text"><div><span class="inline-wrap">DHCP<span class="jill"></span>使用客户-服务器方式，采用请求/应答方式工作。</span></div></div><div id="a3iuvoLn3q49PaTNpFMD6y" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>DHCP<span class="jill"></span>基于<span class="jill"></span>UDP<span class="jill"></span>工作，DHCP<span class="jill"></span>服务器运行在<span class="jill"></span>67<span class="jill"></span>号端口，DHCP<span class="jill"></span>客户运行在<span class="jill"></span>68<span class="jill"></span>号端口。</b></span></div></div><div id="h9Zhz3WPaZvNGVUkoLHXRH" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_9.png" style="width: 646.4px"/></figure></div><div id="pq54ahZbYtr1srttDPfim8" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_10.png" style="width: 100%"/></figure></div><div id="36sSo35DutNJBPHcNgrryB" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_11.png" style="width: 100%"/></figure></div><h2 id="h1z2R9MCmVSwkAAnbhTiHC" class="wolai-block"><span class="inline-wrap">DHCP 中继代理<span class="jill"></span>DHCPRelay(DHCPR)</span></h2><div id="5ERQ1xMnXvP5WYBEmZtTXM" class="wolai-block wolai-text"><div><span class="inline-wrap">并不是每个网络上都有<span class="jill"></span>DHCP<span class="jill"></span>服务器，这样会使<span class="jill"></span>DHCP<span class="jill"></span>服务器的数量太多。现在是每一个网络至少有一个<span class="jill"></span>DHCP<span class="jill"></span>中继代理，它配置了<span class="jill"></span>DHCP<span class="jill"></span>服务器的<span class="jill"></span>IP<span class="jill"></span>地址信息。</span></div></div><div id="f19m7hF6Hkw4CfR2UqRLnj" class="wolai-block wolai-text"><div><span class="inline-wrap">当 DHCP<span class="jill"></span>中继代理收到主机发送的发现报文后，就以单播方式向<span class="jill"></span>DHCP<span class="jill"></span>服务器转发此报文，并等待其回答。收到<span class="jill"></span>DHCP<span class="jill"></span>服务器回答的提供报文后，DHCP<span class="jill"></span>中继代理再将此提供报文发回给主机。</span></div></div><div id="7MyJxUtaSNoULWuuU25jfX" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_12.png" style="width: 100%"/></figure></div><h2 id="dLCgzg66of9dz1JF1DUTvH" class="wolai-block"><span class="inline-wrap">DHCP 租用期(lease period)</span></h2><div id="dNedzbuZ88zVQo4oysLAeN" class="wolai-block wolai-text"><div><span class="inline-wrap">DHCP<span class="jill"></span>服务器分配给<span class="jill"></span>DHCP<span class="jill"></span>客户的<span class="jill"></span>IP<span class="jill"></span>地址的临时的，因此<span class="jill"></span>DHCP<span class="jill"></span>客户只能在一段有限的时间内使用这个分配到的<span class="jill"></span>IP<span class="jill"></span>地址。DHCP<span class="jill"></span>协议称这段时间为租用期。</span></div></div><div id="hXLd6VnA49oo2ZXxZxv4mJ" class="wolai-block wolai-text"><div><span class="inline-wrap">租用期的数值应由<span class="jill"></span>DHCP<span class="jill"></span>服务器自己决定。</span></div></div><div id="jAqKsm5iKaBpHgFkqhTG3a" class="wolai-block wolai-text"><div><span class="inline-wrap">DHCP<span class="jill"></span>客户也可在自己发送的报文中（例如，发现报文）提出对租用期的要求。</span></div></div></div><h1 id="6XU18qqXsruFCA2vF6c9Nz" class="wolai-block"><span class="inline-wrap">因特网控制报文协议<span class="jill"></span>ICMP</span></h1><aside id="p4VhX7U4xsP5K6zq1KBent" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap">篇幅很大，要求不多</span></aside><div id="mcgqMHRw332VKxyQQ29A2d" class="wolai-sub-page wolai-block"><div class="page-icon"></div><a href="ipv4%E5%8D%8F%E8%AE%AE/icmp/icmp.html"><span>ICMP</span></a><h2 id="vps8Z8ZHYW1kJ7GT9GGC2t" class="wolai-block"><span class="inline-wrap">介绍</span></h2><div id="dHwjsTV8HtWQvnksP5Dxem" class="wolai-block wolai-text"><div><span class="inline-wrap">IP<span class="jill"></span>不能提供可靠的服务，为了更有效地转发 IP 数据报和提高交付成功的机会，在网络层使用了网际控制报文协议 ICMP (Internet Control MessageProtocol)来报告错误，并提供因特网中发生的最新情况给路由器。</span></div></div><div id="3HLULUEY8G77QYJTi1KrZT" class="wolai-block wolai-text"><div><span class="inline-wrap">ICMP<span class="jill"></span>是网络层比较重要的协议，主机或路由器报告差错情况和提供有关异常情况的报告。路由器主要利用该协议对数据报的传输过程进行监控。它也可以用来检测因特网，ICMP<span class="jill"></span>是在<span class="jill"></span>RFC792<span class="jill"></span>中定义的。</span></div></div><div id="iUYZqqbXMhtzNegkJHiSE8" class="wolai-block wolai-text"><div><span class="inline-wrap">ICMP<span class="jill"></span>通过将信息封装在<span class="jill"></span>IP<span class="jill"></span>分组中，并设置报头的协议字段为<span class="jill"></span>1<span class="jill"></span>来发送信息。但<span class="jill"></span>ICMP<span class="jill"></span>是<span class="jill"></span>IP<span class="jill"></span>层协议的一部分，不是高层协议。</span></div></div><h2 id="mSphNbZAdD58g4xATNG2yM" class="wolai-block"><span class="inline-wrap">参考文章</span></h2><div id="2CZcTePXHNE6TC5YRX4ZCw" class="wolai-sub-page wolai-block"><div class="page-icon"></div><a href="ipv4%E5%8D%8F%E8%AE%AE/icmp/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3icmp%E5%8D%8F%E8%AE%AE%20-%20%E7%9F%A5%E4%B9%8E/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3icmp%E5%8D%8F%E8%AE%AE%20-%20%E7%9F%A5%E4%B9%8E.html"><span>深入理解ICMP协议 - 知乎</span></a><div id="9BqZcdoedN3x5oSb5wjNy5" class="wolai-block wolai-text"><div><span class="inline-wrap">在日常工作中，我们经常需要判断网络是否连通，相信大家使用最多的命令就是 ping，traceroute 啦。大家都知道 ping/traceroute 命令是基于 ICMP 协议来实现的，那么什么是 ICMP 协议呢？ping/traceroute 命令又是如何基于 ICMP 实现的呢？  </span></div></div><div id="ibcLAuPKSz7UtnoxTrdunT" class="wolai-block wolai-text"><div><span class="inline-wrap">今天这篇文章，我们就来一起搞清楚其中的原理。下面首先我们先来了解一下<span class="jill"></span>ICMP 协议。</span></div></div><h2 id="fkUt4bfebpu3mkfdo9S8L7" class="wolai-block"><span class="inline-wrap"><b>ICMP<span class="jill"></span>协议</b></span></h2><div id="iEbLC3BjbfadacPW39a9je" class="wolai-block wolai-text"><div><span class="inline-wrap">ICMP<span class="jill"></span>是 Internet Control Message Protocol 的缩写，即互联网控制消息协议。它是互联网协议族的核心协议之一。它用于 TCP/IP 网络中发送控制消息，提供可能发生在通信环境中的各种问题反馈，通过这些信息，使网络管理者可以对所发生的问题作出诊断，然后采取适当的措施解决问题。</span></div></div><div id="4nkTyKKgGhUJabwkiDuMca" class="wolai-block wolai-text"><div><span class="inline-wrap">虽然 ICMP 是网络层协议，但是它不像 IP 协议和 ARP 协议一样直接传递给数据链路层，而是先封装成 IP 数据包然后再传递给数据链路层。</span><span class="inline-wrap"><b>所以在 IP 数据包中如果协议类型字段的值是 1 的话，就表示 IP 数据是 ICMP 报文。IP 数据包就是靠这个协议类型字段来区分不同的数据包的。</b></span><span class="inline-wrap">如下图 WireShark 抓包所示：</span></div></div><div id="pt9Q87uyBQt4qN8Z565aYb" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-7614b8422b03023ecfa1bd9150f504bb_b.jpg" style="width: 724px"/></figure></div><div id="dEHAKA6FTDBFho2ZNNB6Re" class="wolai-block wolai-text"><div><span class="inline-wrap">在 IP 通信中如果某个包因为未知原因没有到达目的地址，那么这个具体的原因就是由 ICMP 负责告知。而 ICMP 协议的类型定义中就清楚的描述了各种报文的含义。</span></div></div><h2 id="wqkjD7grW3kCRL73AHmjda" class="wolai-block"><span class="inline-wrap"><b>ICMP<span class="jill"></span>协议类型</b></span></h2><div id="qLPMBGUCtYpHzfDsiigV3K" class="wolai-block wolai-text"><div><span class="inline-wrap">ICMP<span class="jill"></span>协议的类型分为两大类，</span><span class="inline-wrap"><b>查询报文</b></span><span class="inline-wrap">和</span><span class="inline-wrap"><b>差错报文</b></span><span class="inline-wrap">。如下表：</span></div></div><div id="peKmD3sxRCBNCQD5tPATxF" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-4f259c166221946c2ef40960d360053c_b.jpg" style="width: 576px"/></figure></div><div id="oBk6kyhUmCkL7TpQEGE7ZM" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-621f5a7f9898466bb1ec4d097b3c141f_b.jpg" style="width: 576px"/></figure></div><div id="tPCqBAdvCYVi3Rdzsjc64Y" class="wolai-block wolai-text"><div><span class="inline-wrap"><i>是不是看起来有点多啊？计算机网络真的是博大精深啊。而平时我们经常使用的少之又少。</i></span></div></div><aside id="2SDfZgWM3uanoedcy1bFou" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap">PPT<span class="jill"></span>表格</span><div id="4uELKDVhiNM5hKj8XycTK3" class="wolai-block"><figure class="wolai-left" style="width: 100%"><img src="media/image_13.png" style="width: 100%"/></figure></div></aside><h2 id="cTVuHXDKkjgPW4UuEYU8fY" class="wolai-block"><span class="inline-wrap"><b>ICMP<span class="jill"></span>报文格式</b></span></h2><div id="b3pp2XNpx5jQbMsM6GqfS5" class="wolai-block wolai-text"><div><span class="inline-wrap">从 ICMP 的报文格式来说，ICMP 是 IP 的上层协议。但是 ICMP 是分担了 IP 的一部分功能。所以，他也被认为是与 IP 同层的协议。下面一起来看一下 ICMP 数据包格式和报文内容吧。具体参考下图：</span></div></div><div id="e7xvAeegwMzbgFwkvop1oh" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-ef5b42aff92acc5a8873d946d48177e4_b.jpg" style="width: 556.8px"/></figure></div><div id="fZvTZBwP6jPNhQk4Pr4UJh" class="wolai-block wolai-text"><div><span class="inline-wrap">可以看到，我们一层层剥开 ICMP 的外壳，查看其本质。方便我们更好的理解 ICMP 协议。  </span></div></div><h2 id="r3aaYMrt9F6Kh1svWtQSX9" class="wolai-block"><span class="inline-wrap"><b>ICMP<span class="jill"></span>协议实现--Ping<span class="jill"></span>命令</b></span></h2><div id="d5ZrSBEUhY3GKmbwn51pcP" class="wolai-block wolai-text"><div><span class="inline-wrap">通过上面的叙述，我们初步了解了 ICMP 协议的内容，那么下面我们来看一下<span class="jill"></span>ICMP 的具体实现与应用吧，首先我们来了解</span><span class="inline-wrap"><b>查询报文</b></span><span class="inline-wrap">的应用--ping，下面我们通过 ping 同一个子网的主机，来看一下整个过程是怎么样的。</span></div></div><div id="hssDob18gjKgJ421wRBJrB" class="wolai-block wolai-text"><div><span class="inline-wrap">那么比较完整的流程是：  </span></div></div><div id="5v6miYzwKeMXgYCzhDLDF" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>1. 向目的服务器发送回显请求</b></span><span class="inline-wrap">首先，向目的服务器上执行<span class="jill"></span>ping<span class="jill"></span>命令，主机会构建一个 ICMP 回显请求消息数据包（类型是<span class="jill"></span>8，代码是<span class="jill"></span>0），在这个回显请求数据包中，除了类型和代码字段，还被追加了标识符和序号字段。标识符和序号字段分别是 16 位的字段。ping 命令在发送回显请求数据包时，会将进程号填写在标识符里。对于序号，每送出一个数据包数值就增加<span class="jill"></span>1。而且，回显请求的选项数据部分用来装任意数据。这个任意数据用来调整 ping 的交互数据包的大小。如下图在 192.168.1.10<span class="jill"></span>上执行 ping 192.168.1.1<span class="jill"></span>的命令：</span></div></div><div id="4e2RAjjNf7NheqhWfCmtaE" class="wolai-block wolai-text"><div><span class="inline-wrap">ping 命令执行的时候，他的进程号是 43991：</span></div></div><div id="5yDLChYVwettJYAhyCC5xK" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-d8a328032435c1713659ae37411afdcc_b.jpg" style="width: 864px"/></figure></div><div id="w9N9eiig2GK4UrYFuTuefU" class="wolai-block wolai-text"><div><span class="inline-wrap">通过 WireShark 抓包可以看出，上图中的 192.168.1.10 主机会构建一个 ICMP 回显请求消息数据包。</span></div></div><div id="BKSiKYdtEk1oS5RdWz28H" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-d2161822052e99cd7e545a14dc965386_b.jpg" style="width: 100%"/></figure></div><div id="biJH2i1NwZjn28pjZFF5rx" class="wolai-block wolai-text"><div><span class="inline-wrap">上图中我们可以看到 ICMP 的 Type（协议类型）是 8，Code（代码）是 0，Identifier(ping<span class="jill"></span>进程号) 是 43991，同时还有 Sequence Number 发送序号<span class="jill"></span>11，以及发送时间 。</span></div></div><div id="3jMVJ32ZrQwh5xHMaPRmS7" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>2. 目的服务器发送回显应答</b></span></div></div><div id="rRKgihuYKXb2DGKXjWnVs3" class="wolai-block wolai-text"><div><span class="inline-wrap">当<span class="jill"></span>192.168.1.10<span class="jill"></span>送到 回显请求数据包后，192.168.1.1<span class="jill"></span>就会向发送方<span class="jill"></span>192.168.1.10<span class="jill"></span>发送回显应答（类型是<span class="jill"></span>0，代码是<span class="jill"></span>0），这个 ICMP 回显应答数据包在 IP 层来看，与被送来的回显请求数据包基本上一样。不同的只有源、目标 IP 地址字段被交换了，Type<span class="jill"></span>类型字段里填入了表示回显应答的<span class="jill"></span>0。通过 WireShark 抓包可以看出，如下图：</span></div></div><div id="cPFECcYpzVPDA3nkHvYQWB" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-6ac347e9fecb1feba27f11929f463fd7_b.jpg" style="width: 100%"/></figure></div><div id="5uTfpLxg7MNvxNncvN2QKG" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>3. 源服务器显示相关数据</b></span></div></div><div id="9EvNTecxP9YFqwtY16DMhv" class="wolai-block wolai-text"><div><span class="inline-wrap">如果源服务器可以接收到回显应答数据包，那我们就认为<span class="jill"></span>192.168.1.1<span class="jill"></span>是正常工作着的。进一步，记住发送回显请求数据包的时间，与接收到回显应答数据包的时间差，就能计算出数据包一去一回所需要的时间。这个时候<span class="jill"></span>ping<span class="jill"></span>命令就会将目的服务器的 IP 地址，数据大小，往返花费的时间打印到屏幕上。如下图：</span></div></div><div id="8WdnP56wiF7y1gZgjK4Xwm" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-b4d74f52d89436bc6e7fbcf9165e9ef8_b.jpg" style="width: 100%"/></figure></div><h2 id="rTEfghdkkcs5x8LdvJ4Rxt" class="wolai-block"><span class="inline-wrap"><b>ICMP<span class="jill"></span>协议实现--traceroute<span class="jill"></span>命令</b></span></h2><div id="dMZaL8B3RLpMXbwrMUPrmg" class="wolai-block wolai-text"><div><span class="inline-wrap">traceroute<span class="jill"></span>命令是一款充分利用 ICMP </span><span class="inline-wrap"><b>差错报文</b></span><span class="inline-wrap">类型的应用，其主要用作追踪路由信息，下面我们来逐个查看一下其工作原理。</span></div></div><div id="gtWfmBRYFwFyAs77dCkKk7" class="wolai-block wolai-text"><div><span class="inline-wrap">我们通过执行 traceroute 192.168.1.1，来分析一下他的原理，它的原理就是利用 IP 包的 TTL 从 1 开始按照顺序递增的同时发送 UDP 包，强制接收 ICMP 超时消息的方法。</span></div></div><div id="weG4E5oCfDFSyZ5DYGPh3Y" class="wolai-block wolai-text"><div><span class="inline-wrap">首先 traceroute 会将 IP 包的 TTL 设置 为 1，然后发送 UDP 包，他会填入一个端口号作为 UDP 目标端口号（默认是：33434-33534）。如下图：</span></div></div><div id="nupDVUqtrjd34dbooGmGCa" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-b94339a7a5f98df9a54e2c57a8e0335e_b.jpg" style="width: 576px"/></figure></div><div id="v6VUBkLNKmxMg8jptqBY1n" class="wolai-block wolai-text"><div><span class="inline-wrap">当目的主机收到 UDP 包后，会返回 ICMP 差错报文消息（类型 3，代码 3）。参照上面的表，该错报文类型是端口不可达，说明发送方发出的 UDP 包到达了目的主机。如下图：</span></div></div><div id="fwP484GhjdR7NXsoqxvMAW" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic3.zhimg.com/v2-fe105808fa75759d2bcbf902b95583b2_b.jpg" style="width: 576px"/></figure></div><div id="jwY4sGNFjcdKpJbAkCpywc" class="wolai-block wolai-text"><div><span class="inline-wrap">这样的过程，traceroute 就可以拿到了所有的路由器 IP，这样子就可以看到从源主机到目的主机过程中的所有路由信息。  </span></div></div><div id="cNZgc1ANXaxrbryUk9jCJa" class="wolai-block wolai-text"><div><span class="inline-wrap">当然实际情况有的路由器禁用 ICMP ，那么他就根本不会返回这个 ICMP 差错报文，所以是看不到中间经过的路由<span class="jill"></span>IP<span class="jill"></span>的。</span></div></div><blockquote id="kfawgUyrENAEaQrD9gNxre" class="wolai-block"><span class="inline-wrap">Tips：traceroute 在类 Unix/Linux 系统中默认使用的是 UDP 协议，也可以通过参数修改为使用 ICMP 协议；Windows 操作系统中只使用 ICMP 协议。</span></blockquote><div id="9LU6tyKL2p4YvB5AVVEYTG" class="wolai-block wolai-text"><div><span class="inline-wrap">说了这么多，我们还是直接来看一张图吧，基本可以描述清楚 traceroute 的整个过程。如下图：</span></div></div><div id="mV2jrJzCdVWb7FmjA9ybW4" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic1.zhimg.com/v2-1835f72b05f39288dd909bd059a55944_b.jpg" style="width: 576px"/></figure></div><h2 id="ntgkVMuFpnYRadTA385wYM" class="wolai-block"><span class="inline-wrap"><b>总结</b></span></h2><div id="wFvNGWsWEMEoChcc8Jffka" class="wolai-block wolai-text"><div><span class="inline-wrap">以上内容就是关于<span class="jill"></span>ICMP<span class="jill"></span>协议的全部内容啦，相信你看完本篇文章就可以深入理解每一次<span class="jill"></span>ping，traceroute<span class="jill"></span>背后的工作原理啦。好了，当我们深入学习完以上内容，当我们面对面试官的各种刁钻问题时，是不是游刃有余了呢？那么面试官一般都问些什么问题呢？这就给推荐牛客网，各种面试经历，还有在线面试模拟。</span></div></div><div id="cJyeHvEBDKFsX5QRSZFuoB" class="wolai-block wolai-text"><div><span class="inline-wrap">另外，欢迎添加我的微信公众号：矢量<span class="jill"></span>SRE</span></div></div><div id="5yzYxQuAqbvkE28fuNe5gM" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://pic4.zhimg.com/v2-7393ad246801c6a39f9e67b531fac477_b.jpg" style="width: 206.4px"/></figure></div></div><h1 id="ujAejXxeMtwXLPWQKFgx1j" class="wolai-block"><span class="inline-wrap">差错报文</span></h1><h2 id="7WvbQprVHNpvQZbLA23YYW" class="wolai-block"><span class="inline-wrap">差错报告</span></h2><div id="dStGYgtRth2hZ2AJBvKH7t" class="wolai-block wolai-text"><div><span class="inline-wrap">ICMP<span class="jill"></span>差错报文提供</span><span class="inline-wrap"><b>差错报告</b></span><span class="inline-wrap">，中间的路由器或目的端在处理<span class="jill"></span>IP<span class="jill"></span>报文时，如果发现错误，就向源端主机发送<span class="jill"></span>ICMP<span class="jill"></span>差错控制报文。主要包括：</span></div></div><div id="qrcjV9v7xpfGDCSok2hTsz" class="wolai-block wolai-text"><div><span class="inline-wrap">•目的无法到达(DestinationUnreachable),用于报告多种原因造成的<span class="jill"></span>IP<span class="jill"></span>报文无法到达的错误。</span></div></div><div id="7DrjQnym4xm1ckTSesEbfp" class="wolai-block wolai-text"><div><span class="inline-wrap">•超时(Time Exceeded)。 当<span class="jill"></span>IP<span class="jill"></span>分组中的生存期<span class="jill"></span>TTL<span class="jill"></span>字段减到<span class="jill"></span>0<span class="jill"></span>或重装定时器（在收到分组的第一个段时设置）到期时发送超时分组。类型值为<span class="jill"></span>11，码值为<span class="jill"></span>0<span class="jill"></span>或<span class="jill"></span>l。0<span class="jill"></span>表示<span class="jill"></span>TTL<span class="jill"></span>超时，而<span class="jill"></span>1<span class="jill"></span>表示重组超时 </span></div></div><div id="iMRSWB4ovzxiCSJmyhNtMV" class="wolai-block wolai-text"><div><span class="inline-wrap">•参数问题(ParameterProblem)报文用于报告<span class="jill"></span>IP<span class="jill"></span>报文头的错误。</span></div></div><h3 id="s4taWwtHE6KrCLVYoFeoJv" class="wolai-block"><span class="inline-wrap">详解</span></h3><div id="safMz8YMpVpGSsJeWj4g3A" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_14.png" style="width: 100%"/></figure></div><h4 id="71KvwKz5JyKk9AQpjsb5SE" class="wolai-block"><span class="inline-wrap">3 目的端不可达</span></h4><aside id="qNKh2woX5GWXxfYG3n1bUf" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap">也就是前面的差错报文类型<span class="jill"></span>3<span class="jill"></span>中由分出了<span class="jill"></span>13<span class="jill"></span>种可能</span></aside><div id="dHfJJKScyuwxZcLWHEypC3" class="wolai-row"><div id="8fj6xK1Yq3tf6dxNan3bBt" class="wolai-col" style="flex-grow: 0.5"><div id="53sjjFpBrozFcHpcE1g8nH" class="wolai-block"><figure class="wolai-left" style="width: 100%"><img src="media/image_15.png" style="width: 601.6px"/></figure></div></div><div id="uf7kb3xP9RfDUmvkPUZMR5" class="wolai-col" style="flex-grow: 0.5"><div id="mwn6cQM1aSNMZL348CnSoN" class="wolai-block"><figure class="wolai-left" style="width: 100%"><img src="media/image_16.png" style="width: 549.6px"/></figure></div></div></div><div id="rxsgf7QkezdA9oDUpEBRnU" class="wolai-block wolai-text"><div></div></div><aside id="qDyg7p8DbFHz9FJxjqeP7L" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap">（1）当子网或路由器不能定位到一个分组的目标时，路由器可以使用“目标不可达”ICMP<span class="jill"></span>消息来报告情况；</span><div id="w6KpEaBLxRZvK6nAWVF9Qb" class="wolai-block wolai-text"><div><span class="inline-wrap">（2）当一个设置了<span class="jill"></span>DF<span class="jill"></span>位的长分组由于途中经过一个“小帧长”网络而不能被递交时，路由器可以使用“目标不可达”ICMP<span class="jill"></span>消息来报告情况；</span></div></div></aside><h4 id="w2D6RYaUcGpwX8sDpNjnwk" class="wolai-block"><span class="inline-wrap">12 参数问题</span></h4><div id="fZ1isoVSWfuixoW3t2pRRL" class="wolai-block wolai-text"><div><span class="inline-wrap">ICMP<span class="jill"></span>参数问题报文是由<span class="jill"></span>IP<span class="jill"></span>数据报首部字段值不明确或空缺而引起的差错报告。一旦路由器或信宿机发现错误的数据报首部和错误的数据报选项参数时，便丢弃该数据报，并向信源发送参数问题差错报文。</span></div></div><div id="atmXKvUnEug5tDJjk1a3QT" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_17.png" style="width: 100%"/></figure></div><div id="33dRcXUsV57uxy6fwCTcXt" class="wolai-block wolai-text"><div><span class="inline-wrap">码值=0</span><span class="inline-wrap">   </span><span class="inline-wrap">表示<span class="jill"></span>IP<span class="jill"></span>报文中现有的某参数错，指针指向报文中引起错误的字节。</span><span class="inline-wrap">首部某个字段出现差错或二义性。         </span></div></div><div id="rFeG4n2LgBwTfp8Aq1vMQP" class="wolai-block wolai-text"><div><span class="inline-wrap">码值=1   表示报文中缺少某一要求的选项(如安全选项等)，此时指针字段应该为<span class="jill"></span>0。缺少选项所要求的部分。</span></div></div><h3 id="evSVyVssJZ2BitvxHeTaiR" class="wolai-block"><span class="inline-wrap">数据字段</span></h3><div id="jHw6PL1cj2mP7QUr58EmYi" class="wolai-block wolai-text"><div><span class="inline-wrap">ICMP<span class="jill"></span>差错报告报文的数据字段的内容：</span><span class="inline-wrap"><b>把收到的需要进行差错报告的<span class="jill"></span>ICMP<span class="jill"></span>数据报的首部和引发错误的<span class="jill"></span>IP<span class="jill"></span>数据字段的前<span class="jill"></span>8<span class="jill"></span>个字节提取出来，作为<span class="jill"></span>ICMP<span class="jill"></span>报文的数据字段，再加上相应的<span class="jill"></span>ICMP<span class="jill"></span>差错报告的前<span class="jill"></span>8<span class="jill"></span>个字节，就构成了差错报告报文。</b></span></div></div><div id="vtCAhLgA4op6ZBFWc1bsLd" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>提取了数据部分的前八个字节则可以得到传输层的端口号和发送序号（TCP），对于通知高层协议是有用的
最后整个<span class="jill"></span>ICMP<span class="jill"></span>报文作为<span class="jill"></span>IP<span class="jill"></span>数据报的数据字段发送给源端</b></span></div></div><div id="41Qf46uWg9YhwKyGKk1Y4z" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_18.png" style="width: 100%"/></figure></div><h2 id="39Nt6kdLuh5WyuEyybpwZ6" class="wolai-block"><span class="inline-wrap">拥塞控制和路径控制</span></h2><div id="7KFTMPf4SnuXkeqqvqDYJw" class="wolai-block wolai-text"><div><span class="inline-wrap">ICMP<span class="jill"></span>差错报文还可用于网络层的</span><span class="inline-wrap"><b>拥塞控制和路径控制</b></span><span class="inline-wrap">。包括源抑制和重定向报文：</span></div></div><h3 id="mXXyoCb3zMnadmj1AqgkWg" class="wolai-block"><span class="inline-wrap">源抑制(SourceQuench)</span><span class="inline-wrap">：</span></h3><div id="qgajuAfdAtERd3KHMe7GGM" class="wolai-block wolai-text"><div><span class="inline-wrap">路由器收到太多的分组，发送要求降低分组的传输速度。 </span></div></div><div id="LBQkWc6Z5oiwbSm88XcPb" class="wolai-block wolai-text"><div><span class="inline-wrap">用于拥塞控制的源抑制报文的格式和差错报告的格式一样，源抑制报文类型为<span class="jill"></span>4，码值只能为<span class="jill"></span>0。</span></div></div><div id="cZyp2U12Tj55dRoru4yaS9" class="wolai-block wolai-text"><div><span class="inline-wrap">•IP<span class="jill"></span>协议采用的是无连接数据报方式进行传输</span></div></div><div id="4WugTfcpHwWJM4hK6qK7tV" class="wolai-block wolai-text"><div><span class="inline-wrap">•发送方事先并不了解中间的路由器和信宿的处理能力和缓冲区大小</span></div></div><div id="2ufc1kirA1qHncb4nW9XYD" class="wolai-block wolai-text"><div><span class="inline-wrap">•在数据报传输过程中没有采用任何流量控制机制</span></div></div><div id="3WRGnRxJ2PVcyurkqPAihs" class="wolai-block wolai-text"><div><span class="inline-wrap">• 因此，当大量的数据报进入路由器或信宿时，会造成缓冲区溢出，即出现拥塞(Congestion)。</span></div></div><div id="nPWJjFRRyRegACyo7CCS4b" class="wolai-block wolai-text"><div><span class="inline-wrap">•ICMP<span class="jill"></span>利用源端抑制的方法来进行拥塞控制，减缓信源发出数据报的速率。</span></div><div id="6EJ9UdgTh2k7kEMu6FraCJ" class="wolai-block"><figure class="wolai-left" style="width: 100%"><img src="media/image_19.png" style="width: 100%"/></figure></div></div><div id="3p5NJDUi6GhneAaSCFrpJw" class="wolai-block wolai-text"><div><span class="inline-wrap">用于拥塞控制的源抑制报文的格式和差错报告的格式一样，源抑制报文类型为<span class="jill"></span>4，码值只能为<span class="jill"></span>0。</span></div></div><aside id="b7iawVCRyCV9oNCXmUdUzQ" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap">“源端抑制”ICMP<span class="jill"></span>消息被用来通知发送端减慢发送速度，但现在很少使用了，而主要由传输层来承担拥塞控制任务；</span></aside><h3 id="jLte5k5AcpNgSxkXegpLyL" class="wolai-block"><span class="inline-wrap">重定向(Redirect)报文：</span></h3><div id="6XTyEFEemZSMMDATXf7z3n" class="wolai-block wolai-text"><div><span class="inline-wrap">重定向：也叫改变路由。</span></div></div><div id="9htsEjJFT2UFS46rt53dfC" class="wolai-block wolai-text"><div><span class="inline-wrap">因特网上的路由器和主机中都存有一个路由表，路由表决定了去往目的地的下一跳路由器的地址。</span></div></div><div id="8uHnHH6zaa2nTL7VmkHzES" class="wolai-block wolai-text"><div><span class="inline-wrap">•路由器上的路由表能够及时地反映网络结构的变化，这一特点由路由器之间定期交换路由信息加以保证。</span></div></div><div id="hKuNjFz4rPETLsDpsJnHch" class="wolai-block wolai-text"><div><span class="inline-wrap">•主机因为不能保证全天开机，所以主机中的路由表不能及时反映网络结构的变化情况。另外，由于因特网上的主机数量远大于路由器数量，主机如果参与路由信息交换，势必带来大量的通信开销。因此主机中的路由表不通过路由协议进行更新。</span></div></div><div id="sKxQGwMPgHE3hE3BohJ2Dv" class="wolai-block wolai-text"><div><span class="inline-wrap">•主机所在的网络可能和多个路由器相连，主机在发送信息时也要根据其路由表来选择下一跳路由器，为了解决主机路由表的刷新问题，ICMP<span class="jill"></span>提供了重定向机制。</span></div></div><div id="pTzSU5GYfhrRU54WCx83LM" class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>IP<span class="jill"></span>网络中，路由选择主要由网络中的路由器来承担。主机只是知道很少的寻径信息，它把非本网的信息往设置的缺省路由器上发送。在一个网络上有两台或多台路由器时，经过缺省路由器虽然可以保证把数据包发送出去，但不能保证对于所有的目的地总是最优的。ICMP<span class="jill"></span>中定义的重定向报文，是主机和路由器之间交换路由信息的途径。</span></div></div><div id="wwKS99A14dxZkT9KYzXEdW" class="wolai-block wolai-text"><div><span class="inline-wrap">主机路由表所给出的下一跳路由器可能并非去往信宿的最佳下一跳路由器，当主机的下一跳路由器收到数据报后，</span><span class="inline-wrap"><b>该路由器根据它的路由表判断本路由器是否是去往信宿的最佳选择，如果不是，该路由器仍然会向信宿网络转发该数据报，但在转发的同时会产生一个<span class="jill"></span>ICMP<span class="jill"></span>重定向报文，通知信源修改它的路由表，重定向报文中将给出信源最佳下一跳路由器的<span class="jill"></span>IP<span class="jill"></span>地址。</b></span><span class="inline-wrap"></span></div></div><aside id="njJhzjgFMP3g2KFVT85vW9" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap">当路由器发现一个分组看起来被错误转发了，它将发送“重定向”ICMP<span class="jill"></span>消息来告诉发送主机；</span></aside><div id="5GsL4m9nYdghtNdZ9Y9fmV" class="wolai-block wolai-text"><div><span class="inline-wrap">主机<span class="jill"></span>A<span class="jill"></span>向主机<span class="jill"></span>B<span class="jill"></span>发送数据报时，根据其路由表得知，去往主机<span class="jill"></span>B<span class="jill"></span>所在网络<span class="jill"></span>192.168.8.0<span class="jill"></span>的路由器接口是<span class="jill"></span>196.168.6.1，因此数据报被发送到路由器<span class="jill"></span>R1。R1<span class="jill"></span>收到数据报后判断出<span class="jill"></span>R2<span class="jill"></span>是主机<span class="jill"></span>A<span class="jill"></span>发送数据报到主机<span class="jill"></span>B<span class="jill"></span>的最佳下一跳，R1<span class="jill"></span>向<span class="jill"></span>R2<span class="jill"></span>转发数据报后，产生重定向报文，发送给<span class="jill"></span>A，主机<span class="jill"></span>A<span class="jill"></span>根据收到的重定向报文首部中的目标路由器<span class="jill"></span>IP<span class="jill"></span>地址（192.168.6.2）更新自己的路由表。</span></div></div><div id="28aYFkV4yDJGoV3KVbJpjD" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_20.png" style="width: 100%"/></figure></div><div id="bs8ttHZkNX1rHanBBHJpVn" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_21.png" style="width: 681.6px"/></figure></div><div id="hgEMENEEoQoeabAWzXKRy5" class="wolai-block wolai-text"><div><span class="inline-wrap">从<span class="jill"></span>ICMP<span class="jill"></span>报文数据部分的<span class="jill"></span>IP<span class="jill"></span>报文头部，可以得到目的地的地址。在<span class="jill"></span>ICMP<span class="jill"></span>包中路由器<span class="jill"></span>IP<span class="jill"></span>地址即为到该目的地的最优路径的第一个路由器。 </span></div></div><h2 id="sNsztyp7refsNjxYsUnhsK" class="wolai-block"><span class="inline-wrap">不应发送<span class="jill"></span>ICMP<span class="jill"></span>差错报告报文的几种情况</span></h2><div id="7UFaV5UAjajZQ6sWybkmdF" class="wolai-block wolai-text"><div><span class="inline-wrap">对 ICMP 差错报告报文不再发送 ICMP 差错报告报文。</span></div></div><div id="aBnbsKcukvV8yFcRfNhLXL" class="wolai-block wolai-text"><div><span class="inline-wrap">对第一个分片的数据报片的所有后续数据报片都不发送 ICMP 差错报告报文。</span></div></div><div id="9S5tqbrywzzFzaZwoziiUz" class="wolai-block wolai-text"><div><span class="inline-wrap">对具有多播地址的数据报都不发送 ICMP 差错报告报文。</span></div></div><div id="bDF6f3asf6tSeoaqdKyuFp" class="wolai-block wolai-text"><div><span class="inline-wrap">对具有特殊地址（如<span class="jill"></span>127.0.0.0 或 0.0.0.0）的数据报不发送 ICMP 差错报告报文。</span></div></div><h1 id="hxY3Zn2TQuofkvUpQQQaC6" class="wolai-block"><span class="inline-wrap">查询报文</span></h1><div id="daaxNCgJ6xdyU9pJxrJbiX" class="wolai-block wolai-text"><div><span class="inline-wrap">ICMP<span class="jill"></span>查询报文类型值如下图所示。其中的信息请求与应答报文和地址掩码请求与应答已经不再使用。 </span></div></div><div id="nCan5ybxZfoz7my45TDjoN" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_22.png" style="width: 100%"/></figure></div><h3 id="obBjsKqNugi14Pgk3idxVQ" class="wolai-block"><span class="inline-wrap">回送请求和应答报文(EchoRequest and Rely) 8<span class="jill"></span>或者<span class="jill"></span>0</span></h3><div id="q1y2YXStyA6D6VwwyuAyCn" class="wolai-block wolai-text"><div><span class="inline-wrap">ICMP<span class="jill"></span>使用这个分组来确定某具体目的地能否到达。</span></div></div><div id="KwXyy9MadWnZtoendNQkZ" class="wolai-block wolai-text"><div><span class="inline-wrap">•使得因特网上的任何主机或路由器可以向其他主机或路由器发送请求并获得应答。</span></div></div><div id="9ncg1w1Tmd2hme179cYdHA" class="wolai-block wolai-text"><div><span class="inline-wrap">•通过<span class="jill"></span>ICMP<span class="jill"></span>查询报文，网络管理人员、用户或应用程序可以对网络进行检测，了解：</span></div><div id="q9hL89T33fgUcfwiDcfkiw" class="wolai-block wolai-text"><div><span class="inline-wrap">•设备的可达性（如<span class="jill"></span>Ping<span class="jill"></span>命令）</span></div></div><div id="6VyDVAcS1qYYn3sGeKnrQV" class="wolai-block wolai-text"><div><span class="inline-wrap">•地址掩码的设置</span></div></div><div id="98SGdEm3D1XHvBhQt2xMBF" class="wolai-block wolai-text"><div><span class="inline-wrap">•时钟的同步等情况</span></div></div><div id="pSNfCyobM4Hw4pjNkUEiKN" class="wolai-block wolai-text"><div><span class="inline-wrap">•ICMP<span class="jill"></span>查询报文目的是利用这些有用的信息，对网络进行故障诊断和控制。</span></div></div></div><div id="eM3A2TSXxK2QJ2bKspYx5h" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_23.png" style="width: 100%"/></figure></div><h3 id="7XRwgk161n7BsBt3XdCekE" class="wolai-block"><span class="inline-wrap">时间戳请求和回答报文(Timestamp Request and Reply) 13<span class="jill"></span>或者<span class="jill"></span>14</span></h3><div id="riSCKfezdQiHqagqm9XJzq" class="wolai-block wolai-text"><div><span class="inline-wrap">时戳分组使主机能估计它到另一个主机间一次来回所需的时间。</span></div></div><div id="qSqP2KcTEYPMgVFPU8AA1n" class="wolai-block wolai-text"><div><span class="inline-wrap">•因特网中的各个主机和路由器都是独立运行的，因此在时钟上存在着较大的差异，而一些分布式应用系统要求各个设备的时钟是同步的，ICMP<span class="jill"></span>时间戳请求和回答报文就是用于设备间进行时钟同步的报文对。</span></div></div><div id="iES2eAynVcAWBvKMQ1X3TU" class="wolai-block wolai-text"><div><span class="inline-wrap">•时钟同步的基本思路是请求方主机通过获取另一主机的时间戳信息，将该信息和请求方主机的时间戳信息进行比较后，估算两者的时钟差异。</span></div></div><div id="ma1tgV1gQ8G6zrNM4Atj9" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_24.png" style="width: 100%"/></figure></div><div id="5ezQCsKn7Je7L52nGsJzKY" class="wolai-block wolai-text"><div><span class="inline-wrap">具体而言，上面的字段中：</span></div></div><div id="aBxjC5jAwXXQFKpXtC4ZBS" class="wolai-block wolai-text"><div><span class="inline-wrap">•原始时间戳字段用于指示请求方发出请求的时间</span></div></div><div id="tQsmDQJ5iAnoRdBKLB3rWP" class="wolai-block wolai-text"><div><span class="inline-wrap">•接收时间戳字段用于指示应答方主机收到请求的时间</span></div></div><div id="4ipV74ADYgaoQTkenZeU83" class="wolai-block wolai-text"><div><span class="inline-wrap">•发送时间戳字段用于指示应答方主机发送应答的时间</span></div></div><div id="7QawxHaTWqmpAVsrxSQZyX" class="wolai-block wolai-text"><div><span class="inline-wrap">•三个时间戳字段均为<span class="jill"></span>4<span class="jill"></span>字节，以毫秒为单位从世界时间午夜<span class="jill"></span>0<span class="jill"></span>点起计时。时间戳的计数值不能超过<span class="jill"></span>24<span class="jill"></span>小时。</span></div></div><aside id="oNUTYuYiJdFXaWEbp3kUoP" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap">ECHO<span class="jill"></span>和<span class="jill"></span>ECHO REPLY（可以用来判断一个指定目标是否可达，以及是否还存活），以及<span class="jill"></span>TIMESTAMP RESQUEST<span class="jill"></span>和<span class="jill"></span>TIMESTAMP REPLY（用途类似前述），可被用于测试网络性能。</span></aside><h4 id="iT5ZoD1KhHnCkhbqYhwzfA" class="wolai-block"><span class="inline-wrap">应用：同步收发端的时钟</span></h4><div id="gQVDhSt39kdfNoU7YCeoN2" class="wolai-block wolai-text"><div><span class="inline-wrap">1）计算出时间戳请求和应答的往返时间</span></div></div><div id="kTTEAw9SGh8CoWmUgxgQHx" class="wolai-block wolai-text"><div><span class="inline-wrap">2）计算出单程时延</span></div></div><div id="aw8cvqxQ8kHZxXCZ5ciawJ" class="wolai-block wolai-text"><div><span class="inline-wrap">3）由两设备的时间戳和单程传输延迟计算出两台设备之间的时间差，从而实现时钟的同步。</span></div></div><hr id="pxYhWXy4xnEPQsxVU5bCit" class="wolai-block"/><div id="3wDurp3snM94NaCxrnfGNU" class="wolai-block wolai-text"><div><span class="inline-wrap">往返延迟时间可以用下式计算：</span></div></div><div id="4vpd1sSPKgvN4w1bupKzph" class="wolai-block wolai-text"><div><span class="inline-wrap">往返时间＝t<span class="jill"></span>当前－t<span class="jill"></span>初始－(t<span class="jill"></span>发送－t<span class="jill"></span>接收)</span></div><div id="28Pz5Y9JLVAm6aUVQeai3D" class="wolai-block wolai-text"><div><span class="inline-wrap">＝t<span class="jill"></span>接收－t<span class="jill"></span>初始＋t<span class="jill"></span>当前－t<span class="jill"></span>发送</span></div></div></div><div id="bwnC881RXBghyhvZJejMXY" class="wolai-block wolai-text"><div><span class="inline-wrap">假设传输请求的时延和传输应答的时延相同，那么单程时延就等于往返时间的一半。</span></div></div><hr id="hyESheYRxTAGP8bmVg95ur" class="wolai-block"/><div id="qqQcmeKhupwVBX2YeRVWtR" class="wolai-block wolai-text"><div><span class="inline-wrap">一个时钟同步的例子：主机<span class="jill"></span>A<span class="jill"></span>发出时间戳请求时的初始时间戳为<span class="jill"></span>1000<span class="jill"></span>毫秒，主机<span class="jill"></span>B<span class="jill"></span>收到请求时的接收时间戳是<span class="jill"></span>1055<span class="jill"></span>毫秒，主机<span class="jill"></span>B<span class="jill"></span>给出应答时的发送时间戳是<span class="jill"></span>1057<span class="jill"></span>毫秒，主机<span class="jill"></span>A<span class="jill"></span>收到应答时的时间为<span class="jill"></span>1030<span class="jill"></span>毫秒。主机<span class="jill"></span>A<span class="jill"></span>可以根据这些时间戳计算出两台主机间的时间差。</span></div></div><div id="kbDTb2aECSkTeG8VxAgieo" class="wolai-block wolai-text"><div><span class="inline-wrap">往返时间＝t<span class="jill"></span>当前－t<span class="jill"></span>初始－(t<span class="jill"></span>发送－t<span class="jill"></span>接收)</span></div><div id="fvtoVUTsDKk7ExFa1iGqG4" class="wolai-block wolai-text"><div><span class="inline-wrap">＝1030－1000－(1057－1055)＝28(毫秒)</span></div></div></div><div id="uuM1mDpVe7zVyFtCYU8iuS" class="wolai-block wolai-text"><div><span class="inline-wrap">单程时延＝28÷2＝14(毫秒)</span></div></div><div id="6iFmuQPXprYi7aaKbj6t7M" class="wolai-block wolai-text"><div><span class="inline-wrap">时间差＝t<span class="jill"></span>接收－(t<span class="jill"></span>初始＋单程时延)＝1055－(1000＋14)＝41(毫秒)</span></div></div><div id="9ZiHcgRMG5Hv4Cjbq6z3eW" class="wolai-block wolai-text"><div><span class="inline-wrap">•由上面的计算可知：主机<span class="jill"></span>B<span class="jill"></span>的时钟比主机<span class="jill"></span>A<span class="jill"></span>的时钟快了<span class="jill"></span>41<span class="jill"></span>毫秒。</span></div></div><h3 id="2btBxw3ebh2UVwgxER1eBV" class="wolai-block"><span class="inline-wrap">地址掩码请求和应答(AddressMask Request and Reply)17<span class="jill"></span>或者<span class="jill"></span>18</span></h3><div id="m1aGXtSezpQV3eCMcQQ49z" class="wolai-block wolai-text"><div><span class="inline-wrap">主机可以向路由器发送一个地址掩码请求分组来获取它所在网络的网络掩码，路由器会作出应答。</span></div></div><h1 id="ccv3cxf9FUAPmYLLaXNf22" class="wolai-block"><span class="inline-wrap">相关命令</span></h1><h2 id="FXJjkAKgFduH3LeAHrwhH" class="wolai-block"><span class="inline-wrap">PING</span></h2><div id="qM2FShd2q6HAcPMD2HQzQ6" class="wolai-block wolai-text"><div><span class="inline-wrap">•PING (Packet InterNetGroper)</span></div></div><div id="iMyKzTZicY8qWSK7HBkE42" class="wolai-block wolai-text"><div><span class="inline-wrap">•PING 用来测试两个主机之间的连通性。</span></div></div><div id="6M35ukeQEQBWKBD5uYEap5" class="wolai-block wolai-text"><div><span class="inline-wrap">•PING 使用了 ICMP<span class="jill"></span>回送请求与回送回答报文。</span></div></div><div id="cKkMGuy5Cgi9KcoXLTnb5J" class="wolai-block wolai-text"><div><span class="inline-wrap">•PING 是应用层直接使用网络层 ICMP<span class="jill"></span>的例子，它没有通过运输层的<span class="jill"></span>TCP<span class="jill"></span>或<span class="jill"></span>UDP。</span></div></div><div id="r2mDEcdmzsVz1MsWNMNeUe" class="wolai-block wolai-text"><div><span class="inline-wrap">•源主机向目标主机发送<span class="jill"></span>ICMP<span class="jill"></span>回送请求数据包，然后等待目标主机的回答。目标主机收到<span class="jill"></span>ICMP<span class="jill"></span>回送请求数据包后，交换源、目的主机地址，然后将收到的<span class="jill"></span>ICMP<span class="jill"></span>回送请求数据包中的数据部分，原封不动地封装在自己的<span class="jill"></span>ICMP<span class="jill"></span>应答数据包中，发回给源主机。</span></div></div><div id="uBK2Kogvo7GvoEpppJTt1p" class="wolai-block wolai-text"><div><span class="inline-wrap">•发送方校验正确，认为目标主机回送服务正常，即物理连接畅通。</span></div></div><div id="vQgvpfWAcqJ2Uc9D994dvq" class="wolai-block wolai-text"><div><span class="inline-wrap">实际上<span class="jill"></span>Ping<span class="jill"></span>是向目标发送一个要求回显（Type = 8）的<span class="jill"></span>ICMP<span class="jill"></span>数据报，当主机得到请求后，再返回一个应答（Type = 0）数据报。</span></div></div><h3 id="oiWZki4Aq2BJSXpGTDZ9pE" class="wolai-block"><span class="inline-wrap">ping<span class="jill"></span>命令的语法</span></h3><code-block id="asst6taTfsogJqc47bL5fk" class="wolai-block"><div class="wolai-pre"><div data-lang="PowerShell" class="marker"></div><pre>ping <span class="token operator">/</span>? 显示帮助

ping target_name 测试和目标主机间的链接

ping <span class="token operator">-</span>a 解析地址到主机名

ping <span class="token operator">-</span>n count 发送的响应请求数，默认为4</pre></div></code-block><div id="pV45HaieAwACe6tMWBpFze" class="wolai-block wolai-text"><div><span class="inline-wrap">在例子中&quot;bytes=32&quot;表示<span class="jill"></span>ICMP<span class="jill"></span>报文中有<span class="jill"></span>32<span class="jill"></span>个字节的测试数据，&quot;time= ms&quot;是往返时间。 Sent 发送多个包、Received 收到多个回应包、Lost 丢弃了多少个<span class="jill"></span>Minmum 最小值 、MAXimun 最大值、Average 平均值。所在图上来看，来回只用了<span class="jill"></span>7MS 时间，lost =0 即是丢包数为<span class="jill"></span>0，网络状态相当良好。 (更详细可以使用-n<span class="jill"></span>参数 “ping –n 100 IP<span class="jill"></span>地址” ping 100<span class="jill"></span>次。查看 Sent Received Lost Minmum MAXimun Average 这些值的变化。)</span></div></div><h2 id="v6vQig6PsRjwHvxubx7zaT" class="wolai-block"><span class="inline-wrap">Tracert</span></h2><div id="iGhFK6obnnbeCoabQ99MDy" class="wolai-block wolai-text"><div><span class="inline-wrap">•Tracert（Windows<span class="jill"></span>下）和<span class="jill"></span>Traceroute（Unix<span class="jill"></span>下）是一个路由跟踪实用程序，用来跟踪一个分组从源点到终点的路径。确定<span class="jill"></span>IP 数据报访问目标所经过的路由。Tracert 命令用<span class="jill"></span>IP 生存时间字段<span class="jill"></span>TTL<span class="jill"></span>和 ICMP 错误消息来确定从一个主机到网络上其他主机的路由。</span></div></div><div id="hi93kxSMMSgmbfB5hf8YKD" class="wolai-block wolai-text"><div><span class="inline-wrap">•通过向目标发送不同<span class="jill"></span>TTL 值的<span class="jill"></span>ICMP<span class="jill"></span>回应数据包，Tracert 程序确定到目标所经过的路由。</span></div></div><div id="mqPzF5VJySELUoRDz4paPY" class="wolai-block wolai-text"><div><span class="inline-wrap">•数据包上的<span class="jill"></span>TTL 减为 0 时，路由器将<span class="jill"></span>ICMP<span class="jill"></span>超时报文发回源系统。</span></div></div><div id="hzYfnnuxmeAy3DojH12Acp" class="wolai-block wolai-text"><div><span class="inline-wrap">•收到<span class="jill"></span>ICMP<span class="jill"></span>报文的，计算往返时间。</span></div></div><div id="u1AbEsobksWoTowFKSxAtR" class="wolai-block wolai-text"><div><span class="inline-wrap">•Tracert<span class="jill"></span>的使用很简单，只需要在<span class="jill"></span>tracert<span class="jill"></span>后面跟一个<span class="jill"></span>IP<span class="jill"></span>地址或<span class="jill"></span>URL，Tracert<span class="jill"></span>会进行相应的域名转换。Tracert<span class="jill"></span>一般用来检测故障的位置，用<span class="jill"></span>tracert IP<span class="jill"></span>告诉你问题所在的地方。</span></div></div><h3 id="b1g7q6ypRk3ZkG5HTRYhsG" class="wolai-block"><span class="inline-wrap">Tracert<span class="jill"></span>命令</span></h3><code-block id="s9iZvw3iQ1K8JHJcgqFTsA" class="wolai-block"><div class="wolai-pre"><div data-lang="PowerShell" class="marker"></div><pre>tracert target_name 

tracert <span class="token operator">-</span>d target_name 不解析地址到主机名

tracert <span class="token operator">-</span>h maximum hops 指定最大跳数，默认为30
</pre></div></code-block><h3 id="tgSKBHAGjoWrkoZrTE1E5H" class="wolai-block"><span class="inline-wrap">工作原理</span></h3><div id="sGBNKF195v5nkA32tCyK3J" class="wolai-block wolai-text"><div><span class="inline-wrap">•Tracert<span class="jill"></span>是利用<span class="jill"></span>ICMP<span class="jill"></span>和<span class="jill"></span>TTL<span class="jill"></span>进行工作的。首先<span class="jill"></span>tracert<span class="jill"></span>会发出<span class="jill"></span>TTL<span class="jill"></span>值为<span class="jill"></span>1<span class="jill"></span>的<span class="jill"></span>ICMP<span class="jill"></span>数据报（包含<span class="jill"></span>40<span class="jill"></span>个字节，包括源地址、目标地址和发出的时间标签，一般会连续发<span class="jill"></span>3<span class="jill"></span>个包）。</span></div></div><div id="3PENTJmVWZcPa4JtZAnVYD" class="wolai-block wolai-text"><div><span class="inline-wrap">•当到达路径上的第一个路由器时,路由器会将<span class="jill"></span>TTL<span class="jill"></span>值减<span class="jill"></span>1，此时<span class="jill"></span>TTL<span class="jill"></span>值变成<span class="jill"></span>0，该路由器会将此数据报丢弃，并返回一个超时回应数据报（包括数据报的源地址、内容和路由器的<span class="jill"></span>IP<span class="jill"></span>地址）</span></div></div><div id="tsF1YDKdEZcdyivFm6LpUf" class="wolai-block wolai-text"><div><span class="inline-wrap">•当<span class="jill"></span>tracert<span class="jill"></span>收到该数据报时，它便获得了这个路径上的第一个路由器的地址。接着，tracert<span class="jill"></span>再发送另一个<span class="jill"></span>TTL<span class="jill"></span>为<span class="jill"></span>2<span class="jill"></span>的数据报，第一个路由器会将此数据报转发给第二个路由器，而第二个路由器收到数据报时，TTL<span class="jill"></span>为<span class="jill"></span>0。第二个路由器便会返回一个超时回应数据报，从而<span class="jill"></span>tracert<span class="jill"></span>便获得了第二个路由器的地址</span></div></div><div id="rkXTb5FHDztxxbuZezRRiv" class="wolai-block wolai-text"><div><span class="inline-wrap">•Tracert<span class="jill"></span>每次发出数据报时便会将<span class="jill"></span>TTL<span class="jill"></span>加<span class="jill"></span>1（一般每次都是发<span class="jill"></span>3<span class="jill"></span>个数据报），来发现下一个路由器。这个动作一直重复，直到到达目的地或者确定目标主机不可到达为止。</span></div></div><div id="491bLYcu1cRpnxvXv4BUqu" class="wolai-block wolai-text"><div><span class="inline-wrap">•当数据报到达目的地后，目标主机并不返回超时回应数据报。</span></div></div><h3 id="6Le9rfcUgu17Kuk9FgK2q1" class="wolai-block"><span class="inline-wrap">执行过程</span></h3><div id="qVF5R3R8ambeP9vfjj8q9E" class="wolai-block wolai-text"><div><span class="inline-wrap">•源端发送一系列的<span class="jill"></span>UDP<span class="jill"></span>数据报给目的端</span></div></div><div id="xiFG8rKGutXrYHKY4MKJZE" class="wolai-block wolai-text"><div><span class="inline-wrap">•第一个字段<span class="jill"></span>TTL =1</span></div></div><div id="utRbH7a9tdoHyRkCYDyY97" class="wolai-block wolai-text"><div><span class="inline-wrap">•第二个字段<span class="jill"></span>TTL=2,</span></div></div><div id="m1mjZu1kN5ZynaZi6QkuCe" class="wolai-block wolai-text"><div><span class="inline-wrap">•以此类推<span class="jill"></span>etc.</span></div></div><div id="jYa4ZXKwkgaEKwQXBQ1kFc" class="wolai-block wolai-text"><div><span class="inline-wrap">•当第<span class="jill"></span>n<span class="jill"></span>个数据报到达第<span class="jill"></span>n<span class="jill"></span>个路由器</span></div></div><div id="6zkMaD57iKqmh9ag3fYUfr" class="wolai-block wolai-text"><div><span class="inline-wrap">•路由器抛弃掉数据报。</span></div></div><div id="bRKHe1eLXgy3DgQsYgRxHJ" class="wolai-block wolai-text"><div><span class="inline-wrap">•发送给源端<span class="jill"></span>ICMP<span class="jill"></span>消息（类型为<span class="jill"></span>11，code<span class="jill"></span>为<span class="jill"></span>0）</span></div></div><div id="v5nb2djEL1DYpR1aL8NDrs" class="wolai-block wolai-text"><div><span class="inline-wrap">•而消息中包含了每台路由器的名字和<span class="jill"></span>IP<span class="jill"></span>地址</span></div></div><div id="gGLDnFa5QLPSNT337AQKiw" class="wolai-block wolai-text"><div><span class="inline-wrap">•当<span class="jill"></span>ICMP<span class="jill"></span>消息到达后，源端可以计算<span class="jill"></span>RTT（Roundtrip time,往返时间）</span></div></div><div id="2y8bYUW6FddjKdbdCYg9Ff" class="wolai-block wolai-text"><div><span class="inline-wrap">•Traceroute 做三次这样的命令</span></div></div><div id="v1Z5nGBJ9iCz8jmdxCQsz6" class="wolai-block wolai-text"><div><span class="inline-wrap">•停止规则</span></div></div><div id="qNiJNVKu7FYoeQUubYrZBz" class="wolai-block wolai-text"><div><span class="inline-wrap">•UDP 数据段 最终到达目的主机</span></div></div><div id="onrqzUeVpQRQwLinZ2NuoV" class="wolai-block wolai-text"><div><span class="inline-wrap">•目的主机返回<span class="jill"></span>ICMP “host unreachable” 数据包。</span></div><div id="treyB8RBusyZ7GEhwAVuaA" class="wolai-block wolai-text"><div><span class="inline-wrap">因为发送的<span class="jill"></span>UDP<span class="jill"></span>数据段故意使用的是一个非法<span class="jill"></span>UDP<span class="jill"></span>端口，结果<span class="jill"></span>ICMP<span class="jill"></span>就返回“端口不可达”的差错报文，达到测试的目的。（在<span class="jill"></span>Traceroute<span class="jill"></span>命令中应用层并没有真正的数据要传送，就是为了测试）</span></div></div></div><div id="2UUA5LHSWoPTzBHgudfV22" class="wolai-block wolai-text"><div><span class="inline-wrap">•最终当源端收到该<span class="jill"></span>ICMP<span class="jill"></span>消息，停止</span></div></div></div><h1 id="qWtm5BU6nDszRhBpPXg3gN" class="wolai-block"><span class="inline-wrap">Internet<span class="jill"></span>组播协议<span class="jill"></span>IGMP</span></h1><div id="pV4mwxTYxaaWJZbKtBkea8" class="wolai-sub-page wolai-block"><div class="page-icon"></div><a href="ipv4%E5%8D%8F%E8%AE%AE/igmp/igmp.html"><span>IGMP</span></a></div><h1 id="8JzLjxbbLLMmXKZiFDgTh2" class="wolai-block"><span class="inline-wrap">移动<span class="jill"></span>IP<span class="jill"></span>协议<span class="jill"></span>Mobile IP </span></h1><div id="8VgRGPjiTBCYmyS26UJ7GM" class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div></div><h3 id="hNPNbnmeyHqXjfaDvwadLe" class="wolai-block"><span class="inline-wrap"><b>3、长度</b></span></h3><aside id="k29Dn3r8jNJCnqgFS2zuVG" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap">我们可以利用这两个字段计算出数据部分的长度</span></aside><h4 id="wqXsqYCAZExJLAhuRgF6hn" class="wolai-block"><span class="inline-wrap">分组头长度字段：</span></h4><div id="nBo1y8pLNFsSsVFZLLwRcF" class="wolai-block wolai-text"><div><span class="inline-wrap">该字段长度为<span class="jill"></span>4<span class="jill"></span>位，定义了以<span class="jill"></span>4<span class="jill"></span>字节为一个单位的分组头长度，分组头长度为<span class="jill"></span>20-60<span class="jill"></span>字节，因此该字段最小值为<span class="jill"></span>5（20<span class="jill"></span>字节），最大值为<span class="jill"></span>15（60<span class="jill"></span>字节）。</span></div></div><h4 id="qamSYL4b5mabNTVhdtoipi" class="wolai-block"><span class="inline-wrap">总长度字段：</span></h4><div id="xz9VZajk5e3PZhBt3YSBzM" class="wolai-block wolai-text"><div><span class="inline-wrap">该字段长度为<span class="jill"></span>16<span class="jill"></span>位，定义了以字节为单位的分组总长度，是分组头长度与数据长度之和。因为<span class="jill"></span>16<span class="jill"></span>位，所以最大长度为<span class="jill"></span>2^16-1。（所以<span class="jill"></span>IP<span class="jill"></span>数据包最长可达<span class="jill"></span>65535<span class="jill"></span>个字节</span></div></div><h3 id="di86hZ9jLKGzLhmd3iV8PU" class="wolai-block"><span class="inline-wrap"><b>4、服务字段</b></span></h3><div id="eAtEUX915d7Mhvs3g3gKET" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>占<span class="jill"></span>8bit，用于指示路由器如何处理分组。</b></span></div></div><div id="cqkNwUgZKexqCmh6TGB8p1" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://img-blog.csdnimg.cn/20200805173444342.png" style="width: 272px"/></figure></div><aside id="ohH139jRS2Asq4UjYrc97F" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap">其中有</span><span class="inline-wrap"><b>D，T，R<span class="jill"></span>三位表示本报文所希望的传输类型</b></span><span class="inline-wrap">，优先级字段表示本报文的重要性，具体解释为：</span></aside><div id="atfRi6uQ2rx28auvhmtxCK" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>D，T，R<span class="jill"></span>三位表示本报文所希望的传输类型</b></span></div></div><div id="A4RfjrFsKaNmYs2yCmMi" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>若为<span class="jill"></span>1，则分别表示要求低延迟、高吞吐率或高可靠性等</b></span></div></div><h4 id="wnpC7kT5sBAG5vhXLJ141m" class="wolai-block"><span class="inline-wrap">D<span class="jill"></span>字段：</span></h4><div id="2sGzHMWXRvC29XHEq86YcP" class="wolai-block wolai-text"><div><span class="inline-wrap">是延迟(delay)的缩写，</span></div></div><div id="pCk3U3iRc2fBNX1RdTPj3R" class="wolai-block wolai-text"><div><span class="inline-wrap">•低延迟对于在传输用户在远程计算机中登录并要求快速响应时很有用</span></div></div><h4 id="9nQvCCqowh21U6XWWdX69K" class="wolai-block"><span class="inline-wrap">T<span class="jill"></span>字段：</span></h4><div id="iKwCXukFXoo36v5Gm69KLu" class="wolai-block wolai-text"><div><span class="inline-wrap">是吞吐率(throughput)的缩写</span></div></div><div id="v633CABokbULM5zYcHGbcz" class="wolai-block wolai-text"><div><span class="inline-wrap">•在分组设置高吞吐率（High-Throughput）要求</span></div></div><div id="iciCw9aJUQCJmCrVnWA38n" class="wolai-block wolai-text"><div><span class="inline-wrap">•可以使路由器的<span class="jill"></span>IP<span class="jill"></span>寻找高速网络来传送分组</span></div></div><h4 id="p7vH4GWEy1Znsr1uYCXCrQ" class="wolai-block"><span class="inline-wrap">R<span class="jill"></span>字段：</span></h4><div id="dMqMc1kdGah7xtJ89mufGp" class="wolai-block wolai-text"><div><span class="inline-wrap">表示可靠性(reliability)</span></div></div><div id="fen3x9RD8iLX43uSsLdrxX" class="wolai-block wolai-text"><div><span class="inline-wrap">高可靠（High-Reliablility）要求说明了分组应当被可靠地投送</span></div></div><hr id="ekrv9mpnLbTvP2e92vNw24" class="wolai-block"/><h4 id="vM5Ci33hfrS4gN42ioKJkv" class="wolai-block"><span class="inline-wrap">优先级字段：</span></h4><div id="fX19E267MjmbnkGyoH3SAL" class="wolai-block wolai-text"><div><span class="inline-wrap">•3<span class="jill"></span>比特优先权指示本报文的重要程度，其值为<span class="jill"></span>0<span class="jill"></span>到<span class="jill"></span>7</span></div></div><div id="djhEeLZ9i5NVY8ohQ3EVYB" class="wolai-block wolai-text"><div><span class="inline-wrap">•0<span class="jill"></span>表示一般优先权，而<span class="jill"></span>7<span class="jill"></span>表示网络控制优先权</span></div></div><div id="gSdFkhrGFRqFztmfUCUon1" class="wolai-block wolai-text"><div><span class="inline-wrap">值越大，表示优先级越高，也就是要求在</span></div><div id="8b58SRr3LEK7oFinnN5Dtr" class="wolai-block wolai-text"><div><span class="inline-wrap">（1）分组传输时，需要网络提供优先服务</span></div></div><div id="aMdg62FE3GqGJKYjB85czC" class="wolai-block wolai-text"><div><span class="inline-wrap">（2）重要服务信息处理等级高于一般服务信息处理等级</span></div></div></div><div id="7SzBVSjxtBvdmMmxoG42WD" class="wolai-block wolai-text"><div><span class="inline-wrap">•它提供了一种可以利用的手段，让网络控制信息比一般数据具有更高的优先级</span></div></div><div id="jVmjfszrec8KzrEZit2gmZ" class="wolai-block wolai-text"><div><span class="inline-wrap">•它在交换用于指示状态的控制分组和执行分布式的拥塞控制算法中传输拥塞控制分组时，尤为重要</span></div></div><div id="tB2E89quVXkA1taVp2q7yK" class="wolai-block wolai-text"><div><span class="inline-wrap">•尽管目前大部分路由器忽略服务类型，但它的实现考虑到了更新版本的变化</span></div></div><h3 id="awXsZHGA6cwSiXjeDsCiEt" class="wolai-block"><span class="inline-wrap"><b>5、生存时间字段</b></span></h3><div id="g5ivxt9oy64n11aQ3xmLcC" class="wolai-block wolai-text"><div><span class="inline-wrap">生存时间字段又叫<span class="jill"></span>TTL，用来设定分组在互联网中的“寿命”，避免分组在网络中无限循环、无休止转发。通常是用转发分组最多的路由器跳数来实现。</span></div></div><div id="qYNo2W7G1S8ugNTwDHJppE" class="wolai-block wolai-text"><div><span class="inline-wrap">每一个新产生的<span class="jill"></span>IP<span class="jill"></span>报文中，IP<span class="jill"></span>头部的生存时间(TTL)字段都被设置为最大生存周期<span class="jill"></span>255</span></div></div><div id="Kj6k9UB91Yan75aXmdEiD" class="wolai-block wolai-text"><div><span class="inline-wrap">设计<span class="jill"></span>TTL<span class="jill"></span>是用来限制一个分组在互联网中的最大生存时间，</span><span class="inline-wrap"><b>TTL<span class="jill"></span>的初始值由源主机设置，经过一个路由器，它的值减<span class="jill"></span>1</b></span><span class="inline-wrap">。当<span class="jill"></span>TTL<span class="jill"></span>的值变为<span class="jill"></span>0<span class="jill"></span>时，分组就被丢弃，并发送<span class="jill"></span>ICMP<span class="jill"></span>报文通知主机。</span></div></div><h3 id="bPkhWDskaf1c8AbzLybKYn" class="wolai-block"><span class="inline-wrap"><b>6、头检验和字段</b></span></h3><blockquote id="nQutg1GXkphyXgWkstAyQp" class="wolai-block"><span class="inline-wrap">长度为<span class="jill"></span>16<span class="jill"></span>位，用于保证分组头数据完整性，</span><span class="inline-wrap"><b>只需要对分组头进行检验和计算而不需要对整个分组进行</b></span><span class="inline-wrap">，因为高层数据会有自己相应的检验字段，检验和的方法和<span class="jill"></span>UDP、TCP<span class="jill"></span>的检验和类似。</span></blockquote><h4 id="w2JWP9ytJ3VxBXF15G6Qoe" class="wolai-block"><span class="inline-wrap">⭐</span><span class="inline-wrap">校验对象：分组头</span></h4><aside id="sHeUMpyCFrQ7HRnWDoUmTa" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap">数据部分的校验负担太重，就不做校验了（其实高层自己会校验）</span><div id="jSHCx3s7hhWm9MDxKPwMv" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>为什么负担太重？</b></span></div></div><div id="3jbUmS5moLw2wjvPxng2tM" class="wolai-block wolai-text"><div><span class="inline-wrap">因为每走一步都要做校验</span></div></div><div id="SEoZaGYU4haxrVzyqcJnk" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>为什么每走异步都要做校验？</b></span></div></div><div id="3S2H8b19EfxtDmySQokWPN" class="wolai-block wolai-text"><div><span class="inline-wrap">因为生存字段每次转发都会改变</span></div></div></aside><div id="mKg9dT2zx8QcGFpiqir7tA" class="wolai-block wolai-text"><div><span class="inline-wrap">•只检验<span class="jill"></span>IP<span class="jill"></span>分组的首部，不检验数据部分；用于保证<span class="jill"></span>IP<span class="jill"></span>头部数据的完整性；每次传输必须重新计算校验和，因为<span class="jill"></span>IP<span class="jill"></span>头部中的生存期字段在不断改变；不采用 CRC<span class="jill"></span>检验码而采用简单的计算方法</span></div></div><div id="kvGKJrFbrNYVefvq3tVZbs" class="wolai-block wolai-text"><div><span class="inline-wrap">•二进制反码求和的运算规则：从低位到高位逐列进行计算；0<span class="jill"></span>和<span class="jill"></span>0<span class="jill"></span>相加是<span class="jill"></span>0，0<span class="jill"></span>和<span class="jill"></span>1<span class="jill"></span>相加是<span class="jill"></span>1，1<span class="jill"></span>和<span class="jill"></span>1<span class="jill"></span>相加是<span class="jill"></span>0<span class="jill"></span>但要产生一个进位<span class="jill"></span>1，加到下一列；若最高位相加后产生进位，则最后得到的结果要加<span class="jill"></span>1（也就是加到末位）</span></div></div><div id="kXSPbbMFLxF7d464Wkfq4e" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_25.png" style="width: 100%"/></figure></div><h3 id="a6kugJNbjTU88zS6RcK6zQ" class="wolai-block"><span class="inline-wrap"><b></b></span><span class="inline-wrap">⭐</span><span class="inline-wrap"><b>7、地址字段</b></span></h3><aside id="igBcfq493tNSCo8GmN7MVq" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap">最重要的就是地址字段，长篇大论讲地址，具体看下面这个页面</span></aside><div id="qcyVgs7dxAj2TK1Vz7WkQE" class="wolai-sub-page wolai-block"><div data-symbol="⭐" class="page-icon"></div><a href="ipv4%E5%9C%B0%E5%9D%80/ipv4%E5%9C%B0%E5%9D%80.html"><span>IPv4地址</span></a><div id="3UVzN9t1mXTqqVGRxpnycu" class="wolai-block wolai-text"><div><span class="inline-wrap">•IPv4<span class="jill"></span>地址长度为<span class="jill"></span>32<span class="jill"></span>比特，按<span class="jill"></span>8<span class="jill"></span>比特一组，可分成<span class="jill"></span>4<span class="jill"></span>组</span></div></div><div id="nDhZrtdrQsMM8e4kr2devP" class="wolai-block wolai-text"><div><span class="inline-wrap">•每组<span class="jill"></span>8<span class="jill"></span>比特二进制串可以转换为<span class="jill"></span>0～255<span class="jill"></span>之间的一个十进制数来表示</span></div></div><div id="ebBAwGxMfqGoixRoes95vz" class="wolai-block wolai-text"><div><span class="inline-wrap">•4<span class="jill"></span>组数之间用点(.)隔开，即点分十进制格式</span></div></div><div id="8uouYYoLYnFaP2QqBzS7W" class="wolai-block wolai-text"><div><span class="inline-wrap">•点分十进制格式示例如下图</span></div></div><div id="wFzX3Tk92Hhr3Zaw4QU6A3" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_26.png" style="width: 100%"/></figure></div><h2 id="qiyxCiNfvXXm7tZcB7M9je" class="wolai-block"><span class="inline-wrap">分类</span></h2><div id="eP1a1LAN8i7mhFiiUBQqWj" class="wolai-block wolai-text"><div><span class="inline-wrap">•IPv4<span class="jill"></span>地址按前几位的类别比特分成<span class="jill"></span>A、B、C、D、E<span class="jill"></span>五类</span></div></div><div id="jBYe4H2yD8v4hWeMhovd8t" class="wolai-block wolai-text"><div><span class="inline-wrap">•A、B、C<span class="jill"></span>类地址为单播地址</span></div></div><div id="pY4Ug7mPvXMuLfAw6fwK5b" class="wolai-block wolai-text"><div><span class="inline-wrap">•D<span class="jill"></span>类地址为组播地址</span></div></div><div id="6GHMJ1WCn15YQabN8JgiZi" class="wolai-block wolai-text"><div><span class="inline-wrap">•E<span class="jill"></span>类地址保留，以备将来的特殊用途</span></div></div><div id="3xWiZJwjpmm6ZJgTpLEuMs" class="wolai-block wolai-text"><div><span class="inline-wrap">•A、B、C<span class="jill"></span>三类地址可以分为网络号和主机号两部分</span></div><div id="dg9YjDxtBjPkbyMz5Dfrzc" class="wolai-block wolai-text"><div><span class="inline-wrap">主机号在<span class="jill"></span>0.0.0-255.255.255<span class="jill"></span>之间</span></div></div></div><div id="sGmEZjd5owWiV8CKUSM8BM" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_27.png" style="width: 100%"/></figure></div><div id="7Lopbvp7bpXFErwfrE84jb" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_28.png" style="width: 100%"/></figure></div><div id="4StUPCUxKsq37L2a5QxfB4" class="wolai-block wolai-text"><div><span class="inline-wrap">•IPv4<span class="jill"></span>地址分两个等级的好处</span></div></div><div id="rsutzmhYRxtWCvcUHunqTL" class="wolai-block wolai-text"><div><span class="inline-wrap">•IP<span class="jill"></span>地址管理机构在分配<span class="jill"></span>IP<span class="jill"></span>地址时只分配网络号，而剩下的主机号则由得到该网络号的单位自行分配，这样就方便了<span class="jill"></span>IP<span class="jill"></span>地址的管理</span></div></div><div id="wySxHa84EVFgn2nz1Zo6sf" class="wolai-block wolai-text"><div><span class="inline-wrap">•路由器仅根据目的主机所连接的网络号来转发分组（而不考虑目的主机号），这样就可以使路由表中的项目数大幅度减少，从而减小了路由表所占的存储空间</span></div></div><h3 id="v3GBVgLWdpkioMpzUwt9DZ" class="wolai-block"><span class="inline-wrap">A<span class="jill"></span>地址的二级结构示例</span></h3><div id="8iW5yKep75Eqn6ZmSB9AfH" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_29.png" style="width: 100%"/></figure></div><h3 id="9hanUrRe8qTuzC5CikhkSC" class="wolai-block"><span class="inline-wrap">B<span class="jill"></span>地址的二级结构示例</span></h3><div id="7g7Np9ytARM8YqMri2zBcH" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_30.png" style="width: 100%"/></figure></div><h3 id="r86XqdnkyopNwFqsquFGFH" class="wolai-block"><span class="inline-wrap">C<span class="jill"></span>地址的二级结构示例</span></h3><div id="cCRP2Y5gMYBiRJVGd9G1tz" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_31.png" style="width: 100%"/></figure></div><h3 id="va8TAHiE2ntKwJw4f522xC" class="wolai-block"><span class="inline-wrap">特殊的 IP 地址汇总</span></h3><div id="jptvGTGYPT1EARw5KXSvPj" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_32.png" style="width: 100%"/></figure></div><h3 id="f3ngpzBN6sJgTn69nFxBPL" class="wolai-block"><span class="inline-wrap">私有地址</span></h3><div id="uvPuYjubqS4jk6j46sTTgz" class="wolai-block wolai-text"><div><span class="inline-wrap">•私有地址不被正式的分配给任何人</span></div></div><div id="qnSoZcd6WQfQ3opFpDgdDT" class="wolai-block wolai-text"><div><span class="inline-wrap">•也应该被使用在自己网络的外部机构(即<span class="jill"></span>Internet<span class="jill"></span>网上)</span></div></div><div id="7H3QxuMXbSnz62bqtPND7n" class="wolai-block wolai-text"><div><span class="inline-wrap">• A<span class="jill"></span>类网：从<span class="jill"></span>10.0.0.0<span class="jill"></span>到<span class="jill"></span>10.255.255.255</span></div></div><div id="fGseuWcSWq9mCNhAVbqMEh" class="wolai-block wolai-text"><div><span class="inline-wrap">• B<span class="jill"></span>类网：从<span class="jill"></span>172.16.0.0<span class="jill"></span>到<span class="jill"></span>172.31.255.255</span></div></div><div id="xogcGAmwtHouQkPfr72rAU" class="wolai-block wolai-text"><div><span class="inline-wrap">• C<span class="jill"></span>类网：从<span class="jill"></span>192.168.0.0<span class="jill"></span>到<span class="jill"></span>l92.168.255.255</span></div></div><h1 id="uY5dtuDh6RZadiW7KPR2sE" class="wolai-block"><span class="inline-wrap">子网划分</span></h1><div id="fxC1jt5r5gHT8DAoHuLBoP" class="wolai-block wolai-text"><div><span class="inline-wrap">•子网划分属于<span class="jill"></span>IPv4<span class="jill"></span>地址扩充工作</span></div></div><div id="DQ27GxvgfjbszbNhRFaeo" class="wolai-block wolai-text"><div><span class="inline-wrap">•主要用于改进<span class="jill"></span>32<span class="jill"></span>位地址空间的使用效率</span></div></div><div id="695yy4GnF33ha8gGNTYSCK" class="wolai-block wolai-text"><div><span class="inline-wrap">•在 ARPANET 的早期，IPv4<span class="jill"></span>地址的设计确实不够合理</span></div><div id="eAbuGNh9M364ANMKanQuCc" class="wolai-block wolai-text"><div><span class="inline-wrap">•IPv4<span class="jill"></span>地址空间的利用率有时很低</span></div></div><div id="8RhJHXjxvxj61JFJ2RWpKL" class="wolai-block wolai-text"><div><span class="inline-wrap">•给每一个物理网络分配一个网络号会使路由表变得太大因而使网络性能变坏</span></div></div><div id="uf3o8ShzJyoC2Ss5yadKGZ" class="wolai-block wolai-text"><div><span class="inline-wrap">•两级的 IP 地址不够灵活</span></div></div></div><h2 id="q8d7SZiJTFAGi9muE7kwTP" class="wolai-block"><span class="inline-wrap">三级地址</span></h2><div id="iqW1goVaEbBwhxpV5JdUTs" class="wolai-block wolai-text"><div><span class="inline-wrap">•从两级<span class="jill"></span>IPv4<span class="jill"></span>地址到三级<span class="jill"></span>IPv4<span class="jill"></span>地址</span></div></div><div id="g5PQaLD4j16L9bvUDrWjjP" class="wolai-block wolai-text"><div><span class="inline-wrap">•从 1985 年起在 IPv4<span class="jill"></span>地址中又增加了一个“子网号字段”</span></div></div><div id="dE4YJYRC3kGauLdf8pCnKY" class="wolai-block wolai-text"><div><span class="inline-wrap">•使两级的 IPv4<span class="jill"></span>地址变成为三级的 IP 地址</span></div></div><div id="kK7VjMCi42DAKVyBDYLKaf" class="wolai-block wolai-text"><div><span class="inline-wrap">•这种做法叫做划分子网 (subnetting)</span></div></div><div id="8we5hNCMUptP6j1ym8nJBR" class="wolai-block wolai-text"><div><span class="inline-wrap">•划分子网已成为互联网的正式标准协议</span></div></div><div id="tnFGtc8Wnbkjxf9y6h73Pn" class="wolai-block wolai-text"><div><span class="inline-wrap">•划分子网后优点</span></div><div id="caWNjs6u73z4ZD9gLKZqZk" class="wolai-block wolai-text"><div><span class="inline-wrap">•减少了 IP 地址的浪费</span></div></div><div id="8G8dDFfsPKKWotyttgU2AB" class="wolai-block wolai-text"><div><span class="inline-wrap">•使网络的组织更加灵活</span></div></div><div id="2abgTaZNgWs6X75cuUj1dy" class="wolai-block wolai-text"><div><span class="inline-wrap">•更便于维护和管理</span></div></div></div><h2 id="fy6Kp39KhcT8DY9TG6Jp2A" class="wolai-block"><span class="inline-wrap">划分子网的基本思路</span></h2><div id="ucAJatZPnwLHkDY2z7cr7C" class="wolai-block wolai-text"><div><span class="inline-wrap">•划分子网纯属一个单位内部的事情</span></div></div><div id="eZSCvUhnrAhcndQMYcEEA6" class="wolai-block wolai-text"><div><span class="inline-wrap">•单位对外仍然表现为没有划分子网的网络</span></div></div><div id="77DQPM67R7nP4P4qPng3ce" class="wolai-block wolai-text"><div><span class="inline-wrap">•从主机号借用若干个位作为子网号 subnet-id</span></div></div><div id="un6SycK4oiAK3Tvowq1BcW" class="wolai-block wolai-text"><div><span class="inline-wrap">•主机号 host-id<span class="jill"></span>也就相应减少了若干个位</span></div><div id="m4KS9SLDcMLB8gK8Vsbvze" class="wolai-block"><figure class="wolai-left" style="width: 100%"><img src="media/image_33.png" style="width: 492px"/></figure></div></div><div id="eo4Hpm4SZmAAhAbrjJ5frV" class="wolai-block wolai-text"><div><span class="inline-wrap">•从其它网络发送给本单位某个主机的<span class="jill"></span>IP<span class="jill"></span>数据报，仍然是根据<span class="jill"></span>IP<span class="jill"></span>分组的目的网络号<span class="jill"></span>net-id，先找到连接在本单位网络上的路由器</span></div></div><div id="9BYyKvVLFfYuxzDmXWxbFS" class="wolai-block wolai-text"><div><span class="inline-wrap">•此路由器在收到<span class="jill"></span>IP<span class="jill"></span>分组后，再按目的网络号<span class="jill"></span>net-id<span class="jill"></span>和子网号<span class="jill"></span>subnet-id<span class="jill"></span>找到目的子网，并将<span class="jill"></span>IP<span class="jill"></span>分组直接交付目的主机</span></div></div><div id="sBvQhzryAsUSrvdpgRKmEx" class="wolai-block wolai-text"><div><span class="inline-wrap">•一个未划分子网的 B 类网络<span class="jill"></span>145.13.0.0<span class="jill"></span>如下左图</span></div></div><div id="i9ZH9VfjXsBKizQ9Xuici2" class="wolai-block wolai-text"><div><span class="inline-wrap">•如下右图展示了划分为三个子网后对外仍是一个网络</span></div></div><div id="r8UKxDwzZrEXNwgymzBh9h" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_34.png" style="width: 100%"/></figure></div><h2 id="cvcpeusjFuLeZvVgAUPvsR" class="wolai-block"><span class="inline-wrap">子网掩码</span></h2><div id="dk9zWVNE2kf8nHKecGFzxT" class="wolai-block wolai-text"><div><span class="inline-wrap">•从一个 IP 分组的首部并无法判断源主机或目的主机所连接的网络是否进行了子网划分</span></div></div><div id="53AGGyEw61D94GUCozfh92" class="wolai-block wolai-text"><div><span class="inline-wrap">•使用子网掩码 (subnetmask) 可以找出<span class="jill"></span>IP 地址中的子网部分</span></div></div><h4 id="hcUuyKmdjxfbGwHEBvnQYb" class="wolai-block"><span class="inline-wrap">子网掩码的特点</span></h4><div id="33mYj8qBS3imDYVeMbs2E" class="wolai-block wolai-text"><div><span class="inline-wrap">•长度 为 32 位的比特串</span></div></div><div id="7XkdxowMeQesbXqGncWwdL" class="wolai-block wolai-text"><div><span class="inline-wrap">•左边部分有一连串比特 1，对应于网络号和子网号</span></div></div><div id="rtUFW7nx6gtLpw732HKnLP" class="wolai-block wolai-text"><div><span class="inline-wrap">•右边部分有一连串比特<span class="jill"></span>0，对应于主机号</span></div></div><h4 id="UFXQzDSBMdB2Kg4BqZFim" class="wolai-block"><span class="inline-wrap">子网掩码的作用</span></h4><div id="2gAhn1uXiYi8NMGuDhAq5N" class="wolai-block wolai-text"><div><span class="inline-wrap">•使用子网掩码与同一子网的<span class="jill"></span>IP<span class="jill"></span>地址进行相“与”运算（二进制逻辑与），可以得到该地址的子网号</span></div></div><div id="6yG1j3K6AgSqvNocS477uf" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_35.png" style="width: 100%"/></figure></div><div id="xcKEFuVjhBm7viNEMCELjW" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_36.png" style="width: 100%"/></figure></div><div id="69iKGYNBhgmEQKEEvz1fWt" class="wolai-block wolai-text"><div><span class="inline-wrap">针对未划分子网的<span class="jill"></span>A、B、C<span class="jill"></span>类地址，掩码是默认的，不需要显式给出</span></div></div><div id="nUDTBBkvaWSrxSboj5AXcv" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_37.png" style="width: 739.2px"/></figure></div><div id="dLQtqrNS1BuNoGvqv1jxKz" class="wolai-block wolai-text"><div><span class="inline-wrap">•在划分了子网情况下，路由器在和相邻路由器交换路由信息时，必须把自己所在子网的子网掩码告诉相邻路由器</span></div></div><div id="2Ra9hnWxmodwyBVci4XdDp" class="wolai-block wolai-text"><div><span class="inline-wrap">•路由器的路由表中的每一个项目，除了要给出目的网络地址外，还必须同时给出该子网络的子网掩码。</span></div></div><div id="9KznxTvEiHE6MNdrx8BVSW" class="wolai-block wolai-text"><div><span class="inline-wrap">•若一个路由器连接在两个子网上，就拥有两个网络地址和两个子网掩码</span></div></div><h2 id="aB2Ced469bJYSUqLKwkFaN" class="wolai-block"><span class="inline-wrap">子网划分方法</span></h2><div id="45fXNWnG3geSTL8NhXb7pD" class="wolai-block wolai-text"><div><span class="inline-wrap">•有固定长度子网和变长子网两种子网划分方法</span></div></div><h3 id="xpSerK19mXbjR5ymLu8LxP" class="wolai-block"><span class="inline-wrap">固定长度子网</span></h3><div id="eMUDVxFSyACQqgv3AKsFzy" class="wolai-block wolai-text"><div><span class="inline-wrap">•在采用固定长度子网时，所划分的所有子网的子网掩码都是相同的</span></div></div><div id="t1mupzzfVNRQChS8oybP6" class="wolai-block wolai-text"><div><span class="inline-wrap">•根据已成为互联网标准协议的 RFC950 文档，子网号不能为全<span class="jill"></span>1 或全 0</span></div></div><div id="g1nEnb1ugHaSNUvyfvLSjN" class="wolai-block wolai-text"><div><span class="inline-wrap">•随着无分类域间路由选择 CIDR<span class="jill"></span>的广泛使用，全 1 和全 0 的子网号也可以使用</span></div></div><div id="rWZkvrwopmfEQtRddLFohu" class="wolai-block wolai-text"><div><span class="inline-wrap">•全 1 和全 0 的子网号的使用一定要谨慎，确保设备的路由软件能支持</span></div></div><div id="gmeejQLiT7c1mKHV8ANiwN" class="wolai-block wolai-text"><div><span class="inline-wrap">•划分子网增加了灵活性，但却减少了能够连接在网络上的主机总数</span></div></div><div id="dKruaR5WtFex6ocLZNeTNH" class="wolai-block wolai-text"><div><span class="inline-wrap">以<span class="jill"></span>B 类地址为例</span></div></div><div id="3NJkWDY8v8KWXSJ6wdFQdc" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_38.png" style="width: 100%"/></figure></div><h3 id="dcG56Vap3htvCZXFuxBBzT" class="wolai-block"><span class="inline-wrap">可变长子网掩码</span></h3><div id="jAewhiXYN3GZj42bw1V385" class="wolai-block wolai-text"><div><span class="inline-wrap">•针对固定长度子网基本的限制——整个网络只能有一个子网掩码，1987<span class="jill"></span>年针对这一问题提出了解决方法</span></div></div><div id="pBqgkVPKeF7sPWvDo9DvVB" class="wolai-block wolai-text"><div><span class="inline-wrap">•IETF<span class="jill"></span>发布了<span class="jill"></span>RFC1009<span class="jill"></span>文档——规范了如何使用多个子网掩码划分子网</span></div></div><div id="txyAq6dSQhN6aLvMk3qNjw" class="wolai-block wolai-text"><div><span class="inline-wrap">•新的子网化技术称为<span class="jill"></span>VLSM（VariableLength Subnet Mask, 可变长子网掩码）</span></div></div><div id="jUbHNR4J484aiNvomfk7qF" class="wolai-block wolai-text"><div><span class="inline-wrap">•这是一种产生不同大小子网的网络分配机制</span></div></div><h4 id="4NKfxYatDYa4NVW3VydG9B" class="wolai-block"><span class="inline-wrap">使用<span class="jill"></span>VLSM<span class="jill"></span>进行子网划分的基本步骤：</span></h4><div id="pX2r9PMt7rehoWRU4nEcdi" class="wolai-block wolai-text"><div><span class="inline-wrap">•使用某一掩码划分出所需要的最大的子网</span></div></div><div id="qB8piXDcRLae3dcy4W1dPk" class="wolai-block wolai-text"><div><span class="inline-wrap">•从这些最大的子网中选择一个</span></div></div><div id="iu2WA5ikFth8xDTeE5BtYK" class="wolai-block wolai-text"><div><span class="inline-wrap">•用一个更长的掩码对它继续进行子网划分</span></div></div><div id="gQMs4a9FoswW6UxMXFsYzw" class="wolai-block wolai-text"><div><span class="inline-wrap">•示例：如何在一个<span class="jill"></span>B<span class="jill"></span>类网络地址块<span class="jill"></span>172.16.0.0（默认网络前缀长度<span class="jill"></span>16）下，为一个地址需求数范围<span class="jill"></span>600~1000<span class="jill"></span>的机构、一个地址需求数范围<span class="jill"></span>40~60<span class="jill"></span>的机构分配地址块？</span></div></div><div id="7Da9c6c9i3KK4fBDGiAZrE" class="wolai-block wolai-text"><div><span class="inline-wrap">•首先按<span class="jill"></span>22<span class="jill"></span>位的扩展网络前缀来划分，即有<span class="jill"></span>62<span class="jill"></span>个前缀长度为<span class="jill"></span>22<span class="jill"></span>的可用子网，从中选择一个（例如，172.16.4.0/22）分配给地址需求数大的机构</span></div></div><div id="ttxA8pCvoHficYQEP5wZJ9" class="wolai-block wolai-text"><div><span class="inline-wrap">•然后再从中选择另一个（例如，172.16.8.0/22），按<span class="jill"></span>26<span class="jill"></span>位的扩展网络前缀继续进行划分，可得到<span class="jill"></span>14<span class="jill"></span>个前缀长度为<span class="jill"></span>26<span class="jill"></span>的子网，从中选择一个（例如，172.16.8.64/26）分配给地址需求数小的机构</span></div></div><h4 id="oN6zHRqwGseXsUWNgbcnJ2" class="wolai-block"><span class="inline-wrap">在可变长子网划分的网络中如何路由？</span></h4><div id="qwq785LSZSQekcxJU5rK1k" class="wolai-block wolai-text"><div><span class="inline-wrap">•一个携带目的<span class="jill"></span>IP<span class="jill"></span>地址<span class="jill"></span>128.208.2.151 的<span class="jill"></span>IP<span class="jill"></span>分组应该被路由到何处？</span></div></div><div id="fddueCPf3h9UoxpHLHtfcq" class="wolai-block wolai-text"><div><span class="inline-wrap">•它是属于<span class="jill"></span>CS? 还是属于<span class="jill"></span>EE<span class="jill"></span>或<span class="jill"></span>Art？</span></div></div><div id="fWqbRzu6mirw1y4B2zDNPs" class="wolai-block wolai-text"><div><span class="inline-wrap">•把该目的地址与<span class="jill"></span>CS<span class="jill"></span>网段的子网掩码<span class="jill"></span>255.255.128.0<span class="jill"></span>进行<span class="jill"></span>AND<span class="jill"></span>操作后得到<span class="jill"></span>128.208.0.0，它与<span class="jill"></span>CS<span class="jill"></span>网段的网络地址<span class="jill"></span>128.208.128.0<span class="jill"></span>不匹配</span></div></div><div id="4VnKYJ9M8tmBGqD7abE1fL" class="wolai-block wolai-text"><div><span class="inline-wrap">•把该目的地址与<span class="jill"></span>EE<span class="jill"></span>网段的子网掩码<span class="jill"></span>255.255.192.0<span class="jill"></span>进行<span class="jill"></span>AND<span class="jill"></span>操作后得到<span class="jill"></span>128.208.0.0，它与<span class="jill"></span>EE<span class="jill"></span>网段的网络地址<span class="jill"></span>128.208.0.0<span class="jill"></span>匹配</span></div></div><div id="GBWzHYeQTQSxfu98Z8C1y" class="wolai-block wolai-text"><div><span class="inline-wrap">•因此它应该被路由到<span class="jill"></span>EE</span></div></div><h4 id="5CGEW34dmJ89rUnX6NHz2B" class="wolai-block"><span class="inline-wrap">CIDR</span></h4><div id="kv7J7sG7QHuyFKuJLM5JpD" class="wolai-block wolai-text"><div><span class="inline-wrap">•划分子网在一定程度上缓解了互联网在发展中遇到的困难</span></div></div><div id="8NZRK6DvBZsNpyGTUwtZF2" class="wolai-block wolai-text"><div><span class="inline-wrap">•使用变长子网掩码<span class="jill"></span>VLSM<span class="jill"></span>可进一步提高<span class="jill"></span>IP<span class="jill"></span>地址资源的利用率</span></div></div><div id="dLj7PyzRn6VW5SwP7fCk7U" class="wolai-block wolai-text"><div><span class="inline-wrap">•在 VLSM<span class="jill"></span>的基础上又进一步研究出无分类编址方法，它的正式名字是无分类域间路由选择<span class="jill"></span>CIDR(Classless Inter-Domain Routing)</span></div></div><div id="egh74WgweG72577kPAGKfe" class="wolai-sub-page wolai-block"><div class="page-icon"></div><a href="ipv4%E5%9C%B0%E5%9D%80/cidr/cidr.html"><span>CIDR</span></a><h2 id="bvEw8aMAwPzqfRnvDAss1M" class="wolai-block"><span class="inline-wrap">记法</span></h2><h3 id="vBoeQvZ6TQAYeiK7U18HsD" class="wolai-block"><span class="inline-wrap">一般记法</span></h3><div id="qsEwq9MdNnieMEHS541Rdd" class="wolai-block wolai-text"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>I</mi><mi>P</mi><mo>:</mo><mo>:</mo><mo>=</mo><mo stretchy="false">{</mo><mo>&lt;</mo><mtext>网络前缀</mtext><mo>&gt;</mo><mo separator="true">,</mo><mo>&lt;</mo><mtext>主机号</mtext><mo>&gt;</mo><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">IP:: =\{&lt; 网络前缀 &gt;,&lt; 主机号 &gt;\} </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">::=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord cjk_fallback">网络前缀</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span></span><span class="base"><span class="strut" style="height:0.7335em;vertical-align:-0.1944em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord cjk_fallback">主机号</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mclose">}</span></span></span></span></span></div><h3 id="8xdXNFHf5zoyMgkuafQgRz" class="wolai-block"><span class="inline-wrap">斜线记法</span></h3><div id="ccHtHN9LCSwMVWRDhJhoSU" class="wolai-block wolai-text"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>I</mi><mi>P</mi><mtext>地址</mtext><mi mathvariant="normal">/</mi><mtext>网络前缀所占比特数</mtext></mrow><annotation encoding="application/x-tex">IP 地址/网络前缀所占比特数</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord cjk_fallback">地址</span><span class="mord">/</span><span class="mord cjk_fallback">网络前缀所占比特数</span></span></span></span></span></div><div id="3NApXjKV82mPXiRBkGGvg5" class="wolai-block wolai-text"><div><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>例如</mtext><mo separator="true">,</mo><mtext>对于</mtext><mn>128.14.32.5</mn><mi mathvariant="normal">/</mi><mn>20</mn></mrow><annotation encoding="application/x-tex">例如, 对于 128.14 .32 .5 / 20</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord cjk_fallback">例如</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord cjk_fallback">对于</span><span class="mord">128.14.32.5/20</span></span></span></span></span></div></div><div id="4kTNYCtr2YyLBB8RgNXALf" class="wolai-block wolai-text"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>逐位与</mtext><mrow><mo fence="true">{</mo><mtable rowspacing="0.16em" columnalign="left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mrow><mi mathvariant="normal">I</mi><mi mathvariant="normal">P</mi></mrow><mo>=</mo><mtext>    </mtext><mn>10000000.00001110.00100000.00000101</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>掩码</mtext><mo>=</mo><mn>11111111.11111111.11110000.00000000</mn></mrow></mstyle></mtd></mtr></mtable></mrow><mspace linebreak="newline"></mspace><mtext>                             网络前缀</mtext><mo>=</mo><mn>10000000.00001110.00100000.00000000</mn><mo stretchy="false">(</mo><mn>128.14.32.0</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">逐位与 \left\{\begin{array}{l}\mathrm{IP}=\ \ \ \ 10000000.00001110 .00100000 .00000101 \\ 掩码 =11111111.11111111 .11110000 .00000000\end{array}\right.\\\ \ \ \ \ \ \ \ \ \ \ \  \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 网络前缀 = 10000000.00001110 .00100000 .00000000 (128.14.32.0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="mord cjk_fallback">逐位与</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">{</span></span><span class="mord"><span class="mtable"><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">IP</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">10000000.00001110.00100000.00000101</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord cjk_fallback">掩码</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">11111111.11111111.11110000.00000000</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mord cjk_fallback">网络前缀</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">10000000.00001110.00100000.00000000</span><span class="mopen">(</span><span class="mord">128.14.32.0</span><span class="mclose">)</span></span></span></span></span></div><h2 id="bDdhExZe5rz3m2xVLj79Eo" class="wolai-block"><span class="inline-wrap">“CIDR”不使用子网</span></h2><div id="7GBzRqPYTJwT4u5ZMGWR7S" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_39.png" style="width: 100%"/></figure></div><h2 id="7uGUFCTQZS7xyScMLxuSba" class="wolai-block"><span class="inline-wrap">地址块与路由聚合</span></h2><div id="uyj9bk8NzWv9FaPcazVRXi" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_40.png" style="width: 100%"/></figure></div><aside id="bdkVfMvQuhrMc1NSUDRyMW" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap">路由聚合目的：缩小路由表的表项</span></aside><h4 id="45QB2D2GcFEBDSxrfARskU" class="wolai-block"><span class="inline-wrap">CIDR<span class="jill"></span>路由聚合示例</span></h4><div id="8Xw7UBdykHpuKozesWyEmH" class="wolai-block wolai-text"><div><span class="inline-wrap">•某<span class="jill"></span>ISP<span class="jill"></span>已经有一个地址块<span class="jill"></span>200.23.16.0/20</span></div></div><div id="a7tax5sPgbReqhHrmjjN2F" class="wolai-block wolai-text"><div><span class="inline-wrap">•它可以依次序将该地址块分成八个大小相等的连续的更小的地址块</span></div></div><div id="pQP9GfNd2XD9Ye2cWB18UJ" class="wolai-block wolai-text"><div><span class="inline-wrap">•分别分配给它服务的<span class="jill"></span>8<span class="jill"></span>个组织，网络结构见下图</span></div></div><div id="qZqbjZwCnhmzpxe6cmCiNu" class="wolai-block wolai-text"><div><span class="inline-wrap">•Internet<span class="jill"></span>其它组织或用户不需要知道在地址块<span class="jill"></span>200.23.16.0/20<span class="jill"></span>内实际上还存在这<span class="jill"></span>8<span class="jill"></span>个组织的子网，只需要找到<span class="jill"></span>200.23.16.0/20，就能找到这<span class="jill"></span>ISP，再由<span class="jill"></span>ISP<span class="jill"></span>可能找到<span class="jill"></span>8<span class="jill"></span>个子网中任何一个，减少了路由器维护的表项数</span></div></div><div id="gnMomeGokW8WPk6T5GjyKs" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_41.png" style="width: 747.2px"/></figure></div><h4 id="kjLjauGBD61JiKz3QjNKmZ" class="wolai-block"><span class="inline-wrap">地址块中的地址数</span></h4><div id="gYU4MwqGPLyipKPZDgXqmz" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_42.png" style="width: 100%"/></figure></div><div id="7cLWPGEdq5afmsSh2ZaRPp" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_43.png" style="width: 100%"/></figure></div><div id="b8DLmhEpbQjbBeYTD9qZWV" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_44.png" style="width: 628.8px"/></figure></div><div id="31NwrVmCX9cc1L2JoKBoXR" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_45.png" style="width: 590.4px"/></figure></div><h3 id="wor1B6isrcsr1b2nQjki7x" class="wolai-block"><span class="inline-wrap">分配例子</span></h3><div id="2dbYHpV8DuvZ7jodPejCMX" class="wolai-block wolai-text"><div><span class="inline-wrap">•有一块地址从<span class="jill"></span>194.24.0.0<span class="jill"></span>开始，可用的地址数是<span class="jill"></span>8192<span class="jill"></span>个，即<span class="jill"></span>194.24.0.0/19，分配情况如下图</span></div></div><div id="gaNi7Gg7twA94bfRh22fka" class="wolai-block wolai-text"><div><span class="inline-wrap">•剑桥需要<span class="jill"></span>2048，主机需要<span class="jill"></span>11<span class="jill"></span>位，网络位是<span class="jill"></span>32-11=21<span class="jill"></span>位。 194.24.0.0<span class="jill"></span>开始到<span class="jill"></span>192.24.7.255 1100001000011000 00000 111 11111111 </span></div></div><div id="oAurzSZgEGo2VdCtWpNHMk" class="wolai-block wolai-text"><div><span class="inline-wrap">•爱丁堡需要<span class="jill"></span>1024，所以只需要<span class="jill"></span>10<span class="jill"></span>位主机位，网络为<span class="jill"></span>22<span class="jill"></span>位</span></div></div><div id="kRfHxKCHnevKWfTdBhGXvk" class="wolai-block wolai-text"><div><span class="inline-wrap">•194.24.11.255 1100001000011000 00000 1011 11111111</span></div></div><div id="zgzgHC4f1F196HBXF1jgi" class="wolai-block wolai-text"><div><span class="inline-wrap">•其他分配从<span class="jill"></span>194.24.12.0<span class="jill"></span>开始<span class="jill"></span>11000010 00011000 0000110000000000</span></div></div><div id="5ktTRcU95yth4GG5HQHtXR" class="wolai-block wolai-text"><div><span class="inline-wrap">•到<span class="jill"></span>194.24.15.155 11000010 00011000 000011111111111</span></div></div><div id="dSbQvuBwQXxMyeoLf1pcn2" class="wolai-block wolai-text"><div><span class="inline-wrap">•牛津大学需要<span class="jill"></span>4096<span class="jill"></span>个主机，需要<span class="jill"></span>12<span class="jill"></span>位，网络位<span class="jill"></span>20<span class="jill"></span>位，从<span class="jill"></span>194.24.16.0<span class="jill"></span>开始到<span class="jill"></span>193.23.31.255 11000010 0001100000011111 11111111</span></div></div><div id="9u6zzgSmDhMiWvAJ5KCVd" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_46.png" style="width: 100%"/></figure></div><div id="kJQTxgwKQzLCtY9QEhKE1X" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_47.png" style="width: 100%"/></figure></div><h2 id="g6FBU8tzJcXpmyBJvCbAet" class="wolai-block"><span class="inline-wrap">路由</span></h2><div id="nehaofGtkUSznVibMifM7j" class="wolai-block wolai-text"><div><span class="inline-wrap">•从纽约的远程路由器来看，3<span class="jill"></span>个前缀的所有<span class="jill"></span>IP<span class="jill"></span>地址合成一个聚合表项，即前缀<span class="jill"></span>194.24.0.0/19<span class="jill"></span>地址从<span class="jill"></span>194.24.0.0<span class="jill"></span>开始，可用的地址是<span class="jill"></span>8192<span class="jill"></span>个（即<span class="jill"></span>2<span class="jill"></span>的<span class="jill"></span>13<span class="jill"></span>次方即位<span class="jill"></span>8192）</span></div></div><div id="6nEfNrdpKks3CFgiKxXZu3" class="wolai-block wolai-text"><div><span class="inline-wrap">•通过聚合，3<span class="jill"></span>个不同前缀的网络被聚合为一个超网（即三所大学的<span class="jill"></span>3<span class="jill"></span>个前缀合并成一个聚合表项）194.24.0.0/19，大大降低了表项数</span></div></div><div id="haJaG9htZuUxi5QxsEpgmi" class="wolai-block wolai-text"><div><span class="inline-wrap">•假如一个<span class="jill"></span>IP<span class="jill"></span>地址是<span class="jill"></span>194.24.17.4，将该地址与<span class="jill"></span>Mask<span class="jill"></span>相与，只与<span class="jill"></span>Oxford<span class="jill"></span>匹配，选取<span class="jill"></span>Oxford，即<span class="jill"></span>Oxford<span class="jill"></span>牛津大学对应的路由器端口</span></div></div><div id="h7Y6csjvWbybcr5gK7S2gL" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_48.png" style="width: 680px"/></figure></div><h3 id="mSWCayUTDcaFwVsae7URQA" class="wolai-block"><span class="inline-wrap">最长前缀匹配(longest-prefixmatching)</span></h3><div id="j5EN9Po5bjtFLr1kBekHBs" class="wolai-block wolai-text"><div><span class="inline-wrap">•使用 CIDR 时，路由表中的每个项目由“网络前缀”和“下一跳地址”组成</span></div></div><div id="w96DZRUUZvhPfqkyZQ3vqL" class="wolai-block wolai-text"><div><span class="green inline-wrap"><b>•在查找路由表时可能会得到不止一个匹配结果</b></span></div></div><div id="pbXr9LTqf4DTfHJmmh6Tp1" class="wolai-block wolai-text"><div><span class="inline-wrap">•应当从匹配结果中选择具有最长网络前缀的路由，即最长前缀匹配</span></div></div><div id="87ovB69FhNfotULq1rBCty" class="wolai-block wolai-text"><div><span class="inline-wrap">•网络前缀越长，其地址块就越小，因而路由就越具体</span></div></div><div id="vEq2HL2GUVQUqEhFYWQib8" class="wolai-block wolai-text"><div><span class="inline-wrap">•最长前缀匹配又称为最长匹配或最佳匹配</span></div></div><h4 id="Qfa8E4iSVPNkRW7L79q4V" class="wolai-block"><span class="inline-wrap">举个栗子🌰一：</span></h4><div id="asMKScVymgTdP6tgikCmvY" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_49.png" style="width: 100%"/></figure></div><div id="npDCgbGoysKS9pGwyCwnyp" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_50.png" style="width: 567.2px"/></figure></div><h4 id="kkzqHSTPhqZTobthgyodMs" class="wolai-block"><span class="inline-wrap">举个栗子🌰二：</span></h4><div id="rwBSfjR8xsrHN6GUw7HNKu" class="wolai-block wolai-text"><div><span class="inline-wrap">•一个目标地址为<span class="jill"></span>192.23.12.2<span class="jill"></span>的<span class="jill"></span>IP<span class="jill"></span>分组经过<span class="jill"></span>New York<span class="jill"></span>路由器</span></div></div><div id="ttK3ENZ89b5FHWd8z4vsgP" class="wolai-block wolai-text"><div><span class="inline-wrap">•与<span class="jill"></span>19<span class="jill"></span>位的子网掩码<span class="jill"></span>AND<span class="jill"></span>操作后，匹配的结果是<span class="jill"></span>192.24.0.0</span></div></div><div id="4cQ1vesLnyB9Npp5xKm9J7" class="wolai-block wolai-text"><div><span class="inline-wrap">•与<span class="jill"></span>22<span class="jill"></span>位的子网掩码<span class="jill"></span>AND<span class="jill"></span>操作后，匹配的结果是<span class="jill"></span>192.24.12.0</span></div></div><div id="whJCkjf94JPzJAVpG2b4qf" class="wolai-block wolai-text"><div><span class="inline-wrap">•按照最长匹配前缀路由规则，22<span class="jill"></span>比<span class="jill"></span>19<span class="jill"></span>长，所以该<span class="jill"></span>IP<span class="jill"></span>分组被发往圣弗朗西斯科，而不是伦敦</span></div></div><div id="4Sm4ztDXNfniG671Z9Smpa" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_51.png" style="width: 100%"/></figure></div><h2 id="oqVv1SfqvdVwZP3A13Wyfa" class="wolai-block"><span class="inline-wrap">路由转发过程</span></h2><div id="tgDnWGmgCxaEzHnxuRhTHQ" class="wolai-block wolai-text"><div><span class="inline-wrap">•在不划分子网的两级<span class="jill"></span>IP<span class="jill"></span>地址下的<span class="jill"></span>IP<span class="jill"></span>分组转发过程</span></div></div><div id="ecFp4pc1jxW3uTRMAVZLng" class="wolai-block wolai-text"><div><span class="inline-wrap">•分类<span class="jill"></span>IPv4<span class="jill"></span>地址中每一类地址都由两个固定长度的网络号<span class="jill"></span>net-id<span class="jill"></span>和主机号<span class="jill"></span>host-id<span class="jill"></span>字段组成，且网络掩码是默认的</span></div></div><div id="3sYiddcyk943VBHc22zxxt" class="wolai-block wolai-text"><div><span class="inline-wrap">•IPv4<span class="jill"></span>地址是标志一个主机（或路由器）和一条链路的接口</span></div></div><div id="91jRcnPqtoSmcAqP4cVVzB" class="wolai-block wolai-text"><div><span class="inline-wrap">•每个路由器至少应连接到两个网络，以便能将<span class="jill"></span>IPv4<span class="jill"></span>分组从一个网络转发到另一个网络，因此一个路由器至少应当有两个不同的<span class="jill"></span>IPv4<span class="jill"></span>地址</span></div></div><h4 id="vBfaigRsWiWKodq1UpT5w" class="wolai-block"><span class="inline-wrap">使用网络地址作为路由表项中目的地的路由</span></h4><div id="rmmn2vfczw19iaWnAzQ6cv" class="wolai-block wolai-text"><div><span class="inline-wrap">•假设有四个<span class="jill"></span>A<span class="jill"></span>类网络通过三个路由器连接在一起</span></div></div><div id="nhEbxxmnwG8VhG6D5vBa4N" class="wolai-block wolai-text"><div><span class="inline-wrap">•每一个网络上都可能有成千上万个主机</span></div></div><div id="eTRW9Ydf6ktsKHTe9HgxQz" class="wolai-block wolai-text"><div><span class="inline-wrap">•若按目的主机号来制作路由表，则每一个路由表都会过于庞大</span></div></div><div id="5jZi55WJnNezxc7c51uFM7" class="wolai-block wolai-text"><div><span class="inline-wrap">•若按主机所在的网络地址来制作路由表，则每一个路由器中的路由表就会大大简化</span></div></div><div id="2f2fo747xgijz9QzGkbrHZ" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_52.png" style="width: 100%"/></figure></div><h4 id="aqcNJ6V1gA9E45F4pnehxM" class="wolai-block"><span class="inline-wrap">基于目的网络地址的路由表项查找</span></h4><div id="cH9PFF4az26NBZ7coKzoFC" class="wolai-block wolai-text"><div><span class="inline-wrap">•根据目的网络地址就能确定下一跳路由器，这样做的结果是</span></div></div><div id="2d8uiz4J1VnF8qKaryFkqN" class="wolai-block wolai-text"><div><span class="inline-wrap">•IP<span class="jill"></span>分组最终一定可以找到目的主机所在目的网络上的路由器（可能要通过多次的间接交付）</span></div></div><div id="9DAn7wagBXdVtSpYGnQgNq" class="wolai-block wolai-text"><div><span class="inline-wrap">•只有到达最后一个路由器时，才试图向目的主机进行直接交付</span></div></div><div id="sj1nybui5vaknCoBWK6pFq" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_53.png" style="width: 100%"/></figure></div><h3 id="u34KrB7fGn3aru9UqCNr8V" class="wolai-block"><span class="inline-wrap">在不划分子网的两级<span class="jill"></span>IP<span class="jill"></span>地址下的<span class="jill"></span>IP<span class="jill"></span>分组转发过程</span></h3><h4 id="kumdrEGfhUJsda8M2YebGE" class="wolai-block"><span class="inline-wrap">基于特定主机路由的路由表项查找</span></h4><div id="8aBqLUpUPgZam8dwkCYHAn" class="wolai-block wolai-text"><div><span class="inline-wrap">•虽然互联网所有的分组转发都是基于目的主机所在的网络</span></div></div><div id="oQdYrm8PmBShApfoptuW9T" class="wolai-block wolai-text"><div><span class="inline-wrap">•但在大多数情况下都允许有这样的特例</span></div></div><div id="qa2RqYZ2K5rWtXvBCXcEuK" class="wolai-block wolai-text"><div><span class="inline-wrap">•即为特定的目的主机指明一个路由</span></div></div><div id="tyREbKMtkcPoYcq2HZPAfX" class="wolai-block wolai-text"><div><span class="inline-wrap">•采用特定主机路由可使网络管理人员能更方便地控制网络和测试网络</span></div></div><div id="7MFg3YbMiXpiF844TkFXYi" class="wolai-block wolai-text"><div><span class="inline-wrap">•同时也可在需要考虑某种安全问题时采用这种特定主机路由</span></div></div><h4 id="4h89gUGwD354vtWxdRo5QD" class="wolai-block"><span class="inline-wrap">基于默认路由的路由表项查找</span></h4><div id="8KFhCrc3LCATJSyAHp9VVN" class="wolai-block wolai-text"><div><span class="inline-wrap">•路由器可采用默认路由以减少路由表所占用的空间和搜索路由表所用的时间</span></div></div><div id="8h65DSJCKhMfL7k1ky7gX6" class="wolai-block wolai-text"><div><span class="inline-wrap">•这种转发方式在一个网络只有很少的对外连接时是很有用的</span></div></div><div id="aRPcb1VPCFtWD96JtscrHn" class="wolai-block wolai-text"><div><span class="inline-wrap">•默认路由在主机发送<span class="jill"></span>IP<span class="jill"></span>分组时往往更能显示出它的好处</span></div></div><div id="dMhy9Rngrn8ahJZ262t6P6" class="wolai-block wolai-text"><div><span class="inline-wrap">•如果一个主机连接在一个小网络上，而这个网络只用一个路由器和互联网连接，那么在这种情况下使用默认路由是非常合适的</span></div></div><div id="tU7at42nhCkwpTEk5J7Hq1" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_54.png" style="width: 100%"/></figure></div><div id="ur2jTresyDZWvhpGJ9ZHhV" class="wolai-block wolai-text"><div><span class="inline-wrap">•IP<span class="jill"></span>分组的首部中没有字段用来指明“下一跳路由器的<span class="jill"></span>IP<span class="jill"></span>地址”</span></div></div><div id="4GVWC4XbTPZD3wHqeDWN2o" class="wolai-block wolai-text"><div><span class="inline-wrap">•当路由器收到待转发的<span class="jill"></span>IP<span class="jill"></span>分组时，不是将下一跳路由器的<span class="jill"></span>IP<span class="jill"></span>地址填入 IP<span class="jill"></span>分组，而是送交下层的网络接口软件</span></div></div><div id="toAnjXj5jTAFG3w7BZiAyJ" class="wolai-block wolai-text"><div><span class="inline-wrap">•网络接口软件使用<span class="jill"></span>ARP<span class="jill"></span>负责将下一跳路由器的<span class="jill"></span>IP<span class="jill"></span>地址转换成硬件地址，并将此硬件地址放在链路层的<span class="jill"></span>MAC<span class="jill"></span>帧的首部，然后根据这个硬件地址找到下一跳路由器</span></div></div><h4 id="xewSFwRkbV23DTL3Lz1MHu" class="wolai-block"><span class="inline-wrap">在路由器上执行分组转发流程</span></h4><div id="i8gR7WMZhDDkvLQTkXWhPj" class="wolai-block wolai-text"><div><span class="inline-wrap">•1）从接收的<span class="jill"></span>IP<span class="jill"></span>分组首部提取目的主机的<span class="jill"></span>IP<span class="jill"></span>地址 D,得出目的网络地址为<span class="jill"></span>N</span></div></div><div id="3YqT7hUpTebkdU91j4eRop" class="wolai-block wolai-text"><div><span class="inline-wrap">•2）若网络<span class="jill"></span>N<span class="jill"></span>与此路由器直接相连，则把<span class="jill"></span>IP<span class="jill"></span>分组直接交付目的主机<span class="jill"></span>D；否则是间接交付，执行<span class="jill"></span>3)</span></div></div><div id="k627ZoL4KxMEEWEDnoxSsP" class="wolai-block wolai-text"><div><span class="inline-wrap">•3）若路由表中有目的地址为<span class="jill"></span>D<span class="jill"></span>的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行<span class="jill"></span>4)</span></div></div><div id="94spi58tPry8eafGWHoz2Q" class="wolai-block wolai-text"><div><span class="inline-wrap">•4）若路由表中有到达网络<span class="jill"></span>N<span class="jill"></span>的路由，则把数据报传送给路由表指明的下一跳路由器；否则，执行<span class="jill"></span>5)</span></div></div><div id="qdzEWcLLPXm8ZQhayTL7kw" class="wolai-block wolai-text"><div><span class="inline-wrap">•5）若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则，执行<span class="jill"></span>6)</span></div></div><div id="bMsreMXvzrM5qGQaa68jFk" class="wolai-block wolai-text"><div><span class="inline-wrap">•6）报告转发分组出错</span></div></div><hr id="rqzMUa3YhK8AMDVY6HyX1Y" class="wolai-block"/><div id="gqQLgCsp4uUUsHTNhv4qsH" class="wolai-block wolai-text"><div><span class="inline-wrap">•在不划分子网的两级<span class="jill"></span>IP<span class="jill"></span>地址下，从<span class="jill"></span>IP<span class="jill"></span>地址得出网络地址是个很简单的事</span></div></div><div id="jm73uExdFscWPPHnx81VRM" class="wolai-block wolai-text"><div><span class="inline-wrap">•在划分子网的情况下，从<span class="jill"></span>IP<span class="jill"></span>地址却不能唯一地得出网络地址来</span></div></div><div id="n3bsHZfpdgjCEdpskYva8L" class="wolai-block wolai-text"><div><span class="inline-wrap">•原因是网络地址取决于那个网络所采用的子网掩码，而<span class="jill"></span>IP<span class="jill"></span>首部并没有提供子网掩码的信息</span></div></div><div id="3SLK4AuAALpqJP3pXwRSCd" class="wolai-block wolai-text"><div><span class="inline-wrap">•因此分组转发的算法也必须做相应的改动</span></div></div><hr id="fVfmiruDd85XtyzLD5ucwA" class="wolai-block"/><div id="9swPDRn8qFvnV7jwtEs4Z" class="wolai-block wolai-text"><div><span class="inline-wrap">•在不划分子网的两级<span class="jill"></span>IP<span class="jill"></span>地址下，从<span class="jill"></span>IP<span class="jill"></span>地址得出网络地址是个很简单的事</span></div></div><div id="cvk3XtdBtaesX7vwzaXAke" class="wolai-block wolai-text"><div><span class="inline-wrap">•在划分子网的情况下，从<span class="jill"></span>IP<span class="jill"></span>地址却不能唯一地得出网络地址来</span></div></div><div id="nUHWSgRDekunLzfVFptXfJ" class="wolai-block wolai-text"><div><span class="inline-wrap">•原因是网络地址取决于那个网络所采用的子网掩码，而<span class="jill"></span>IP<span class="jill"></span>首部并没有提供子网掩码的信息</span></div></div><div id="cfARQA8ipGjVYVR1kxzzS" class="wolai-block wolai-text"><div><span class="inline-wrap">•因此分组转发的算法也必须做相应的改动</span></div></div><div id="qv5pRPqvo22x78WChJHami" class="wolai-block wolai-text"><div><span class="inline-wrap">•已知互联网和路由器<span class="jill"></span>R1<span class="jill"></span>中的路由表</span></div></div><div id="9WEiTSBV8VUidAnFWy55op" class="wolai-block wolai-text"><div><span class="inline-wrap">•主机 H1<span class="jill"></span>向 H2<span class="jill"></span>发送分组</span></div></div><div id="r5a8cHHow9MaKTFWGSNsJ9" class="wolai-block wolai-text"><div><span class="inline-wrap">•试讨论<span class="jill"></span>R1<span class="jill"></span>收到 H1<span class="jill"></span>向 H2<span class="jill"></span>发送的分组后查找路由表的过程</span></div></div><div id="nWm7wN5dZtX3K1rnFnZAeV" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_55.png" style="width: 100%"/></figure></div><h2 id="aA8NcRn3h6v6FvsW2748b4" class="wolai-block"><span class="inline-wrap">优点</span></h2><div id="4p8kUwCahsbyyqs4MrH8JE" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_56.png" style="width: 100%"/></figure></div><div id="wABWRdkyzjk3ZgVitXkkr5" class="wolai-block wolai-text"><div></div></div></div><div id="oMW8sjp5GfqV86vB97EmAA" class="wolai-block wolai-text"><div></div></div></div><h2 id="tq2T96z7x1bqJPteavskXA" class="wolai-block"><span class="inline-wrap">IP<span class="jill"></span>分组的分段与组装</span></h2><h3 id="8pnL6LakCBhh3TLSEzEYRd" class="wolai-block"><span class="inline-wrap"><b>1、最大传输单元与<span class="jill"></span>IP<span class="jill"></span>分组的分段</b></span></h3><div id="77rR24TaCN56LUiZ5j9SRj" class="wolai-block wolai-text"><div><span class="inline-wrap">IP<span class="jill"></span>分组头中，与分组的分段和组装有关字段有标识、标志、段偏移。</span></div></div><div id="uuZnoBMua9vfGDE33op3oL" class="wolai-block wolai-text"><div><span class="inline-wrap">每种网络规定数据链路层的帧的数据字段的最大长度称为最大传输单元（MTU）。</span></div></div><div id="5MvckEL81i2LzZj1F3KUEA" class="wolai-block wolai-text"><div><span class="inline-wrap">不同网络的数据链路层<span class="jill"></span>MTU<span class="jill"></span>的长度可能不同，因此路由器在接收到分组并准备转发到目的主机时，首先要根据下一个网络的数据链路层<span class="jill"></span>MTU，决定该分组在转发之前是否需要分段。</span><span class="inline-wrap"><b>当<span class="jill"></span>IP<span class="jill"></span>分组的长度大于<span class="jill"></span>MTU<span class="jill"></span>的长度时，就必须对<span class="jill"></span>IP<span class="jill"></span>分组进行分段。</b></span><span class="inline-wrap"> </span></div></div><h3 id="cdbsT22h2FSVwoeZVy591k" class="wolai-block"><span class="inline-wrap"><b>2、分段方法</b></span></h3><div id="8iwracKJtjKP42DG9HzUzA" class="wolai-block wolai-text"><div><span class="inline-wrap">如下图所示，根据<span class="jill"></span>MTU<span class="jill"></span>长度完成分段，并对每一个分段数据添加原来的分组头。</span></div></div><div id="ewok34WfaigWvZ4dCmkxre" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://img-blog.csdnimg.cn/20200805174923619.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDE2NDQ4OQ==,size_16,color_FFFFFF,t_70" style="width: 486.4px"/></figure></div><h3 id="ux2rcH7t1eJ72E9xPx9r5M" class="wolai-block"><span class="inline-wrap"><b>3、标识、标志、段偏移字段</b></span></h3><aside id="Kz7z61qH3hUP9o7eN9VVw" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap">这里就是前面那张图的第二排</span></aside><h4 id="qRrBnBm3k5cnXdWbD5a6Gu" class="wolai-block"><span class="inline-wrap"><b>标识字段：</b></span><span class="inline-wrap"> </span></h4><aside id="7xPH6h99YsuZ8Ha5ievfPx" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap">根据标识字段<span class="jill"></span>ID<span class="jill"></span>值是否相同来判断不同的段是否属于同一个分组，从而确保不会混淆。</span></aside><div id="qXemEuJ35SEBmih3PVyGKg" class="wolai-block wolai-text"><div><span class="inline-wrap">•用于唯一标志一个分组，分段时路由器将分组标识符放入分段后的标识符字段（IdentificationField）中</span></div></div><div id="4FKNmy93FaafJYJaakXZg4" class="wolai-block wolai-text"><div><span class="inline-wrap">•目的主机使用该标志来确定新到的分段属于哪一个报文</span></div></div><div id="nFjjsDXjJMf82kGAXcNWG1" class="wolai-block wolai-text"><div><span class="inline-wrap">•IP<span class="jill"></span>协议每发送一个<span class="jill"></span>IP<span class="jill"></span>分组，则要把该标志符加<span class="jill"></span>1，作为下一个分组的标志符</span></div></div><div id="25zE42dP7bekBoF2Phv9zL" class="wolai-block wolai-text"><div><span class="inline-wrap">•标识符有<span class="jill"></span>16<span class="jill"></span>个比特，可以保证在重复使用一个标识符时，具有该标识符的上一个分组的所有分段都已经从网络上消失</span></div></div><h4 id="x7Be9ddE52HzmsnrLzAFZB" class="wolai-block"><span class="inline-wrap"><b>标志字段：</b></span><span class="inline-wrap">  </span></h4><div id="knEQejfaFFcpaAHzhDZng7" class="wolai-block wolai-text"><div><span class="inline-wrap">结构如下图</span></div></div><div id="88Ppjxv4nHYqNZvEDUkqDg" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://img-blog.csdnimg.cn/20200805175610591.png" style="width: 302.4px"/></figure></div><div id="k7qgc33cLG2Y7GYV7FfVBW" class="wolai-block wolai-text"><div><span class="inline-wrap">•有三位，只有低两位有效</span></div></div><div id="hdWYD5XzCsUR4iLe3qNYZ3" class="wolai-block wolai-text"><div><span class="inline-wrap">•分别是多段标志位（morefragments，MF）和禁止分段标志位(donot fragment，DF)</span></div><div id="vngDhdoeyVXSUSLFxQRNtn" class="wolai-block wolai-text"><div><span class="inline-wrap">DF=1<span class="jill"></span>表示不能对分组进行分段，DF=0<span class="jill"></span>表示可以分段。MF=1<span class="jill"></span>表示不是最后一个分段，MF=0<span class="jill"></span>表示接受的是最后一个分段。</span></div></div></div><h4 id="esfVL6LnmzG9GvM6hBaBR3" class="wolai-block"><span class="inline-wrap"><b>段偏移：</b></span><span class="inline-wrap">  </span></h4><aside id="9rF6SmxbdE5too7QvZRhpQ" class="green wolai-block"><div data-symbol="🌲" class="icon"></div><span class="inline-wrap">表示分段在整个分组中的相对位置，段偏移是以<span class="jill"></span>8<span class="jill"></span>字节为单位来计数。</span></aside><div id="2wYGtDqZ3FnAKnQFUr2dnY" class="wolai-block wolai-text"><div><span class="inline-wrap">•表示分段在分组数据中的偏移，即分段数据从分组中哪个位置取出的</span></div></div><div id="oYup9Czod48y3ChuyX5ddm" class="wolai-block wolai-text"><div><span class="inline-wrap">•在进行分段时，每个数据段的长度依照物理网络的<span class="jill"></span>MTU<span class="jill"></span>确定</span></div></div><div id="edX2RKcZe85yYz94kuyQYH" class="wolai-block wolai-text"><div><span class="inline-wrap">•在<span class="jill"></span>IPv4<span class="jill"></span>中约定分段位移必须为<span class="jill"></span>8<span class="jill"></span>字节的整数倍</span></div></div><div id="idKjL9ZJYkHbuq834zhDrL" class="wolai-block wolai-text"><div><span class="inline-wrap">•所以要求每个分段的长度必须为<span class="jill"></span>8<span class="jill"></span>的整数倍</span></div></div><div id="7SPDJYn7YWxdQc6F5oPN7e" class="wolai-block wolai-text"><div><span class="inline-wrap">•偏移量<span class="jill"></span>1<span class="jill"></span>对应字节号<span class="jill"></span>8，偏移量<span class="jill"></span>2<span class="jill"></span>对应字节号<span class="jill"></span>16，依此类推</span></div></div><div id="ac2hUNH5YRJynWxWvBuY1C" class="wolai-block wolai-text"><div><span class="inline-wrap">•最后一个分段除外，它可能比前面的几个分段的长度小，长度可以为任意值</span></div></div><div id="vM3cR9w1YCmMykjscno3GB" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://img-blog.csdnimg.cn/20200805175619224.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDE2NDQ4OQ==,size_16,color_FFFFFF,t_70" style="width: 619.2px"/></figure></div><div id="8kkSQD1FkjKj3wxZ5ZdCRU" class="wolai-block wolai-text"><div><span class="inline-wrap"><b>具体例子</b></span></div></div><div id="qAdJxcxA5c9ez4WyUHnzy5" class="wolai-block wolai-text"><div><span class="inline-wrap">如下图例子所示：</span></div></div><div id="hP6eJRXFbBSgk719ynApjn" class="wolai-block wolai-text"><div><span class="inline-wrap">265<span class="jill"></span>为标识，表示同一分组；DF<span class="jill"></span>都为<span class="jill"></span>0<span class="jill"></span>代表可以分段；最后一个分段的<span class="jill"></span>MF<span class="jill"></span>为<span class="jill"></span>0，代表是最后一个分段；偏移量分别为<span class="jill"></span>0、100、200，代表偏移了<span class="jill"></span>0、800、1600<span class="jill"></span>字节。  
</span></div></div><div id="8kqn6Znbq4Dn2o1h85WZRm" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="https://img-blog.csdnimg.cn/20200805175733896.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDE2NDQ4OQ==,size_16,color_FFFFFF,t_70" style="width: 594px"/></figure></div><h2 id="ofJkHCQdMqpPAtFPde36eb" class="wolai-block"><span class="inline-wrap">IP<span class="jill"></span>分组头选项</span></h2><div id="6V6eY388FiaNdHjA7eHUmM" class="wolai-block wolai-text"><div><span class="inline-wrap">选项用于控制与测试，最大长度为<span class="jill"></span>40<span class="jill"></span>字节，如果不受<span class="jill"></span>4<span class="jill"></span>的整数倍要添加填充位。</span></div></div><div id="gaTW46rJ7KotBba55P7ks9" class="wolai-block wolai-text"><div><span class="inline-wrap">分组头选项由选项码、长度、选项数据组成。</span></div></div><div id="g8HhtM6UwKnyWiPoxRoda3" class="wolai-block wolai-text"><div><span class="inline-wrap">其中选项码用于确定具体功能，包括源路由、记录路由、时间戳，如下：</span></div></div><h3 id="kSZ8wYtzM4AkovcrLiYAjV" class="wolai-block"><span class="inline-wrap"><b>1、源路由</b></span></h3><blockquote id="ruf8dq7wApdB2JQ9Z6V6Vy" class="wolai-block"><span class="inline-wrap">指由源主机指定的传输路径，分为严格源路由(SSR）和松散源路由（LSR），前者经过的路由器和路径必须和规定一致，后者除了规定的路由器外中途还可以经过其它路由器。</span></blockquote><h4 id="imA4cmjzzMgqdToWSq9v7a" class="wolai-block"><span class="inline-wrap">严格源路由选项（SourceRoute Option）</span></h4><h4 id="7SKTkDR3tpeVjnYLYVi7xd" class="wolai-block"><span class="inline-wrap">宽松源路由选项（LooseSource Route Option）</span></h4><h3 id="mBUBikJ3XvyqrGPgsBz1KE" class="wolai-block"><span class="inline-wrap"><b>2、记录路由选项（Record Route Option）</b></span></h3><div id="k3gfdtjCgujZnwLpt6YTsc" class="wolai-block wolai-text"><div><span class="inline-wrap">将每个路由器的<span class="jill"></span>IP<span class="jill"></span>地址记录下来。</span></div></div><h3 id="bDqiV5beHcFrU1jgWEm96o" class="wolai-block"><span class="inline-wrap"><b>3、时戳选项（Time Stamp Option）</b></span></h3><div id="9mK124rsxjCH6gMd4VmmWr" class="wolai-block wolai-text"><div><span class="inline-wrap">记录分组经过每个路由器的本地时间。</span></div></div><h3 id="k3Qi3wYyuRRX1PMQUEX8fj" class="wolai-block"><span class="inline-wrap">4. 安全选项（Security Option）</span></h3><div id="h9nmjQHCxvFmMgnp4RijaM" class="wolai-block"><figure class="wolai-center" style="width: 100%"><img src="media/image_57.png" style="width: 100%"/></figure></div><h1 id="4HEnxFm62uRqoCZqS3d97T" class="wolai-block"><span class="inline-wrap">Reference</span></h1><div id="pXBkQxNPTHegFyQaxLZgEX" class="wolai-bookmark wolai-block"><a href="https://blog.csdn.net/weixin_44164489/article/details/107820407">IPv4分组格式（网络层学习笔记）_ip分组首部格式_你喜欢梅西吗的博客-CSDN博客</a><div class="info-box"><div class="text-pane"><div data-title="IPv4分组格式（网络层学习笔记）_ip分组首部格式_你喜欢梅西吗的博客-CSDN博客"></div><div data-desc="IPv4分组结构IP分组由两个部分组成：分组头和数据。与TCP报文类似，IP分组头的基本单位也为4字节，即分组头的每行宽度为4字节，如下图所示前5行是每个分组头必须有的字段，第6行是选项字段，因此IP分组头的基本长度为5*4=20字节，如果加上最长为40字节的选项，则IP分组头的最大长度为60字节。可见IP分组头的长度为20-60字节。值得一提的是，TCP报头长度也为20-60字节。IPv4分组头"></div><div class="icon-host"><div class="icon icon-image" style="background-image: url(&quot;https://g.csdnimg.cn/static/logo/favicon32.ico&quot;)"></div><div data-hostname="blog.csdn.net"></div></div></div><div class="preview-pane"></div></div></div><div id="eCYRELxxoJAVuXMYD6AWX" class="wolai-block wolai-text"><div></div></div></article><footer></footer></body></html>